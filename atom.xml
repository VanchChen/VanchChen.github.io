<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Vanch&#39;s Blog</title>
  <icon>https://www.gravatar.com/avatar/753583210964c7a8a41496ec0dc617dc</icon>
  <subtitle>æ¬¢è¿æ¥åˆ°æˆ‘çš„ä¸–ç•Œ</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://vanchchen.github.io/"/>
  <updated>2018-12-25T09:54:50.335Z</updated>
  <id>https://vanchchen.github.io/</id>
  
  <author>
    <name>Vanch</name>
    <email>447389831@qq.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ä¸‰ç§UIScrollViewåµŒå¥—å®ç°æ–¹æ¡ˆ</title>
    <link href="https://vanchchen.github.io/p/7448.html"/>
    <id>https://vanchchen.github.io/p/7448.html</id>
    <published>2018-12-25T09:34:25.000Z</published>
    <updated>2018-12-25T09:54:50.335Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>éšç€äº§å“åŠŸèƒ½ä¸æ–­çš„è¿­ä»£ï¼Œæ€»ä¼šæœ‰éœ€æ±‚å¸Œæœ›åœ¨ä¿è¯ä¸å½±å“å…¶ä»–åŒºåŸŸåŠŸèƒ½çš„å‰æä¸‹ï¼Œåœ¨æŸä¸€åŒºåŸŸå®ç°æ ¹æ®é€‰æ‹©å™¨åˆ‡æ¢ä¸åŒçš„å†…å®¹æ˜¾ç¤ºã€‚</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://vanch-1258064554.cos.ap-shanghai.myqcloud.com/gif/gif_1699821243_12.gif" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>è‹¹æœå¹¶ä¸æ¨èåµŒå¥—æ»šåŠ¨è§†å›¾ï¼Œå¦‚æœç›´æ¥æ·»åŠ çš„è¯ï¼Œå°±ä¼šå‡ºç°ä¸‹å›¾è¿™ç§æƒ…å†µï¼Œæ‰‹åŠ¿çš„å†²çªé€ æˆäº†ä½“éªŒä¸Šçš„æ‚²å‰§ã€‚</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://vanch-1258064554.cos.ap-shanghai.myqcloud.com/gif/gif_1544777437_77.gif" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä¹Ÿä¸æ–­çš„åœ¨æ€è€ƒè§£å†³æ–¹æ¡ˆï¼Œç»å†äº†å‡ æ¬¡é‡æ„åï¼Œæœ‰äº†äº›æ”¹è¿›çš„ç»éªŒï¼Œå› æ­¤æŠ½ç©ºæ•´ç†äº†ä¸‰ç§æ–¹æ¡ˆï¼Œä»–ä»¬å®ç°çš„æœ€ç»ˆæ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><hr><h2 id="åˆ†è€Œæ²»ä¹‹"><a href="#åˆ†è€Œæ²»ä¹‹" class="headerlink" title="åˆ†è€Œæ²»ä¹‹"></a>åˆ†è€Œæ²»ä¹‹</h2><p>æœ€å¸¸è§çš„ä¸€ç§æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨ <code>UITableView</code> ä½œä¸ºå¤–éƒ¨æ¡†æ¶ï¼Œå°†å­è§†å›¾çš„å†…å®¹é€šè¿‡ <code>UITableViewCell</code> çš„æ–¹å¼å±•ç°ã€‚</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://vanch-1258064554.cos.ap-shanghai.myqcloud.com/blog/pic_1545731447_55.jpg" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>è¿™ç§åšæ³•çš„å¥½å¤„åœ¨äºè§£è€¦æ€§ï¼Œæ¡†æ¶åªè¦æ¥å—ä¸åŒçš„æ•°æ®æºå°±èƒ½åˆ·æ–°å¯¹åº”çš„å†…å®¹ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, heightForRowAt indexPath: IndexPath)</span></span> </span><br><span class="line">    -&gt; <span class="type">CGFloat</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> indexPath.section == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">NSTHeaderHeight</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> segmentView.selectedIndex == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tableSource.tableView(<span class="number">_</span>:tableView, heightForRowAt:indexPath)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> webSource.tableView(<span class="number">_</span>:tableView, heightForRowAt:indexPath)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ç›¸å¯¹çš„ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå†…éƒ¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ»šåŠ¨è§†å›¾ï¼Œæ¯”å¦‚ <code>UIWebView</code> çš„å­è§†å›¾ <code>UIWebScrollView</code>ï¼Œè¿˜æ˜¯ä¼šæœ‰æ‰‹åŠ¿å†²çªçš„æƒ…å†µã€‚</p><p>å¸¸è§„åšæ³•é¦–å…ˆç¦æ­¢å†…éƒ¨è§†å›¾çš„æ»šåŠ¨ï¼Œå½“æ»šåŠ¨åˆ°ç½‘é¡µçš„ä½ç½®æ—¶ï¼Œå¯åŠ¨ç½‘é¡µçš„æ»šåŠ¨å¹¶ç¦æ­¢å¤–éƒ¨æ»šåŠ¨ï¼Œåä¹‹äº¦ç„¶ã€‚</p><p>ä¸å¹¸çš„æ˜¯ï¼Œè¿™ç§æ–¹æ¡ˆæœ€å¤§çš„é—®é¢˜æ˜¯<strong>é¡¿æŒ«æ„Ÿ</strong>ã€‚</p><p>å†…éƒ¨è§†å›¾åˆå§‹æ˜¯ä¸èƒ½æ»šåŠ¨çš„ï¼Œæ‰€ä»¥å¤–éƒ¨è§†å›¾ä½œä¸ºæ•´å¥—äº‹ä»¶çš„æ¥æ”¶è€…ã€‚å½“æ»šåŠ¨åˆ°é¢„è®¾çš„ä½ç½®å¹¶å¼€å¯äº†å†…éƒ¨è§†å›¾çš„æ»šåŠ¨ï¼Œäº‹ä»¶è¿˜æ˜¯ä¼ é€’ç»™å”¯ä¸€æ¥æ”¶è€…å¤–éƒ¨è§†å›¾ï¼Œåªæœ‰æ¾å¼€æ‰‹ç»“æŸäº‹ä»¶åé‡æ–°è§¦å‘ï¼Œæ‰èƒ½ä½¿å†…éƒ¨è§†å›¾å¼€å§‹æ»šåŠ¨ã€‚</p><p>å¥½åœ¨æœ‰ä¸€ä¸ªæ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scrollViewDidScroll</span><span class="params">(<span class="number">_</span> scrollView: UIScrollView)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> scrollView == tableView &#123;</span><br><span class="line">        <span class="comment">//å¤–éƒ¨åœ¨æ»šåŠ¨</span></span><br><span class="line">        <span class="keyword">if</span> offset &gt; anchor &#123;</span><br><span class="line">            <span class="comment">//æ»šåˆ°è¿‡äº†é”šç‚¹ï¼Œè¿˜åŸå¤–éƒ¨è§†å›¾ä½ç½®ï¼Œæ·»åŠ åç§»åˆ°å†…éƒ¨</span></span><br><span class="line">            tableView.setContentOffset(<span class="type">CGPoint</span>(x: <span class="number">0</span>, y: anchor), animated: <span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">let</span> webOffset = webScrollView.contentOffset.y + offset - anchor</span><br><span class="line">            webScrollView.setContentOffset(<span class="type">CGPoint</span>(x: <span class="number">0</span>, y: webOffset), animated: <span class="literal">false</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> offset &lt; anchor &#123;</span><br><span class="line">            <span class="comment">//æ²¡æ»šåˆ°é”šç‚¹ï¼Œè¿˜åŸä½ç½®</span></span><br><span class="line">            webScrollView.setContentOffset(<span class="type">CGPoint</span>.zero, animated: <span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//å†…éƒ¨åœ¨æ»šåŠ¨</span></span><br><span class="line">        <span class="keyword">if</span> offset &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">//å†…éƒ¨æ»šåŠ¨è¿˜åŸå¤–éƒ¨ä½ç½®</span></span><br><span class="line">            tableView.setContentOffset(<span class="type">CGPoint</span>(x: <span class="number">0</span>, y: anchor), animated: <span class="literal">false</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> offset &lt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">//å†…éƒ¨å¾€ä¸Šæ»šï¼Œæ·»åŠ åç§»é‡åˆ°å¤–éƒ¨è§†å›¾</span></span><br><span class="line">            <span class="keyword">let</span> tableOffset = tableView.contentOffset.y + offset</span><br><span class="line">            tableView.setContentOffset(<span class="type">CGPoint</span>(x: <span class="number">0</span>, y: tableOffset), animated: <span class="literal">false</span>)</span><br><span class="line">            webScrollView.setContentOffset(<span class="type">CGPoint</span>.zero, animated: <span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scrollViewDidEndScroll</span><span class="params">(<span class="number">_</span> scrollView: UIScrollView)</span></span> &#123;</span><br><span class="line">    <span class="comment">//æ ¹æ®æ»šåŠ¨åœæ­¢åçš„åç§»é‡ï¼Œè®¡ç®—è°å¯ä»¥æ»šåŠ¨</span></span><br><span class="line">    <span class="keyword">var</span> outsideScrollEnable = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> scrollView == tableView &#123;</span><br><span class="line">        <span class="keyword">if</span> offset == anchor &amp;&amp;</span><br><span class="line">            webScrollView.contentOffset.y &gt; <span class="number">0</span> &#123;</span><br><span class="line">            outsideScrollEnable = <span class="literal">false</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            outsideScrollEnable = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> offset == <span class="number">0</span> &amp;&amp;</span><br><span class="line">            tableView.contentOffset.y &lt; anchor &#123;</span><br><span class="line">            outsideScrollEnable = <span class="literal">true</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            outsideScrollEnable = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è®¾ç½®æ»šåŠ¨ï¼Œæ˜¾ç¤ºå¯¹åº”çš„æ»šåŠ¨æ¡</span></span><br><span class="line">    tableView.isScrollEnabled = outsideScrollEnable</span><br><span class="line">    tableView.showsHorizontalScrollIndicator = outsideScrollEnable</span><br><span class="line">    webScrollView.isScrollEnabled = !outsideScrollEnable</span><br><span class="line">    webScrollView.showsHorizontalScrollIndicator = !outsideScrollEnable</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ¥å—æ»šåŠ¨å›è°ƒï¼Œæˆ‘ä»¬å°±å¯ä»¥äººä¸ºæ§åˆ¶æ»šåŠ¨è¡Œä¸ºã€‚å½“æ»šåŠ¨è·ç¦»è¶…è¿‡äº†æˆ‘ä»¬çš„é¢„è®¾å€¼ï¼Œå°±å¯ä»¥è®¾ç½®å¦ä¸€ä¸ªè§†å›¾çš„åç§»é‡æ¨¡æ‹Ÿå‡ºæ»šåŠ¨çš„æ•ˆæœã€‚æ»šåŠ¨çŠ¶æ€ç»“æŸåï¼Œå†æ ¹æ®åˆ¤æ–­æ¥å®šä½å“ªä¸ªè§†å›¾å¯ä»¥æ»šåŠ¨ã€‚</p><p>å½“ç„¶è¦ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¿…é¡»æŠŠä¸¤ä¸ªæ»šåŠ¨è§†å›¾çš„ä»£ç†éƒ½è®¾ç½®ä¸ºæ§åˆ¶å™¨ï¼Œå¯èƒ½ä¼šå¯¹ä»£ç é€»è¾‘æœ‰å½±å“ (UIWebView æ˜¯ UIWebScrollView çš„ä»£ç†ï¼Œåæ–‡æœ‰è§£å†³æ–¹æ¡ˆ)ã€‚</p><p><code>UITableView</code> åµŒå¥—çš„æ–¹å¼ï¼Œèƒ½å¤Ÿå¾ˆå¥½çš„è§£å†³åµŒå¥—ç®€å•è§†å›¾ï¼Œé‡åˆ° <code>UIWebView</code> è¿™ç§å¤æ‚æƒ…å†µï¼Œä¹Ÿèƒ½äººä¸ºæ§åˆ¶è§£å†³ã€‚ä½†æ˜¯ä½œä¸º <code>UITableView</code> çš„ä¸€ç¯ï¼Œæœ‰å¾ˆå¤šé™åˆ¶(æ¯”å¦‚ä¸åŒæ•°æ®æºéœ€è¦ä¸åŒçš„è®¾å®šï¼Œæœ‰çš„å¸Œæœ›åŠ¨æ€é«˜åº¦ï¼Œæœ‰çš„éœ€è¦æ’å…¥é¢å¤–çš„è§†å›¾)ï¼Œè¿™äº›éƒ½ä¸èƒ½å¾ˆå¥½çš„è§£å†³ã€‚</p><hr><h2 id="å„è‡ªä¸ºæ”¿"><a href="#å„è‡ªä¸ºæ”¿" class="headerlink" title="å„è‡ªä¸ºæ”¿"></a>å„è‡ªä¸ºæ”¿</h2><p>å¦ä¸€ç§è§£å†³æ–¹æ¡ˆæ¯”è¾ƒåå®¢ä¸ºä¸»ï¼Œçµæ„Ÿæ¥æºäºä¸‹æ‹‰åˆ·æ–°çš„å®ç°æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯å°†éœ€è¦æ˜¾ç¤ºçš„å†…å®¹å¡å…¥è´Ÿä¸€å±ã€‚</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://vanch-1258064554.cos.ap-shanghai.myqcloud.com/blog/pic_1545731463_75.jpg" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>é¦–å…ˆä¿è¯å­è§†å›¾æ’‘æ»¡å…¨å±ï¼ŒæŠŠä¸»è§†å›¾å†…å®¹æ’å…¥å­è§†å›¾ï¼Œå¹¶è®¾ç½® <code>ContentInset</code> ä¸ºå¤´éƒ¨é«˜åº¦ï¼Œä»è€Œå®ç°æ•ˆæœã€‚</p><p>æ¥çœ‹ä¸‹ä»£ç å®ç°ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reloadScrollView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//é€‰æ‹©å½“å‰æ˜¾ç¤ºçš„è§†å›¾</span></span><br><span class="line">    <span class="keyword">let</span> scrollView = segmentView.selectedIndex == <span class="number">0</span> ? </span><br><span class="line">        tableSource.tableView : webSource.webView.scrollView</span><br><span class="line">    <span class="comment">//ç›¸åŒè§†å›¾å°±ä¸æ“ä½œäº†</span></span><br><span class="line">    <span class="keyword">if</span> currentScrollView == scrollView &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä»ä¸Šæ¬¡çš„è§†å›¾ä¸­ç§»é™¤å¤–éƒ¨å†…å®¹</span></span><br><span class="line">    headLabel.removeFromSuperview()</span><br><span class="line">    segmentView.removeFromSuperview()</span><br><span class="line">    <span class="keyword">if</span> currentScrollView != <span class="literal">nil</span> &#123;</span><br><span class="line">        currentScrollView!.removeFromSuperview()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è®¾ç½®æ–°æ»šåŠ¨è§†å›¾çš„å†…åµŒåç§»é‡ä¸ºå¤–éƒ¨å†…å®¹çš„é«˜åº¦</span></span><br><span class="line">    scrollView.contentInset = <span class="type">UIEdgeInsets</span>(top: </span><br><span class="line">        <span class="type">NSTSegmentHeight</span> + <span class="type">NSTHeaderHeight</span>, <span class="keyword">left</span>: <span class="number">0</span>, bottom: <span class="number">0</span>, <span class="keyword">right</span>: <span class="number">0</span>)</span><br><span class="line">    <span class="comment">//æ·»åŠ å¤–éƒ¨å†…å®¹åˆ°æ–°è§†å›¾ä¸Š</span></span><br><span class="line">    scrollView.addSubview(headLabel)</span><br><span class="line">    scrollView.addSubview(segmentView)</span><br><span class="line">    view.addSubview(scrollView)</span><br><span class="line">    </span><br><span class="line">    currentScrollView = scrollView</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºåœ¨UIå±‚çº§å°±åªå­˜åœ¨ä¸€ä¸ªæ»šåŠ¨è§†å›¾ï¼Œæ‰€ä»¥å·§å¦™çš„é¿å¼€äº†å†²çªã€‚</p><p>ç›¸å¯¹çš„ï¼Œæ’å…¥çš„å¤´éƒ¨è§†å›¾å¿…é¡»è¦è½»é‡ï¼Œå¦‚æœéœ€è¦å’Œæˆ‘ä¾‹å­ä¸­ä¸€æ ·å®ç°æµ®åŠ¨æ æ•ˆæœï¼Œå°±è¦è§‚å¯Ÿåç§»é‡çš„å˜åŒ–æ‰‹åŠ¨å®šä½ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reloadScrollView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> currentScrollView != <span class="literal">nil</span> &#123;</span><br><span class="line">        currentScrollView!.removeFromSuperview()</span><br><span class="line">        <span class="comment">//ç§»é™¤ä¹‹å‰çš„ KVO</span></span><br><span class="line">        observer?.invalidate()</span><br><span class="line">        observer = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ–°è§†å›¾æ·»åŠ æ»šåŠ¨è§‚å¯Ÿ</span></span><br><span class="line">    observer = scrollView.observe(\.contentOffset, options: [.new, .initial]) </span><br><span class="line">    &#123;[<span class="keyword">weak</span> <span class="keyword">self</span>] object, change <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> strongSelf = <span class="keyword">self</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> closureScrollView = object <span class="keyword">as</span> <span class="type">UIScrollView</span></span><br><span class="line">        <span class="keyword">var</span> segmentFrame = strongSelf.segmentView.frame</span><br><span class="line">        <span class="comment">//è®¡ç®—åç§»ä½ç½®</span></span><br><span class="line">        <span class="keyword">let</span> safeOffsetY = closureScrollView.contentOffset.y + </span><br><span class="line">            closureScrollView.safeAreaInsets.top</span><br><span class="line">        <span class="comment">//è®¡ç®—æµ®åŠ¨æ ä½ç½®</span></span><br><span class="line">        <span class="keyword">if</span> safeOffsetY &lt; -<span class="type">NSTSegmentHeight</span> &#123;</span><br><span class="line">            segmentFrame.origin.y = -<span class="type">NSTSegmentHeight</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            segmentFrame.origin.y = safeOffsetY</span><br><span class="line">        &#125;</span><br><span class="line">        strongSelf.segmentView.frame = segmentFrame</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ–¹æ³•æœ‰ä¸€ä¸ªå‘ï¼Œå¦‚æœåŠ è½½çš„ <code>UITableView</code> éœ€è¦æ˜¾ç¤ºè‡ªå·±çš„ <code>SectionHeader</code> ï¼Œé‚£ä¹ˆç”±äºè®¾ç½®äº† <code>ContentInset</code> ï¼Œå°±ä¼šå¯¼è‡´æµ®åŠ¨ä½ç½®åç§»ã€‚</p><p>æˆ‘æƒ³åˆ°çš„è§£å†³åŠæ³•å°±æ˜¯åœ¨å›è°ƒä¸­ä¸æ–­è°ƒæ•´ <code>ContentInset</code> æ¥è§£å†³ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">observer = scrollView.observe(\.contentOffset, options: [.new, .initial]) </span><br><span class="line">&#123;[<span class="keyword">weak</span> <span class="keyword">self</span>] object, change <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> strongSelf = <span class="keyword">self</span> <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> closureScrollView = object <span class="keyword">as</span> <span class="type">UIScrollView</span></span><br><span class="line">    <span class="comment">//è®¡ç®—åç§»ä½ç½®</span></span><br><span class="line">    <span class="keyword">let</span> safeOffsetY = closureScrollView.contentOffset.y + </span><br><span class="line">        closureScrollView.safeAreaInsets.top</span><br><span class="line">    <span class="comment">//ContentInset æ ¹æ®å½“å‰æ»šåŠ¨å®šåˆ¶</span></span><br><span class="line">    <span class="keyword">var</span> contentInsetTop = <span class="type">NSTSegmentHeight</span> + <span class="type">NSTHeaderHeight</span></span><br><span class="line">    <span class="keyword">if</span> safeOffsetY &lt; <span class="number">0</span> &#123;</span><br><span class="line">        contentInsetTop = <span class="built_in">min</span>(contentInsetTop, fabs(safeOffsetY))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        contentInsetTop = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    closureScrollView.contentInset = <span class="type">UIEdgeInsets</span>(top: </span><br><span class="line">    contentInsetTop, <span class="keyword">left</span>: <span class="number">0</span>, bottom: <span class="number">0</span>, <span class="keyword">right</span>: <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•å¥½åœ¨ä¿è¯äº†æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ»šåŠ¨è§†å›¾ï¼Œæ‰€æœ‰çš„æ‰‹åŠ¿æ“ä½œéƒ½æ˜¯åŸç”Ÿå®ç°ï¼Œå‡å°‘äº†å¯èƒ½å­˜åœ¨çš„è”åŠ¨é—®é¢˜ã€‚</p><p>ä½†ä¹Ÿæœ‰ä¸€ä¸ªå°ç¼ºé™·ï¼Œé‚£å°±æ˜¯å¤´éƒ¨å†…å®¹çš„åç§»é‡éƒ½æ˜¯è´Ÿæ•°ï¼Œè¿™ä¸åˆ©äºä¸‰æ–¹è°ƒç”¨å’Œç³»ç»ŸåŸå§‹è°ƒç”¨çš„å®ç°ï¼Œéœ€è¦ç»´æŠ¤ã€‚</p><hr><h2 id="ä¸­å¤®é›†æƒ"><a href="#ä¸­å¤®é›†æƒ" class="headerlink" title="ä¸­å¤®é›†æƒ"></a>ä¸­å¤®é›†æƒ</h2><p>æœ€åä»‹ç»ä¸€ç§æ¯”è¾ƒå®Œå–„çš„æ–¹æ¡ˆã€‚å¤–éƒ¨è§†å›¾é‡‡ç”¨ <code>UIScrollView</code> ï¼Œå†…éƒ¨è§†å›¾æ°¸è¿œä¸å¯æ»šåŠ¨ï¼Œå¤–éƒ¨è¾¹æ»šåŠ¨è¾¹è°ƒæ•´å†…éƒ¨çš„ä½ç½®ï¼Œä¿è¯äº†åŒæ–¹çš„ç‹¬ç«‹æ€§ã€‚</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://vanch-1258064554.cos.ap-shanghai.myqcloud.com/blog/pic_1545731478_85.jpg" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>ä¸ç¬¬äºŒç§æ–¹æ³•ç›¸æ¯”ï¼Œåˆ‡æ¢ä¸åŒåŠŸèƒ½å°±æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦æ›¿æ¢å†…éƒ¨è§†å›¾ï¼Œå¹¶å®ç°å¤–éƒ¨è§†å›¾çš„ä»£ç†ï¼Œæ»šåŠ¨æ—¶è®¾ç½®å†…éƒ¨è§†å›¾çš„åç§»é‡å°±å¯ä»¥äº†ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reloadScrollView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰æ•°æ®æº</span></span><br><span class="line">    <span class="keyword">let</span> contentScrollView = segmentView.selectedIndex == <span class="number">0</span> ? </span><br><span class="line">    tableSource.tableView : webSource.webView.scrollView</span><br><span class="line">    <span class="comment">//ç§»é™¤ä¹‹å‰çš„è§†å›¾</span></span><br><span class="line">    <span class="keyword">if</span> currentScrollView != <span class="literal">nil</span> &#123;</span><br><span class="line">        currentScrollView!.removeFromSuperview()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç¦æ­¢æ»šåŠ¨åæ·»åŠ æ–°è§†å›¾</span></span><br><span class="line">    contentScrollView.isScrollEnabled = <span class="literal">false</span></span><br><span class="line">    scrollView.addSubview(contentScrollView)</span><br><span class="line">    <span class="comment">//ä¿å­˜å½“å‰è§†å›¾</span></span><br><span class="line">    currentScrollView = contentScrollView</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scrollViewDidScroll</span><span class="params">(<span class="number">_</span> scrollView: UIScrollView)</span></span> &#123;</span><br><span class="line">    <span class="comment">//æ ¹æ®åç§»é‡åˆ·æ–° Segment å’Œå†…éƒ¨è§†å›¾çš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">self</span>.view.setNeedsLayout()</span><br><span class="line">    <span class="keyword">self</span>.view.layoutIfNeeded()</span><br><span class="line">    <span class="comment">//æ ¹æ®å¤–éƒ¨è§†å›¾æ•°æ®è®¡ç®—å†…éƒ¨è§†å›¾çš„åç§»é‡</span></span><br><span class="line">    <span class="keyword">var</span> floatOffset = scrollView.contentOffset</span><br><span class="line">    floatOffset.y -= (<span class="type">NSTHeaderHeight</span> + <span class="type">NSTSegmentHeight</span>)</span><br><span class="line">    floatOffset.y = <span class="built_in">max</span>(floatOffset.y, <span class="number">0</span>)</span><br><span class="line">    <span class="comment">//åŒæ­¥å†…éƒ¨è§†å›¾çš„åç§»</span></span><br><span class="line">    <span class="keyword">if</span> currentScrollView?.contentOffset.equalTo(floatOffset) == <span class="literal">false</span> &#123;</span><br><span class="line">        currentScrollView?.setContentOffset(floatOffset, animated: <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLayoutSubviews</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.viewDidLayoutSubviews()</span><br><span class="line">    <span class="comment">//æ’‘æ»¡å…¨éƒ¨</span></span><br><span class="line">    scrollView.frame = view.bounds</span><br><span class="line">    <span class="comment">//å¤´éƒ¨å›ºå®š</span></span><br><span class="line">    headLabel.frame = <span class="type">CGRect</span>(x: <span class="number">15</span>, y: <span class="number">0</span>, </span><br><span class="line">        width: scrollView.frame.size.width - <span class="number">30</span>, height: <span class="type">NSTHeaderHeight</span>)</span><br><span class="line">    <span class="comment">//Segmentçš„ä½ç½®æ˜¯åç§»å’Œå¤´éƒ¨é«˜åº¦çš„æœ€å¤§å€¼</span></span><br><span class="line">    <span class="comment">//ä¿è¯æ»šåŠ¨åˆ°å¤´éƒ¨ä½ç½®æ—¶ä¸æµ®åŠ¨</span></span><br><span class="line">    segmentView.frame = <span class="type">CGRect</span>(x: <span class="number">0</span>, </span><br><span class="line">        y: <span class="built_in">max</span>(<span class="type">NSTHeaderHeight</span>, scrollView.contentOffset.y), </span><br><span class="line">        width: scrollView.frame.size.width, height: <span class="type">NSTSegmentHeight</span>)</span><br><span class="line">    <span class="comment">//è°ƒæ•´å†…éƒ¨è§†å›¾çš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">if</span> currentScrollView != <span class="literal">nil</span> &#123;</span><br><span class="line">        currentScrollView?.frame = <span class="type">CGRect</span>(x: <span class="number">0</span>, y: segmentView.frame.maxY, </span><br><span class="line">            width: scrollView.frame.size.width, </span><br><span class="line">            height: view.bounds.size.height - <span class="type">NSTSegmentHeight</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“å¤–éƒ¨è§†å›¾å¼€å§‹æ»šåŠ¨æ—¶ï¼Œå…¶å®ä¸€ç›´åœ¨æ ¹æ®åç§»é‡è°ƒæ•´å†…éƒ¨è§†å›¾çš„ä½ç½®ã€‚</p><p>å¤–éƒ¨è§†å›¾çš„å†…å®¹é«˜åº¦ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯å†…éƒ¨è§†å›¾å†…å®¹é«˜åº¦åŠ ä¸Šå¤´éƒ¨é«˜åº¦ï¼Œæ‰€ä»¥éœ€è¦è§‚å¯Ÿå…¶å˜åŒ–å¹¶åˆ·æ–°ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reloadScrollView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> currentScrollView != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">//ç§»é™¤KVO</span></span><br><span class="line">        observer?.invalidate()</span><br><span class="line">        observer = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ·»åŠ å†…å®¹å°ºå¯¸çš„ KVO</span></span><br><span class="line">    observer = contentScrollView.observe(\.contentSize, options: [.new, .initial]) </span><br><span class="line">    &#123;[<span class="keyword">weak</span> <span class="keyword">self</span>] object, change <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> strongSelf = <span class="keyword">self</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> closureScrollView = object <span class="keyword">as</span> <span class="type">UIScrollView</span></span><br><span class="line">        <span class="keyword">let</span> contentSizeHeight = <span class="type">NSTHeaderHeight</span> + <span class="type">NSTSegmentHeight</span> + </span><br><span class="line">            closureScrollView.contentSize.height</span><br><span class="line">        <span class="comment">//å½“å†…å®¹å°ºå¯¸æ”¹å˜æ—¶ï¼Œåˆ·æ–°å¤–éƒ¨è§†å›¾çš„æ€»å°ºå¯¸ï¼Œä¿è¯æ»šåŠ¨è·ç¦»</span></span><br><span class="line">        strongSelf.scrollView.contentSize = <span class="type">CGSize</span>(width: <span class="number">0</span>, height: contentSizeHeight)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºå†…éƒ¨æ»šåŠ¨éƒ½æ˜¯ç”±å¤–éƒ¨æ¥å®ç°ï¼Œæ²¡æœ‰æ‰‹åŠ¿çš„å‚ä¸ï¼Œå› æ­¤å¾—ä¸åˆ° <code>scrollViewDidEndDragging</code> ç­‰æ»šåŠ¨å›è°ƒï¼Œå¦‚æœæ¶‰åŠç¿»é¡µä¹‹ç±»çš„éœ€æ±‚å°±ä¼šé‡åˆ°å›°éš¾ã€‚</p><p>è§£å†³åŠæ³•æ˜¯è·å–å†…éƒ¨è§†å›¾åŸæœ¬çš„ä»£ç†ï¼Œå½“å¤–éƒ¨è§†å›¾ä»£ç†æ”¶åˆ°å›è°ƒæ—¶ï¼Œè½¬å‘ç»™è¯¥ä»£ç†å®ç°åŠŸèƒ½ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reloadScrollView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">ClosureType</span> = <span class="meta">@convention</span>(<span class="built_in">c</span>) (<span class="type">AnyObject</span>, <span class="type">Selector</span>) -&gt; <span class="type">AnyObject</span></span><br><span class="line">    <span class="comment">//å®šä¹‰è·å–ä»£ç†æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">let</span> sel = #selector(getter: <span class="type">UIScrollView</span>.delegate)</span><br><span class="line">    <span class="comment">//è·å–æ»šåŠ¨è§†å›¾ä»£ç†çš„å®ç°</span></span><br><span class="line">    <span class="keyword">let</span> imp = class_getMethodImplementation(<span class="type">UIScrollView</span>.<span class="keyword">self</span>, sel)</span><br><span class="line">    <span class="comment">//åŒ…è£…æˆé—­åŒ…çš„å½¢å¼</span></span><br><span class="line">    <span class="keyword">let</span> delegateFunc : <span class="type">ClosureType</span> = <span class="built_in">unsafeBitCast</span>(imp, to: <span class="type">ClosureType</span>.<span class="keyword">self</span>)</span><br><span class="line">    <span class="comment">//è·å¾—å®é™…çš„ä»£ç†å¯¹è±¡</span></span><br><span class="line">    currentScrollDelegate = delegateFunc(contentScrollView, sel) <span class="keyword">as</span>? <span class="type">UIScrollViewDelegate</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scrollViewDidEndDragging</span><span class="params">(<span class="number">_</span> scrollView: UIScrollView, willDecelerate decelerate: Bool)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> currentScrollDelegate != <span class="literal">nil</span> &#123;</span><br><span class="line">        currentScrollDelegate!.scrollViewDidEndDragging?</span><br><span class="line">            (currentScrollView!, willDecelerate: decelerate)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œæˆ‘å¹¶æ²¡æœ‰ä½¿ç”¨ <code>contentScrollView.delegate</code>ï¼Œè¿™æ˜¯å› ä¸º <code>UIWebScrollView</code> é‡è½½äº†è¿™ä¸ªæ–¹æ³•å¹¶è¿”å›äº† <code>UIWebView</code> çš„ä»£ç†ã€‚ä½†å®é™…çœŸæ­£çš„ä»£ç†æ˜¯ä¸€ä¸ª <code>NSProxy</code> å¯¹è±¡ï¼Œä»–è´Ÿè´£æŠŠå›è°ƒä¼ ç»™ <code>UIWebView</code> å’Œå¤–éƒ¨ä»£ç†ã€‚è¦ä¿è¯ <code>UIWebView</code> èƒ½æ­£å¸¸å¤„ç†çš„è¯ï¼Œå°±è¦è®©å®ƒä¹Ÿæ”¶åˆ°å›è°ƒï¼Œæ‰€ä»¥ä½¿ç”¨ <code>Runtime</code> æ‰§è¡Œ <code>UIScrollView</code> åŸå§‹è·å–ä»£ç†çš„å®ç°æ¥è·å–ã€‚</p><hr><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç›®å‰åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä½¿ç”¨çš„æ˜¯æœ€åä¸€ç§æ–¹æ³•ï¼Œä½†å…¶å®è¿™äº›æ–¹æ³•äº’æœ‰ä¼˜ç¼ºç‚¹ã€‚</p><table><thead><tr><th>æ–¹æ¡ˆ</th><th>åˆ†è€Œæ²»ä¹‹</th><th>å„è‡ªä¸ºæ”¿</th><th>ä¸­å¤®é›†æƒ</th></tr></thead><tbody><tr><td>æ–¹å¼</td><td>åµŒå¥—</td><td>å†…åµŒ</td><td>åµŒå¥—</td></tr><tr><td>è”åŠ¨</td><td>æ‰‹åŠ¨</td><td>è‡ªåŠ¨</td><td>æ‰‹åŠ¨</td></tr><tr><td>åˆ‡æ¢</td><td>æ•°æ®æº</td><td>æ•´ä½“æ›´æ”¹</td><td>å±€éƒ¨æ›´æ”¹</td></tr><tr><td>ä¼˜åŠ¿</td><td>ä¾¿äºç†è§£</td><td>æ»šåŠ¨æ•ˆæœå¥½</td><td>ç‹¬ç«‹æ€§</td></tr><tr><td>åŠ£åŠ¿</td><td>è”åŠ¨å¤æ‚</td><td>å¤æ‚åœºæ™¯è‹¦æ‰‹</td><td>æ¨¡æ‹Ÿæ»šåŠ¨éšæ‚£</td></tr><tr><td>è¯„åˆ†</td><td>ğŸŒŸğŸŒŸğŸŒŸ</td><td>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</td><td>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</td></tr></tbody></table><p>æŠ€æœ¯æ²¡æœ‰å¯¹é”™ï¼Œåªæœ‰é€‚ä¸é€‚åˆå½“å‰çš„éœ€æ±‚ã€‚</p><p>åˆ†è€Œæ²»ä¹‹é€‚åˆ <code>UITableView</code> äº’ç›¸åµŒå¥—çš„æƒ…å†µï¼Œé€šè¿‡æ•°æ®æºçš„å˜åŒ–èƒ½å¤Ÿå¾ˆå¥½å®ç°åˆ‡æ¢åŠŸèƒ½ã€‚</p><p>å„è‡ªä¸ºæ”¿é€‚åˆç›¸å¯¹ç®€å•çš„é¡µé¢éœ€æ±‚ï¼Œå¦‚æœèƒ½å¤Ÿé¿å…æµ®åŠ¨æ¡†ï¼Œé‚£ä½¿ç”¨è¿™ä¸ªæ–¹æ³•èƒ½å¤Ÿå®ç°æœ€å¥½çš„æ»šåŠ¨æ•ˆæœã€‚</p><p>ä¸­å¤®é›†æƒé€‚åˆå¤æ‚çš„åœºæ™¯ï¼Œé€šè¿‡ç‹¬ç«‹ä¸åŒç±»å‹çš„æ»šåŠ¨è§†å›¾ï¼Œä½¿å¾—äº’ç›¸æœ€å°‘å½±å“ï¼Œä½†æ˜¯ç”±äºå…¶æ¨¡æ‹Ÿæ»šåŠ¨çš„ç‰¹æ€§ï¼Œéœ€è¦å°å¿ƒå¤„ç†ã€‚</p><p>å¸Œæœ›æœ¬æ–‡èƒ½ç»™å¤§å®¶å¸¦æ¥å¯å‘ï¼Œé¡¹ç›®å¼€æºä»£ç <a href="https://github.com/VanchChen/NestedScrollview" target="_blank" rel="noopener">åœ¨æ­¤</a>ï¼Œæ¬¢è¿æŒ‡æ•™ä¸Starã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;éšç€äº§å“åŠŸèƒ½ä¸æ–­çš„è¿­ä»£ï¼Œæ€»ä¼šæœ‰éœ€æ±‚å¸Œæœ›åœ¨ä¿è¯ä¸å½±å“å…¶ä»–åŒºåŸŸåŠŸèƒ½çš„å‰æä¸‹ï¼Œåœ¨æŸä¸€åŒºåŸŸå®ç°æ ¹æ®é€‰æ‹©å™¨åˆ‡æ¢ä¸åŒçš„å†…å®¹æ˜¾ç¤ºã€‚&lt;/p&gt;
&lt;figure
      
    
    </summary>
    
      <category term="iOS" scheme="https://vanchchen.github.io/categories/iOS/"/>
    
    
      <category term="é‡æ„" scheme="https://vanchchen.github.io/tags/%E9%87%8D%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>è…¾è®¯äº‘Macå›¾åºŠæ’ä»¶</title>
    <link href="https://vanchchen.github.io/p/648.html"/>
    <id>https://vanchchen.github.io/p/648.html</id>
    <published>2018-12-07T06:16:09.000Z</published>
    <updated>2018-12-07T06:52:08.715Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://vanch-1258064554.cos.ap-shanghai.myqcloud.com/blog/pic_1544160967_34.jpg" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>éšç€åšå®¢è¶Šå†™è¶Šå¤šï¼Œéš¾å…ä¼šé‡åˆ°éœ€è¦æ’å…¥å›¾ç‰‡æ¥è¯´æ˜çš„æƒ…å†µã€‚</p><h3 id="å›¾åºŠé€‰æ‹©"><a href="#å›¾åºŠé€‰æ‹©" class="headerlink" title="å›¾åºŠé€‰æ‹©"></a>å›¾åºŠé€‰æ‹©</h3><p>é¦–å…ˆè°ƒç ”äº†å¸‚é¢ä¸Šçš„å›¾åºŠæœåŠ¡ï¼Œæœ¬ç€ç¨³å®šé•¿æœŸçš„ç›®æ ‡ï¼Œè¿‡æ»¤æ‰äº†æ‰“ä¸€æªæ¢ä¸€ä¸ªåœ°æ–¹çš„é‡é¸¡å°ç½‘ç«™ï¼Œå‰©ä½™æ¯”è¾ƒé è°±çš„ä¼˜ç¼ºç‚¹å¦‚ä¸‹ã€‚</p><table><thead><tr><th>å›¾åºŠ</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>è…¾è®¯äº‘</td><td>å…è´¹ æ— éœ€åŸŸå</td><td>æœªæ¥å¯èƒ½ä¼šæ”¶è´¹</td></tr><tr><td>ä¸ƒç‰›</td><td>å…è´¹</td><td>éœ€è¦åŸŸåå’Œå¤‡æ¡ˆ</td></tr><tr><td>åˆæ‹äº‘</td><td>å…è´¹ æ— éœ€åŸŸå</td><td>æœªæ¥å¯èƒ½ä¼šæ”¶è´¹</td></tr><tr><td>é˜¿é‡Œäº‘</td><td>ç›®å‰æœ€å®Œå¤‡</td><td>æ”¶è´¹ éœ€è¦åŸŸå</td></tr><tr><td>å¾®åš</td><td>å…è´¹ æ— éœ€åŸŸå</td><td>ä¸ç¨³å®š åŒ¿åä¸Šä¼ </td></tr></tbody></table><p>ä½œä¸ºä¸€ä¸ªåˆšèµ·æ­¥çš„å°åšå®¢ï¼Œåº”è¯¥æŠŠç²¾åŠ›æ›´å¤šå…³æ³¨äºå†…å®¹ï¼Œä»¥åå†è€ƒè™‘åŸŸåå¤‡æ¡ˆæˆ–è€…å¤§æµé‡å¥—é¤ï¼Œå› æ­¤å°½é‡é€‰æ‹©å…è´¹çš„å›¾åºŠã€‚ <del>å…¶å®æ˜¯ç©·</del></p><p>å¾®åšä½œä¸ºå›½å†…é¦–å±ˆä¸€æŒ‡çš„æµé‡å¤§æˆ·ï¼Œå…¶å›¾åºŠçš„CDNå’Œè´¨é‡è‚¯å®šæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ä¸Šä¼ å›¾ç‰‡ä¼šè‡ªå¸¦æ°´å°ï¼Œä¸”åŒ¿åä¸Šä¼ æ€»è§‰å¾—ä¸é è°±ã€‚</p><p>å‰©ä¸‹çš„é€‰æ‹©è¿˜æœ‰ä¸¤ä¸ªï¼Œåˆæ‹äº‘è¿›å†›å¯¹è±¡å­˜å‚¨é¢†åŸŸæ¯”è…¾è®¯äº‘æ—©è€Œä¸”æ›´æˆç†Ÿï¼Œä½†æ˜¯å°±è§„æ¨¡å’ŒæŠ€æœ¯æ¥è¯´ï¼Œæˆ‘è¿˜æ˜¯æ›´æ„¿æ„ç›¸ä¿¡è…¾è®¯ã€‚</p><h3 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h3><p>æ³¨å†Œå®Œè…¾è®¯äº‘è´¦å·åï¼Œä¸‹ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ€ä¹ˆæ›´æ–¹ä¾¿çš„å°†å›¾åºŠä¸ MarkDown ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œæé«˜æ•ˆç‡å’Œä½“éªŒã€‚</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://vanch-1258064554.cos.ap-shanghai.myqcloud.com/blog/pic_1544165437_77.jpg" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p><strong>iPic</strong> å®Œç¾ç¬¦åˆæˆ‘çš„éœ€æ±‚ï¼Œè¿™æ˜¯ä¸€æ¬¾ <strong>Mac</strong> ä¸Šçš„çŠ¶æ€æ è½¯ä»¶ï¼Œæ”¯æŒä¸Šä¼ æœ¬åœ°å›¾ç‰‡åˆ°è®¾å®šçš„å›¾åºŠï¼Œè·å–å›¾ç‰‡åœ°å€åæŒ‰ç…§ <code>![](url)</code> æ ¼å¼å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚</p><p><strong><em>é‚£ä¹ˆå¥½çš„åº”ç”¨ä¸ºå•¥ä¸ç”¨å‘¢ï¼Ÿ</em></strong></p><p>å› ä¸ºä¸æƒ³<strong>æŒ‰å¹´äº¤é’±</strong>ã€‚åº”ç”¨é»˜è®¤æ˜¯å¾®åšå›¾åºŠï¼Œå¦‚æœè¦ä½¿ç”¨å…¶ä»–å›¾åºŠå°±éœ€è¦è´­ä¹°ä¸“ä¸šç‰ˆï¼Œæ¯å¹´60å…ƒã€‚å¦‚æœæ˜¯ä¸€æ¬¡ä¹°æ–­çš„è¯ï¼Œä¹Ÿå°±ä¹°äº†ï¼Œå¹´è´¹å¿ƒé‡Œæ€»æœ‰ç–™ç˜© <del>çŸ«æƒ…</del>ã€‚</p><p>çªç„¶ï¼Œæˆ‘å°±æƒ³åˆ°ï¼ è‡ªå·±å¼€å‘ä¸€ä¸ªï¼ <del>é—²çš„è›‹ç–¼</del></p><p>å¼€å‘<code>iPhone</code>åº”ç”¨å·²ç»å¥½å¤šå¹´äº†ï¼Œè¿˜ä»æœªå¼€å‘è¿‡<code>Mac</code>ä¸Šçš„çŠ¶æ€æ è½¯ä»¶ï¼Œæ­£å¥½è¿˜èƒ½é”»ç‚¼ä¸‹<code>Swift</code>ï¼Œäºæ˜¯è¯´å¹²å°±å¹²ã€‚<del>æ²¡æƒ³åˆ°å¼€å‘äº†ä¸€ä¸ªæœˆ</del></p><hr><h2 id="éœ€æ±‚è®¾è®¡"><a href="#éœ€æ±‚è®¾è®¡" class="headerlink" title="éœ€æ±‚è®¾è®¡"></a>éœ€æ±‚è®¾è®¡</h2><p>äº§å“ä½¿ç”¨é€»è¾‘åŸºæœ¬ä¸ <strong>iPic</strong> ä¸€è‡´ï¼ŒåŸºäºçŠ¶æ€æ äº¤äº’ï¼Œé€‰æ‹©<code>png</code> <code>jpg</code>æ–‡ä»¶ä¸Šä¼ ã€‚</p><p>å¯ä»¥è®¾ç½®æ˜¯å¦å‹ç¼©å›¾ç‰‡ï¼Œå‹ç¼©ä¼šå‹åˆ°<code>500K</code>ä»¥ä¸‹ã€‚</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://vanch-1258064554.cos.ap-shanghai.myqcloud.com/blog/pic_1544165455_60.jpg" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>è¿˜éœ€è¦æœ‰ä¸€ä¸ªç™»å½•ç•Œé¢è®°å½•è…¾è®¯äº‘çš„è´¦å·å’Œå­˜å‚¨åº“ä¿¡æ¯ã€‚</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://vanch-1258064554.cos.ap-shanghai.myqcloud.com/blog/pic_1544165470_40.jpg" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>æ–‡ä»¶ä¸Šä¼ æˆåŠŸåï¼Œå¼¹å‡ºé€šçŸ¥æé†’ï¼Œå¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://vanch-1258064554.cos.ap-shanghai.myqcloud.com/blog/pic_1544165482_81.jpg" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>å¦‚æœä¸æ…å¤åˆ¶äº†å…¶ä»–æ–‡æœ¬å¯¼è‡´ä¸¢å¤±äº†é“¾æ¥ï¼Œå†ç‚¹å‡»ä¸€æ¬¡é€šçŸ¥å°±å¯ä»¥é‡æ–°è·å–ã€‚</p><hr><h2 id="é‡åˆ°çš„éš¾é¢˜"><a href="#é‡åˆ°çš„éš¾é¢˜" class="headerlink" title="é‡åˆ°çš„éš¾é¢˜"></a>é‡åˆ°çš„éš¾é¢˜</h2><h3 id="Swift"><a href="#Swift" class="headerlink" title="Swift"></a>Swift</h3><p>ç¬¬ä¸€å…³å°±æ˜¯ç¼–ç¨‹è¯­è¨€ã€‚</p><p>è™½ç„¶ä¹Ÿæ›¾ç³»ç»Ÿçš„å­¦è¿‡<code>Swift</code>ï¼Œä½†ç”±äºå¸¸å¹´ä½¿ç”¨<code>Objective-C</code> å¼€å‘ï¼Œæ€ç»´æ–¹å¼è¿˜è½¬ä¸è¿‡æ¥ã€‚</p><h4 id="ä¸¥æ ¼çš„ç©ºå˜é‡"><a href="#ä¸¥æ ¼çš„ç©ºå˜é‡" class="headerlink" title="ä¸¥æ ¼çš„ç©ºå˜é‡"></a>ä¸¥æ ¼çš„ç©ºå˜é‡</h4><p>æ¯”è¾ƒæ˜æ˜¾çš„åŒºåˆ«å°±æ˜¯å¤„ç†ç©ºå˜é‡çš„æ–¹å¼ã€‚</p><p>åœ¨<code>ObjC</code>ä¸­ï¼ŒæŒ‡é’ˆå˜é‡å¯ä»¥æ˜¯<code>nil</code>ï¼ˆä¹Ÿå°±æ˜¯0ï¼‰ï¼Œå¯¹<code>nil</code>æ‰§è¡Œæ–¹æ³•ä¸ä¼šå‘ç”Ÿä»»ä½•äº‹æƒ…ï¼Œå› æ­¤å¯ä»¥ç®—æ˜¯éƒ¨åˆ†å®‰å…¨ã€‚</p><p><code>Swift</code>å¯¹å¾…ç©ºå˜é‡æ›´ä¸¥æ ¼ï¼Œ<code>!</code>ä¿®é¥°çš„å˜é‡å¿…é¡»æœ‰å…·ä½“å€¼ï¼Œ<code>?</code>ä¿®é¥°çš„å˜é‡æ‰å…·æœ‰ç©ºå€¼çš„å¯èƒ½æ€§ã€‚</p><p><code>nil</code>ä¸å†è¡¨ç¤ºä¸ºç©ºå¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªç©ºå€¼ï¼Œå‘ç©ºå€¼è°ƒç”¨æ–¹æ³•ä¼šå¯¼è‡´é—ªé€€ã€‚å¯¹å¾…<code>?</code>ä¿®é¥°çš„å˜é‡å¿…é¡»è¦å°å¿ƒï¼Œæœ€å¥½å…ˆåˆ¤æ–­æ˜¯å¦æœ‰å€¼å†ä½¿ç”¨ï¼Œå¥½åœ¨æœ‰è¯­æ³•ç³–å¯ä»¥è§£å†³è¿™ç±»é—®é¢˜ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é»˜è®¤ä¸ºnil</span></span><br><span class="line"><span class="keyword">var</span> money : <span class="type">String</span>?</span><br><span class="line"><span class="comment">//å˜é‡æœ‰å€¼</span></span><br><span class="line">money = <span class="string">"million"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­è‚¯å®šæœ‰å€¼åå†ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">if</span> money != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"I have \(money!) dollars."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¿è¯å˜é‡æœ‰å€¼å¹¶èµ‹å€¼ç»™å®‰å…¨å˜é‡åæ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> account = money &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"I have \(account) dollars."</span>) </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å˜é‡å¦‚æœæ²¡æœ‰å€¼å°±æ‰§è¡Œelseäº‹ä»¶å¹¶return</span></span><br><span class="line"><span class="keyword">guard</span> <span class="keyword">let</span> account = money <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"I have no money."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"I have \(account) dollars."</span>)</span><br></pre></td></tr></table></figure><p>åˆç†ä½¿ç”¨<code>! ?</code> ä¼šä½¿æˆ‘ä»¬çš„ä»£ç æ›´å®‰å…¨ä¸ç®€æ´ã€‚</p><blockquote><p>Swift çš„ nil å’Œ Objective-C ä¸­çš„ nil å¹¶ä¸ä¸€æ ·ã€‚åœ¨ Objective-C ä¸­ï¼Œnil æ˜¯ä¸€ä¸ªæŒ‡å‘ä¸å­˜åœ¨å¯¹è±¡çš„æŒ‡é’ˆã€‚åœ¨ Swift ä¸­ï¼Œnil ä¸æ˜¯æŒ‡é’ˆâ€”â€”å®ƒæ˜¯ä¸€ä¸ªç¡®å®šçš„å€¼ï¼Œç”¨æ¥è¡¨ç¤ºå€¼ç¼ºå¤±ã€‚ä»»ä½•ç±»å‹çš„å¯é€‰çŠ¶æ€éƒ½å¯ä»¥è¢«è®¾ç½®ä¸º nilï¼Œä¸åªæ˜¯å¯¹è±¡ç±»å‹ã€‚</p></blockquote><h4 id="æŠ›å‡ºè­¦å‘Š"><a href="#æŠ›å‡ºè­¦å‘Š" class="headerlink" title="æŠ›å‡ºè­¦å‘Š"></a>æŠ›å‡ºè­¦å‘Š</h4><p><code>ObjC</code> æœ‰ <code>@throw</code> çš„ç”¨æ³•ï¼Œä½†æ˜¯æ ¹æ®è‹¹æœå®˜æ–¹çš„æè¿°ï¼Œæ‰§è¡Œçš„æˆæœ¬å¾ˆå¤§ã€‚ç©¶å…¶åŸå› åœ¨äº <code>ObjC</code> åŸºäº <code>C</code> è¯­è¨€è€Œä¸æ˜¯ <code>C++</code>ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨ <code>setjmp()</code>å’Œ<code>longjmp()</code> æ–¹æ³•å®ç°ï¼Œå› æ­¤å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚</p><blockquote><p>Important: Exceptions are resource-intensive in Objective-C. You should not use exceptions for general flow-control, or simply to signify errors (such as a file not being accessible)</p></blockquote><p><code>Swift</code> ä»æ ¹æœ¬è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ç»“åˆæšä¸¾ä¼˜åŒ–äº†æ•´ä¸ªæµç¨‹ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">CompressError</span> : <span class="title">Error</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">NoImage</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">OverSize</span>(size : <span class="type">Int</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">compressImage</span><span class="params">(<span class="number">_</span> imageData: Data?)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Data</span>? &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">var</span> compressData = imageData <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">CompressError</span>.<span class="type">NoImage</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> compressData.<span class="built_in">count</span> &gt; maxSize &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">CompressError</span>.<span class="type">OverSize</span>(size: compressData.<span class="built_in">count</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">uploadImage</span><span class="params">(<span class="number">_</span> imageData: Data?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> compressData : <span class="type">Data</span>? = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        compressData = <span class="keyword">try</span> <span class="keyword">self</span>.compressImage(imageData)</span><br><span class="line">    &#125; <span class="keyword">catch</span> <span class="type">CompressError</span>.<span class="type">NoImage</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Image Not Exist"</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> <span class="type">CompressError</span>.<span class="type">OverSize</span>(<span class="keyword">let</span> size) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Image over size of \(size)"</span>)</span><br><span class="line">    &#125;  <span class="keyword">catch</span> <span class="number">_</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç®€æ´çš„æ–¹å¼ï¼Œå¿½ç•¥å¤„ç†è­¦å‘Š</span></span><br><span class="line">    <span class="keyword">let</span> compressData = <span class="keyword">try</span>? <span class="keyword">self</span>.compressImage(imageData)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨<code>Swift</code>å¼ºå¤§çš„æšä¸¾ç±»å‹ï¼Œå¯ä»¥å®šåˆ¶åŒ–è­¦å‘Šä»è€Œä¼ é€’å‡ºæˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯ï¼Œä½¿å¾—æ•´ä¸ªæµç¨‹æ›´ä¸ºé¡ºç•…ã€‚</p><p>è¯­æ³•è¿˜æ”¯æŒ <code>try?</code>å¿½ç•¥è­¦å‘Šè·å–ä¸€ä¸ªå¯èƒ½ä¸ºç©ºå€¼çš„å˜é‡ï¼Œå¦‚æœè‡ªä¿¡ç»å¯¹ä¸ä¼šæŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œè¿˜èƒ½ä½¿ç”¨<code>try!</code>è·å–ä¸€ä¸ªè‚¯å®šå€¼ã€‚</p><h3 id="Mac-OS-å¼€å‘"><a href="#Mac-OS-å¼€å‘" class="headerlink" title="Mac OS å¼€å‘"></a>Mac OS å¼€å‘</h3><p>å®é™…ç¼–å†™<code>Cocoa</code>ä»£ç è¿‡ç¨‹ä¸­ï¼Œå‘ç°ä¸<code>UIKit</code>ç›¸å·®è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ã€‚</p><h4 id="æ§ä»¶é€»è¾‘"><a href="#æ§ä»¶é€»è¾‘" class="headerlink" title="æ§ä»¶é€»è¾‘"></a>æ§ä»¶é€»è¾‘</h4><p><code>UIKit</code> çš„å±‚çº§ä¸€èˆ¬æ˜¯ <code>UINavigationController -&gt; UIViewController</code></p><p><code>Cocoa</code> çš„å±‚çº§åˆ™ä¸å¤ªä¸€æ ·ï¼Œ<code>NSWindowController -&gt; NSViewController</code></p><p>åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œæ‰‹æœºä¸Šä¸€èˆ¬åªæœ‰ä¸€ä¸ªçª—å£ï¼Œä¾é å¯¼èˆªæ è¿›è¡Œé¡µé¢è·³è½¬ã€‚ä½†æ˜¯æ¡Œé¢ç«¯é€»è¾‘å°±ä¸å¤ªä¸€æ ·ï¼Œæ–°é¡µé¢ä¸€èˆ¬éƒ½æ˜¯ä»¥æ–°çª—å£çš„å½¢å¼å¼¹å‡ºã€‚</p><p>å…¶æ¬¡æ¡Œé¢ç«¯æ‹¥æœ‰ç‰¹å®šçš„çŠ¶æ€æ æ§ä»¶<code>NSMenu</code>ï¼Œåœ¨å…¶ä¸­æ“ä½œèœå•é¡¹ä¹Ÿæ˜¯ä¸€ä¸ªæ–°çš„æŒ‘æˆ˜ã€‚</p><h4 id="è…¾è®¯äº‘ç›¸å…³"><a href="#è…¾è®¯äº‘ç›¸å…³" class="headerlink" title="è…¾è®¯äº‘ç›¸å…³"></a>è…¾è®¯äº‘ç›¸å…³</h4><p>ç”±äºè…¾è®¯äº‘åªæä¾›äº†<code>iOS</code>çš„åº“ï¼Œæ‰€ä»¥æˆ‘è¿˜éœ€è¦å…ˆæŠŠåº“æ–‡ä»¶é‡æ–°è°ƒæ•´ä¸º<code>Cocoa</code>ä»£ç ã€‚<br>è¿™ä¸€éƒ¨åˆ†ä¹Ÿæ˜¯åƒäº†ä¸å°‘è‹¦å¤´ï¼Œéœ€è¦æŠŠè®¾å¤‡ç›¸å…³çš„ä»£ç ä¸åº”ç”¨ã€è¿›å‡ºåå°çš„é€šçŸ¥ç­‰éƒ½å»é™¤ï¼Œè¿˜è¦å¤„ç†ç±»ä¼¼åŠŸèƒ½çš„è½¬æ¢ï¼ˆæ¯”å¦‚<code>UIImage -&gt; NSImage</code>ï¼‰ã€‚</p><p>åŒæ—¶è¿˜æœ‰ç¬¬äºŒä¸ªå‘ï¼Œè…¾è®¯äº‘çš„åº“éƒ½æ˜¯<code>ObjC</code>ä»£ç ï¼Œæ‰€ä»¥éœ€è¦æ··ç¼–ã€‚</p><p>åˆ›å»ºä¸€ä¸ªå·¥ä½œç©ºé—´åæ‹–å…¥ä¸¤ä¸ªå·¥ç¨‹ï¼Œåœ¨ä¸»å·¥ç¨‹çš„ <code>Targets / Build Phases / Embed Frameworks</code> ä¸­åŠ å…¥SDKåº“ã€‚</p><p>æ¥ç€åœ¨<code>Swift</code>å·¥ç¨‹ä¸­åˆ›å»º<code>Project-Bridging-Header.h</code> å¤´æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­å¼•ç”¨SDKåº“ã€‚</p><p>æœ€ååœ¨ <code>Targets / Build Settings / Objective-C Bridging Header</code> è®¾ç½®å¤´æ–‡ä»¶ï¼Œå°±å¯ä»¥è§£å†³ä»£ç æ··ç¼–çš„é—®é¢˜ã€‚</p><p>å…¶åŸç†åœ¨äºè‡ªåŠ¨åˆ›å»ºäº†åŸºäºå¤´æ–‡ä»¶çš„<code>pch</code>ï¼ŒæŠŠå¤´æ–‡ä»¶ä¸­å¼•ç”¨åˆ°çš„<code>ObjC</code>ä»£ç ï¼Œéƒ½æ¡¥æ¥åˆ°å·¥ç¨‹ä¸­ã€‚</p><h3 id="å›¾ç‰‡å‹ç¼©ç®—æ³•"><a href="#å›¾ç‰‡å‹ç¼©ç®—æ³•" class="headerlink" title="å›¾ç‰‡å‹ç¼©ç®—æ³•"></a>å›¾ç‰‡å‹ç¼©ç®—æ³•</h3><p>ä¹‹æ‰€ä»¥ä¸ä½¿ç”¨ç°æˆçš„è½¯ä»¶è¿˜æœ‰ä¸€ä¸ªåŸå› ï¼Œå°±æ˜¯æˆ‘æƒ³è‡ªå·±æ§åˆ¶å‹ç¼©å›¾ç‰‡çš„å‚æ•°å’Œæ•ˆæœã€‚</p><p>é€šè¿‡è°ƒç ”å’Œå®éªŒå›¾ç‰‡å‹ç¼©æ•ˆæœï¼Œæœ€ç»ˆæˆ‘é€‰æ‹©å‹åˆ¶æˆ<code>jpg</code>æ ¼å¼ï¼Œ<code>500k</code>å¤§å°é™åˆ¶ï¼Œå‹ç¼©ç‡é™åˆ¶ä¸ºæœ€å°<code>0.75</code>ï¼Œç­‰æ¯”å®½åº¦é™åˆ¶ä¸º<code>1280px</code>ã€‚</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://vanch-1258064554.cos.ap-shanghai.myqcloud.com/blog/pic_1544165504_98.jpg" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>æ–‡é¦–é‚£å¼ ç¾å¥³å›¾ï¼Œåˆå§‹æ˜¯<code>1.9M 5087x3661</code>ï¼Œç”±äºå°ºå¯¸è¿‡å¤§ï¼Œç¬¬ä¸€æ¬¡å‹ç¼©å›¾ç‰‡è´¨é‡åï¼Œå®¹é‡åè€Œå¢åŠ åˆ°äº†<code>2.4M</code>ã€‚</p><p>å°†å®½é«˜ç­‰æ¯”ç¼©å°åˆ°<code>1280x922</code>ï¼Œå›¾ç‰‡åˆå˜å¤§äº†ï¼Œè¿™æ¬¡å¢åŠ åˆ°äº†<code>4.7M</code>ã€‚ï¼ˆæ”¹å˜å®½é«˜éœ€è¦æ–°å»ºä¸€å¼ ç”»å¸ƒï¼Œåˆ›å»ºæ—¶å¿…é¡»è¦æœ‰alphaé€šé“ç­‰å…¶ä»–è®¾ç½®ï¼Œæ‰€ä»¥ä¼šå˜å¤§ï¼‰</p><p>æˆ‘ä»¬æ¥ç€å‹ç¼©ï¼Œæœ€ç»ˆåœ¨å‹ç¼©ç‡ä¸º<code>0.9</code>çš„æƒ…å†µä¸‹æŠŠå›¾ç‰‡å‹åˆ°äº†<code>260K</code>ï¼ŒæˆåŠŸè¾¾åˆ°äº†ç›®æ ‡ã€‚</p><hr><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è·ç¦»ä¸Šä¸€æ¬¡åšå®¢å·²ç»æœ‰ä¸¤ä¸ªæœˆçš„é—´éš”ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†åŸå› åœ¨äºç”Ÿæ´»ä¸Šçš„ä¸€äº›å˜æ•…ï¼Œå¦ä¸€ä¸ªåŸå› å°±åœ¨äºä¸ç†Ÿæ‚‰ <code>Cocoa + Swift</code> å¼€å‘ã€‚</p><p>å¥½åœ¨æœ€ç»ˆè¿˜æ˜¯å•ƒå‡ºæ¥äº†ï¼Œ<a href="https://github.com/VanchChen/Image2Url" target="_blank" rel="noopener">Githubé¡¹ç›®</a>å·²å¼€æºï¼Œæ¬¢è¿å¤§å®¶æŒ‡ç‚¹ä¸åæ§½ã€‚</p><p>è¿™æ¬¡é¡¹ç›®æœ€å¤§çš„æ”¶è·åœ¨äºè„±ç¦»è‡ªå·±çš„èˆ’é€‚åŒºã€‚äººçš„æœ¬æ€§åŒ…å«æƒ°æ€§ï¼Œæ€»æ˜¯è¶‹å‘äºåœ¨ç†Ÿæ‚‰çš„é¢†åŸŸå¹²ç†Ÿæ‚‰çš„æ´»ã€‚ä½†æ˜¯å°±å’Œä¼ä¸šä¸€æ ·ï¼Œä¸åˆ›æ–°å°±æ­»ï¼ŒæŠ€æœ¯ä¸æ–­åœ¨å‘å±•ï¼Œå¦‚æœæ²¡æœ‰è·Ÿä¸Šæ½®æµï¼Œæœ€ç»ˆå°±ä¼šè¢«æ·˜æ±°ã€‚ä»¥æ­¤å…±å‹‰ï¼</p><hr><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="http://www.swift51.com/swift4.0/" target="_blank" rel="noopener">Swift 4.0 æ•™ç¨‹</a></p><p><a href="https://www.jianshu.com/p/9b47fc25f526" target="_blank" rel="noopener">Appå›¾ç‰‡å‹ç¼©è£å‰ªåŸç†å’Œä¸Šä¼ æ–¹æ¡ˆ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;figure class=&quot;image-bubble&quot;&gt;
                &lt;div class=&quot;img-lightbox&quot;&gt;

      
    
    </summary>
    
      <category term="iOS" scheme="https://vanchchen.github.io/categories/iOS/"/>
    
    
      <category term="æ•ˆç‡å·¥å…·" scheme="https://vanchchen.github.io/tags/%E6%95%88%E7%8E%87%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>åˆ¨æ ¹é—®åº•KVOåŸç†</title>
    <link href="https://vanchchen.github.io/p/52b3.html"/>
    <id>https://vanchchen.github.io/p/52b3.html</id>
    <published>2018-10-15T09:31:00.000Z</published>
    <updated>2018-10-16T01:15:41.979Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>KVO( <code>NSKeyValueObserving</code> )æ˜¯ä¸€ç§ç›‘æµ‹å¯¹è±¡å±æ€§å€¼å˜åŒ–çš„è§‚å¯Ÿè€…æ¨¡å¼æœºåˆ¶ã€‚å…¶ç‰¹ç‚¹æ˜¯æ— éœ€äº‹å…ˆä¿®æ”¹è¢«è§‚å¯Ÿè€…ä»£ç ï¼Œåˆ©ç”¨ <code>runtime</code> å®ç°è¿è¡Œä¸­ä¿®æ”¹æŸä¸€å®ä¾‹è¾¾åˆ°ç›®çš„ï¼Œä¿è¯äº†æœªä¾µå…¥æ€§ã€‚</p><p>Aå¯¹è±¡æŒ‡å®šè§‚å¯ŸBå¯¹è±¡çš„å±æ€§åï¼Œå½“å±æ€§å‘ç”Ÿå˜æ›´ï¼ŒAå¯¹è±¡ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œè·å–å˜æ›´å‰ä»¥åŠå˜æ›´çš„çŠ¶æ€ï¼Œä»è€Œåšè¿›ä¸€æ­¥å¤„ç†ã€‚</p><p>åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¤šç”¨äºåº”ç”¨å±‚è§‚å¯Ÿæ¨¡å‹å±‚æ•°æ®å˜åŠ¨ï¼Œæ¥æ”¶åˆ°é€šçŸ¥åæ›´æ–°ï¼Œä»è€Œè¾¾æˆæ¯”è¾ƒå¥½çš„è®¾è®¡æ¨¡å¼ã€‚</p><p>å¦ä¸€ç§å¸¸ç”¨çš„ç”¨æ³•æ˜¯ <code>Debug</code>ï¼Œé€šè¿‡è§‚å¯Ÿé—®é¢˜å±æ€§çš„å˜åŒ–ï¼Œè¿½è¸ªé—®é¢˜å‡ºç°çš„å †æ ˆï¼Œæ›´æœ‰æ•ˆç‡çš„è§£å†³é—®é¢˜ã€‚</p><hr><h2 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h2><h3 id="è§‚å¯Ÿå›è°ƒ"><a href="#è§‚å¯Ÿå›è°ƒ" class="headerlink" title="è§‚å¯Ÿå›è°ƒ"></a>è§‚å¯Ÿå›è°ƒ</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)keyPath </span><br><span class="line">                      ofObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object </span><br><span class="line">                        change:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>, <span class="keyword">id</span>&gt; *)change </span><br><span class="line">                       context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br></pre></td></tr></table></figure><p>è§‚å¯Ÿè€…éœ€è¦å®ç°è¿™ä¸ªæ–¹æ³•æ¥æ¥å—å›è°ƒï¼Œå…¶ä¸­<code>keyPath</code> æ˜¯ <code>KVC</code> è·¯å¾„ï¼Œ <code>object</code> æ˜¯è§‚å¯Ÿè€…ï¼Œ<code>context</code> åŒºåˆ†ä¸åŒè§‚å¯Ÿçš„æ ‡è¯†ã€‚</p><h4 id="æ”¹å˜å­—å…¸"><a href="#æ”¹å˜å­—å…¸" class="headerlink" title="æ”¹å˜å­—å…¸"></a>æ”¹å˜å­—å…¸</h4><p>æœ€å…³é”®çš„æ˜¯æ”¹å˜å­—å…¸ï¼Œå…¶ä¸­åŒ…å«äº† <code>NSKeyValueChangeKey</code>ï¼Œé€šè¿‡é¢„å®šä¹‰çš„å­—ç¬¦ä¸²æ¥è·å–ç‰¹å®šçš„æ•°å€¼ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSString</span> * <span class="built_in">NSKeyValueChangeKey</span> <span class="built_in">NS_STRING_ENUM</span>;</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSKeyValueChangeKey</span> <span class="keyword">const</span> <span class="built_in">NSKeyValueChangeKindKey</span>;</span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSKeyValueChangeKey</span> <span class="keyword">const</span> <span class="built_in">NSKeyValueChangeNewKey</span>;</span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSKeyValueChangeKey</span> <span class="keyword">const</span> <span class="built_in">NSKeyValueChangeOldKey</span>;</span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSKeyValueChangeKey</span> <span class="keyword">const</span> <span class="built_in">NSKeyValueChangeIndexesKey</span>;</span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSKeyValueChangeKey</span> <span class="keyword">const</span> <span class="built_in">NSKeyValueChangeNotificationIsPriorKey</span></span><br></pre></td></tr></table></figure><p><code>NSKeyValueChangeKindKey</code> ä¸­å®šä¹‰çš„æ˜¯æ”¹å˜çš„ç±»å‹ï¼Œå¦‚æœè°ƒç”¨çš„æ˜¯<code>Setter</code>æ–¹æ³•ï¼Œé‚£å°±æ˜¯<code>NSKeyValueChangeSetting</code>ã€‚</p><p>å‰©ä½™çš„ä¸‰ç§åˆ†åˆ«æ˜¯æ’å…¥ã€åˆ é™¤ã€æ›¿æ¢ï¼Œå½“è§‚å¯Ÿçš„å±æ€§å±äºé›†åˆç±»ï¼ˆè¿™ç‚¹ä¼šåœ¨ä¹‹åè®²ï¼‰ï¼Œå˜åŠ¨æ—¶å°±ä¼šé€šçŸ¥è¿™äº›ç±»å‹ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>, <span class="built_in">NSKeyValueChange</span>) &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueChangeSetting</span> = <span class="number">1</span>,</span><br><span class="line">    <span class="built_in">NSKeyValueChangeInsertion</span> = <span class="number">2</span>,</span><br><span class="line">    <span class="built_in">NSKeyValueChangeRemoval</span> = <span class="number">3</span>,</span><br><span class="line">    <span class="built_in">NSKeyValueChangeReplacement</span> = <span class="number">4</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>NSKeyValueChangeNewKey</code> è·å–å˜æ›´çš„æœ€æ–°å€¼ï¼Œ<code>NSKeyValueChangeOldKey</code> è·å–åŸå§‹æ•°å€¼ã€‚</p><p><code>NSKeyValueChangeIndexesKey</code> å¦‚æœè§‚å¯Ÿçš„æ˜¯é›†åˆï¼Œé‚£è¿™ä¸ªé”®å€¼è¿”å›ç´¢å¼•é›†åˆã€‚</p><p><code>NSKeyValueChangeNotificationIsPriorKey</code> å¦‚æœè®¾ç½®äº†æ¥å—æå‰é€šçŸ¥ï¼Œé‚£ä¹ˆä¿®æ”¹ä¹‹å‰ä¼šå…ˆå‘é€é€šçŸ¥ï¼Œä¿®æ”¹åå†å‘ä¸€æ¬¡ã€‚ä¸ºäº†åŒºåˆ†è¿™ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡ä¼šå¸¦ä¸Šè¿™ä¸ªé”®å€¼å¯¹ï¼Œå…¶å†…å®¹ä¸º <code>@1</code>ã€‚</p><h4 id="å­—ç¬¦ä¸²æšä¸¾"><a href="#å­—ç¬¦ä¸²æšä¸¾" class="headerlink" title="å­—ç¬¦ä¸²æšä¸¾"></a>å­—ç¬¦ä¸²æšä¸¾</h4><p>åœ¨æ³¨å†Œç±»å‹æ—¶ï¼Œè‹¹æœä½¿ç”¨äº†<code>NS_STRING_ENUM</code>å®ã€‚</p><p>è™½ç„¶è¿™ä¸ªå®åœ¨<code>ObjC</code>ä¸‹æ¯«æ— ä½œç”¨ï¼Œä½†æ˜¯å¯¹äº<code>Swift</code>æœ‰ä¼˜åŒ–<br>ï¼Œä¸Šé¢çš„å®šä¹‰ä¼šå˜æˆè¿™æ ·ã€‚<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">NSKeyValueChangeKey</span>: <span class="title">String</span> </span>&#123; </span><br><span class="line">    <span class="keyword">case</span> kind</span><br><span class="line">    <span class="keyword">case</span> new</span><br><span class="line">    <span class="keyword">case</span> old</span><br><span class="line">    <span class="keyword">case</span> indexes </span><br><span class="line">    <span class="keyword">case</span> notificationIsPrior</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> dict: [<span class="type">NSKeyValueChangeKey</span> : <span class="type">Any</span>] = [......]</span><br><span class="line"><span class="keyword">let</span> kind = dict[.kind] <span class="keyword">as</span>! <span class="type">Number</span></span><br></pre></td></tr></table></figure></p><p>å­—ç¬¦ä¸²æšä¸¾å¯¹äºä½¿ç”¨æ¥è¯´æ˜¯éå¸¸ç›´è§‚å’Œå®‰å…¨çš„ã€‚</p><h3 id="æ·»åŠ ä¸åˆ é™¤"><a href="#æ·»åŠ ä¸åˆ é™¤" class="headerlink" title="æ·»åŠ ä¸åˆ é™¤"></a>æ·»åŠ ä¸åˆ é™¤</h3><p>å¯¹äºæ™®é€šå¯¹è±¡ï¼Œä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•å°±èƒ½æ³¨å†Œä¸æ³¨é”€è§‚å¯Ÿã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addObserver:(<span class="built_in">NSObject</span> *)observer </span><br><span class="line">         forKeyPath:(<span class="built_in">NSString</span> *)keyPath </span><br><span class="line">            options:(<span class="built_in">NSKeyValueObservingOptions</span>)options </span><br><span class="line">            context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer </span><br><span class="line">            forKeyPath:(<span class="built_in">NSString</span> *)keyPath </span><br><span class="line">               context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥è®¾ç½®å¤šç§è§‚å¯Ÿæ¨¡å¼æ¥åŒ¹é…éœ€æ±‚ã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, <span class="built_in">NSKeyValueObservingOptions</span>) &#123;</span><br><span class="line">    <span class="comment">//å¯ä»¥æ”¶åˆ°æ–°æ”¹å˜çš„æ•°å€¼</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservingOptionNew</span> = <span class="number">0x01</span>,</span><br><span class="line">    <span class="comment">//å¯ä»¥æ”¶åˆ°æ”¹å˜å‰çš„æ•°å€¼</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservingOptionOld</span> = <span class="number">0x02</span>,</span><br><span class="line">    <span class="comment">//addObserveråç«‹åˆ»è§¦å‘é€šçŸ¥ï¼Œåªæœ‰newï¼Œæ²¡æœ‰old</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservingOptionInitial</span> = <span class="number">0x04</span>,</span><br><span class="line">    <span class="comment">//ä¼šåœ¨æ”¹å˜å‰ä¸æ”¹å˜åå‘é€ä¸¤æ¬¡é€šçŸ¥</span></span><br><span class="line">    <span class="comment">//æ”¹å˜å‰çš„é€šçŸ¥å¸¦æœ‰notificationIsPrior=@1ï¼Œold</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservingOptionPrior</span> = <span class="number">0x08</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>ç”±äºä¸ç¬¦åˆ <code>KVC</code> çš„è®¿é—®å™¨æ ‡å‡†ï¼Œè‹¹æœè§„å®š <code>NSArray NSOrderedSet NSSet</code> ä¸å¯ä»¥æ‰§è¡Œ <code>addObserver</code> æ–¹æ³•ï¼Œä¸ç„¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚é’ˆå¯¹ <code>NSArray</code> æœ‰ç‰¹æ®Šçš„æ–¹æ³•ï¼Œå¦‚ä¸‹<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addObserver:(<span class="built_in">NSObject</span> *)observer </span><br><span class="line"> toObjectsAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes </span><br><span class="line">         forKeyPath:(<span class="built_in">NSString</span> *)keyPath </span><br><span class="line">            options:(<span class="built_in">NSKeyValueObservingOptions</span>)options </span><br><span class="line">            context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer </span><br><span class="line">  fromObjectsAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes </span><br><span class="line">            forKeyPath:(<span class="built_in">NSString</span> *)keyPath </span><br><span class="line">               context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br></pre></td></tr></table></figure></p><p>ä¸»è¦çš„åŒºåˆ«åœ¨äºå¤šäº†ä¸€ä¸ª<code>ObjectsAtIndexes</code>ï¼Œå…¶å®åšçš„äº‹æƒ…æ˜¯ä¸€æ ·çš„ï¼Œæ ¹æ®ç´¢å¼•æ‰¾åˆ°å¯¹è±¡ï¼Œå†é€ä¸€å»ºç«‹è§‚å¯Ÿå…³ç³»ã€‚</p><hr><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><h3 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h3><p><code>NSKeyValueObserving</code>  ä¸ <code>NSKeyValueCoding</code>  ä¸€èµ·å®šä¹‰åœ¨ <code>Foundation</code>  åº“ï¼Œè€Œè¿™ä¸ªåº“æ˜¯ä¸å¼€æºçš„ï¼Œæˆ‘ä»¬å…ˆä»è‹¹æœå¼€å‘è€…æ–‡æ¡£ä¸­è·å–ä¿¡æ¯ã€‚</p><blockquote><p>Automatic key-value observing is implemented using a technique called isa-swizzling.</p></blockquote><p>çœ‹æè¿°çŒœæµ‹è‹¹æœåº”è¯¥æ˜¯é€šè¿‡é‡æ–°è®¾ç½®è¢«è§‚å¯Ÿè€…çš„ <code>Class</code> (<code>isa</code> ä¸­åŒ…å« <code>Class</code> ä¿¡æ¯)ï¼Œè¯¥ç±»ç»§æ‰¿äº†åŸç±»å¹¶ä¸”é‡è½½å±æ€§çš„ <code>Setter</code> æ–¹æ³•ï¼Œæ·»åŠ å‘é€šçŸ¥çš„æ“ä½œè¾¾åˆ°ç›®çš„ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ConcreteSubject</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> obj;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">ConcreteSubject *sub = [ConcreteSubject new];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, class_getName(object_getClass(sub)));</span><br><span class="line"><span class="comment">//æ”¹å˜å‰ outprint--&gt; ConcreteSubject</span></span><br><span class="line"></span><br><span class="line">[sub addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"obj"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:<span class="literal">nil</span>];</span><br><span class="line"><span class="comment">//æ‰§è¡Œè§‚å¯Ÿæ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, class_getName(object_getClass(sub)));</span><br><span class="line"><span class="comment">//æ”¹å˜å outprint--&gt; NSKVONotifying_ConcreteSubject</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, class_getName(object_getClass(class_getSuperclass(cls))));</span><br><span class="line"><span class="comment">//è·å–è¶…ç±»å outprint--&gt; ConcreteSubject</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, class_getName(sub.class));</span><br><span class="line"><span class="comment">//è·å–ç±»å outprint--&gt; ConcreteSubject</span></span><br><span class="line"></span><br><span class="line">class_getMethodImplementation(cls, <span class="keyword">@selector</span>(setObj:));</span><br><span class="line"><span class="comment">//imp = (IMP)(Foundation`_NSSetObjectValueAndNotify)</span></span><br><span class="line"></span><br><span class="line">class_getMethodImplementation(cls, <span class="keyword">@selector</span>(<span class="keyword">class</span>));</span><br><span class="line"><span class="comment">//imp = (IMP)(Foundation`NSKVOClass)</span></span><br></pre></td></tr></table></figure><p>è¯•äº†ä¸€ä¸‹æœç„¶ <code>Class</code> è¢«æ›¿æ¢äº†ï¼Œå˜æˆåŠ äº† <code>NSKVONotifying_</code> å‰ç¼€çš„æ–°ç±»ã€‚</p><p>æ–°ç±»ç»§æ‰¿è‡ªåŸç±»ï¼Œä½†æ˜¯è¿™ä¸ªç±»çš„ <code>class</code> æ–¹æ³•è¿”å›çš„è¿˜æ˜¯åŸç±»ï¼Œè¿™ä¿è¯äº†å¤–éƒ¨é€»è¾‘å®Œæ•´ã€‚</p><h3 id="åç¼–è¯‘æºç "><a href="#åç¼–è¯‘æºç " class="headerlink" title="åç¼–è¯‘æºç "></a>åç¼–è¯‘æºç </h3><p>é€šè¿‡ <code>Runtime</code> ï¼Œæˆ‘ä»¬åªèƒ½çŸ¥é“ <code>KVO</code> ä½¿ç”¨äº†ä¸€ä¸ªç»§æ‰¿äº†åŸç±»çš„ç±»ï¼Œå¹¶ä¸”æ›¿æ¢äº†åŸæ–¹æ³•çš„å®ç°ï¼Œ<code>setObj: = _NSSetObjectValueAndNotify</code> <code>class = _NSKVOClass</code>ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¿›ä¸€æ­¥äº†è§£è¯¦æƒ…ï¼Œåªèƒ½é€šè¿‡åç¼–è¯‘ <code>Foundation</code> æ¥æŸ¥æ‰¾æ±‡ç¼–ä»£ç ã€‚</p><blockquote><p>è¿™é‡Œæˆ‘ä½¿ç”¨äº† <code>Hopper</code> å·¥å…·ï¼Œåˆ†æçš„äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„æ˜¯/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/Library/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/Frameworks/Foundation.framework/Foundation</p></blockquote><h3 id="æ›¿æ¢çš„å®ç°"><a href="#æ›¿æ¢çš„å®ç°" class="headerlink" title="æ›¿æ¢çš„å®ç°"></a>æ›¿æ¢çš„å®ç°</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ªä»£ç ï¼Œä»…ä¾›ç†è§£</span></span><br><span class="line"><span class="keyword">void</span> _NSKVOClass(<span class="keyword">id</span> <span class="keyword">self</span>,  SEL _cmd) &#123;</span><br><span class="line">    Class cls = object_getClass(<span class="keyword">self</span>);</span><br><span class="line">    Class originCls = __NSKVONotifyingOriginalClassForIsa(cls);</span><br><span class="line">    <span class="keyword">if</span> (cls != originCls) &#123;</span><br><span class="line">        <span class="keyword">return</span> [originCls <span class="keyword">class</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Method method = class_getInstanceMethod(cls, _cmd);</span><br><span class="line">        <span class="keyword">return</span> method_invoke(<span class="keyword">self</span>, method);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹åŸ <code>class</code> æ–¹æ³•ï¼Œè·å–äº†å½“å‰ç±»å’ŒåŸç±»ï¼Œå¦‚æœä¸ä¸€è‡´å°±è¿”å›åŸç±»ï¼Œå¦‚æœä¸€è‡´å°±æ‰§è¡ŒåŸ <code>class</code> å®ç°ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ªä»£ç ï¼Œä»…ä¾›ç†è§£</span></span><br><span class="line"><span class="keyword">void</span> __NSSetObjectValueAndNotify(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="comment">//è·å–é¢å¤–çš„å˜é‡</span></span><br><span class="line">    <span class="keyword">void</span> *indexedIvars = object_getIndexedIvars(object_getClass(<span class="keyword">self</span>));</span><br><span class="line">    <span class="comment">//åŠ é”</span></span><br><span class="line">    pthread_mutex_lock(indexedIvars + <span class="number">0x20</span>);</span><br><span class="line">    <span class="comment">//ä»SELè·å–KeyPath</span></span><br><span class="line">    <span class="built_in">NSString</span> *keyPath = [<span class="built_in">CFDictionaryGetValue</span>(*(indexedIvars) + <span class="number">0x18</span>), _cmd) copyWithZone:<span class="number">0x0</span>];</span><br><span class="line">    <span class="comment">//è§£é”</span></span><br><span class="line">    pthread_mutex_unlock(indexedIvars + <span class="number">0x20</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ”¹å˜å‰å‘é€šçŸ¥</span></span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:keyPath];</span><br><span class="line">    <span class="comment">//å®ç°Setteræ–¹æ³•</span></span><br><span class="line">    IMP imp = class_getMethodImplementation(*indexedIvars, _cmd);</span><br><span class="line">    (imp)(<span class="keyword">self</span>, _cmd, value);</span><br><span class="line">    <span class="comment">//æ”¹å˜åå‘é€šçŸ¥</span></span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:keyPath];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹æ”¹å˜åçš„ <code>Setter</code> æ–¹æ³•ï¼Œå…¶ä¸­ <code>indexedIvars</code> æ˜¯åŸç±»ä¹‹å¤–çš„æˆå‘˜å˜é‡ï¼Œç¬¬ä¸€ä¸ªæŒ‡é’ˆæ˜¯æ”¹å˜åçš„ç±»ï¼Œ<code>0x20</code> çš„åç§»é‡æ˜¯çº¿ç¨‹é”ï¼Œ<code>0x18</code> åœ°å€å‚¨å­˜äº†æ”¹å˜è¿‡çš„æ–¹æ³•å­—å…¸ã€‚</p><p>åœ¨æ‰§è¡ŒåŸæ–¹æ³•å®ç°å‰è°ƒç”¨äº† <code>willChangeValueForKey</code> å‘èµ·é€šçŸ¥ï¼ŒåŒæ ·åœ¨ä¹‹åè°ƒç”¨ <code>didChangeValueForKey</code>ã€‚</p><h3 id="æ·»åŠ è§‚å¯Ÿæ–¹æ³•"><a href="#æ·»åŠ è§‚å¯Ÿæ–¹æ³•" class="headerlink" title="æ·»åŠ è§‚å¯Ÿæ–¹æ³•"></a>æ·»åŠ è§‚å¯Ÿæ–¹æ³•</h3><p>é‚£ä¹ˆæ˜¯åœ¨å“ªä¸ªæ–¹æ³•ä¸­æ›¿æ¢çš„å®ç°å‘¢ï¼Ÿå…ˆçœ‹ <code>[NSObject addObserver:forKeyPath:options:context:]</code> æ–¹æ³•ã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ªä»£ç ï¼Œä»…ä¾›ç†è§£</span></span><br><span class="line"><span class="keyword">void</span> -[<span class="built_in">NSObject</span> addObserver:forKeyPath:options:context:]</span><br><span class="line">(<span class="keyword">void</span> * <span class="keyword">self</span>, <span class="keyword">void</span> * _cmd, <span class="keyword">void</span> * arg2, <span class="keyword">void</span> * arg3, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> arg4, <span class="keyword">void</span> * arg5) &#123;</span><br><span class="line">    pthread_mutex_lock(__NSKeyValueObserverRegistrationLock);</span><br><span class="line">    *__NSKeyValueObserverRegistrationLockOwner = pthread_self();</span><br><span class="line">    rax = object_getClass(<span class="keyword">self</span>);</span><br><span class="line">    rax = _NSKeyValuePropertyForIsaAndKeyPath(rax, arg3);</span><br><span class="line">    [<span class="keyword">self</span> _addObserver:arg2 forProperty:rax options:arg4 context:arg5];</span><br><span class="line">    *__NSKeyValueObserverRegistrationLockOwner = <span class="number">0x0</span>;</span><br><span class="line">    pthread_mutex_unlock(__NSKeyValueObserverRegistrationLock);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ–¹æ³•å¾ˆç®€å•ï¼Œæ ¹æ® <code>KeyPath</code> è·å–å…·ä½“å±æ€§åè¿›ä¸€æ­¥è°ƒç”¨æ–¹æ³•ã€‚ç”±äºè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œæˆ‘ç‰¹åœ°æ•´ç†æˆ <code>ObjC</code> ä»£ç ï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ªä»£ç ï¼Œä»…ä¾›ç†è§£</span></span><br><span class="line">- (<span class="keyword">void</span> *)_addObserver:(<span class="keyword">id</span>)observer </span><br><span class="line">           forProperty:(<span class="built_in">NSKeyValueProperty</span> *)property </span><br><span class="line">               options:(<span class="built_in">NSKeyValueObservingOptions</span>)option </span><br><span class="line">               context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="comment">//éœ€è¦æ³¨å†Œé€šçŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> (option &amp; <span class="built_in">NSKeyValueObservingOptionInitial</span>) &#123;</span><br><span class="line">        <span class="comment">//è·å–å±æ€§åè·¯å¾„</span></span><br><span class="line">        <span class="built_in">NSString</span> *keyPath = [property keyPath];</span><br><span class="line">        <span class="comment">//è§£é”</span></span><br><span class="line">        pthread_mutex_unlock(__NSKeyValueObserverRegistrationLock);</span><br><span class="line">        <span class="comment">//å¦‚æœæ³¨å†Œäº†è·å¾—æ–°å€¼ï¼Œå°±è·å–æ•°å€¼</span></span><br><span class="line">        <span class="keyword">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span> (option &amp; <span class="built_in">NSKeyValueObservingOptionNew</span>) &#123;</span><br><span class="line">            value = [<span class="keyword">self</span> valueForKeyPath:keyPath];</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="literal">nil</span>) &#123;</span><br><span class="line">                value = [<span class="built_in">NSNull</span> null];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å‘é€æ³¨å†Œé€šçŸ¥</span></span><br><span class="line">        _NSKeyValueNotifyObserver(observer, keyPath, <span class="keyword">self</span>, context, value, </span><br><span class="line">        <span class="number">0</span> <span class="comment">/*originalObservable*/</span>, <span class="number">1</span> <span class="comment">/*NSKeyValueChangeSetting*/</span>);</span><br><span class="line">        <span class="comment">//åŠ é”</span></span><br><span class="line">        pthread_mutex_lock(__NSKeyValueObserverRegistrationLock);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//è·å–å±æ€§çš„è§‚å¯Ÿä¿¡æ¯</span></span><br><span class="line">    Info *info = __NSKeyValueRetainedObservationInfoForObject(<span class="keyword">self</span>, property-&gt;_containerClass);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦è·å–æ–°çš„æ•°å€¼</span></span><br><span class="line">    <span class="keyword">id</span> _additionOriginalObservable = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (option &amp; <span class="built_in">NSKeyValueObservingOptionNew</span>) &#123;</span><br><span class="line">        <span class="comment">//0x15æ²¡æœ‰æ‰¾åˆ°å®šä¹‰ï¼ŒçŒœæµ‹ä¸ºä¿å­˜æ˜¯å¦å¯è§‚å¯Ÿçš„æ•°ç»„</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">id</span> tsd = _CFGetTSD(<span class="number">0x15</span>);</span><br><span class="line">        <span class="keyword">if</span> (tsd != <span class="literal">nil</span>) &#123;</span><br><span class="line">            _additionOriginalObservable = *(tsd + <span class="number">0x10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åœ¨åŸæœ‰ä¿¡æ¯ä¸Šç”Ÿæˆæ–°çš„ä¿¡æ¯</span></span><br><span class="line">    Info *newInfo = __NSKeyValueObservationInfoCreateByAdding</span><br><span class="line">    (info, observer, property, option, context, _additionOriginalObservable, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//æ›¿æ¢å±æ€§çš„è§‚å¯Ÿä¿¡æ¯</span></span><br><span class="line">    __NSKeyValueReplaceObservationInfoForObject(<span class="keyword">self</span>, property-&gt;_containerClass, info, newInfo);</span><br><span class="line">    <span class="comment">//å±æ€§æ·»åŠ åé€’å½’æ·»åŠ å…³è”å±æ€§</span></span><br><span class="line">    [property object:<span class="keyword">self</span> didAddObservance:newInfo recurse:<span class="literal">true</span>];</span><br><span class="line">    <span class="comment">//è·å–æ–°çš„isa</span></span><br><span class="line">    Class cls = [property isaForAutonotifying];</span><br><span class="line">    <span class="keyword">if</span> ((cls != <span class="literal">NULL</span>) &amp;&amp; (object_getClass(<span class="keyword">self</span>) != cls)) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å°±æ›¿æ¢isa</span></span><br><span class="line">        object_setClass(<span class="keyword">self</span>, cls);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é‡Šæ”¾è§‚å¯Ÿä¿¡æ¯</span></span><br><span class="line">    [newInfo release];</span><br><span class="line">    <span class="keyword">if</span> (info != <span class="literal">nil</span>) &#123;</span><br><span class="line">        [info release];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰å¯èƒ½æ›¿æ¢æ–¹æ³•å®ç°çš„æ­¥éª¤æ˜¯è·å– <code>isa</code> çš„æ—¶å€™ï¼ŒçŒœæµ‹å½“ç¬¬ä¸€æ¬¡åˆ›å»ºæ–°ç±»çš„æ—¶å€™ï¼Œä¼šæ³¨å†Œæ–°çš„æ–¹æ³•ï¼Œæ¥ç€è¿½è¸ª <code>isaForAutonotifying</code> æ–¹æ³•ã€‚ </p><h3 id="è·å–è§‚å¯Ÿç±»"><a href="#è·å–è§‚å¯Ÿç±»" class="headerlink" title="è·å–è§‚å¯Ÿç±»"></a>è·å–è§‚å¯Ÿç±»</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> * -[<span class="built_in">NSKeyValueUnnestedProperty</span> _isaForAutonotifying]</span><br><span class="line">    (<span class="keyword">void</span> * <span class="keyword">self</span>, <span class="keyword">void</span> * _cmd) &#123;</span><br><span class="line">    rbx = <span class="keyword">self</span>;</span><br><span class="line">    r14 = *_OBJC_IVAR_$_NSKeyValueProperty._containerClass;</span><br><span class="line">    <span class="keyword">if</span> ([*(rbx + r14)-&gt;_originalClass </span><br><span class="line">        automaticallyNotifiesObserversForKey:rbx-&gt;_keyPath] != <span class="number">0x0</span>) &#123;</span><br><span class="line">            r14 = __NSKeyValueContainerClassGetNotifyingInfo(*(rbx + r14));</span><br><span class="line">            <span class="keyword">if</span> (r14 != <span class="number">0x0</span>) &#123;</span><br><span class="line">                    __NSKVONotifyingEnableForInfoAndKey(r14, rbx-&gt;_keyPath);</span><br><span class="line">                    rax = *(r14 + <span class="number">0x8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                    rax = <span class="number">0x0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">            rax = <span class="number">0x0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rax;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç«‹åˆ»å‘ç°äº†ç†Ÿæ‚‰çš„æ–¹æ³•ï¼</p><p><code>automaticallyNotifiesObserversForKey:</code> æ˜¯ä¸€ä¸ªç±»æ–¹æ³•ï¼Œå¦‚æœä½ ä¸å¸Œæœ›æŸä¸ªå±æ€§è¢«è§‚å¯Ÿï¼Œé‚£ä¹ˆå°±è®¾ä¸º <code>NO</code>ï¼Œ<code>isa</code> è¿”å›æ˜¯ç©ºä¹Ÿå°±å®£å‘Šè¿™æ¬¡æ·»åŠ è§‚å¯Ÿå¤±è´¥ã€‚</p><p>å¦‚æœä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œå°†ä¼šæ‰§è¡Œ<code>__NSKVONotifyingEnableForInfoAndKey(info, keyPath)</code> æ”¹å˜ <code>class</code> çš„æ–¹æ³•ï¼Œæœ€ç»ˆè¿”å›å…¶ <code>isa</code>ã€‚</p><h3 id="å®è´¨æ›¿æ¢æ–¹æ³•"><a href="#å®è´¨æ›¿æ¢æ–¹æ³•" class="headerlink" title="å®è´¨æ›¿æ¢æ–¹æ³•"></a>å®è´¨æ›¿æ¢æ–¹æ³•</h3><p>ç”±äºè¯¥æ–¹æ³•å®åœ¨å¤ªé•¿ï¼Œä¸”ä½¿ç”¨äº†<code>goto</code>ä¸æ–¹ä¾¿é˜…è¯»ï¼Œæ‰€ä»¥ä¾æ—§æ•´ç†æˆä¼ªä»£ç ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ªä»£ç ï¼Œä»…ä¾›ç†è§£</span></span><br><span class="line"><span class="keyword">int</span> __NSKVONotifyingEnableForInfoAndKey(<span class="keyword">void</span> *info, <span class="keyword">id</span> keyPath) &#123;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹é”åŠ é”</span></span><br><span class="line">    pthread_mutex_lock(info + <span class="number">0x20</span>);</span><br><span class="line">    <span class="comment">//æ·»åŠ keyPathåˆ°æ•°ç»„</span></span><br><span class="line">    <span class="built_in">CFSetAddValue</span>(*(info + <span class="number">0x10</span>), keyPath);</span><br><span class="line">    <span class="comment">//è§£é”</span></span><br><span class="line">    pthread_mutex_unlock(info + <span class="number">0x20</span>);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­åŸç±»å®ç°èƒ½ä¸èƒ½æ›¿æ¢</span></span><br><span class="line">    Class originClass = *info;</span><br><span class="line">    MethodClass *methodClass = </span><br><span class="line">    __NSKeyValueSetterForClassAndKey(originClass, keyPath, originClass);</span><br><span class="line">    <span class="keyword">if</span> (![methodClass isKindOfClass:[<span class="built_in">NSKeyValueMethodSetter</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        swizzleMutableMethod(info, keyPath);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­Setteræ–¹æ³•è¿”å›å€¼</span></span><br><span class="line">    Method method = [methodClass method];</span><br><span class="line">    <span class="keyword">if</span> (*(int8_t *)method_getTypeEncoding(method) != _C_VOID) &#123;</span><br><span class="line">        _NSLog(<span class="string">@"KVO autonotifying only supports -set&lt;Key&gt;: methods that return void."</span>);</span><br><span class="line">        swizzleMutableMethod(info, keyPath);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–Setteræ–¹æ³•å‚æ•°</span></span><br><span class="line">    <span class="keyword">char</span> *typeEncoding = method_copyArgumentType(method, <span class="number">0x2</span>);</span><br><span class="line">    <span class="keyword">char</span> type = sign_extend_64(*(int8_t *)typeEncoding);</span><br><span class="line">    SEL sel;<span class="comment">//æ ¹æ®å‚æ•°ç±»å‹é€‰æ‹©æ›¿æ¢çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> _C_BOOL: sel = __NSSetBoolValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_UCHR: sel = __NSSetUnsignedCharValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_UINT: sel = __NSSetUnsignedIntValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_ULNG: sel = __NSSetUnsignedLongValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_ULNG_LNG: sel = __NSSetUnsignedLongLongValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_CHR: sel = __NSSetCharValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_DBL: sel = __NSSetDoubleValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_FLT: sel = __NSSetFloatValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_INT: sel = __NSSetIntValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_LNG: sel = __NSSetLongValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_LNG_LNG: sel = __NSSetLongLongValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_SHT: sel = __NSSetShortValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_USHT: sel = __NSSetUnsignedShortValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_LNG_LNG: sel = __NSSetLongLongValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> _C_ID: sel = __NSSetObjectValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"&#123;CGPoint=dd&#125;"</span>: sel = __NSSetPointValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"&#123;_NSRange=QQ&#125;"</span>: sel = __NSSetRangeValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"&#123;CGRect=&#123;CGPoint=dd&#125;&#123;CGSize=dd&#125;&#125;"</span>: sel = __NSSetRectValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"&#123;CGSize=dd&#125;"</span>: sel = __NSSetSizeValueAndNotify;</span><br><span class="line">        <span class="keyword">case</span> *_NSKeyValueOldSizeObjCTypeName: sel = __CF_forwarding_prep_0;</span><br><span class="line">        <span class="keyword">default</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸æ”¯æŒçš„å‚æ•°ç±»å‹æ‰“å°é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (sel == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        _NSLog(<span class="string">@"KVO autonotifying only supports -set&lt;Key&gt;: methods that take id,</span></span><br><span class="line"><span class="string">        NSNumber-supported scalar types, and some NSValue-supported structure types."</span>)</span><br><span class="line">        swizzleMutableMethod(info, keyPath);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ›¿æ¢æ–¹æ³•å®ç°</span></span><br><span class="line">    SEL methodSel = method_getName(method);</span><br><span class="line">    _NSKVONotifyingSetMethodImplementation(info, methodSel, sel, keyPath);</span><br><span class="line">    <span class="keyword">if</span> (sel == __CF_forwarding_prep_0) &#123;</span><br><span class="line">        _NSKVONotifyingSetMethodImplementation(info, <span class="keyword">@selector</span>(forwardInvocation:), </span><br><span class="line">         _NSKVOForwardInvocation, <span class="literal">false</span>);</span><br><span class="line">        Class cls = *(info + <span class="number">0x8</span>);</span><br><span class="line">        SEL newSel = sel_registerName(<span class="string">"_original_"</span> + sel_getName(methodSel));</span><br><span class="line">        Imp imp = method_getImplementation(method);</span><br><span class="line">        TypeEncoding type = method_getTypeEncoding(method);</span><br><span class="line">        class_addMethod(cls, newSel, imp, type);</span><br><span class="line">    &#125;</span><br><span class="line">    swizzleMutableMethod(info, keyPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥è¡¨è¿°ä¸ºæ ¹æ® <code>Setter</code> æ–¹æ³•è¾“å…¥å‚æ•°ç±»å‹ï¼ŒåŒ¹é…åˆé€‚çš„ <code>NSSetValueAndNotify</code> å®ç°æ¥æ›¿æ¢ï¼Œä»è€Œå®ç°æ•ˆæœã€‚</p><p>é‚£ä¹ˆ <code>swizzleMutableMethod</code> æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿ</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ›¿æ¢å¯å˜æ•°ç»„é›†åˆçš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">int</span> swizzleMutableMethod(<span class="keyword">void</span> *info, <span class="keyword">id</span> keyPath) &#123;</span><br><span class="line">    <span class="comment">//NSKeyValueArray</span></span><br><span class="line">    <span class="built_in">CFMutableSetRef</span> getterSet = __NSKeyValueMutableArrayGetterForIsaAndKey(*info, keyPath);</span><br><span class="line">    <span class="keyword">if</span> ([getterSet respondsToSelector:mutatingMethods]) &#123;</span><br><span class="line">        mutatingMethods methodList = [getterSet mutatingMethods];</span><br><span class="line">        replace methodList-&gt;insertObjectAtIndex _NSKVOInsertObjectAtIndexAndNotify</span><br><span class="line">        replace methodList-&gt;insertObjectsAtIndexes _NSKVOInsertObjectsAtIndexesAndNotify</span><br><span class="line">        replace methodList-&gt;removeObjectAtIndex _NSKVORemoveObjectAtIndexAndNotify</span><br><span class="line">        replace methodList-&gt;removeObjectsAtIndexes _NSKVORemoveObjectsAtIndexesAndNotify</span><br><span class="line">        replace methodList-&gt;replaceObjectAtIndex _NSKVOReplaceObjectAtIndexAndNotify</span><br><span class="line">        replace methodList-&gt;replaceObjectsAtIndexes _NSKVOReplaceObjectsAtIndexesAndNotify</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//NSKeyValueOrderedSet</span></span><br><span class="line">    getterSet = __NSKeyValueMutableOrderedSetGetterForIsaAndKey(*info, keyPath);</span><br><span class="line">    <span class="keyword">if</span> ([getterSet respondsToSelector:mutatingMethods]) &#123;</span><br><span class="line">        mutatingMethods methodList = [getterSet mutatingMethods];</span><br><span class="line">        replace methodList-&gt;insertObjectAtIndex _NSKVOInsertObjectAtIndexAndNotify</span><br><span class="line">        replace methodList-&gt;insertObjectsAtIndexes _NSKVOInsertObjectsAtIndexesAndNotify</span><br><span class="line">        replace methodList-&gt;removeObjectAtIndex _NSKVORemoveObjectAtIndexAndNotify</span><br><span class="line">        replace methodList-&gt;removeObjectsAtIndexes _NSKVORemoveObjectsAtIndexesAndNotify</span><br><span class="line">        replace methodList-&gt;replaceObjectAtIndex _NSKVOReplaceObjectAtIndexAndNotify</span><br><span class="line">        replace methodList-&gt;replaceObjectsAtIndexes _NSKVOReplaceObjectsAtIndexesAndNotify</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//NSKeyValueSet</span></span><br><span class="line">    getterSet = __NSKeyValueMutableSetGetterForClassAndKey(*info, keyPath);</span><br><span class="line">    <span class="keyword">if</span> ([getterSet respondsToSelector:mutatingMethods]) &#123;</span><br><span class="line">        mutatingMethods methodList = [getterSet mutatingMethods];</span><br><span class="line">        replace methodList-&gt;addObject _NSKVOAddObjectAndNotify</span><br><span class="line">        replace methodList-&gt;intersectSet _NSKVOIntersectSetAndNotify</span><br><span class="line">        replace methodList-&gt;minusSet _NSKVOMinusSetAndNotify</span><br><span class="line">        replace methodList-&gt;removeObject _NSKVORemoveObjectAndNotify</span><br><span class="line">        replace methodList-&gt;unionSet _NSKVOUnionSetAndNotify</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ”¹å˜æ–°ç±»çš„æ–¹æ³•ç¼“å­˜</span></span><br><span class="line">    __NSKeyValueInvalidateCachedMutatorsForIsaAndKey(*(info + <span class="number">0x8</span>), keyPath);</span><br><span class="line">    <span class="keyword">return</span> rax;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‰é¢æåˆ°çš„éƒ½æ˜¯ä¸€å¯¹ä¸€ï¼Œé‚£å¦‚æœæˆ‘æƒ³è§‚å¯Ÿä¸€å¯¹å¤šçš„é›†åˆç±»å‘¢ï¼Ÿå°±æ˜¯é€šè¿‡ <code>KVC</code> ä¸­çš„ <code>mutableArrayValueForKey:</code> è¿”å›ä¸€ä¸ªä»£ç†é›†åˆï¼Œæ”¹å˜è¿™äº›ä»£ç†ç±»çš„å®ç°åšåˆ°çš„ã€‚å…·ä½“çš„ä¾‹å­ä¹‹åä¼šä»‹ç»ã€‚</p><h3 id="åˆ›å»ºæ–°ç±»"><a href="#åˆ›å»ºæ–°ç±»" class="headerlink" title="åˆ›å»ºæ–°ç±»"></a>åˆ›å»ºæ–°ç±»</h3><p>è¿˜æœ‰ä¸€ä¸ªç–‘é—®å°±æ˜¯æ›¿æ¢çš„ç±»æ˜¯æ€ä¹ˆåˆ›å»ºçš„ï¼Ÿå…·ä½“æ–¹æ³•åœ¨ <code>__NSKVONotifyingEnableForInfoAndKey</code> ä¸­å®ç°ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ªä»£ç ï¼Œä»…ä¾›ç†è§£</span></span><br><span class="line"><span class="keyword">int</span> __NSKVONotifyingCreateInfoWithOriginalClass(Class cls) &#123;</span><br><span class="line">    <span class="comment">//æ‹¼æ¥æ–°åå­—</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name = class_getName(cls);</span><br><span class="line">    <span class="keyword">int</span> length = strlen(r12) + <span class="number">0x10</span>;<span class="comment">//16æ˜¯NSKVONotifying_çš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">char</span> *newName = malloc(length);</span><br><span class="line">    __strlcpy_chk(newName, <span class="string">"NSKVONotifying_"</span>, length, <span class="number">-1</span>);</span><br><span class="line">    __strlcat_chk(newName, name, length, <span class="number">-1</span>);</span><br><span class="line">    <span class="comment">//ç”Ÿæˆä¸€ä¸ªç»§æ‰¿åŸç±»çš„æ–°ç±»</span></span><br><span class="line">    Class newCls = objc_allocateClassPair(cls, newName, <span class="number">0x68</span>);</span><br><span class="line">    free(newName);</span><br><span class="line">    <span class="keyword">if</span> (newCls != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        objc_registerClassPair(newCls);</span><br><span class="line">        <span class="comment">//è·å–é¢å¤–çš„å®ä¾‹å˜é‡è¡¨</span></span><br><span class="line">        <span class="keyword">void</span> *indexedIvars = object_getIndexedIvars(newCls);</span><br><span class="line">        *indexedIvars = cls;            <span class="comment">//è®°å½•åŸisa</span></span><br><span class="line">        *(indexedIvars + <span class="number">0x8</span>) = newCls; <span class="comment">//è®°å½•æ–°isa</span></span><br><span class="line">        <span class="comment">//æ–°å»ºä¸€ä¸ªé›†åˆï¼Œä¿å­˜è§‚å¯Ÿçš„keyPath</span></span><br><span class="line">        *(indexedIvars + <span class="number">0x10</span>) = <span class="built_in">CFSetCreateMutable</span>(<span class="number">0x0</span>, <span class="number">0x0</span>, _kCFCopyStringSetCallBacks);</span><br><span class="line">        <span class="comment">//æ–°å»ºä¸€ä¸ªå­—å…¸ï¼Œä¿å­˜æ”¹å˜è¿‡çš„SEL</span></span><br><span class="line">        *(indexedIvars + <span class="number">0x18</span>) = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>,   </span><br><span class="line">                                _kCFTypeDictionaryValueCallBacks);</span><br><span class="line">        <span class="comment">//æ–°å»ºä¸€ä¸ªçº¿ç¨‹é”</span></span><br><span class="line">        pthread_mutexattr_init(var_38);</span><br><span class="line">        pthread_mutexattr_settype(var_38, <span class="number">0x2</span>);</span><br><span class="line">        pthread_mutex_init(indexedIvars + <span class="number">0x20</span>, var_38);</span><br><span class="line">        pthread_mutexattr_destroy(var_38);</span><br><span class="line">        <span class="comment">//è·å–NSObjectç±»é»˜è®¤çš„å®ç°</span></span><br><span class="line">        <span class="keyword">if</span> (*__NSKVONotifyingCreateInfoWithOriginalClass.NSObjectIMPLookupOnce == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">            <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">                *__NSKVONotifyingCreateInfoWithOriginalClass.NSObjectWillChange = </span><br><span class="line">                class_getMethodImplementation([<span class="built_in">NSObject</span> <span class="keyword">class</span>],</span><br><span class="line">                <span class="keyword">@selector</span>(willChangeValueForKey:));</span><br><span class="line"></span><br><span class="line">                *__NSKVONotifyingCreateInfoWithOriginalClass.NSObjectDidChange = </span><br><span class="line">                class_getMethodImplementation([<span class="built_in">NSObject</span> <span class="keyword">class</span>], </span><br><span class="line">                <span class="keyword">@selector</span>(didChangeValueForKey:));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è®¾ç½®æ˜¯å¦æ›¿æ¢è¿‡ChangeValueæ–¹æ³•çš„flag</span></span><br><span class="line">        <span class="built_in">BOOL</span> isChangedImp = <span class="literal">YES</span>;</span><br><span class="line">        <span class="keyword">if</span> (class_getMethodImplementation(cls, <span class="keyword">@selector</span>(willChangeValueForKey:)) == </span><br><span class="line">        *__NSKVONotifyingCreateInfoWithOriginalClass.NSObjectWillChange) &#123;</span><br><span class="line">            <span class="built_in">BOOL</span> isChangedDidImp = </span><br><span class="line">                class_getMethodImplementation(cls, <span class="keyword">@selector</span>(didChangeValueForKey:)) </span><br><span class="line">                != </span><br><span class="line">                *__NSKVONotifyingCreateInfoWithOriginalClass.NSObjectDidChange;</span><br><span class="line">            isChangedImp = isChangedDidImp ? <span class="literal">YES</span> : <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        *(int8_t *)(indexedIvars + <span class="number">0x60</span>) = isChangedImp;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ä½¿ç”¨KVOçš„å®ç°æ›¿æ¢åŸç±»æ–¹æ³•</span></span><br><span class="line">        _NSKVONotifyingSetMethodImplementation(indexedIvars, <span class="keyword">@selector</span>(_isKVOA),</span><br><span class="line">         _NSKVOIsAutonotifying, <span class="literal">false</span><span class="comment">/*æ˜¯å¦éœ€è¦ä¿å­˜SELåˆ°å­—å…¸*/</span>);</span><br><span class="line"></span><br><span class="line">        _NSKVONotifyingSetMethodImplementation(indexedIvars, <span class="keyword">@selector</span>(dealloc), </span><br><span class="line">         _NSKVODeallocate, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        _NSKVONotifyingSetMethodImplementation(indexedIvars, <span class="keyword">@selector</span>(<span class="keyword">class</span>), </span><br><span class="line">         _NSKVOClass, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newCls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å»ºç«‹å…³ç³»"><a href="#å»ºç«‹å…³ç³»" class="headerlink" title="å»ºç«‹å…³ç³»"></a>å»ºç«‹å…³ç³»</h3><p>è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯è§‚å¯Ÿçš„å±æ€§ä¾èµ–äºå¤šä¸ªå…³ç³»ï¼Œæ¯”å¦‚ <code>color</code> å¯èƒ½ä¾èµ–äº <code>r g b a</code>ï¼Œå…¶ä¸­ä»»ä½•ä¸€ä¸ªæ”¹å˜ï¼Œéƒ½éœ€è¦é€šçŸ¥ <code>color</code> çš„å˜åŒ–ã€‚</p><p>å»ºç«‹å…³ç³»çš„æ–¹æ³•æ˜¯ </p><p><code>+ (NSSet *)keyPathsForValuesAffectingValueForKey:(NSString *)key</code></p><p>æˆ– <code>+ (NSSet *)keyPathsForValuesAffecting&lt;key&gt;</code></p><p>è¿”å›ä¾èµ–é”®å€¼çš„å­—ç¬¦ä¸²é›†åˆ</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ªä»£ç </span></span><br><span class="line">+ (<span class="built_in">NSSet</span> *)keyPathsForValuesAffectingValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">char</span> *str = <span class="string">"keyPathsForValuesAffecting"</span> + key;</span><br><span class="line">    SEL sel = sel_registerName(str);</span><br><span class="line">    Method method = class_getClassMethod(<span class="keyword">self</span>, sel);</span><br><span class="line">    <span class="keyword">if</span> (method != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        result = method_invoke(<span class="keyword">self</span>, method);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = [<span class="keyword">self</span> _keysForValuesAffectingValueForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜è®°å¾—ä¹‹å‰åœ¨ <code>_addObserver</code> æ–¹æ³•ä¸­æœ‰è¿™æ®µä»£ç å—ï¼Ÿ</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å±æ€§æ·»åŠ åé€’å½’æ·»åŠ å…³è”å±æ€§</span></span><br><span class="line">[property object:<span class="keyword">self</span> didAddObservance:newInfo recurse:<span class="literal">true</span>];</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>NSKeyValueProperty</code> ä¹Ÿæ˜¯ä¸€ä¸ªç±»ç°‡ï¼Œå…·ä½“åˆ†ä¸º <code>NSKeyValueProperty NSKeyValueComputedProperty NSKeyValueUnnestedProperty NSKeyValueNestedProperty</code>ï¼Œä»åå­—ä¹Ÿçœ‹å‡º <code>NSKeyValueNestedProperty</code> æ˜¯æŒ‡åµŒå¥—å­å±æ€§çš„å±æ€§ç±»ï¼Œé‚£æˆ‘ä»¬è§‚å¯Ÿä¸‹ä»–çš„å®ç°ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ªä»£ç </span></span><br><span class="line">- (<span class="keyword">void</span>)object:(<span class="keyword">id</span>)obj didAddObservance:(<span class="keyword">id</span>)info recurse:(<span class="built_in">BOOL</span>)isRecurse &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>-&gt;_isAllowedToResultInForwarding != <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="comment">//è·å¾—å…³ç³»é”®</span></span><br><span class="line">        relateObj = [obj valueForKey:<span class="keyword">self</span>-&gt;_relationshipKey];</span><br><span class="line">        <span class="comment">//æ³¨å†Œæ‰€æœ‰å…³ç³»é€šçŸ¥</span></span><br><span class="line">        [relateObj addObserver:info </span><br><span class="line">                    forKeyPath:<span class="keyword">self</span>-&gt;_keyPathFromRelatedObject </span><br><span class="line">                       options:info-&gt;options </span><br><span class="line">                       context:<span class="literal">nil</span>];</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//å†å¾€ä¸‹é€’å½’</span></span><br><span class="line">    [<span class="keyword">self</span>-&gt;_relationshipProperty object:obj didAddObservance:info recurse:isRecurse];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œå®ç°çš„å¤§è‡´æ•´ä½“è½®å»“æ¯”è¾ƒäº†è§£äº†ï¼Œä¸‹é¢ä¼šè®²ä¸€ä¸‹æ€ä¹ˆæŠŠåŸç†è¿ç”¨åˆ°å®é™…ã€‚</p><hr><h2 id="åº”ç”¨åŸç†"><a href="#åº”ç”¨åŸç†" class="headerlink" title="åº”ç”¨åŸç†"></a>åº”ç”¨åŸç†</h2><h3 id="æ‰‹åŠ¨è§¦å‘"><a href="#æ‰‹åŠ¨è§¦å‘" class="headerlink" title="æ‰‹åŠ¨è§¦å‘"></a>æ‰‹åŠ¨è§¦å‘</h3><p>å½“ <code>+(BOOL)automaticallyNotifiesObserversForKey:(NSString *)key</code> è¿”å›æ˜¯ <code>YES</code>ï¼Œé‚£ä¹ˆæ³¨å†Œçš„è¿™ä¸ª <code>Key</code> å°±ä¼šæ›¿æ¢å¯¹åº”çš„ <code>Setter</code> ï¼Œä»è€Œåœ¨æ”¹å˜çš„æ—¶å€™è°ƒç”¨ <code>-(void)willChangeValueForKey:(NSString *)key</code> ä¸ <code>-(void)didChangeValueForKey:(NSString *)key</code> å‘é€é€šçŸ¥ç»™è§‚å¯Ÿè€…ã€‚</p><p>é‚£ä¹ˆåªè¦æŠŠè‡ªåŠ¨é€šçŸ¥è®¾ä¸º <code>NO</code>ï¼Œå¹¶ä»£ç å®ç°è¿™ä¸¤ä¸ªé€šçŸ¥æ–¹æ³•ï¼Œå°±å¯ä»¥è¾¾åˆ°æ‰‹åŠ¨è§¦å‘çš„è¦æ±‚ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"object"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="built_in">NSObject</span> *)object &#123;</span><br><span class="line">    <span class="keyword">if</span> (object != _object) &#123;</span><br><span class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"object"</span>];</span><br><span class="line">        _object = object;</span><br><span class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"object"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ“ä½œçš„æ˜¯ä¹‹å‰æåˆ°çš„é›†åˆå¯¹è±¡ï¼Œé‚£ä¹ˆå®ç°çš„æ–¹æ³•å°±éœ€è¦å˜ä¸º</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)willChange:(<span class="built_in">NSKeyValueChange</span>)changeKind </span><br><span class="line">   valuesAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes </span><br><span class="line">            forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)didChange:(<span class="built_in">NSKeyValueChange</span>)changeKind </span><br><span class="line">  valuesAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes </span><br><span class="line">           forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)willChangeValueForKey:(<span class="built_in">NSString</span> *)key </span><br><span class="line">              withSetMutation:(<span class="built_in">NSKeyValueSetMutationKind</span>)mutationKind </span><br><span class="line">                 usingObjects:(<span class="built_in">NSSet</span> *)objects;</span><br><span class="line">- (<span class="keyword">void</span>)didChangeValueForKey:(<span class="built_in">NSString</span> *)key </span><br><span class="line">             withSetMutation:(<span class="built_in">NSKeyValueSetMutationKind</span>)mutationKind </span><br><span class="line">                usingObjects:(<span class="built_in">NSSet</span> *)objects;</span><br></pre></td></tr></table></figure><h3 id="ä¾èµ–é”®è§‚å¯Ÿ"><a href="#ä¾èµ–é”®è§‚å¯Ÿ" class="headerlink" title="ä¾èµ–é”®è§‚å¯Ÿ"></a>ä¾èµ–é”®è§‚å¯Ÿ</h3><p>ä¹‹å‰ä¹Ÿæœ‰æè¿‡æ„å»ºä¾èµ–å…³ç³»çš„æ–¹æ³•ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSSet</span>&lt;<span class="built_in">NSString</span> *&gt; *)keyPathsForValuesAffectingValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"color"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"r"</span>,<span class="string">@"g"</span>,<span class="string">@"b"</span>,<span class="string">@"a"</span>,<span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> keyPathsForValuesAffectingValueForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å»ºè®®ä½¿ç”¨é™æ€æŒ‡é’ˆåœ°å€ä½œä¸ºä¸Šä¸‹æ–‡åŒºåˆ†ä¸åŒçš„è§‚å¯Ÿ</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> * <span class="keyword">const</span> kColorContext = (<span class="keyword">void</span>*)&amp;kColorContext;</span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"color"</span> </span><br><span class="line">              options:<span class="built_in">NSKeyValueObservingOptionNew</span> </span><br><span class="line">              context:kColorContext];</span><br><span class="line">    <span class="keyword">self</span>.r = <span class="number">133</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath </span><br><span class="line">                      ofObject:(<span class="keyword">id</span>)object </span><br><span class="line">                        change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change </span><br><span class="line">                       context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> (context == kColorContext) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, keyPath); </span><br><span class="line">        <span class="comment">//outprint --&gt; color</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¯å˜æ•°ç»„ä¸é›†åˆ"><a href="#å¯å˜æ•°ç»„ä¸é›†åˆ" class="headerlink" title="å¯å˜æ•°ç»„ä¸é›†åˆ"></a>å¯å˜æ•°ç»„ä¸é›†åˆ</h3><p>ä¸å¯å˜çš„æ•°ç»„ä¸é›†åˆç”±äºå†…éƒ¨ç»“æ„å›ºå®šï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡è§‚å¯Ÿå®¹å™¨ç±»å†…å­˜åœ°å€æ¥åˆ¤æ–­æ˜¯å¦å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯ <code>NSKeyValueChangeSetting</code>ã€‚</p><p>é›†åˆå’Œæ•°ç»„çš„è§‚å¯Ÿéƒ½å¾ˆç±»ä¼¼ï¼Œæˆ‘ä»¬å…ˆå…³æ³¨å¦‚æœè¦è§‚å¯Ÿå¯å˜æ•°ç»„å†…éƒ¨æ’å…¥ç§»é™¤çš„å˜åŒ–å‘¢ï¼Ÿ</p><p>å…ˆäº†è§£ä¸€ä¸‹é›†åˆä»£ç†æ–¹æ³•ï¼Œ<code>- (NSMutableArray *)mutableArrayValueForKey:</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>KVC</code> æ–¹æ³•ï¼Œèƒ½å¤Ÿè¿”å›ä¸€ä¸ªå¯ä¾›è§‚å¯Ÿçš„ <code>NSKeyValueArray</code> å¯¹è±¡ã€‚</p><p>æ ¹æ®è‹¹æœæ³¨é‡Šï¼Œå…¶æœç´¢é¡ºåºå¦‚ä¸‹</p><p>1.æœç´¢æ˜¯å¦å®ç°æœ€å°‘ä¸€ä¸ªæ’å…¥ä¸ä¸€ä¸ªåˆ é™¤æ–¹æ³•<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-insertObject:<span class="keyword">in</span>&lt;Key&gt;AtIndex:</span><br><span class="line">-removeObjectFrom&lt;Key&gt;AtIndex:</span><br><span class="line">-insert&lt;Key&gt;:atIndexes:</span><br><span class="line">-remove&lt;Key&gt;AtIndexes:</span><br></pre></td></tr></table></figure></p><p>2.å¦åˆ™æœç´¢æ˜¯å¦æœ‰ <code>set&lt;Key&gt;:</code> æ–¹æ³•ï¼Œæœ‰çš„è¯æ¯æ¬¡éƒ½æŠŠä¿®æ”¹æ•°ç»„é‡æ–°èµ‹å€¼å›åŸå±æ€§ã€‚</p><p>3.å¦åˆ™æ£€æŸ¥ <code>+ (BOOL)accessInstanceVariablesDirectly</code>ï¼Œå¦‚æœæ˜¯<code>YES</code>ï¼Œå°±æŸ¥æ‰¾æˆå‘˜å˜é‡<code>_&lt;key&gt; or &lt;key&gt;</code>ï¼Œæ­¤åæ‰€æœ‰çš„æ“ä½œé’ˆå¯¹ä»£ç†éƒ½è½¬æ¥ç»™æˆå‘˜å˜é‡æ‰§è¡Œã€‚</p><p>4.æœ€åè¿›å…¥ä¿æŠ¤æ–¹æ³•<code>valueForUndefinedKey:</code></p><h4 id="ç¬¬ä¸€ç§æ–¹æ³•"><a href="#ç¬¬ä¸€ç§æ–¹æ³•" class="headerlink" title="ç¬¬ä¸€ç§æ–¹æ³•"></a>ç¬¬ä¸€ç§æ–¹æ³•</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)insertObject:(<span class="built_in">NSObject</span> *)object inDataArrayAtIndex:(<span class="built_in">NSUInteger</span>)index &#123;</span><br><span class="line">    [_dataArray insertObject:object atIndex:index];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObjectFromDataArrayAtIndex:(<span class="built_in">NSUInteger</span>)index &#123;</span><br><span class="line">    [_dataArray removeObjectAtIndex:index];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    _dataArray = @[].mutableCopy;</span><br><span class="line">    [<span class="keyword">self</span> addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"dataArray"</span> </span><br><span class="line">    options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> |  </span><br><span class="line">    <span class="built_in">NSKeyValueObservingOptionPrior</span> context:<span class="literal">nil</span>];</span><br><span class="line">    [<span class="keyword">self</span> insertObject:@<span class="number">1</span> inDataArrayAtIndex:<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡å®ç°äº†<code>insert</code>ä¸<code>remove</code>æ–¹æ³•ï¼Œä½¿å¾—ä»£ç†æ•°ç»„èƒ½å¤Ÿæ­£å¸¸è¿ä½œæ•°ç»„å˜é‡ï¼Œ<code>KVO</code> è§‚å¯Ÿäº†ä»£ç†æ•°ç»„çš„è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå‘å‡ºäº†æˆ‘ä»¬éœ€è¦çš„é€šçŸ¥ã€‚</p><p>è¿™ç§æ–¹å¼ä½¿ç”¨äº†ç¬¬ä¸€æ­¥æœç´¢ï¼Œæ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œç¼ºç‚¹æ˜¯æ”¹åŠ¨çš„ä»£ç æ¯”è¾ƒå¤šï¼Œæ”¹åŠ¨æ•°ç»„å¿…é¡»é€šè¿‡è‡ªå®šä¹‰æ–¹æ³•ã€‚</p><h4 id="ç¬¬äºŒç§æ–¹æ³•"><a href="#ç¬¬äºŒç§æ–¹æ³•" class="headerlink" title="ç¬¬äºŒç§æ–¹æ³•"></a>ç¬¬äºŒç§æ–¹æ³•</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSMutableArray</span> *dataArray;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@synthesize</span> dataArray = _dataArray;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMutableArray</span> *)dataArray &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> mutableArrayValueForKey:<span class="string">@"dataArray"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    _dataArray = @[].mutableCopy;</span><br><span class="line">    [<span class="keyword">self</span> addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"dataArray"</span> </span><br><span class="line">    options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> |   </span><br><span class="line">    <span class="built_in">NSKeyValueObservingOptionPrior</span> context:<span class="literal">nil</span>];</span><br><span class="line">    [<span class="keyword">self</span>.dataArray addObject:@<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼ç›¸å¯¹æ¥è¯´æ›´ç®€æ´ï¼Œä¿®æ”¹æ•°ç»„çš„æ–¹æ³•ä¸å¹³æ—¶ä¸€è‡´ï¼Œæ¯”è¾ƒé€‚åˆä½¿ç”¨ã€‚</p><p>ä¸‹é¢è¯´ä¸€ä¸‹åŸç†ï¼Œé¦–å…ˆæˆ‘ä»¬æ²¡æœ‰å®ç°å¯¹åº”çš„<code>insert</code>ä¸<code>remove</code>æ–¹æ³•ï¼Œå…¶æ¬¡<code>readonly</code>å±æ€§ä¹Ÿæ²¡æœ‰<code>set&lt;key&gt;:</code>æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å®ç°äº† <code>@synthesize dataArray = _dataArray;</code> æ‰€ä»¥æ ¹æ®ç¬¬ä¸‰æ­¥å¯¹ä»£ç†æ•°ç»„çš„æ“ä½œéƒ½ä¼šå®é™…æ“ä½œåˆ°å®ä¾‹å˜é‡ä¸­ã€‚</p><p>ç„¶åé‡è½½äº† <code>dataArray</code> çš„ <code>Getter</code> æ–¹æ³•ï¼Œä¿è¯äº†ä¿®æ”¹æ•°ç»„æ—¶å¿…é¡»è°ƒç”¨ä¸»ä½“æ˜¯<code>self.dataArray</code>ï¼Œä¹Ÿå°±æ˜¯ä»£ç†æ•°ç»„ï¼Œä»è€Œå‘é€é€šçŸ¥ã€‚</p><hr><h2 id="é—®ç­”"><a href="#é—®ç­”" class="headerlink" title="é—®ç­”"></a>é—®ç­”</h2><h3 id="KVOçš„åº•å±‚å®ç°ï¼Ÿ"><a href="#KVOçš„åº•å±‚å®ç°ï¼Ÿ" class="headerlink" title="KVOçš„åº•å±‚å®ç°ï¼Ÿ"></a>KVOçš„åº•å±‚å®ç°ï¼Ÿ</h3><p><code>KVO</code> å°±æ˜¯é€šè¿‡ <code>Runtime</code> æ›¿æ¢è¢«è§‚å¯Ÿç±»çš„ <code>Setter</code> å®ç°ï¼Œä»è€Œåœ¨å‘ç”Ÿæ”¹å˜æ—¶å‘èµ·é€šçŸ¥ã€‚</p><h3 id="å¦‚ä½•å–æ¶ˆç³»ç»Ÿé»˜è®¤çš„KVOå¹¶æ‰‹åŠ¨è§¦å‘ï¼ˆç»™KVOçš„è§¦å‘è®¾å®šæ¡ä»¶ï¼šæ”¹å˜çš„å€¼ç¬¦åˆæŸä¸ªæ¡ä»¶æ—¶å†è§¦å‘KVOï¼‰ï¼Ÿ"><a href="#å¦‚ä½•å–æ¶ˆç³»ç»Ÿé»˜è®¤çš„KVOå¹¶æ‰‹åŠ¨è§¦å‘ï¼ˆç»™KVOçš„è§¦å‘è®¾å®šæ¡ä»¶ï¼šæ”¹å˜çš„å€¼ç¬¦åˆæŸä¸ªæ¡ä»¶æ—¶å†è§¦å‘KVOï¼‰ï¼Ÿ" class="headerlink" title="å¦‚ä½•å–æ¶ˆç³»ç»Ÿé»˜è®¤çš„KVOå¹¶æ‰‹åŠ¨è§¦å‘ï¼ˆç»™KVOçš„è§¦å‘è®¾å®šæ¡ä»¶ï¼šæ”¹å˜çš„å€¼ç¬¦åˆæŸä¸ªæ¡ä»¶æ—¶å†è§¦å‘KVOï¼‰ï¼Ÿ"></a>å¦‚ä½•å–æ¶ˆç³»ç»Ÿé»˜è®¤çš„KVOå¹¶æ‰‹åŠ¨è§¦å‘ï¼ˆç»™KVOçš„è§¦å‘è®¾å®šæ¡ä»¶ï¼šæ”¹å˜çš„å€¼ç¬¦åˆæŸä¸ªæ¡ä»¶æ—¶å†è§¦å‘KVOï¼‰ï¼Ÿ</h3><p>é€šè¿‡è®¾ç½® <code>automaticallyNotifiesObserversForKey</code> ä¸º <code>False</code> å®ç°å–æ¶ˆè‡ªåŠ¨è§¦å‘ã€‚</p><p>ç¬¦åˆæ¡ä»¶å†è§¦å‘å¯ä»¥è¿™ä¹ˆå®ç°ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="built_in">NSObject</span> *)object &#123;</span><br><span class="line">    <span class="keyword">if</span> (object == _object) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BOOL</span> needNotify = [object isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]];</span><br><span class="line">    <span class="keyword">if</span> (needNotify) &#123;</span><br><span class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"object"</span>];    </span><br><span class="line">    &#125;</span><br><span class="line">    _object = object;</span><br><span class="line">    <span class="keyword">if</span> (needNotify) &#123;</span><br><span class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"object"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç”±äºå¯¹æ±‡ç¼–è¯­è¨€ã€åç¼–è¯‘å·¥å…·ã€<code>objc4</code>å¼€æºä»£ç çš„ä¸ç†Ÿæ‚‰ï¼Œè¿™ç¯‡æ–‡ç« å†™äº†ä¸€å‘¨æ—¶é—´ï¼Œç»“æ„ä¹Ÿæœ‰ç‚¹æ··ä¹±ã€‚</p><p>æ‰€å¹¸è¿˜æ˜¯ç†é¡ºäº†æ•´ä½“ç»“æ„ï¼Œåœ¨æ•´ç†çš„è¿‡ç¨‹ä¸­å­¦ä¼šäº†å¾ˆå¤šå¾ˆå¤šã€‚</p><p>ç”±äºæ‰ç–å­¦æµ…ï¼Œå…¶ä¸­å¯¹æ±‡ç¼–å’Œæºç çš„è§£é‡Šéš¾å…å‡ºé”™ï¼Œè¿˜æœ›å¤§ä½¬å¤šå¤šæŒ‡æ•™ï¼</p><hr><h2 id="èµ„æ–™åˆ†äº«"><a href="#èµ„æ–™åˆ†äº«" class="headerlink" title="èµ„æ–™åˆ†äº«"></a>èµ„æ–™åˆ†äº«</h2><p>ObjCä¸­å›½çš„æœŸåˆŠ <a href="https://objccn.io/issue-7-3/" target="_blank" rel="noopener">KVCå’ŒKVO</a></p><p>æ¨å¤§ç‰›çš„ <a href="http://yulingtianxia.com/blog/2014/05/12/objective-czhong-de-kvche-kvo/" target="_blank" rel="noopener">Objective-Cä¸­çš„KVCå’ŒKVO</a></p><p><a href="https://www.jianshu.com/p/45cbd324ea65" target="_blank" rel="noopener">iOSå¼€å‘æŠ€å·§ç³»åˆ—â€”è¯¦è§£KVC(æˆ‘å‘Šè¯‰ä½ KVCçš„ä¸€åˆ‡)</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä»‹ç»&quot;&gt;&lt;/a&gt;ä»‹ç»&lt;/h2&gt;&lt;p&gt;KVO( &lt;code&gt;NSKeyValueObserving&lt;/code&gt; )æ˜¯ä¸€ç§ç›‘æµ‹å¯¹è±¡å±æ€§å€¼å˜åŒ–çš„è§‚å¯Ÿè€…æ¨¡å¼æœºåˆ¶ã€‚å…¶ç‰¹ç‚¹æ˜¯æ— éœ€äº‹å…ˆä¿®æ”¹
      
    
    </summary>
    
      <category term="iOS" scheme="https://vanchchen.github.io/categories/iOS/"/>
    
    
      <category term="åŸç†åˆ†æ" scheme="https://vanchchen.github.io/tags/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>è„šæœ¬å¤„ç†iOSçš„Crashæ—¥å¿—</title>
    <link href="https://vanchchen.github.io/p/2616.html"/>
    <id>https://vanchchen.github.io/p/2616.html</id>
    <published>2018-10-08T08:06:38.000Z</published>
    <updated>2018-12-07T06:16:41.187Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>å½“æˆ‘ä»¬æ‰“åŒ…appæ—¶ï¼Œå¯ä»¥é€‰æ‹©ç”Ÿæˆå¯¹åº”çš„ç¬¦å·è¡¨ï¼Œå…¶ä¿å­˜ 16 è¿›åˆ¶å‡½æ•°åœ°å€æ˜ å°„ä¿¡æ¯ï¼Œé€šè¿‡ç»™å®šçš„å‡½æ•°èµ·å§‹åœ°å€å’Œåç§»é‡ï¼Œå¯ä»¥å¯¹åº”å‡½æ•°å…·ä½“ä¿¡æ¯ä»¥ä¾›åˆ†æã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬æ‹¿åˆ°æµ‹è¯•ç»™çš„é—ªé€€æ—¥å¿—(<code>.crash</code>)æ—¶ï¼Œéœ€è¦æ‰¾åˆ°æ‰“åŒ…æ—¶å¯¹åº”ç”Ÿæˆçš„ç¬¦å·è¡¨(<code>.dSYM</code>)ä½œä¸ºé’¥åŒ™è§£æã€‚å…·ä½“åˆ†ä¸ºä¸‹é¢å‡ ä¸ªæ­¥éª¤</p><ol><li><code>dwarfdump --uuid</code> å‘½ä»¤è·å– <code>.dSYM</code> çš„ <code>uuid</code></li><li>æ‰“å¼€ <code>.crash</code> æ–‡ä»¶ï¼Œåœ¨ç‰¹å®šä½ç½®æ‰¾åˆ° <code>uuid</code></li><li>æ ¹æ® <code>arm</code> ç‰ˆæœ¬æ¯”å¯¹ä¸¤è€…æ˜¯å¦ä¸€è‡´</li><li><p>åˆ° <code>Xcode</code> ç›®å½•ä¸‹å¯»æ‰¾ <code>symbolicatecrash</code> å·¥å…·</p><blockquote><p>ä¸åŒç‰ˆæœ¬æ–‡ä»¶è·¯å¾„ä¸åŒï¼Œå…·ä½“ç‰ˆæœ¬è¯·è°·æ­Œã€‚Xcode9è·¯å¾„æ˜¯/Applications/Xcode.app/Contents/SharedFrameworks/DVTFoundation.framework/Versions/A/Resources/</p></blockquote></li><li><p>è®¾ç½®ç»ˆç«¯ç¯å¢ƒå˜é‡</p><p> <code>export DEVELOPER_DIR=&quot;/Applications/Xcode.app/Contents/Developer&quot;</code></p></li><li>ä½¿ç”¨ <code>symbolicatecrash</code> å·¥å…·è§£ææ—¥å¿—<br> <code>symbolicatecrash .crash .dsym &gt; a.out</code></li></ol><p>è™½ç„¶è¿‡ç¨‹ä¸å¤æ‚ï¼Œä½†æ˜¯æ¯æ¬¡éƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ä¸å‘½ä»¤ï¼Œè¿‡äºç¹çï¼Œæ‰€ä»¥å†³å®šç”¨è„šæœ¬åŒ–æé«˜æ•ˆç‡ã€‚</p><hr><h2 id="æ­¥éª¤å®ç°"><a href="#æ­¥éª¤å®ç°" class="headerlink" title="æ­¥éª¤å®ç°"></a>æ­¥éª¤å®ç°</h2><h3 id="è¾“å…¥Crashæ—¥å¿—"><a href="#è¾“å…¥Crashæ—¥å¿—" class="headerlink" title="è¾“å…¥Crashæ—¥å¿—"></a>è¾“å…¥Crashæ—¥å¿—</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>è¦æ±‚è¾“å…¥crashæ–‡ä»¶è·¯å¾„</span><br><span class="line">inputFile 'Please Input Crash File' 'crash'</span><br><span class="line">crashPath=$filePath</span><br></pre></td></tr></table></figure><p>ç”±äºéœ€è¦è¾“å…¥ä¸¤ç§ä¸åŒåç¼€çš„æ–‡ä»¶è·¯å¾„ï¼Œä¸”éƒ½éœ€è¦æ£€æŸ¥ï¼Œå› æ­¤ç»Ÿä¸€å®šä¹‰ä¸€ä¸ªæ–¹æ³•ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>å®šä¹‰å…¨å±€å˜é‡</span><br><span class="line">filePath=</span><br><span class="line"><span class="meta">#</span>è¾“å…¥æ–‡ä»¶è·¯å¾„</span><br><span class="line">inputFile() &#123;</span><br><span class="line">    readSuccess=false</span><br><span class="line">    #é¦–å…ˆæ¸…ç©ºå˜é‡å€¼</span><br><span class="line">    filePath=</span><br><span class="line">    while [ $readSuccess = false ]; do </span><br><span class="line">        echo $1</span><br><span class="line">        #è¯»å–åˆ°å˜é‡ä¸­</span><br><span class="line">        read -a filePath</span><br><span class="line">        if [[ ! -e $filePath || $&#123;filePath##*.&#125; != $2 ]]; then</span><br><span class="line">            echo "Input file is not ."$2</span><br><span class="line">        else</span><br><span class="line">            readSuccess=true</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>.dSYM</code> æ˜¯æ–‡ä»¶å¤¹è·¯å¾„ï¼Œæ‰€ä»¥è¿™é‡Œç®€å•çš„åˆ¤æ–­äº†è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±ç»§ç»­è®©ç”¨æˆ·è¾“å…¥ã€‚</p><blockquote><p>Shellå‘½ä»¤ä¸­åˆ¤æ–­åˆ†ä¸º[]ä¸[[]]ï¼Œåè€…æ¯”å‰è€…æ›´é€šç”¨ï¼Œå¯ä»¥ä½¿ç”¨ || æ­£åˆ™è¿ç®—ç­‰ã€‚</p><p>åˆ¤æ–­ä¸­ï¼Œ-fè¡¨ç¤ºæ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œ-dè¡¨ç¤ºæ£€æŸ¥æ˜¯å¦å­˜åœ¨æ–‡ä»¶å¤¹ï¼Œ-eè¡¨ç¤ºæ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥è·¯å¾„</p></blockquote><h3 id="è¾“å…¥dSYMç¬¦å·è¡¨"><a href="#è¾“å…¥dSYMç¬¦å·è¡¨" class="headerlink" title="è¾“å…¥dSYMç¬¦å·è¡¨"></a>è¾“å…¥dSYMç¬¦å·è¡¨</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dsymSuccess=false</span><br><span class="line">while [ $dsymSuccess = false ]; do</span><br><span class="line">    #è¦æ±‚è¾“å…¥dSYMæ–‡ä»¶è·¯å¾„</span><br><span class="line">    inputFile 'Please Input dSYM File' 'dSYM'</span><br><span class="line">    dsymPath=$filePath</span><br><span class="line">    #æ£€æŸ¥æ˜¯å¦åŒ¹é…</span><br><span class="line">    checkUUID "$crashPath" "$dsymPath"</span><br><span class="line">    match=$?</span><br><span class="line">    if [ $match -eq 0 ]; then</span><br><span class="line">        echo 'UUID not match!'</span><br><span class="line">    else</span><br><span class="line">        dsymSuccess=true</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>å¾ªç¯è·å–åŒ¹é… <code>UUID</code> çš„ <code>dSYM</code> ï¼Œè¿™é‡Œä½¿ç”¨äº†å¦ä¸€ç§æ–¹æ³•è·å–æ–¹æ³•è¿”å›å€¼ï¼Œå…·ä½“ä¹‹åç« èŠ‚ä¼šæ€»ç»“ã€‚</p><h3 id="æŸ¥æ‰¾symbolicatecrashå·¥å…·"><a href="#æŸ¥æ‰¾symbolicatecrashå·¥å…·" class="headerlink" title="æŸ¥æ‰¾symbolicatecrashå·¥å…·"></a>æŸ¥æ‰¾symbolicatecrashå·¥å…·</h3><p>åœ¨ <code>Xcode</code> æ–‡ä»¶å¤¹æŒ‡å®šè·¯å¾„ä¸‹æŸ¥æ‰¾å·¥å…·ï¼ŒåŠ å¿«æ•ˆç‡ï¼Œå¦‚æœæ²¡æ‰¾åˆ°å°±åœæ­¢è¿è¡Œã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> æŸ¥æ‰¾symbolicatecrashè§£æå·¥å…·ï¼Œå†…ç½®åœ¨Xcodeçš„åº“æ–‡ä»¶ä¸­</span><br><span class="line">toolPath=`find /Applications/Xcode.app/Contents/SharedFrameworks -name symbolicatecrash | head -n 1`</span><br><span class="line">if [ ! -f $toolPath ]; then</span><br><span class="line">    echo "Symbolicatecrash not exist!"</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œè§£æå‘½ä»¤"><a href="#æ‰§è¡Œè§£æå‘½ä»¤" class="headerlink" title="æ‰§è¡Œè§£æå‘½ä»¤"></a>æ‰§è¡Œè§£æå‘½ä»¤</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>å…ˆè®¾ç½®ç¯å¢ƒå˜é‡</span><br><span class="line">export DEVELOPER_DIR="/Applications/Xcode.app/Contents/Developer"</span><br><span class="line"><span class="meta">#</span>æŒ‡å®šè§£æç»“æœè·¯å¾„</span><br><span class="line">crashName=`basename $crashPath`</span><br><span class="line">afterPath="$(dirname "$crashPath")"/"$&#123;crashName%%.*&#125;""_after.crash"</span><br><span class="line"><span class="meta">#</span>å¼€å§‹è§£æ</span><br><span class="line"><span class="meta">$</span>toolPath "$crashPath" "$dsymPath" &gt; "$afterPath" 2&gt; /dev/null</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘å°†é”™è¯¯ä¿¡æ¯å¯¼æµåˆ° <code>/dev/null</code>ï¼Œä¿è¯è§£ææ–‡ä»¶æ²¡æœ‰æ‚ä¹±ä¿¡æ¯ã€‚</p><hr><h2 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h2><h3 id="æ€ä¹ˆè·å–å‡½æ•°è¿”å›å€¼ï¼Ÿ"><a href="#æ€ä¹ˆè·å–å‡½æ•°è¿”å›å€¼ï¼Ÿ" class="headerlink" title="æ€ä¹ˆè·å–å‡½æ•°è¿”å›å€¼ï¼Ÿ"></a>æ€ä¹ˆè·å–å‡½æ•°è¿”å›å€¼ï¼Ÿ</h3><p>ä¹‹å‰æ²¡æœ‰å¤„ç†è¿‡éœ€è¦è¿”å›æ•°å€¼çš„æ–¹æ³•ï¼Œæ‰€ä»¥ä¸€å¼€å§‹æœ‰ç‚¹æ‡µï¼ŒæŸ¥è¯¢èµ„æ–™åæœ€ç»ˆé‡‡ç”¨äº†ä¸¤ç§æ–¹å¼å®ç°äº†æ•ˆæœï¼Œç°åœ¨åšä¸€äº›æ€»ç»“ã€‚</p><h4 id="å…¨å±€å˜é‡è®°å½•"><a href="#å…¨å±€å˜é‡è®°å½•" class="headerlink" title="å…¨å±€å˜é‡è®°å½•"></a>å…¨å±€å˜é‡è®°å½•</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>å®šä¹‰å…¨å±€å˜é‡</span><br><span class="line">filePath=</span><br><span class="line">inputFile() &#123;</span><br><span class="line">    #è¯»å–åˆ°å˜é‡ä¸­</span><br><span class="line">    read -a filePath</span><br><span class="line">&#125;</span><br><span class="line">inputFile</span><br><span class="line">crashPath=$filePath</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>inputFile</code> æ–¹æ³•æ¥äº†è§£ä¸€ä¸‹ï¼Œé¦–å…ˆå®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ä¸º <code>filePath</code>ï¼Œåœ¨æ–¹æ³•ä¸­é‡æ–°èµ‹å€¼ï¼Œæ–¹æ³•ç»“æŸåè¯»å–å…¨å±€å˜é‡ä¸­çš„æ•°æ®ã€‚</p><p>è¿™ç§æ–¹æ³•çš„å¥½å¤„æ˜¯å¯ä»¥è‡ªå®šä¹‰è¿”å›å‚æ•°ç±»å‹å’Œä¸ªæ•°ï¼Œç¼ºç‚¹æ˜¯å®¹æ˜“å’Œå…¶ä»–å˜é‡ææ··ã€‚</p><h4 id="Returnè¿”å›å€¼"><a href="#Returnè¿”å›å€¼" class="headerlink" title="Returnè¿”å›å€¼"></a>Returnè¿”å›å€¼</h4><p>ç±»ä¼¼ä¸Cè¯­è¨€ä¸­çš„ç”¨æ³•ï¼Œè„šæœ¬ä¹Ÿæ”¯æŒ <code>retrun 0</code> è¿”å›ç»“æœå¹¶åœæ­¢è¿è¡Œã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">checkUUID() &#123;</span><br><span class="line">    grep "$arm64id" "$1"</span><br><span class="line">    if [ $? -ne 0 ]; then</span><br><span class="line">        return 1;</span><br><span class="line">    fi</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">checkUUID "$crashPath" "$dsymPath"</span><br><span class="line">match=$?</span><br></pre></td></tr></table></figure><p>è·å–ç»“æœçš„æ–¹å¼ä¸º <code>$?</code>ï¼Œå…¶èƒ½å¤Ÿè¿”å›ç¯å¢ƒä¸­æœ€åä¸€ä¸ªæŒ‡ä»¤ç»“æœï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰æ‰§è¡Œçš„<code>checkUUID</code>çš„ç»“æœã€‚</p><p>ä¼˜ç‚¹æ˜¯ç®€æ´æ˜äº†ï¼Œç¬¦åˆç¼–ç ä¹ æƒ¯ï¼Œç¼ºç‚¹æ˜¯è¿”å›å€¼åªèƒ½æ˜¯ <code>0-255</code> çš„æ•°å­—ï¼Œä¸èƒ½è¿”å›å…¶ä»–ç±»å‹çš„æ•°æ®ã€‚</p><h4 id="è·å–æ‰“å°å€¼"><a href="#è·å–æ‰“å°å€¼" class="headerlink" title="è·å–æ‰“å°å€¼"></a>è·å–æ‰“å°å€¼</h4><p>è¿˜æœ‰ä¸€ç§æ–¹æ³•å…¶å®å¹³æ—¶ä¸€ç›´åœ¨ä½¿ç”¨ï¼Œåªä¸è¿‡å¹¶ä¸äº†è§£å…¶è¿è¡Œæ–¹å¼ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">crashName=`basename $crashPath`</span><br><span class="line"></span><br><span class="line">print() &#123;</span><br><span class="line">    echo "Hello World"</span><br><span class="line">&#125;</span><br><span class="line">text=$(print)</span><br></pre></td></tr></table></figure></p><p>è¿è¡Œç³»ç»Ÿé¢„è®¾çš„æ–¹æ³•æˆ–è€…è‡ªå®šä¹‰æ–¹æ³•ï¼Œå°†æ‰§è¡Œå‘½ä»¤ç”¨ <code>$()</code> çš„æ–¹å¼ä½¿ç”¨ï¼Œå°±å¯ä»¥è·å–è¯¥å‘½ä»¤ä¸­æ‰€æœ‰æ‰“å°çš„ä¿¡æ¯ï¼Œèµ‹å€¼åˆ°å˜é‡å°±å¯ä»¥æ‹¿åˆ°éœ€è¦çš„è¿”å›å€¼ã€‚</p><p>ä¼˜ç‚¹æ˜¯åŠŸèƒ½å…¨æ•ˆç‡é«˜ï¼Œä½¿ç”¨å­—ç¬¦ä¸²çš„æ–¹å¼å¯ä»¥ä¼ é€’å®šåˆ¶åŒ–ä¿¡æ¯ï¼Œç¼ºç‚¹æ˜¯ä¸å¯é¢„æœŸè¿”å›ç»“æœï¼Œéœ€è¦é€šè¿‡å­—ç¬¦ä¸²æŸ¥æ‰¾ç­‰å‘½ä»¤è¾…åŠ©ã€‚</p><h3 id="å¾ªç¯è¾“å…¥åˆæ³•è·¯å¾„"><a href="#å¾ªç¯è¾“å…¥åˆæ³•è·¯å¾„" class="headerlink" title="å¾ªç¯è¾“å…¥åˆæ³•è·¯å¾„"></a>å¾ªç¯è¾“å…¥åˆæ³•è·¯å¾„</h3><p>åœ¨æˆ‘çš„è®¾æƒ³ä¸­ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥åŒ¹é…çš„ <code>dSYM</code> æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœä¸åŒ¹é…ï¼Œåˆ™é‡æ–°è¾“å…¥ï¼Œç›´åˆ°åˆæ³•ã€‚ä¸ºäº†æ”¯æŒåµŒå¥—ï¼Œéœ€è¦å®šä¹‰å±€éƒ¨å˜é‡æ§åˆ¶å¾ªç¯ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dsymSuccess=false</span><br><span class="line">while [ $dsymSuccess = false ]; do</span><br><span class="line">    #è¦æ±‚è¾“å…¥dSYMæ–‡ä»¶è·¯å¾„</span><br><span class="line">    inputFile 'Please Input dSYM File' 'dSYM'</span><br><span class="line">    dsymPath=$filePath</span><br><span class="line">    #æ£€æŸ¥æ˜¯å¦åŒ¹é…</span><br><span class="line">    checkUUID "$crashPath" "$dsymPath"</span><br><span class="line">    match=$?</span><br><span class="line">    if [ $match -eq 0 ]; then</span><br><span class="line">        echo 'UUID not match!'</span><br><span class="line">    else</span><br><span class="line">        dsymSuccess=true</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p><h3 id="å¤„ç†å­—ç¬¦ä¸²"><a href="#å¤„ç†å­—ç¬¦ä¸²" class="headerlink" title="å¤„ç†å­—ç¬¦ä¸²"></a>å¤„ç†å­—ç¬¦ä¸²</h3><p>è·å–åˆ° <code>UUID</code> æ‰€æœ‰è¾“å‡ºä¿¡æ¯åï¼Œéœ€è¦æˆªå–å‡ºå¯¹åº”å¹³å°çš„ä¿¡æ¯ï¼Œå¤„ç†è¿˜æ˜¯ä¸å¤ªç†Ÿæ‚‰ï¼Œç‰¹åœ°æ•´ç†å¦‚ä¸‹<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>åŸå§‹ä¿¡æ¯</span><br><span class="line">UUID: 92E495AA-C2D4-3E9F-A759-A50AAEF446CD (armv7) /Volumes/.dSYM/Contents/Resources/DWARF/app</span><br><span class="line">UUID: 536527A8-0243-34DB-AE08-F1F64ACA4351 (arm64) /Volumes/.dSYM/Contents/Resources/DWARF/app</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>å»é™¤ä¸­é—´é—´éš”-</span><br><span class="line">uuid=$&#123;uuid//-/&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>ä»åå¾€å‰æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é… \(arm64çš„ï¼Œå¹¶ä¸”éƒ½åˆ é™¤</span><br><span class="line">arm64id=$&#123;uuid% \(arm64*&#125;</span><br><span class="line"><span class="meta">#</span>å¤„ç†å</span><br><span class="line">UUID: 92E495AAC2D43E9FA759A50AAEF446CD (armv7) /Volumes/.dSYM/Contents/Resources/DWARF/app</span><br><span class="line">UUID: 536527A8024334DBAE08F1F64ACA4351</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>ä»å‰å¾€åæ‰¾æœ€åä¸€ä¸ªUUID: ï¼Œå¹¶åˆ é™¤</span><br><span class="line">arm64id=$&#123;arm64id##*UUID: &#125;</span><br><span class="line"><span class="meta">#</span>å¤„ç†å </span><br><span class="line">536527A8024334DBAE08F1F64ACA4351</span><br></pre></td></tr></table></figure></p><hr><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>çœ‹ä¼¼ç®€å•çš„è„šæœ¬ï¼Œä¹ŸèŠ±äº†ä¸€å¤©æ—¶é—´ç¼–å†™ï¼Œæ€»ä½“è¿˜æ˜¯ä¸å¤ªç†Ÿç»ƒï¼Œä»éœ€åŠªåŠ›è”ç³»ã€‚</p><p>è¿™æ¬¡ç‰¹åœ°å°è¯•äº†ä¸ä¸Šæ¬¡ä¸åŒçš„å‚æ•°è¾“å…¥æ–¹æ³•ï¼Œä½¿ç”¨æç¤ºè¾“å…¥çš„æ–¹å¼ï¼Œæœç„¶é‡åˆ°äº†æ–°çš„é—®é¢˜ã€‚å¥½åœ¨éƒ½æŸ¥èµ„æ–™è§£å†³äº†ï¼Œç»“æœè¿˜ç®—æ»¡æ„ã€‚</p><p>è„šæœ¬æˆ‘æäº¤åˆ°äº†<a href="https://github.com/VanchChen/AnalysisCrash" target="_blank" rel="noopener">Github</a>ï¼Œæ¬¢è¿å¤§å®¶æŒ‡æ•™å…±åŒè¿›æ­¥ï¼ç»™ä¸ªå…³æ³¨æœ€å¥½å•¦ï½</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;å½“æˆ‘ä»¬æ‰“åŒ…appæ—¶ï¼Œå¯ä»¥é€‰æ‹©ç”Ÿæˆå¯¹åº”çš„ç¬¦å·è¡¨ï¼Œå…¶ä¿å­˜ 16 è¿›åˆ¶å‡½æ•°åœ°å€æ˜ å°„ä¿¡æ¯ï¼Œé€šè¿‡ç»™å®šçš„å‡½æ•°èµ·å§‹åœ°å€å’Œåç§»é‡ï¼Œå¯ä»¥å¯¹åº”å‡½æ•°å…·ä½“ä¿¡æ¯ä»¥ä¾›åˆ†
      
    
    </summary>
    
      <category term="Shell" scheme="https://vanchchen.github.io/categories/Shell/"/>
    
    
      <category term="æ•ˆç‡å·¥å…·" scheme="https://vanchchen.github.io/tags/%E6%95%88%E7%8E%87%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>AssociatedObjectå…³è”å¯¹è±¡åŸç†å®ç°</title>
    <link href="https://vanchchen.github.io/p/f39e.html"/>
    <id>https://vanchchen.github.io/p/f39e.html</id>
    <published>2018-09-29T09:55:21.000Z</published>
    <updated>2018-10-16T01:15:41.975Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>å…³è”å¯¹è±¡ï¼ˆAssociatedObjectï¼‰æ˜¯Objective-C 2.0è¿è¡Œæ—¶çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå…è®¸å¼€å‘è€…å¯¹å·²ç»å­˜åœ¨çš„ç±»åœ¨æ‰©å±•ä¸­æ·»åŠ è‡ªå®šä¹‰çš„å±æ€§ã€‚åœ¨å®é™…ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æ–¹å¼æ˜¯ç»™åˆ†ç±»ï¼ˆCategoryï¼‰æ·»åŠ æˆå‘˜å˜é‡ã€‚</p><h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">AssociatedObject</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> property;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">AssociatedObject</span>)</span></span><br><span class="line"><span class="keyword">@dynamic</span> property;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)property &#123;</span><br><span class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setProperty:(<span class="built_in">NSString</span> *)property &#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(property), property, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡å®ç°ä»£ç å¯ä»¥ç¨å¾®åˆ†æä¸‹ï¼Œ<code>objc_getAssociatedObject</code> æ‹¿ç€ä¸å˜çš„æŒ‡é’ˆåœ°å€ï¼ˆç¤ºä¾‹ä¼ å…¥selectorä½œä¸ºå‚æ•°ï¼Œå®é™…æ˜¯void*ï¼‰ï¼Œä»å®ä¾‹ä¸­è·å–éœ€è¦çš„å¯¹è±¡ã€‚<code>objc_setAssociatedObject</code> æ ¹æ®ä¼ å…¥çš„å‚æ•°åè®®ï¼Œä¿å­˜æŒ‡å®šçš„å¯¹è±¡ã€‚</p><h3 id="å‚æ•°åè®®"><a href="#å‚æ•°åè®®" class="headerlink" title="å‚æ•°åè®®"></a>å‚æ•°åè®®</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> OBJC_ENUM(uintptr_t, objc_AssociationPolicy) &#123;</span><br><span class="line">    OBJC_ASSOCIATION_ASSIGN = <span class="number">0</span>,           <span class="comment">/**&lt; Specifies a weak reference to the associated object. */</span></span><br><span class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = <span class="number">1</span>, <span class="comment">/**&lt; Specifies a strong reference to the associated object. The association is not made atomically. */</span></span><br><span class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = <span class="number">3</span>,   <span class="comment">/**&lt; Specifies that the associated object is copied. The association is not made atomically. */</span></span><br><span class="line">    OBJC_ASSOCIATION_RETAIN = <span class="number">01401</span>,       <span class="comment">/**&lt; Specifies a strong reference to the associated object. The association is made atomically. */</span></span><br><span class="line">    OBJC_ASSOCIATION_COPY = <span class="number">01403</span>          <span class="comment">/**&lt; Specifies that the associated object is copied. The association is made atomically. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶å®è¿™äº”ä¸ªåè®®å°±æ˜¯æˆ‘ä»¬å¹³æ—¶å®šä¹‰å±æ€§æ—¶ä½¿ç”¨çš„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶è‹¹æœåœ¨æ³¨é‡Šä¸­è¯´ <code>OBJC_ASSOCIATION_ASSIGN</code> ç›¸å½“äºä¸€ä¸ª <code>weak reference</code>ï¼Œä½†å…¶å®ç­‰äº <code>assign/unsafe_unretained</code>ã€‚</p><p>å¯¹äºä¸<code>weak</code>çš„åŒºåˆ«ä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´å†…ï¼Œæµ…æ˜¾çš„åŒºåˆ«åœ¨äºå˜é‡é‡Šæ”¾åï¼Œ<code>weak</code> ä¼šæŠŠå¼•ç”¨ç½®ç©ºï¼Œ<code>unsafe_unretained</code>ä¼šä¿ç•™å†…å­˜åœ°å€ï¼Œä¸€æ—¦è·å–å¯èƒ½ä¼šé‡æŒ‡é’ˆé—ªé€€ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœç±»è¦æ·»åŠ å˜é‡ï¼Œåªæœ‰åœ¨<code>objc_allocateClassPair</code>ä¸<code>objc_registerClassPair</code>ä¹‹é—´<code>addIvar</code>ã€‚ç­‰ç±»æ³¨å†Œåï¼Œå˜é‡ç»“æ„å°±ä¸å…è®¸å†è¢«æ”¹å˜ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢ä¸¤ä¸ªç›¸åŒç±»çš„å®ä¾‹æ‹¥æœ‰ä¸åŒå˜é‡å¯¼è‡´è¿è¡Œå›°æƒ‘ã€‚</p><p>é‚£ä¹ˆåœ¨runtimeæ—¶ç»™å®ä¾‹æ·»åŠ å˜é‡ï¼Œåˆä¸æ”¹å˜ç±»å†…éƒ¨å˜é‡ç»“æ„ï¼Œå…³è”å¯¹è±¡å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„åšæ³•ã€‚</p><hr><h2 id="å…³è”å¯¹è±¡çš„å®ç°"><a href="#å…³è”å¯¹è±¡çš„å®ç°" class="headerlink" title="å…³è”å¯¹è±¡çš„å®ç°"></a>å…³è”å¯¹è±¡çš„å®ç°</h2><h3 id="å¤–éƒ¨æ–¹æ³•"><a href="#å¤–éƒ¨æ–¹æ³•" class="headerlink" title="å¤–éƒ¨æ–¹æ³•"></a>å¤–éƒ¨æ–¹æ³•</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Sets an associated value for a given object using a given key and association policy.</span></span><br><span class="line"><span class="keyword">void</span> objc_setAssociatedObject(<span class="keyword">id</span> object, <span class="keyword">const</span> <span class="keyword">void</span> * key, <span class="keyword">id</span> value, objc_AssociationPolicy policy);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Returns the value associated with a given object for a given key.</span></span><br><span class="line"><span class="keyword">id</span> objc_getAssociatedObject(<span class="keyword">id</span> object, <span class="keyword">const</span> <span class="keyword">void</span> * key);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Removes all associations for a given object.</span></span><br><span class="line"><span class="keyword">void</span> objc_removeAssociatedObjects(<span class="keyword">id</span> object);</span><br></pre></td></tr></table></figure><p>ç›¸æ¯”åˆšåˆšä¾‹å­ä¸­çš„ç”¨æ³•ï¼Œå¤šäº†ä¸€ä¸ª<code>objc_removeAssociatedObjects</code>ï¼Œé‚£ä¹ˆå¯ä¸å¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•æ¥åˆ é™¤ä¸ç”¨çš„å…³è”å¯¹è±¡å‘¢ï¼Ÿ</p><p>è‹¹æœçš„æ–‡æ¡£ä¸­è§£é‡Šè¯´è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨æ¥è¿˜åŸå¯¹è±¡åˆ°ç±»åˆå§‹çš„çŠ¶æ€ï¼Œä¼šç§»é™¤æ‰€æœ‰çš„å…³è”ï¼ŒåŒ…æ‹¬å…¶ä»–æ¨¡å—æ·»åŠ çš„ï¼Œå› æ­¤åº”è¯¥ç”¨ <code>objc_setAssociatedObject(..,nil,..)</code> çš„æ–¹å¼å»å¸è½½ã€‚</p><hr><h3 id="Setterå®ç°"><a href="#Setterå®ç°" class="headerlink" title="Setterå®ç°"></a>Setterå®ç°</h3><p><code>objc_setAssociatedObject</code>å®é™…è°ƒç”¨çš„æ˜¯<code>_object_set_associative_reference</code></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _object_set_associative_reference(<span class="keyword">id</span> object, <span class="keyword">void</span> *key, <span class="keyword">id</span> value, uintptr_t policy) &#123;</span><br><span class="line">    <span class="comment">// retain the new value (if any) outside the lock.</span></span><br><span class="line">    ObjcAssociation old_association(<span class="number">0</span>, <span class="literal">nil</span>);</span><br><span class="line">    <span class="keyword">id</span> new_value = value ? acquireValue(value, policy) : <span class="literal">nil</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        AssociationsManager manager;</span><br><span class="line">        AssociationsHashMap &amp;associations(manager.associations());</span><br><span class="line">        disguised_ptr_t disguised_object = DISGUISE(object);</span><br><span class="line">        <span class="keyword">if</span> (new_value) &#123;</span><br><span class="line">            <span class="comment">// break any existing association.</span></span><br><span class="line">            AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line">            <span class="keyword">if</span> (i != associations.end()) &#123;</span><br><span class="line">                <span class="comment">// secondary table exists</span></span><br><span class="line">                ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">                ObjectAssociationMap::iterator j = refs-&gt;find(key);</span><br><span class="line">                <span class="keyword">if</span> (j != refs-&gt;end()) &#123;</span><br><span class="line">                    old_association = j-&gt;second;</span><br><span class="line">                    j-&gt;second = ObjcAssociation(policy, new_value);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    (*refs)[key] = ObjcAssociation(policy, new_value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// create the new association (first time).</span></span><br><span class="line">                ObjectAssociationMap *refs = new ObjectAssociationMap;</span><br><span class="line">                associations[disguised_object] = refs;</span><br><span class="line">                (*refs)[key] = ObjcAssociation(policy, new_value);</span><br><span class="line">                object-&gt;setHasAssociatedObjects();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// setting the association to nil breaks the association.</span></span><br><span class="line">            AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line">            <span class="keyword">if</span> (i !=  associations.end()) &#123;</span><br><span class="line">                ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">                ObjectAssociationMap::iterator j = refs-&gt;find(key);</span><br><span class="line">                <span class="keyword">if</span> (j != refs-&gt;end()) &#123;</span><br><span class="line">                    old_association = j-&gt;second;</span><br><span class="line">                    refs-&gt;erase(j);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// release the old value (outside of the lock).</span></span><br><span class="line">    <span class="keyword">if</span> (old_association.hasValue()) ReleaseValue()(old_association);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> acquireValue(<span class="keyword">id</span> value, uintptr_t policy) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (policy &amp; <span class="number">0xFF</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> OBJC_ASSOCIATION_SETTER_RETAIN:</span><br><span class="line">        <span class="keyword">return</span> objc_retain(value);</span><br><span class="line">    <span class="keyword">case</span> OBJC_ASSOCIATION_SETTER_COPY:</span><br><span class="line">        <span class="keyword">return</span> ((<span class="keyword">id</span>(*)(<span class="keyword">id</span>, SEL))objc_msgSend)(value, SEL_copy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> releaseValue(<span class="keyword">id</span> value, uintptr_t policy) &#123;</span><br><span class="line">    <span class="keyword">if</span> (policy &amp; OBJC_ASSOCIATION_SETTER_RETAIN) &#123;</span><br><span class="line">        <span class="keyword">return</span> objc_release(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ObjcAssociation old_association(<span class="number">0</span>, <span class="literal">nil</span>);</span><br><span class="line"><span class="keyword">id</span> new_value = value ? acquireValue(value, policy) : <span class="literal">nil</span>;</span><br><span class="line">&#123;</span><br><span class="line">    old_association = ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (old_association.hasValue()) ReleaseValue()(old_association);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‘˜å‡ºä¸å¯¹è±¡å†…å­˜ç›¸å…³çš„ä»£ç ä»”ç»†åˆ†æä¸‹ï¼Œé¦–å…ˆæŠŠæ–°ä¼ å…¥çš„å¯¹è±¡ï¼Œæ ¹æ®åè®®è¿›è¡Œ<code>retain/copy</code>ï¼Œåœ¨èµ‹å€¼çš„è¿‡ç¨‹ä¸­è·å–æ—§å€¼ï¼Œåœ¨æ–¹æ³•ç»“æŸå‰<code>release</code>ã€‚</p><hr><h4 id="èµ‹å€¼"><a href="#èµ‹å€¼" class="headerlink" title="èµ‹å€¼"></a>èµ‹å€¼</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">AssociationsManager manager;</span><br><span class="line">AssociationsHashMap &amp;associations(manager.associations());</span><br><span class="line">disguised_ptr_t disguised_object = DISGUISE(object);</span><br><span class="line"><span class="keyword">if</span> (new_value) &#123;</span><br><span class="line">    <span class="comment">//éœ€è¦èµ‹å€¼</span></span><br><span class="line">    AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line">    <span class="keyword">if</span> (i != associations.end()) &#123;</span><br><span class="line">        <span class="comment">//æ‰¾åˆ°äº†è¿™ä¸ªå¯¹è±¡çš„å…³è”è¡¨</span></span><br><span class="line">        ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">        ObjectAssociationMap::iterator j = refs-&gt;find(key);</span><br><span class="line">        <span class="keyword">if</span> (j != refs-&gt;end()) &#123;</span><br><span class="line">            <span class="comment">//æ‰¾åˆ°äº†è¿™ä¸ªkeyçš„å…³è”å¯¹è±¡</span></span><br><span class="line">            old_association = j-&gt;second;</span><br><span class="line">            j-&gt;second = ObjcAssociation(policy, new_value);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//æ²¡æ‰¾åˆ°ï¼Œæ–°å¢ä¸€ä¸ªå…³è”</span></span><br><span class="line">            (*refs)[key] = ObjcAssociation(policy, new_value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//æ²¡æ‰¾åˆ°ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å…³è”è¡¨</span></span><br><span class="line">        ObjectAssociationMap *refs = new ObjectAssociationMap;</span><br><span class="line">        associations[disguised_object] = refs;</span><br><span class="line">        (*refs)[key] = ObjcAssociation(policy, new_value);</span><br><span class="line">        object-&gt;setHasAssociatedObjects();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆäº†è§£ä¸€ä¸‹<code>AssociationsManager</code>ä¸<code>AssociationsHashMap</code><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> AssociationsManager &#123;</span><br><span class="line">    <span class="keyword">static</span> AssociationsHashMap *_map;</span><br><span class="line">public:</span><br><span class="line">    AssociationsHashMap &amp;associations() &#123;</span><br><span class="line">        <span class="keyword">if</span> (_map == <span class="literal">NULL</span>)</span><br><span class="line">            _map = new AssociationsHashMap();</span><br><span class="line">        <span class="keyword">return</span> *_map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> AssociationsHashMap : public unordered_map&lt;disguised_ptr_t, ObjectAssociationMap *, DisguisedPointerHash, DisguisedPointerEqual, AssociationsHashMapAllocator&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> ObjectAssociationMap : public std::map&lt;<span class="keyword">void</span> *, ObjcAssociation, ObjectPointerLess, ObjectAssociationMapAllocator&gt;ï¼›</span><br></pre></td></tr></table></figure></p><p><code>AssociationsManager</code>é€šè¿‡ä¸€ä¸ªä»¥æŒ‡é’ˆåœ°å€ä¸ºä¸»é”®ï¼Œå€¼ä¸ºå…³è”è¡¨çš„å“ˆå¸Œè¡¨ï¼Œæ¥ç®¡ç†åº”ç”¨å†…æ‰€æœ‰çš„å…³è”å¯¹è±¡ã€‚</p><p>é¦–å…ˆä»¥å¯¹è±¡çš„æŒ‡é’ˆåœ°å€å»å¯»æ‰¾å…³è”è¡¨ï¼Œå†é€šè¿‡æŒ‡å®šçš„é”®å€¼æŸ¥æ‰¾å…³è”å…³ç³»ï¼Œä»è€Œè·å–å…³è”å¯¹è±¡ã€‚</p><h4 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line"><span class="keyword">if</span> (i !=  associations.end()) &#123;</span><br><span class="line">    ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">    ObjectAssociationMap::iterator j = refs-&gt;find(key);</span><br><span class="line">    <span class="keyword">if</span> (j != refs-&gt;end()) &#123;</span><br><span class="line">        old_association = j-&gt;second;</span><br><span class="line">        refs-&gt;erase(j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œä¿®æ”¹æ–¹æ³•ç±»ä¼¼ï¼Œæ‰¾åˆ°å…³è”å…³ç³»åï¼Œæ‰§è¡Œå“ˆå¸Œè¡¨çš„<code>erase</code>æ–¹æ³•åˆ é™¤ã€‚</p><hr><h3 id="Getterå®ç°"><a href="#Getterå®ç°" class="headerlink" title="Getterå®ç°"></a>Getterå®ç°</h3><p><code>objc_getAssociatedObject</code>å®é™…è°ƒç”¨çš„æ˜¯<code>_object_get_associative_reference</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">id _object_get_associative_reference(id object, <span class="keyword">void</span> *key) &#123;</span><br><span class="line">    id value = nil;</span><br><span class="line">    <span class="keyword">uintptr_t</span> policy = OBJC_ASSOCIATION_ASSIGN;</span><br><span class="line">    &#123;</span><br><span class="line">        AssociationsManager manager;</span><br><span class="line">        AssociationsHashMap &amp;associations(manager.associations());</span><br><span class="line">        <span class="keyword">disguised_ptr_t</span> disguised_object = DISGUISE(object);</span><br><span class="line">        AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line">        <span class="keyword">if</span> (i != associations.end()) &#123;</span><br><span class="line">            ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">            ObjectAssociationMap::iterator j = refs-&gt;find(key);</span><br><span class="line">            <span class="keyword">if</span> (j != refs-&gt;end()) &#123;</span><br><span class="line">                ObjcAssociation &amp;entry = j-&gt;second;</span><br><span class="line">                value = entry.value();</span><br><span class="line">                policy = entry.policy();</span><br><span class="line">                <span class="keyword">if</span> (policy &amp; OBJC_ASSOCIATION_GETTER_RETAIN) &#123;</span><br><span class="line">                    objc_retain(value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (value &amp;&amp; (policy &amp; OBJC_ASSOCIATION_GETTER_AUTORELEASE)) &#123;</span><br><span class="line">        objc_autorelease(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥æ‰¾å“ˆå¸Œè¡¨çš„æ–¹æ³•å’ŒSetterä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äºå¦‚æœç­–ç•¥ä¸­éœ€è¦retainå’Œautoreleaseçš„è¯ï¼Œéƒ½éœ€è¦å¤„ç†ã€‚é‚£ä¹ˆæ˜¯æ€ä¹ˆçº¦å®šè¿™äº›ç­–ç•¥å‘¢ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123; </span><br><span class="line">    OBJC_ASSOCIATION_SETTER_ASSIGN      = <span class="number">0</span>,</span><br><span class="line">    OBJC_ASSOCIATION_SETTER_RETAIN      = <span class="number">1</span>,</span><br><span class="line">    OBJC_ASSOCIATION_SETTER_COPY        = <span class="number">3</span>,            <span class="comment">// <span class="doctag">NOTE:</span>  both bits are set, so we can simply test 1 bit in releaseValue below.</span></span><br><span class="line">    OBJC_ASSOCIATION_GETTER_READ        = (<span class="number">0</span> &lt;&lt; <span class="number">8</span>), </span><br><span class="line">    OBJC_ASSOCIATION_GETTER_RETAIN      = (<span class="number">1</span> &lt;&lt; <span class="number">8</span>), </span><br><span class="line">    OBJC_ASSOCIATION_GETTER_AUTORELEASE = (<span class="number">2</span> &lt;&lt; <span class="number">8</span>)</span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">OBJC_ENUM</span><span class="params">(<span class="keyword">uintptr_t</span>, objc_AssociationPolicy)</span> </span>&#123;</span><br><span class="line">    OBJC_ASSOCIATION_ASSIGN = <span class="number">0</span>,</span><br><span class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = <span class="number">1</span>,</span><br><span class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = <span class="number">3</span>,</span><br><span class="line">    OBJC_ASSOCIATION_RETAIN = <span class="number">01401</span>, </span><br><span class="line">    OBJC_ASSOCIATION_COPY = <span class="number">01403</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>OBJC_ASSOCIATION_RETAIN = 01401</code>ï¼Œå…¶ä¸­<code>01401</code>å¼€å¤´æ˜¯<code>0</code>ï¼Œæ‰€ä»¥æ˜¯å…«è¿›åˆ¶æ•°å­—ï¼Œç¿»è¯‘ä¸ºäºŒè¿›åˆ¶å°±æ˜¯<code>0000 0011 0000 0001</code>ï¼Œå–ä½åˆ¤æ–­å°±æ˜¯<code>OBJC_ASSOCIATION_SETTER_RETAIN</code> <code>OBJC_ASSOCIATION_GETTER_RETAIN</code> <code>OBJC_ASSOCIATION_GETTER_AUTORELEASE</code>ã€‚</p><p>åœ¨ä¿å­˜çš„æ—¶å€™ï¼Œéœ€è¦<code>retain</code>ï¼Œåœ¨è·å–çš„æ—¶å€™ï¼Œéœ€è¦å…ˆ<code>retain</code>å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå†æ‰§è¡Œ<code>autorelease</code>ç­‰å¾…é‡Šæ”¾ï¼Œä»è€Œå®ç°åŸå­æ€§ã€‚</p><h3 id="Removeå®ç°"><a href="#Removeå®ç°" class="headerlink" title="Removeå®ç°"></a>Removeå®ç°</h3><p><code>objc_removeAssociatedObjects</code>ä¼šåˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜åœ¨å…³è”ï¼Œç„¶åå†æ‰§è¡Œ<code>_object_set_associative_reference</code><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _object_remove_assocations(id object) &#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt; ObjcAssociation,ObjcAllocator&lt;ObjcAssociation&gt; &gt; elements;</span><br><span class="line">    &#123;</span><br><span class="line">        AssociationsManager manager;</span><br><span class="line">        AssociationsHashMap &amp;associations(manager.associations());</span><br><span class="line">        <span class="keyword">if</span> (associations.size() == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">disguised_ptr_t</span> disguised_object = DISGUISE(object);</span><br><span class="line">        AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line">        <span class="keyword">if</span> (i != associations.end()) &#123;</span><br><span class="line">            <span class="comment">// copy all of the associations that need to be removed.</span></span><br><span class="line">            ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">            <span class="keyword">for</span> (ObjectAssociationMap::iterator j = refs-&gt;begin(), end = refs-&gt;end(); j != end; ++j) &#123;</span><br><span class="line">                elements.push_back(j-&gt;second);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// remove the secondary table.</span></span><br><span class="line">            <span class="keyword">delete</span> refs;</span><br><span class="line">            associations.erase(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// the calls to releaseValue() happen outside of the lock.</span></span><br><span class="line">    for_each(elements.begin(), elements.end(), ReleaseValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å®ç°æ–¹å¼ä¹Ÿå¯ä»¥çœ‹å‡ºä¸ºä»€ä¹ˆåœ¨ä»‹ç»é‡Œä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºä¼šéå†æ‰€æœ‰çš„å…³è”å¯¹è±¡ï¼Œå¹¶ä¸”å…¨éƒ¨é‡Šæ”¾ï¼Œå¯èƒ½ä¼šé€ æˆåˆ«çš„æ¨¡å—åŠŸèƒ½ç¼ºé™·ã€‚</p><h4 id="åˆ¤æ–­å…³è”å¯¹è±¡"><a href="#åˆ¤æ–­å…³è”å¯¹è±¡" class="headerlink" title="åˆ¤æ–­å…³è”å¯¹è±¡"></a>åˆ¤æ–­å…³è”å¯¹è±¡</h4><p>æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯åˆ¤æ–­å¯¹è±¡æ˜¯å¦æœ‰å…³è”å¯¹è±¡çš„å®ç°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="keyword">bool</span> objc_object::hasAssociatedObjects()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (isa.nonpointer) <span class="keyword">return</span> isa.has_assoc;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="keyword">void</span> objc_object::setHasAssociatedObjects()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"> retry:</span><br><span class="line">    <span class="keyword">isa_t</span> oldisa = LoadExclusive(&amp;isa.bits);</span><br><span class="line">    <span class="keyword">isa_t</span> newisa = oldisa;</span><br><span class="line">    <span class="keyword">if</span> (!newisa.nonpointer  ||  newisa.has_assoc) &#123;</span><br><span class="line">        ClearExclusive(&amp;isa.bits);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    newisa.has_assoc = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits)) <span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤è¿”å›çš„ç»“æœéƒ½æ˜¯<code>true</code>ï¼Œåªæœ‰åœ¨64ä½ç³»ç»Ÿä¸‹ï¼Œæ‰ä¿å­˜ä¸€ä¸ªæ ‡è®°ä½ã€‚è¿™ä¹ˆå¤„ç†æˆ‘æ¨æµ‹æ˜¯ä¸ºäº†åŠ å¿«é‡Šæ”¾å‘¨æœŸé€Ÿåº¦ï¼Œåœ¨ææ„å¯¹è±¡æ—¶ï¼Œä¼šæ ¹æ®è¿™ä¸ªæ–¹æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦é‡Šæ”¾å…³è”å¯¹è±¡ã€‚è¯•æƒ³å¦‚æœæ¯æ¬¡éƒ½æŸ¥è¯¢å“ˆå¸Œè¡¨ï¼Œæ‰§è¡Œæ•ˆç‡å¿…å®šä¼šé™ä½ï¼Œä¸å¦‚éƒ½å…ˆé€šè¿‡ï¼Œä¹‹åå†åšå¤„ç†ã€‚</p><blockquote><p>å…³äº<code>nonpointer</code>ä¸åœ¨æœ¬æ–‡ä»‹ç»èŒƒå›´å†…ï¼Œç®€å•æè¿°ä¸ºåœ¨64ä½ç³»ç»Ÿä¸‹ï¼ŒæŒ‡é’ˆåœ°å€ä¿å­˜ä¸ä»…ä»…ä¸ºå†…å­˜åœ°å€ï¼Œè¿˜å­˜æœ‰å…¶ä»–æ ‡è®°ä¿¡æ¯ï¼ŒåŒ…æ‹¬æœ¬æ–‡æ¶‰åŠçš„has_assocã€‚</p><p><code>taggedPointer</code>æ˜¯ä¸€ç§ä¼˜åŒ–ç­–ç•¥ï¼ŒæŠŠç®€å•çš„æ•°å­—æˆ–å­—ç¬¦ä¸²ä¿¡æ¯ç›´æ¥ä¿å­˜åœ¨æŒ‡é’ˆåœ°å€ä¸­ï¼Œä»è€Œä¸ç”³è¯·é¢å¤–å†…å­˜åŠ å¿«è¿è¡Œæ•ˆç‡ã€‚</p></blockquote><h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å…³è”å¯¹è±¡çš„å®ç°ä¸å¤æ‚ï¼Œä¿å­˜çš„æ–¹å¼ä¸ºä¸€ä¸ªå…¨å±€çš„å“ˆå¸Œè¡¨ï¼Œå­˜å–éƒ½é€šè¿‡æŸ¥è¯¢è¡¨æ‰¾åˆ°å…³è”æ¥æ‰§è¡Œã€‚å“ˆå¸Œè¡¨çš„ç‰¹ç‚¹å°±æ˜¯ç‰ºç‰²ç©ºé—´æ¢å–æ—¶é—´ï¼Œæ‰€ä»¥æ‰§è¡Œé€Ÿåº¦ä¹Ÿå¯ä»¥ä¿è¯ã€‚</p><hr><h2 id="é—®ç­”"><a href="#é—®ç­”" class="headerlink" title="é—®ç­”"></a>é—®ç­”</h2><h3 id="å…³è”å¯¹è±¡æœ‰ä»€ä¹ˆåº”ç”¨ï¼Ÿ"><a href="#å…³è”å¯¹è±¡æœ‰ä»€ä¹ˆåº”ç”¨ï¼Ÿ" class="headerlink" title="å…³è”å¯¹è±¡æœ‰ä»€ä¹ˆåº”ç”¨ï¼Ÿ"></a>å…³è”å¯¹è±¡æœ‰ä»€ä¹ˆåº”ç”¨ï¼Ÿ</h3><p>å…³è”å¯¹è±¡å¯ä»¥åœ¨è¿è¡Œæ—¶ç»™æŒ‡å®šå¯¹è±¡ç»‘å®šä¸€ä¸ªæœ‰ç”Ÿå‘½å‘¨æœŸçš„å˜é‡ã€‚</p><p>1.ç”±äºä¸æ”¹å˜åŸç±»çš„å®ç°ï¼Œæ‰€ä»¥å¯ä»¥ç»™åŸç”Ÿç±»æˆ–è€…æ˜¯æ‰“åŒ…çš„åº“è¿›è¡Œæ‰©å±•ï¼Œä¸€èˆ¬é…åˆCategoryå®ç°å®Œæ•´çš„åŠŸèƒ½ã€‚</p><p>2.ObjCç±»å®šä¹‰çš„å˜é‡ï¼Œç”±äºruntimeçš„ç‰¹æ€§ï¼Œéƒ½ä¼šæš´éœ²åˆ°å¤–éƒ¨ï¼Œä½¿ç”¨å…³è”å¯¹è±¡å¯ä»¥éšè—å…³é”®å˜é‡ï¼Œä¿è¯å®‰å…¨ã€‚</p><p>3.å¯ä»¥ç”¨äºKVOï¼Œä½¿ç”¨å…³è”å¯¹è±¡ä½œä¸ºè§‚å¯Ÿè€…ï¼Œå¯ä»¥é¿å…è§‚å¯Ÿè‡ªèº«å¯¼è‡´å¾ªç¯ã€‚</p><h3 id="ç³»ç»Ÿå¦‚ä½•ç®¡ç†å…³è”å¯¹è±¡ï¼Ÿ"><a href="#ç³»ç»Ÿå¦‚ä½•ç®¡ç†å…³è”å¯¹è±¡ï¼Ÿ" class="headerlink" title="ç³»ç»Ÿå¦‚ä½•ç®¡ç†å…³è”å¯¹è±¡ï¼Ÿ"></a>ç³»ç»Ÿå¦‚ä½•ç®¡ç†å…³è”å¯¹è±¡ï¼Ÿ</h3><p>ç³»ç»Ÿé€šè¿‡ç®¡ç†ä¸€ä¸ªå…¨å±€å“ˆå¸Œè¡¨ï¼Œé€šè¿‡å¯¹è±¡æŒ‡é’ˆåœ°å€å’Œä¼ é€’çš„å›ºå®šå‚æ•°åœ°å€æ¥è·å–å…³è”å¯¹è±¡ã€‚æ ¹æ®<code>setter</code>ä¼ å…¥çš„å‚æ•°åè®®ï¼Œæ¥ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><h3 id="å…¶è¢«é‡Šæ”¾çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨å°†å…¶æŒ‡é’ˆç½®ç©ºä¹ˆï¼Ÿ"><a href="#å…¶è¢«é‡Šæ”¾çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨å°†å…¶æŒ‡é’ˆç½®ç©ºä¹ˆï¼Ÿ" class="headerlink" title="å…¶è¢«é‡Šæ”¾çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨å°†å…¶æŒ‡é’ˆç½®ç©ºä¹ˆï¼Ÿ"></a>å…¶è¢«é‡Šæ”¾çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨å°†å…¶æŒ‡é’ˆç½®ç©ºä¹ˆï¼Ÿ</h3><p>å½“å¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œå¦‚æœè®¾ç½®çš„åè®®æ˜¯<code>OBJC_ASSOCIATION_ASSIGN</code>ï¼Œé‚£ä¹ˆä»–çš„å…³è”å¯¹è±¡ä¸ä¼šå‡å°‘å¼•ç”¨è®¡æ•°ï¼Œå…¶ä»–çš„åè®®éƒ½ä¼šå‡å°‘ä»è€Œé‡Šæ”¾å…³è”å¯¹è±¡ã€‚</p><p><code>unsafe_unretain</code>ä¸€èˆ¬è®¤ä¸ºå¤–éƒ¨æœ‰å¯¹è±¡æ§åˆ¶ï¼Œæ‰€ä»¥å¯¹è±¡ä¸ç”¨å¤„ç†ï¼Œå› æ­¤ä¸ç®¡ä»€ä¹ˆåè®®ï¼Œå¯¹è±¡é‡Šæ”¾æ—¶éƒ½æ— éœ€æ‰‹åŠ¨è®²å…³è”å¯¹è±¡ç½®ç©ºã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä»‹ç»&quot;&gt;&lt;/a&gt;ä»‹ç»&lt;/h2&gt;&lt;p&gt;å…³è”å¯¹è±¡ï¼ˆAssociatedObjectï¼‰æ˜¯Objective-C 2.0è¿è¡Œæ—¶çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå…è®¸å¼€å‘è€…å¯¹å·²ç»å­˜åœ¨çš„ç±»åœ¨æ‰©å±•ä¸­æ·»åŠ è‡ªå®šä¹‰çš„å±
      
    
    </summary>
    
      <category term="iOS" scheme="https://vanchchen.github.io/categories/iOS/"/>
    
    
      <category term="åŸç†åˆ†æ" scheme="https://vanchchen.github.io/tags/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>åˆè¯•Shellè„šæœ¬</title>
    <link href="https://vanchchen.github.io/p/3f22.html"/>
    <id>https://vanchchen.github.io/p/3f22.html</id>
    <published>2018-09-20T08:45:12.000Z</published>
    <updated>2018-12-07T06:16:35.757Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>ä¸´ä¸Šçº¿å‰æµ‹è¯•æ¯”è¾ƒåŠªåŠ›ï¼Œé‡åˆ°é—ªé€€æˆ–è€…å…¶ä»–é—®é¢˜ï¼Œä¼šæŠŠæ—¥å¿—åŒ…æ‰“ç»™æˆ‘ï¼Œç”±äºappå†…å­˜é™åˆ¶ï¼Œç›®å‰æ¯æ¬¡æ‰“åŒ…éƒ½æ˜¯1må¤§å°ï¼Œæ‰€ä»¥æœ‰æ—¶æŸ¥æ‰¾é—®é¢˜çš„ä¸Šä¸‹æ–‡æ¯”è¾ƒåƒåŠ›ã€‚åŒæ—¶ç”±äºæ—¥å¿—æ¯”è¾ƒå¤šï¼Œæ ¹æ®å…³é”®è¯è¿‡æ»¤çš„éœ€æ±‚è¶Šæ¥è¶Šé‡è¦ã€‚</p><p>äºæ˜¯å†³å®šå­¦å†™è„šæœ¬å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œæ ¹æ®æˆ‘çš„è¦æ±‚ï¼Œå·¥ä½œæµç¨‹åº”è¯¥æ˜¯ä¼ å…¥å‹ç¼©åŒ…ï¼Œæ ¹æ®åç¼€åè§£å‹ï¼Œæ ¹æ®æ—¥æœŸæ’åºååˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ï¼ŒæŒ‰éœ€è¿‡æ»¤å…³é”®è¯ã€‚</p><hr><h2 id="å…ˆä¸Šä»£ç "><a href="#å…ˆä¸Šä»£ç " class="headerlink" title="å…ˆä¸Šä»£ç "></a>å…ˆä¸Šä»£ç </h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/usr/bin/env bash</span><br><span class="line"><span class="meta">#</span> Created By Vanch at 2018/9/20</span><br><span class="line"></span><br><span class="line">printHelp() &#123;</span><br><span class="line">    echo "Uncompess log files from inputed zip"</span><br><span class="line">    echo "Then Merge these logs to one file"</span><br><span class="line">    echo "Supported file types: zip tar tar.gz tar.bz2"</span><br><span class="line">    echo</span><br><span class="line">    echo "Use -s for filtering socket result to socket.log"</span><br><span class="line">    echo </span><br><span class="line">    echo "Have fun!"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>å¦‚æœæ²¡è¾“å…¥å‚æ•°ï¼Œå°±æ‰“å°å¸®åŠ©ä¿¡æ¯</span><br><span class="line">if [ $# -eq 0 ]; then</span><br><span class="line">    printHelp</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>æŠŠé•¿é€‰é¡¹è½¬åˆ°çŸ­é€‰é¡¹</span><br><span class="line">for arg in "$@"; do</span><br><span class="line">  shift</span><br><span class="line">  case "$arg" in</span><br><span class="line">    "--help")       set -- "$@" "-h" ;;</span><br><span class="line">    "--version")    set -- "$@" "-v" ;;</span><br><span class="line">    "--list")       set -- "$@" "-l" ;;</span><br><span class="line">    *)              set -- "$@" "$arg"</span><br><span class="line">  esac</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span>è·å–çŸ­é€‰é¡¹</span><br><span class="line">OPTIND=1</span><br><span class="line">printS=false;</span><br><span class="line">while getopts "dmksahvl" opt; do</span><br><span class="line">    case $opt in</span><br><span class="line">        h) #è¾“å…¥ä¸ºhelpï¼Œå°±æ‰“å°å¸®åŠ©ä¿¡æ¯</span><br><span class="line">            printHelp</span><br><span class="line">            exit 0;;</span><br><span class="line">        l) #æ”¯æŒå•ç‹¬è·å–æ”¯æŒæ–‡ä»¶åç¼€åˆ—è¡¨</span><br><span class="line">            echo "Supported file types: zip tar tar.gz tar.bz2"</span><br><span class="line">            exit 0;;</span><br><span class="line">        v) #æ”¯æŒæŸ¥æ‰¾ç‰ˆæœ¬å·</span><br><span class="line">            echo "1.0.0"</span><br><span class="line">            exit 0;;</span><br><span class="line">        s) #è¿‡æ»¤Socket</span><br><span class="line">            printS=true;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>è·å¾—å‹ç¼©åŒ…åœ°å€</span><br><span class="line">file=$&#123;!#&#125;</span><br><span class="line"><span class="meta">#</span>å¦‚æœä¸å­˜åœ¨å°±é€€å‡º</span><br><span class="line">if [ ! -f "$file" ]; then</span><br><span class="line">    echo "File not exist!"</span><br><span class="line">    exit 0;</span><br><span class="line">fi </span><br><span class="line"><span class="meta">#</span>è·å–å‹ç¼©åç¼€</span><br><span class="line">fileName=`basename $file`</span><br><span class="line">suffix=$&#123;fileName#*.&#125;</span><br><span class="line"><span class="meta">#</span>åˆ¤æ–­æ–‡ä»¶ç±»å‹</span><br><span class="line">support=('tar','tar.gz','tar.bz2','zip')</span><br><span class="line">if [ -z `echo "$&#123;support[@]&#125;" | grep -w "$suffix"` ] ; then</span><br><span class="line">    echo "File type not support!"</span><br><span class="line">    exit 0;    </span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span>æ‹¼æ¥æ–‡ä»¶å¤¹åœ°å€</span><br><span class="line">fileDir=$(dirname $file)/$&#123;fileName%%.*&#125;</span><br><span class="line">if [ -d $fileDir ]; then</span><br><span class="line">    rm -rf $fileDir</span><br><span class="line">fi</span><br><span class="line">mkdir $fileDir</span><br><span class="line">cd $fileDir</span><br><span class="line"><span class="meta">#</span>è§£å‹æ–‡ä»¶</span><br><span class="line">case $suffix in</span><br><span class="line">    'tar')</span><br><span class="line">        eval "tar xvf $file &gt; /dev/null 2&gt;&amp;1";;</span><br><span class="line">    'tar.gz')</span><br><span class="line">        eval "tar zxvf $file &gt; /dev/null 2&gt;&amp;1";;</span><br><span class="line">    'tar.bz2')</span><br><span class="line">        eval "tar jxvf $file &gt; /dev/null 2&gt;&amp;1";;</span><br><span class="line">    'zip')</span><br><span class="line">        eval "unzip -o $file &gt; /dev/null 2&gt;&amp;1";;</span><br><span class="line">esac</span><br><span class="line">echo 'Uncompass Success!'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>è·å–æ—¥å¿—åˆ—è¡¨ï¼ŒæŒ‰æ’åºåˆå¹¶åˆ°ä¸€ä¸ªæ—¥å¿—</span><br><span class="line">mergeFile=./merge.log</span><br><span class="line">logCount=0</span><br><span class="line"><span class="meta">#</span>æœç´¢comå¼€å¤´çš„æ—¥å¿—ï¼ŒæŒ‰æ—¥æœŸæ’åºï¼Œç”¨ï¼Ÿä¸´æ—¶ä»£æ›¿ç©ºæ ¼</span><br><span class="line">for logName in `ls | grep 'com' | sort -n | tr " " "?"`; do</span><br><span class="line">    logName=$&#123;logName//'?'/' '&#125;</span><br><span class="line">    cat ./"$logName" &gt;&gt; $mergeFile</span><br><span class="line">    ((logCount++))</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span>ä¸å­˜åœ¨æ—¥å¿—å°±æ‰“æ–­</span><br><span class="line">if [ $logCount -eq 0 ]; then</span><br><span class="line">    echo "Log not exist!"</span><br><span class="line">    exit </span><br><span class="line">fi</span><br><span class="line">echo 'Merge Success!'</span><br><span class="line"><span class="meta">#</span>æ‰“å°socket</span><br><span class="line">if [ $printS = true ]; then</span><br><span class="line">    cat $mergeFile | grep -i 'socket' &gt;&gt; ./socket.log</span><br><span class="line">    echo 'Filter socket'</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><hr><h2 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h2><p>æŸ¥è¯¢äº†å¾ˆå¤šèµ„æ–™åå†™å®Œäº†è¿™ä¸ªè„šæœ¬ï¼ŒåŸºæœ¬æ»¡è¶³äº†æˆ‘çš„éœ€æ±‚ï¼Œä¸‹é¢æ€»ç»“ä¸€ä¸‹æ€ä¹ˆè§£å†³é‡åˆ°çš„é—®é¢˜ã€‚</p><h3 id="ä½¿ç”¨ç¯å¢ƒ"><a href="#ä½¿ç”¨ç¯å¢ƒ" class="headerlink" title="ä½¿ç”¨ç¯å¢ƒ"></a>ä½¿ç”¨ç¯å¢ƒ</h3><p>ä¸€å¼€å§‹å­¦è„šæœ¬æ—¶ï¼Œä¹¦ä¸Šéƒ½è¯´<code>#! /bin/bash</code>ï¼Œä½†æ˜¯çœ‹é¡¹ç›®ä¸­å¤§ç¥å†™çš„è„šæœ¬ï¼Œéƒ½æ˜¯<code>#!/usr/bin/env bash</code>ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p><blockquote><p>è„šæœ¬ç”¨envå¯åŠ¨çš„åŸå› ï¼Œæ˜¯å› ä¸ºè„šæœ¬è§£é‡Šå™¨åœ¨linuxä¸­å¯èƒ½è¢«å®‰è£…äºä¸åŒçš„ç›®å½•ï¼Œenvå¯ä»¥åœ¨ç³»ç»Ÿçš„PATHç›®å½•ä¸­æŸ¥æ‰¾ã€‚<br>åŒæ—¶ï¼Œenvè¿˜è§„å®šä¸€äº›ç³»ç»Ÿç¯å¢ƒå˜é‡ã€‚</p></blockquote><p>ä¸åŒçš„ç³»ç»Ÿï¼Œè§£é‡Šå™¨çš„è·¯å¾„å¯èƒ½ä¹Ÿä¸åŒï¼Œæ‰€ä»¥ä½¿ç”¨ç»å¯¹è·¯å¾„æ˜¯æ¯”è¾ƒå±é™©çš„æ–¹å¼ã€‚é€šè¿‡ä»ç¯å¢ƒä¸­æŸ¥æ‰¾ï¼Œå¯ä»¥ä¿è¯å…¼å®¹æ€§ã€‚</p><hr><h3 id="è·å–é€‰é¡¹"><a href="#è·å–é€‰é¡¹" class="headerlink" title="è·å–é€‰é¡¹"></a>è·å–é€‰é¡¹</h3><p>å¼€å‘ä¸­æˆ‘ä»¬ç»å¸¸ç”¨åˆ°å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤ä¸€èˆ¬éƒ½é…åˆé€‰é¡¹è¾¾åˆ°ä¸åŒçš„æ•ˆæœï¼Œæ¯”å¦‚æœ€å¸¸ç”¨çš„<code>ls -al</code>ï¼Œé€šè¿‡<code>-a</code>æ¥æŒ‡å®šç»“æœåŒ…å«éšè—æ–‡ä»¶ï¼Œé€šè¿‡<code>-l</code>è¾¾åˆ°åˆ—è¡¨æ˜¾ç¤ºçš„æ•ˆæœã€‚</p><p>é€šè¿‡æŸ¥è¯¢ç›¸å…³èµ„æ–™ï¼Œæˆ‘å‘ç°è·å–é€‰é¡¹æ™®éçš„åšæ³•æ˜¯ä½¿ç”¨<code>getopts</code>å‘½ä»¤ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•åªèƒ½è·å–<code>-h</code>è¿™ç§çŸ­é€‰é¡¹ï¼Œå¯¹äº<code>--help</code>é•¿é€‰é¡¹å°±ä¸è¡Œã€‚</p><p>ç¬¬ä¸€ç§åŠæ³•æ˜¯æ¢æˆ<code>getopt</code>å‘½ä»¤ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ¯ä¸ªç³»ç»Ÿéƒ½æ”¯æŒè¿™ä¸ªå‘½ä»¤ã€‚å…·ä½“ä½¿ç”¨å’Œ<code>getopts</code>ç±»ä¼¼ï¼Œæ¯”å¦‚<code>getopt -o ab:c -l a-long:b-long</code></p><p>ç¬¬äºŒç§æ–¹æ³•æ˜¯æŠŠæ”¯æŒçš„é•¿å‘½ä»¤è½¬æˆçŸ­å‘½ä»¤ï¼Œæˆ‘ä½¿ç”¨çš„å°±æ˜¯è¿™ç§æ–¹å¼ï¼Œç›¸å¯¹æ¥è¯´æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä¸”caseå†™çš„æ¯”è¾ƒç»Ÿä¸€ã€‚é€šè¿‡<code>shift</code>å–å‡ºå‚æ•°ï¼Œå†<code>set --</code>çš„æ–¹å¼é‡å†™ï¼Œæœ€å<code>OPTIND=1</code>æŠŠæŒ‡é’ˆæŒ‡å›ç¬¬ä¸€ä¸ªé€‰é¡¹ã€‚</p><hr><h3 id="æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶åç¼€"><a href="#æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶åç¼€" class="headerlink" title="æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶åç¼€"></a>æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶åç¼€</h3><p>æŒ‰éœ€æ±‚éœ€è¦åˆ¤æ–­åç¼€åæ¥è§£å‹ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆ¤æ–­<code>tar.gz</code>ä¹‹ç±»çš„é—®é¢˜ã€‚åŒæ—¶ï¼Œå¦‚æœä¼ å…¥çš„æ–‡ä»¶ç›®å½•æ˜¯éšè—ç›®å½•ï¼Œä¹Ÿä¼šé€ æˆä¸€å®šçš„éšœç¢ã€‚æˆ‘ä»¬å‡è®¾ä¼ å…¥æ–‡ä»¶è·¯å¾„ä¸º<code>/a/.b/c.tar.gz</code>ã€‚</p><blockquote><p>${param#pattern}    ä»paramå‰é¢åˆ é™¤patternçš„æœ€å°åŒ¹é…<br>${param##pattern}    ä»paramå‰é¢åˆ é™¤patternçš„æœ€å¤§åŒ¹é…<br>${param%pattern}    ä»paramåé¢åˆ é™¤patternçš„æœ€å°åŒ¹é…<br>${param%%pattern}    ä»paramåé¢åˆ é™¤patternçš„æœ€å¤§åŒ¹é…</p></blockquote><p>å¦‚æœæŒ‰ç…§<code>${fileName##*.}</code>æ¥æˆªå–ï¼Œé‚£ä¹ˆåªèƒ½æ‹¿åˆ°<code>gz</code>ã€‚<br>å¦‚æœæŒ‰ç…§<code>${fileName#*.}</code>æ¥æˆªå–ï¼Œæ‹¿åˆ°çš„åˆæ˜¯<code>b/c.tar.gz</code>ã€‚é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>å¥½åœ¨æœ‰<code>dirname</code>å¯ä»¥ç›´æ¥è·å–æ–‡ä»¶è·¯å¾„ï¼Œ<code>basename</code>æ‹¿åˆ°æ–‡ä»¶åï¼Œå•ç‹¬å¯¹æ–‡ä»¶åè¿›è¡Œ<code>${fileName#*.}</code>å°±å¯ä»¥æ‹¿åˆ°<code>tar.gz</code>äº†ã€‚</p><hr><h3 id="å»é™¤ä¸å¿…è¦çš„æ‰“å°"><a href="#å»é™¤ä¸å¿…è¦çš„æ‰“å°" class="headerlink" title="å»é™¤ä¸å¿…è¦çš„æ‰“å°"></a>å»é™¤ä¸å¿…è¦çš„æ‰“å°</h3><p>æ‰§è¡Œè§£å‹å‘½ä»¤æ—¶ï¼Œä¼šæ‰“å°è§£å‹æ­¥éª¤ï¼Œä¸€èˆ¬æ¥è¯´ä¹Ÿéœ€è¦æ˜¾ç¤ºï¼Œé‚£å¦‚æœæˆ‘ä»¬ä¸æƒ³è¦æ‰“å°å‡ºæ¥å‘¢ï¼Ÿæœ‰ä¸€ä¸ªåŠæ³•å°±æ˜¯åœ¨å‘½ä»¤ä¹‹ååŠ ä¸Š<code>&gt; /dev/null 2&gt;&amp;1</code></p><blockquote><p>/dev/null ï¼šä»£è¡¨ç©ºè®¾å¤‡æ–‡ä»¶</p><p>>  ï¼šä»£è¡¨é‡å®šå‘åˆ°å“ªé‡Œï¼Œä¾‹å¦‚ï¼šecho â€œ123â€ &gt; /home/123.txt</p><p>1  ï¼šè¡¨ç¤ºstdoutæ ‡å‡†è¾“å‡ºï¼Œç³»ç»Ÿé»˜è®¤å€¼æ˜¯1ï¼Œæ‰€ä»¥â€&gt;/dev/nullâ€ç­‰åŒäºâ€1&gt;/dev/nullâ€</p><p>2  ï¼šè¡¨ç¤ºstderræ ‡å‡†é”™è¯¯</p><p>&amp;  ï¼šè¡¨ç¤ºç­‰åŒäºçš„æ„æ€ï¼Œ2&gt;&amp;1ï¼Œè¡¨ç¤º2çš„è¾“å‡ºé‡å®šå‘ç­‰åŒäº1</p></blockquote><p>æ‰€ä»¥å«ä¹‰å°±æ˜¯æŠŠå‘½ä»¤è¾“å‡ºç»“æœå’Œé”™è¯¯è¾“å‡ºé‡å®šå‘ï¼Œä½¿å¾—è¾“å‡ºä¸åœ¨å½“å‰å±å¹•æ˜¾ç¤ºï¼Œç”±äºnullæ¯”è¾ƒç‰¹æ®Šï¼Œå‘è¿™ä¸ªæ–‡ä»¶è¾“å…¥ç­‰äºè¿›å…¥é»‘æ´ï¼Œå› æ­¤è¾¾åˆ°æ•ˆæœã€‚</p><hr><h3 id="æ•°ç»„ä¸ç©ºæ ¼"><a href="#æ•°ç»„ä¸ç©ºæ ¼" class="headerlink" title="æ•°ç»„ä¸ç©ºæ ¼"></a>æ•°ç»„ä¸ç©ºæ ¼</h3><p>ä½¿ç”¨<code>ls | grep</code>çš„æ–¹å¼æ¥è¿‡æ»¤ç»“æœè·å–æ–‡ä»¶åæ•°ç»„çš„æœ€å¤§é—®é¢˜æ˜¯ï¼Œå¦‚æœæ–‡ä»¶ååŒ…å«ç©ºæ ¼ï¼Œé‚£ä¹ˆå‰åä¼šè¢«åˆ†å‰²æˆä¸¤ä¸ªå•å…ƒï¼Œå¯¼è‡´å¤„ç†æ¯”è¾ƒå›°éš¾ã€‚</p><p>æ¯”è¾ƒè®¨å·§çš„æ–¹æ³•æ˜¯ä¸´æ—¶ç”¨ç‰¹æ®Šç¬¦å·ä»£æ›¿ç©ºæ ¼ï¼Œåœ¨ä½¿ç”¨æ—¶å†æ›¿æ¢å›æ¥ã€‚è¿™ç§æ–¹æ³•ä¸ä¼šæ”¹å˜æ–‡ä»¶åï¼Œä¹Ÿä¸ç”¨å†™å¤æ‚çš„æ•°ç»„åˆå¹¶ï¼Œæ¯”è¾ƒç¬¦åˆç®€å•çš„è®¾è®¡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tr " " "?"</span><br><span class="line"><span class="meta">$</span>&#123;logName//'?'/' '&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡è¿™æ¬¡ç®€å•çš„è„šæœ¬å®éªŒï¼Œå¯¹shellæœ‰äº†æ–°çš„è®¤è¯†ï¼ŒåŠæ—¶è®°å½•é‡åˆ°çš„é—®é¢˜ï¼Œç›¸ä¿¡ä¸‹æ¬¡ä¼šæ›´æœ‰å°è±¡ã€‚ä½¿ç”¨è„šæœ¬ï¼Œå¯ä»¥è®©å·¥ä½œæ›´æœ‰æ•ˆç‡ï¼Œç›¸ä¿¡ä»¥åä¹Ÿä¼šè¶Šç”¨è¶Šå¤šã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;ä¸´ä¸Šçº¿å‰æµ‹è¯•æ¯”è¾ƒåŠªåŠ›ï¼Œé‡åˆ°é—ªé€€æˆ–è€…å…¶ä»–é—®é¢˜ï¼Œä¼šæŠŠæ—¥å¿—åŒ…æ‰“ç»™æˆ‘ï¼Œç”±äºappå†…å­˜é™åˆ¶ï¼Œç›®å‰æ¯æ¬¡æ‰“åŒ…éƒ½æ˜¯1må¤§å°ï¼Œæ‰€ä»¥æœ‰æ—¶æŸ¥æ‰¾é—®é¢˜çš„ä¸Šä¸‹æ–‡æ¯”è¾ƒåƒåŠ›
      
    
    </summary>
    
      <category term="Shell" scheme="https://vanchchen.github.io/categories/Shell/"/>
    
    
      <category term="æ•ˆç‡å·¥å…·" scheme="https://vanchchen.github.io/tags/%E6%95%88%E7%8E%87%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>Categoryæ¢ç´¢</title>
    <link href="https://vanchchen.github.io/p/5cb0.html"/>
    <id>https://vanchchen.github.io/p/5cb0.html</id>
    <published>2018-09-17T07:29:29.000Z</published>
    <updated>2018-10-16T01:15:41.976Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯Category"><a href="#ä»€ä¹ˆæ˜¯Category" class="headerlink" title="ä»€ä¹ˆæ˜¯Category?"></a>ä»€ä¹ˆæ˜¯Category?</h2><p>Categoryæ˜¯Objective-C 2.0ä¹‹åæ·»åŠ çš„è¯­è¨€ç‰¹æ€§ï¼ŒCategoryçš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºå·²ç»å­˜åœ¨çš„ç±»æ·»åŠ æ–¹æ³•ï¼Œä¸€èˆ¬ç§°ä¸ºåˆ†ç±»ï¼Œæ–‡ä»¶åæ ¼å¼æ˜¯â€NSObject+A.hâ€ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> category_t &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    classref_t cls;</span><br><span class="line">    <span class="keyword">struct</span> method_list_t *instanceMethods;</span><br><span class="line">    <span class="keyword">struct</span> method_list_t *classMethods;</span><br><span class="line">    <span class="keyword">struct</span> protocol_list_t *protocols;</span><br><span class="line">    <span class="keyword">struct</span> property_list_t *instanceProperties;</span><br><span class="line">    <span class="keyword">struct</span> property_list_t *_classProperties;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ç»“æ„èƒ½çœ‹å‡ºåˆ†ç±»å¯ä»¥æ‰©å±•å®ä¾‹æ–¹æ³•åˆ—è¡¨ã€ç±»æ–¹æ³•åˆ—è¡¨ã€åè®®åˆ—è¡¨ï¼Œä¹Ÿæ”¯æŒæ‰©å±•å±æ€§ï¼Œä½†ä¸æ”¯æŒæ‰©å±•æˆå‘˜å˜é‡ï¼ˆä¹‹åä¼šè¯´ï¼‰ã€‚</p><p>ä¸€èˆ¬ä½¿ç”¨çš„åœºæ™¯æœ‰æ‰©å±•ç°æœ‰ç±»æ–¹æ³•ã€ä»£ç åˆ†åŒºã€æ·»åŠ ç§æœ‰æ–¹æ³•ï¼ˆä¸å¯¹å¤–æš´éœ²category.hï¼‰ã€æ¨¡æ‹Ÿå¤šç»§æ‰¿ï¼ˆä½¿ç”¨å…³è”å¯¹è±¡çš„æ–¹å¼æ·»åŠ å±æ€§å®ç°ï¼‰</p><hr><h2 id="ä»€ä¹ˆæ˜¯Extensionï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯Extensionï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯Extensionï¼Ÿ"></a>ä»€ä¹ˆæ˜¯Extensionï¼Ÿ</h2><p>Extensionä¸€èˆ¬è¢«ç§°ä¸ºç±»æ‰©å±•ã€åŒ¿ååˆ†ç±»ï¼Œç”¨äºå®šä¹‰ç§æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œä¸å¯è¢«ç»§æ‰¿ã€‚åªèƒ½ä¾é™„è‡ªå®šä¹‰ç±»å†™äº.mä¸­ï¼Œå®šä¹‰ä¸€èˆ¬ä¸º:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSObject</span> *obj;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>ç±»æ‰©å±•æ”¯æŒå†™åœ¨å¤šä¸ª.hæ–‡ä»¶ï¼Œä½†éƒ½å¿…é¡»åœ¨.mæ–‡ä»¶ä¸­å¼•ç”¨ï¼Œä¸”ä¸èƒ½æœ‰è‡ªå·±çš„å®ç°ã€‚</p><p>ç±»æ‰©å±•å¾ˆå¤šæ—¶å€™ä¼šä¸åˆ†ç±»ææ··ï¼Œæˆ‘åœ¨æ–‡åé—®ç­”ç¯èŠ‚è¯¦ç»†æ•´ç†äº†ä»–ä»¬çš„åŒºåˆ«ã€‚</p><hr><h2 id="Categoryå¦‚ä½•åŠ è½½çš„ï¼Ÿ"><a href="#Categoryå¦‚ä½•åŠ è½½çš„ï¼Ÿ" class="headerlink" title="Categoryå¦‚ä½•åŠ è½½çš„ï¼Ÿ"></a>Categoryå¦‚ä½•åŠ è½½çš„ï¼Ÿ</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_class : objc_object &#123;</span><br><span class="line">    Class superclass;</span><br><span class="line">    class_data_bits_t bits; </span><br><span class="line">    class_rw_t *data() &#123;</span><br><span class="line">        <span class="keyword">return</span> bits.data();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> class_rw_t &#123;</span><br><span class="line">    <span class="keyword">const</span> class_ro_t *ro;</span><br><span class="line"></span><br><span class="line">    method_array_t methods;</span><br><span class="line">    property_array_t properties;</span><br><span class="line">    protocol_array_t protocols;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> class_ro_t &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * name;</span><br><span class="line">    method_list_t * baseMethodList;</span><br><span class="line">    protocol_list_t * baseProtocols;</span><br><span class="line">    <span class="keyword">const</span> ivar_list_t * ivars; <span class="comment">//åªæœ‰roæ‰æœ‰å®ä¾‹å˜é‡è¡¨</span></span><br><span class="line">    property_list_t *baseProperties;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…ˆç®€å•äº†è§£ä¸€ä¸‹Classå¯¹è±¡çš„ç»“æ„ï¼Œæ¯ä¸ª<code>objc_class</code>éƒ½åŒ…å«æœ‰<code>class_data_bits_t</code>æ•°æ®ä½ï¼Œå…¶ä¸­å‚¨å­˜äº†<code>class_rw_t</code>çš„æŒ‡é’ˆåœ°å€å’Œä¸€äº›å…¶ä»–æ ‡è®°ã€‚<code>class_rw_t</code>ä¸­åŒ…å«æœ‰å±æ€§æ–¹æ³•åè®®åˆ—è¡¨ï¼Œä»¥åŠ<code>class_ro_t</code>æŒ‡é’ˆåœ°å€ã€‚è€Œåœ¨<code>class_ro_t</code>ç»“æ„ä¸­ï¼Œå‚¨å­˜çš„æ˜¯ç¼–è¯‘å™¨å†³å®šçš„å±æ€§æ–¹æ³•åè®®ã€‚</p><h3 id="é‚£ä¹ˆæ˜¯æ€ä¹ˆè¿è¡Œçš„å‘¢ï¼Ÿ"><a href="#é‚£ä¹ˆæ˜¯æ€ä¹ˆè¿è¡Œçš„å‘¢ï¼Ÿ" class="headerlink" title="é‚£ä¹ˆæ˜¯æ€ä¹ˆè¿è¡Œçš„å‘¢ï¼Ÿ"></a>é‚£ä¹ˆæ˜¯æ€ä¹ˆè¿è¡Œçš„å‘¢ï¼Ÿ</h3><p>åœ¨ç¼–è¯‘æœŸç±»çš„ç»“æ„ä¸­çš„<code>class_data_bits_t</code>æŒ‡å‘çš„æ˜¯ä¸€ä¸ª <code>class_ro_t</code>æŒ‡é’ˆã€‚</p><p>åœ¨è¿è¡Œæ—¶è°ƒç”¨<code>realizeClass</code>æ–¹æ³•ï¼Œåˆå§‹åŒ–ä¸€ä¸ª<code>class_rw_t</code>ç»“æ„ä½“ï¼Œè®¾ç½®roå€¼ä¸ºåŸæ•°æ®ä¸­çš„<code>class_ro_t</code>åè®¾ä¸ºæ•°æ®ä½ä¸­çš„æŒ‡å‘ï¼Œæœ€åè°ƒç”¨<code>methodizeClass</code>æ–¹æ³•åŠ è½½ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> methodizeClass(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    auto rw = cls-&gt;data();</span><br><span class="line">    auto ro = rw-&gt;ro;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»roä¸­åŠ è½½æ–¹æ³•è¡¨</span></span><br><span class="line">    method_list_t *list = ro-&gt;baseMethods();</span><br><span class="line">    <span class="keyword">if</span> (list) &#123;</span><br><span class="line">        prepareMethodLists(cls, &amp;list, <span class="number">1</span>, <span class="literal">YES</span>, isBundleClass(cls));</span><br><span class="line">        rw-&gt;methods.attachLists(&amp;list, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åŠ è½½å±æ€§</span></span><br><span class="line">    property_list_t *proplist = ro-&gt;baseProperties;</span><br><span class="line">    <span class="keyword">if</span> (proplist) &#123;</span><br><span class="line">        rw-&gt;properties.attachLists(&amp;proplist, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åŠ è½½åè®®</span></span><br><span class="line">    protocol_list_t *protolist = ro-&gt;baseProtocols;</span><br><span class="line">    <span class="keyword">if</span> (protolist) &#123;</span><br><span class="line">        rw-&gt;protocols.attachLists(&amp;protolist, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åŸºç±»æ·»åŠ åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;isRootMetaclass()) &#123;</span><br><span class="line">        addMethod(cls, SEL_initialize, (IMP)&amp;objc_noop_imp, <span class="string">""</span>, <span class="literal">NO</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åŠ è½½åˆ†ç±»</span></span><br><span class="line">    category_list *cats = unattachedCategoriesForClass(cls, <span class="literal">true</span> <span class="comment">/*realizing*/</span>);</span><br><span class="line">    attachCategories(cls, cats, <span class="literal">false</span> <span class="comment">/*don't flush caches*/</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (cats) free(cats);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨<code>methodizeClass</code>ä¸­åŠ è½½äº†åŸå…ˆç±»åœ¨ç¼–è¯‘æœŸå†³å®šçš„æ–¹æ³•å±æ€§å’Œåè®®ï¼Œç„¶åè·å–äº†æœªè¿æ¥çš„åˆ†ç±»è¡¨ï¼Œå°†åˆ—è¡¨ä¸­çš„æ‰©å±•æ–¹æ³•æ·»åŠ åˆ°è¿è¡ŒæœŸç±»ä¸­ã€‚</p><hr><h2 id="Categoryæ–¹æ³•è¦†ç›–"><a href="#Categoryæ–¹æ³•è¦†ç›–" class="headerlink" title="Categoryæ–¹æ³•è¦†ç›–"></a>Categoryæ–¹æ³•è¦†ç›–</h2><p>å¦‚æœä¸åŒçš„åˆ†ç±»å®ç°äº†ç›¸åŒåå­—çš„æ–¹æ³•ï¼Œé‚£ä¹ˆè°ƒç”¨æ—¶ä¼šä½¿ç”¨æœ€ååŠ å…¥çš„å®ç°ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><h3 id="åŠ è½½Category"><a href="#åŠ è½½Category" class="headerlink" title="åŠ è½½Category"></a>åŠ è½½Category</h3><p>dyldé“¾æ¥å¹¶åˆå§‹åŒ–äºŒè¿›åˆ¶æ–‡ä»¶åï¼Œäº¤ç”±<code>ImageLoader</code>è¯»å–ï¼Œæ¥ç€é€šçŸ¥<code>runtime</code>å¤„ç†ï¼Œ<code>runtime</code>è°ƒç”¨<code>map_images</code>è§£æï¼Œç„¶åæ‰§è¡Œ<code>_read_images</code>åˆ†ææ–‡ä»¶ä¸­åŒ…å«çš„ç±»å’Œåˆ†ç±»ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åŠ è½½åˆ†ç±»</span></span><br><span class="line">category_t **catlist = </span><br><span class="line">    _getObjc2CategoryList(hi, &amp;count);</span><br><span class="line"><span class="keyword">bool</span> hasClassProperties = hi-&gt;info()-&gt;hasCategoryClassProperties();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">    category_t *cat = catlist[i];</span><br><span class="line">    Class cls = remapClass(cat-&gt;cls);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cls) &#123;</span><br><span class="line">        <span class="comment">//åˆ†ç±»æŒ‡å®šçš„ç±»è¿˜æ²¡åŠ è½½ï¼Œå¯èƒ½æ˜¯é“¾æ¥åº“é¡ºåºçš„é—®é¢˜</span></span><br><span class="line">        catlist[i] = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ·»åŠ åˆ†ç±»åˆ°ç±»çš„åˆ†ç±»è¡¨ä¸­ï¼Œä¼ºæœºé‡è½½å…¥</span></span><br><span class="line">    <span class="keyword">bool</span> classExists = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> (cat-&gt;instanceMethods ||  cat-&gt;protocols  </span><br><span class="line">        ||  cat-&gt;instanceProperties) </span><br><span class="line">    &#123;</span><br><span class="line">        addUnattachedCategoryForClass(cat, cls, hi);</span><br><span class="line">        <span class="keyword">if</span> (cls-&gt;isRealized()) &#123;</span><br><span class="line">            remethodizeClass(cls);</span><br><span class="line">            classExists = <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ·»åŠ åˆ†ç±»åˆ°å…ƒç±»ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (cat-&gt;classMethods  ||  cat-&gt;protocols  </span><br><span class="line">        ||  (hasClassProperties &amp;&amp; cat-&gt;_classProperties)) </span><br><span class="line">    &#123;</span><br><span class="line">        addUnattachedCategoryForClass(cat, cls-&gt;ISA(), hi);</span><br><span class="line">        <span class="keyword">if</span> (cls-&gt;ISA()-&gt;isRealized()) &#123;</span><br><span class="line">            remethodizeClass(cls-&gt;ISA());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ æ–¹æ³•å±æ€§å’Œåè®®"><a href="#æ·»åŠ æ–¹æ³•å±æ€§å’Œåè®®" class="headerlink" title="æ·»åŠ æ–¹æ³•å±æ€§å’Œåè®®"></a>æ·»åŠ æ–¹æ³•å±æ€§å’Œåè®®</h3><p>å¦‚æœæœ‰æ–°å¢çš„åˆ†ç±»ï¼Œå°±åˆ†åˆ«æ·»åŠ åˆ°åŸç±»å’Œmetaç±»ï¼Œå¹¶é€šè¿‡<code>remethodizeClass</code>æ›´æ–°ï¼Œå…·ä½“å°±æ˜¯è°ƒç”¨<code>attachCategories</code>æ–¹æ³•æŠŠåˆ†ç±»ä¸­æ‰€æœ‰çš„æ–¹æ³•éƒ½æ·»åŠ åˆ°æŒ‡å®šç±»ä¸­ã€‚<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">attachCategories</span><span class="params">(Class cls, category_list *cats, <span class="keyword">bool</span> flush_caches)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!cats) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isMeta = cls-&gt;isMetaClass();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ–°å»ºæ•°ç»„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">method_list_t</span> **mlists = (<span class="keyword">method_list_t</span> **)</span><br><span class="line">        <span class="built_in">malloc</span>(cats-&gt;count * <span class="keyword">sizeof</span>(*mlists));</span><br><span class="line">    <span class="keyword">property_list_t</span> **proplists = (<span class="keyword">property_list_t</span> **)</span><br><span class="line">        <span class="built_in">malloc</span>(cats-&gt;count * <span class="keyword">sizeof</span>(*proplists));</span><br><span class="line">    <span class="keyword">protocol_list_t</span> **protolists = (<span class="keyword">protocol_list_t</span> **)</span><br><span class="line">        <span class="built_in">malloc</span>(cats-&gt;count * <span class="keyword">sizeof</span>(*protolists));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> mcount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> propcount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> protocount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i = cats-&gt;count;<span class="comment">//å€’åºè·å–æœ€æ–°çš„åˆ†ç±»</span></span><br><span class="line">    <span class="keyword">bool</span> fromBundle = NO;</span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">        <span class="keyword">auto</span>&amp; entry = cats-&gt;<span class="built_in">list</span>[i];</span><br><span class="line">        <span class="comment">//åˆ†åˆ«è·å–åˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">method_list_t</span> *mlist = entry.cat-&gt;methodsForMeta(isMeta);</span><br><span class="line">        <span class="keyword">if</span> (mlist) &#123;</span><br><span class="line">            mlists[mcount++] = mlist;</span><br><span class="line">            fromBundle |= entry.hi-&gt;isBundle();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">property_list_t</span> *proplist = </span><br><span class="line">            entry.cat-&gt;propertiesForMeta(isMeta, entry.hi);</span><br><span class="line">        <span class="keyword">if</span> (proplist) &#123;</span><br><span class="line">            proplists[propcount++] = proplist;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protocol_list_t</span> *protolist = entry.cat-&gt;protocols;</span><br><span class="line">        <span class="keyword">if</span> (protolist) &#123;</span><br><span class="line">            protolists[protocount++] = protolist;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> rw = cls-&gt;data();</span><br><span class="line">    <span class="comment">//åŠ è½½åˆ—è¡¨åˆ°rwä¸­</span></span><br><span class="line">    prepareMethodLists(cls, mlists, mcount, NO, fromBundle);</span><br><span class="line">    rw-&gt;methods.attachLists(mlists, mcount);</span><br><span class="line">    <span class="built_in">free</span>(mlists);</span><br><span class="line">    <span class="keyword">if</span> (flush_caches  &amp;&amp;  mcount &gt; <span class="number">0</span>) flushCaches(cls);</span><br><span class="line"></span><br><span class="line">    rw-&gt;properties.attachLists(proplists, propcount);</span><br><span class="line">    <span class="built_in">free</span>(proplists);</span><br><span class="line"></span><br><span class="line">    rw-&gt;protocols.attachLists(protolists, protocount);</span><br><span class="line">    <span class="built_in">free</span>(protolists);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attachLists</span><span class="params">(List* <span class="keyword">const</span> * addedLists, <span class="keyword">uint32_t</span> addedCount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (addedCount == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasArray()) &#123;</span><br><span class="line">            <span class="comment">// many lists -&gt; many lists</span></span><br><span class="line">            <span class="keyword">uint32_t</span> oldCount = <span class="built_in">array</span>()-&gt;count;</span><br><span class="line">            <span class="keyword">uint32_t</span> newCount = oldCount + addedCount;</span><br><span class="line">            setArray((<span class="keyword">array_t</span> *)<span class="built_in">realloc</span>(<span class="built_in">array</span>(), <span class="keyword">array_t</span>::byteSize(newCount)));</span><br><span class="line">            <span class="built_in">array</span>()-&gt;count = newCount;</span><br><span class="line">            memmove(<span class="built_in">array</span>()-&gt;lists + addedCount, <span class="built_in">array</span>()-&gt;lists, </span><br><span class="line">                    oldCount * <span class="keyword">sizeof</span>(<span class="built_in">array</span>()-&gt;lists[<span class="number">0</span>]));</span><br><span class="line">            <span class="built_in">memcpy</span>(<span class="built_in">array</span>()-&gt;lists, addedLists, </span><br><span class="line">                   addedCount * <span class="keyword">sizeof</span>(<span class="built_in">array</span>()-&gt;lists[<span class="number">0</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">list</span>  &amp;&amp;  addedCount == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 0 lists -&gt; 1 list</span></span><br><span class="line">            <span class="built_in">list</span> = addedLists[<span class="number">0</span>];</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 1 list -&gt; many lists</span></span><br><span class="line">            List* oldList = <span class="built_in">list</span>;</span><br><span class="line">            <span class="keyword">uint32_t</span> oldCount = oldList ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">uint32_t</span> newCount = oldCount + addedCount;</span><br><span class="line">            setArray((<span class="keyword">array_t</span> *)<span class="built_in">malloc</span>(<span class="keyword">array_t</span>::byteSize(newCount)));</span><br><span class="line">            <span class="built_in">array</span>()-&gt;count = newCount;</span><br><span class="line">            <span class="keyword">if</span> (oldList) <span class="built_in">array</span>()-&gt;lists[addedCount] = oldList;</span><br><span class="line">            <span class="built_in">memcpy</span>(<span class="built_in">array</span>()-&gt;lists, addedLists, </span><br><span class="line">                   addedCount * <span class="keyword">sizeof</span>(<span class="built_in">array</span>()-&gt;lists[<span class="number">0</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€åè°ƒç”¨äº†<code>rw-&gt;methods.attachLists(mlists, mcount);</code> æŠŠæ–°å¢åˆ†ç±»ä¸­çš„æ–¹æ³•åˆ—è¡¨æ·»åŠ åˆ°å®é™…è¿è¡Œæ—¶æŸ¥è¯¢çš„æ–¹æ³•åˆ—è¡¨å¤´éƒ¨ã€‚</p><p>åœ¨è¿›è¡Œæ–¹æ³•è°ƒç”¨æ—¶ä¼šä»å¤´éƒ¨æŸ¥è¯¢ï¼Œä¸€æ—¦æŸ¥åˆ°åå°±è¿”å›ç»“æœï¼Œå› æ­¤åç¼–è¯‘çš„æ–‡ä»¶ä¸­çš„æ–¹æ³•ä¼šè¢«ä¼˜å…ˆè°ƒç”¨ã€‚</p><p>åŒæ—¶ä¹‹å‰æ·»åŠ çš„æ–¹æ³•å®ç°ä¹Ÿä¿å­˜äº†ï¼Œå¯ä»¥é€šè¿‡è·å–åŒåæ–¹æ³•çš„æ–¹å¼æŸ¥æ‰¾åŸç±»çš„å®ç°ã€‚</p><hr><h2 id="Categoryå®ç°å±æ€§"><a href="#Categoryå®ç°å±æ€§" class="headerlink" title="Categoryå®ç°å±æ€§"></a>Categoryå®ç°å±æ€§</h2><h3 id="åˆ†ç±»ä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡"><a href="#åˆ†ç±»ä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡" class="headerlink" title="åˆ†ç±»ä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡"></a>åˆ†ç±»ä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡</h3><p>å±æ€§ï¼ˆPropertyï¼‰åŒ…å«äº†æˆå‘˜å˜é‡ï¼ˆIvarï¼‰å’ŒSetter&amp;Getterã€‚</p><p>å¯ä»¥åœ¨åˆ†ç±»ä¸­å®šä¹‰å±æ€§ï¼Œä½†ç”±äºåˆ†ç±»æ˜¯åœ¨è¿è¡Œæ—¶æ·»åŠ åˆ†ç±»å±æ€§åˆ°ç±»çš„å±æ€§åˆ—è¡¨ä¸­ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰åˆ›å»ºå¯¹åº”çš„æˆå‘˜å˜é‡å’Œæ–¹æ³•å®ç°ã€‚</p><h3 id="å…³è”å¯¹è±¡"><a href="#å…³è”å¯¹è±¡" class="headerlink" title="å…³è”å¯¹è±¡"></a>å…³è”å¯¹è±¡</h3><p>å¦‚æœæˆ‘ä»¬æƒ³è®©åˆ†ç±»å®ç°æ·»åŠ æ–°çš„å±æ€§ï¼Œä¸€èˆ¬éƒ½é€šè¿‡å…³è”å¯¹è±¡çš„æ–¹å¼ã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜æ–‡ä»¶</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TestObject</span> (<span class="title">Category</span>)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSObject</span> *object;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="keyword">const</span> kAssociatedObjectKey = (<span class="keyword">void</span> *)&amp;kAssociatedObjectKey;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TestObject</span> (<span class="title">Category</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSObject</span> *)object &#123;</span><br><span class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, kAssociatedObjectKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="built_in">NSObject</span> *)object &#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, kAssociatedObjectKey, object, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><p>è¿™ç§æ–¹å¼å¯ä»¥å®ç°å­˜å–å¯¹è±¡ï¼Œä½†æ˜¯ä¸èƒ½è·å–<code>_object</code>å˜é‡ã€‚</p><hr><h2 id="é—®ç­”"><a href="#é—®ç­”" class="headerlink" title="é—®ç­”"></a>é—®ç­”</h2><h3 id="åˆ†ç±»å’Œæ‰©å±•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#åˆ†ç±»å’Œæ‰©å±•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="åˆ†ç±»å’Œæ‰©å±•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>åˆ†ç±»å’Œæ‰©å±•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3><p>1.åˆ†ç±»å¤šç”¨äºæ‰©å±•æ–¹æ³•å®ç°ï¼Œç±»æ‰©å±•å¤šç”¨äºç”³æ˜ç§æœ‰å˜é‡å’Œæ–¹æ³•ã€‚</p><p>2.ç±»æ‰©å±•ä½œç”¨åœ¨ç¼–è¯‘æœŸï¼Œç›´æ¥å’ŒåŸç±»åœ¨ä¸€èµ·ï¼Œè€Œåˆ†ç±»ä½œç”¨åœ¨è¿è¡Œæ—¶ï¼ŒåŠ è½½ç±»çš„æ—¶å€™åŠ¨æ€æ·»åŠ åˆ°åŸç±»ä¸­ã€‚</p><p>3.ç±»æ‰©å±•å¯ä»¥å®šä¹‰å±æ€§ï¼Œåˆ†ç±»ä¸­å®šä¹‰çš„å±æ€§åªä¼šç”³æ˜setter/getterï¼Œå¹¶æ²¡æœ‰ç›¸å…³å®ç°å’Œå˜é‡ã€‚</p><h3 id="åˆ†ç±»æœ‰å“ªäº›å±€é™æ€§ï¼Ÿ"><a href="#åˆ†ç±»æœ‰å“ªäº›å±€é™æ€§ï¼Ÿ" class="headerlink" title="åˆ†ç±»æœ‰å“ªäº›å±€é™æ€§ï¼Ÿ"></a>åˆ†ç±»æœ‰å“ªäº›å±€é™æ€§ï¼Ÿ</h3><p>1.åˆ†ç±»åªèƒ½ç»™ç°æœ‰çš„ç±»åŠ æ–¹æ³•æˆ–åè®®ï¼Œä¸èƒ½æ·»åŠ å®ä¾‹å˜é‡ï¼ˆivarï¼‰ã€‚</p><p>2.åˆ†ç±»æ·»åŠ çš„æ–¹æ³•å¦‚æœä¸ç°æœ‰çš„é‡åï¼Œä¼šè¦†ç›–åŸæœ‰æ–¹æ³•çš„å®ç°ã€‚å¦‚æœå¤šä¸ªåˆ†ç±»æ–¹æ³•éƒ½é‡åï¼Œåˆ™æ ¹æ®ç¼–è¯‘é¡ºåºæ‰§è¡Œæœ€åä¸€ä¸ªã€‚</p><h3 id="åˆ†ç±»çš„ç»“æ„ä½“é‡Œé¢æœ‰å“ªäº›æˆå‘˜ï¼Ÿ"><a href="#åˆ†ç±»çš„ç»“æ„ä½“é‡Œé¢æœ‰å“ªäº›æˆå‘˜ï¼Ÿ" class="headerlink" title="åˆ†ç±»çš„ç»“æ„ä½“é‡Œé¢æœ‰å“ªäº›æˆå‘˜ï¼Ÿ"></a>åˆ†ç±»çš„ç»“æ„ä½“é‡Œé¢æœ‰å“ªäº›æˆå‘˜ï¼Ÿ</h3><p>åˆ†ç±»ç»“æ„ä½“åŒ…å«äº†åˆ†ç±»åï¼Œç»‘å®šçš„ç±»ï¼Œå®ä¾‹ä¸ç±»æ–¹æ³•åˆ—è¡¨ï¼Œå®ä¾‹ä¸ç±»æ–¹æ³•å±æ€§ä»¥åŠåè®®è¡¨ã€‚</p><hr><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://tech.meituan.com/DiveIntoCategory.html" target="_blank" rel="noopener">æ·±å…¥ç†è§£Objective-Cï¼šCategory</a></p><p><a href="https://halfrost.com/objc_runtime_isa_class/" target="_blank" rel="noopener">ç¥ç»ç—…é™¢ Objective-C Runtime å…¥é™¢ç¬¬ä¸€å¤©â€”â€” isa å’Œ Class</a></p><p><a href="https://www.jianshu.com/p/0dc2513e117b" target="_blank" rel="noopener">æ¢ç§˜Runtime - æ·±å…¥å‰–æCategory</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ä»€ä¹ˆæ˜¯Category&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯Category&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯Category?&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯Category?&lt;/h2&gt;&lt;p&gt;Categoryæ˜¯Objective-C 2.0ä¹‹åæ·»åŠ çš„è¯­è¨€ç‰¹
      
    
    </summary>
    
      <category term="iOS" scheme="https://vanchchen.github.io/categories/iOS/"/>
    
    
      <category term="åŸç†åˆ†æ" scheme="https://vanchchen.github.io/tags/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>iOSé¢è¯•é¢˜</title>
    <link href="https://vanchchen.github.io/p/6ea5.html"/>
    <id>https://vanchchen.github.io/p/6ea5.html</id>
    <published>2018-09-14T09:40:01.000Z</published>
    <updated>2018-10-16T01:35:44.505Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡å€Ÿé‰´æ•´ç†äº†iOSé«˜çº§å¼€å‘å¸¸è§çš„é¢è¯•é¢˜ï¼Œå¹¶ä¸”åˆ†åšå®¢ä¸€ä¸€åˆ†æï¼Œå¸Œæœ›èƒ½å’Œå¤§å®¶ä¸€èµ·è¿›æ­¥å­¦ä¹ ã€‚</p><p>æ¬¢è¿å¤§å®¶å…³æ³¨æˆ‘çš„ <a href="https://github.com/VanchChen" target="_blank" rel="noopener">Github</a>ğŸ‘ä»¥åŠç›¸å…³åšå®¢ <a href="https://www.jianshu.com/u/a3a36cfc4cb6" target="_blank" rel="noopener">ç®€ä¹¦</a> <a href="https://www.cnblogs.com/vanch/" target="_blank" rel="noopener">åšå®¢å›­</a></p><p>å¤§å®¶çš„é¼“åŠ±æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›ğŸ˜„</p><h2 id="iOSåŸºç¡€é¢˜"><a href="#iOSåŸºç¡€é¢˜" class="headerlink" title="iOSåŸºç¡€é¢˜"></a>iOSåŸºç¡€é¢˜</h2><ol><li>åˆ†ç±»å’Œæ‰©å±•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå¯ä»¥åˆ†åˆ«ç”¨æ¥åšä»€ä¹ˆï¼Ÿåˆ†ç±»æœ‰å“ªäº›å±€é™æ€§ï¼Ÿåˆ†ç±»çš„ç»“æ„ä½“é‡Œé¢æœ‰å“ªäº›æˆå‘˜ï¼Ÿ<br> <a href="https://vanchchen.github.io/p/5cb0.html">Categoryæ¢ç´¢</a></li><li>è®²ä¸€ä¸‹atomicçš„å®ç°æœºåˆ¶ï¼›ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯ç»å¯¹çš„çº¿ç¨‹å®‰å…¨ï¼ˆæœ€å¥½å¯ä»¥ç»“åˆåœºæ™¯æ¥è¯´ï¼‰ï¼Ÿ</li><li>è¢«weakä¿®é¥°çš„å¯¹è±¡åœ¨è¢«é‡Šæ”¾çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæ˜¯å¦‚ä½•å®ç°çš„ï¼ŸçŸ¥é“sideTableä¹ˆï¼Ÿé‡Œé¢çš„ç»“æ„å¯ä»¥ç”»å‡ºæ¥ä¹ˆï¼Ÿ</li><li>å…³è”å¯¹è±¡æœ‰ä»€ä¹ˆåº”ç”¨ï¼Œç³»ç»Ÿå¦‚ä½•ç®¡ç†å…³è”å¯¹è±¡ï¼Ÿå…¶è¢«é‡Šæ”¾çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨å°†å…¶æŒ‡é’ˆç½®ç©ºä¹ˆï¼Ÿ<br> <a href="https://vanchchen.github.io/p/f39e.html">AssociatedObjectå…³è”å¯¹è±¡åŸç†å®ç°</a></li><li>KVOçš„åº•å±‚å®ç°ï¼Ÿå¦‚ä½•å–æ¶ˆç³»ç»Ÿé»˜è®¤çš„KVOå¹¶æ‰‹åŠ¨è§¦å‘ï¼ˆç»™KVOçš„è§¦å‘è®¾å®šæ¡ä»¶ï¼šæ”¹å˜çš„å€¼ç¬¦åˆæŸä¸ªæ¡ä»¶æ—¶å†è§¦å‘KVOï¼‰ï¼Ÿ<br> <a href="https://vanchchen.github.io/p/52b3.html">åˆ¨æ ¹é—®åº•KVOåŸç†</a></li><li><code>Autoreleasepool</code>æ‰€ä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ<code>AutoreleasePoolPage</code>ç»“æ„ä½“äº†è§£ä¹ˆï¼Ÿ</li><li>è®²ä¸€ä¸‹å¯¹è±¡ï¼Œç±»å¯¹è±¡ï¼Œå…ƒç±»ï¼Œè·Ÿå…ƒç±»ç»“æ„ä½“çš„ç»„æˆä»¥åŠä»–ä»¬æ˜¯å¦‚ä½•ç›¸å…³è”çš„ï¼Ÿä¸ºä»€ä¹ˆå¯¹è±¡æ–¹æ³•æ²¡æœ‰ä¿å­˜çš„å¯¹è±¡ç»“æ„ä½“é‡Œï¼Œè€Œæ˜¯ä¿å­˜åœ¨ç±»å¯¹è±¡çš„ç»“æ„ä½“é‡Œï¼Ÿ</li><li><code>class_ro_t</code> å’Œ  <code>class_rw_t</code> çš„åŒºåˆ«ï¼Ÿ</li><li>iOS ä¸­å†…çœçš„å‡ ä¸ªæ–¹æ³•ï¼Ÿ<code>class</code>æ–¹æ³•å’Œ<code>objc_getClass</code>æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«?</li><li>åœ¨è¿è¡Œæ—¶åˆ›å»ºç±»çš„æ–¹æ³•<code>objc_allocateClassPair</code>çš„æ–¹æ³•åå°¾éƒ¨ä¸ºä»€ä¹ˆæ˜¯pairï¼ˆæˆå¯¹çš„æ„æ€ï¼‰ï¼Ÿ</li><li>ä¸€ä¸ªintå˜é‡è¢«<code>__block</code>ä¿®é¥°ä¸å¦çš„åŒºåˆ«ï¼Ÿ<br>\12. ä¸ºä»€ä¹ˆåœ¨blockå¤–éƒ¨ä½¿ç”¨<code>__weak</code>ä¿®é¥°çš„åŒæ—¶éœ€è¦åœ¨å†…éƒ¨ä½¿ç”¨<code>__strong</code>ä¿®é¥°ï¼Ÿ</li><li>RunLoopçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿå®ƒçš„å†…éƒ¨å·¥ä½œæœºåˆ¶äº†è§£ä¹ˆï¼Ÿï¼ˆæœ€å¥½ç»“åˆçº¿ç¨‹å’Œå†…å­˜ç®¡ç†æ¥è¯´ï¼‰</li><li>å“ªäº›åœºæ™¯å¯ä»¥è§¦å‘ç¦»å±æ¸²æŸ“ï¼Ÿï¼ˆçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰</li></ol><hr><h2 id="iOS-å®æˆ˜é¢˜"><a href="#iOS-å®æˆ˜é¢˜" class="headerlink" title="iOS å®æˆ˜é¢˜"></a>iOS å®æˆ˜é¢˜</h2><ol><li>AppDelegateå¦‚ä½•ç˜¦èº«ï¼Ÿ</li><li>åå°„æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥ä¸¾å‡ºå‡ ä¸ªåº”ç”¨åœºæ™¯ä¹ˆï¼Ÿï¼ˆçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰</li><li>æœ‰å“ªäº›åœºæ™¯æ˜¯NSOperationæ¯”GCDæ›´å®¹æ˜“å®ç°çš„ï¼Ÿï¼ˆæˆ–æ˜¯NSOperationä¼˜äºGCDçš„å‡ ç‚¹ï¼ŒçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰</li><li>App å¯åŠ¨ä¼˜åŒ–ç­–ç•¥ï¼Ÿæœ€å¥½ç»“åˆå¯åŠ¨æµç¨‹æ¥è¯´ï¼ˆmain()å‡½æ•°çš„æ‰§è¡Œå‰åéƒ½åˆ†åˆ«è¯´ä¸€ä¸‹ï¼ŒçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰</li><li>App æ— ç—•åŸ‹ç‚¹çš„æ€è·¯äº†è§£ä¹ˆï¼Ÿä½ è®¤ä¸ºç†æƒ³çš„æ— ç—•åŸ‹ç‚¹ç³»ç»Ÿåº”è¯¥å…·å¤‡å“ªäº›ç‰¹ç‚¹ï¼Ÿï¼ˆçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰</li><li>ä½ çŸ¥é“æœ‰å“ªäº›æƒ…å†µä¼šå¯¼è‡´appå´©æºƒï¼Œåˆ†åˆ«å¯ä»¥ç”¨ä»€ä¹ˆæ–¹æ³•æ‹¦æˆªå¹¶åŒ–è§£ï¼Ÿï¼ˆçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰</li><li>ä½ çŸ¥é“æœ‰å“ªäº›æƒ…å†µä¼šå¯¼è‡´appå¡é¡¿ï¼Œåˆ†åˆ«å¯ä»¥ç”¨ä»€ä¹ˆæ–¹æ³•æ¥é¿å…ï¼Ÿï¼ˆçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰</li></ol><hr><h2 id="ç½‘ç»œé¢˜"><a href="#ç½‘ç»œé¢˜" class="headerlink" title="ç½‘ç»œé¢˜"></a>ç½‘ç»œé¢˜</h2><ol><li>App ç½‘ç»œå±‚æœ‰å“ªäº›ä¼˜åŒ–ç­–ç•¥ï¼Ÿ</li><li>TCPä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹ï¼Ÿ</li><li>å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†çš„åŒºåˆ«ï¼Ÿåˆ†åˆ«æœ‰å“ªäº›ç®—æ³•çš„å®ç°ï¼Ÿ</li><li>HTTPSçš„æ¡æ‰‹æµç¨‹ï¼Ÿä¸ºä»€ä¹ˆå¯†é’¥çš„ä¼ é€’éœ€è¦ä½¿ç”¨éå¯¹ç§°åŠ å¯†ï¼ŸåŒå‘è®¤è¯äº†è§£ä¹ˆï¼Ÿ</li><li>HTTPSæ˜¯å¦‚ä½•å®ç°éªŒè¯èº«ä»½å’ŒéªŒè¯å®Œæ•´æ€§çš„ï¼Ÿ</li><li>å¦‚ä½•ç”¨CharlesæŠ“HTTPSçš„åŒ…ï¼Ÿå…¶ä¸­åŸç†å’Œæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯ä¸­é—´äººæ”»å‡»ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ</li></ol><hr><h2 id="è®¡ç®—æœºç³»ç»Ÿé¢˜"><a href="#è®¡ç®—æœºç³»ç»Ÿé¢˜" class="headerlink" title="è®¡ç®—æœºç³»ç»Ÿé¢˜"></a>è®¡ç®—æœºç³»ç»Ÿé¢˜</h2><ol><li>äº†è§£ç¼–è¯‘çš„è¿‡ç¨‹ä¹ˆï¼Ÿåˆ†ä¸ºå“ªå‡ ä¸ªæ­¥éª¤ï¼Ÿ</li><li>é™æ€é“¾æ¥äº†è§£ä¹ˆï¼Ÿé™æ€åº“å’ŒåŠ¨æ€åº“çš„åŒºåˆ«ï¼Ÿ</li><li>å†…å­˜çš„å‡ å¤§åŒºåŸŸï¼Œå„è‡ªçš„èŒèƒ½åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>staticå’Œconstæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>äº†è§£å†…è”å‡½æ•°ä¹ˆï¼Ÿ</li><li>ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°æ­»é”ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ</li><li>è¯´ä¸€è¯´ä½ å¯¹çº¿ç¨‹å®‰å…¨çš„ç†è§£ï¼Ÿ</li><li>åˆ—ä¸¾ä½ çŸ¥é“çš„çº¿ç¨‹åŒæ­¥ç­–ç•¥ï¼Ÿ</li><li>æœ‰å“ªå‡ ç§é”ï¼Ÿå„è‡ªçš„åŸç†ï¼Ÿå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿæœ€å¥½å¯ä»¥ç»“åˆä½¿ç”¨åœºæ™¯æ¥è¯´</li></ol><hr><h2 id="è®¾è®¡æ¨¡å¼é¢˜"><a href="#è®¾è®¡æ¨¡å¼é¢˜" class="headerlink" title="è®¾è®¡æ¨¡å¼é¢˜"></a>è®¾è®¡æ¨¡å¼é¢˜</h2><ol><li>é™¤äº†å•ä¾‹ï¼Œè§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼ä»¥å¤–ï¼Œè¿˜çŸ¥é“å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿåˆ†åˆ«ä»‹ç»ä¸€ä¸‹</li><li>æœ€å–œæ¬¢å“ªä¸ªè®¾è®¡æ¨¡å¼ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</li><li>iOS SDK é‡Œé¢æœ‰å“ªäº›è®¾è®¡æ¨¡å¼çš„å®è·µï¼Ÿ</li><li>**è®¾è®¡æ¨¡å¼æ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜çš„ï¼Ÿ</li><li>**è®¾è®¡æ¨¡å¼çš„æˆå‘˜æ„æˆä»¥åŠå·¥ä½œæœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>**è®¾è®¡æ¨¡å¼çš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</li></ol><hr><h2 id="æ¶æ„-amp-è®¾è®¡é¢˜"><a href="#æ¶æ„-amp-è®¾è®¡é¢˜" class="headerlink" title="æ¶æ„ &amp; è®¾è®¡é¢˜"></a>æ¶æ„ &amp; è®¾è®¡é¢˜</h2><ol><li>MVCå’ŒMVVMçš„åŒºåˆ«ï¼ŸMVVMå’ŒMVPçš„åŒºåˆ«ï¼Ÿ</li><li>é¢å‘å¯¹è±¡çš„å‡ ä¸ªè®¾è®¡åŸåˆ™äº†è§£ä¹ˆï¼Ÿæœ€å¥½å¯ä»¥ç»“åˆåœºæ™¯æ¥è¯´ã€‚</li><li>å¯ä»¥è¯´å‡ ä¸ªé‡æ„çš„æŠ€å·§ä¹ˆï¼Ÿä½ è§‰å¾—é‡æ„é€‚åˆä»€ä¹ˆæ—¶å€™æ¥åšï¼Ÿ</li><li>ä½ è§‰å¾—æ¡†æ¶å’Œè®¾è®¡æ¨¡å¼çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>çœ‹è¿‡å“ªäº›ç¬¬ä¸‰æ–¹æ¡†æ¶çš„æºç ï¼Œå®ƒä»¬æ˜¯æ€ä¹ˆè®¾è®¡çš„ï¼Ÿè®¾è®¡å¥½çš„åœ°æ–¹åœ¨å“ªé‡Œï¼Œä¸å¥½çš„åœ°æ–¹åœ¨å“ªé‡Œï¼Œå¦‚ä½•æ”¹è¿›ï¼Ÿï¼ˆè¿™é“é¢˜çš„åä¸‰ä¸ªé—®é¢˜çš„éš¾åº¦å·²ç»å¾ˆé«˜äº†ï¼Œå¦‚æœä¸æ˜¯å¤ªNçš„å…¬å¸ä¸å»ºè®®æ·±ç©¶ï¼‰</li></ol><hr><h2 id="æ•°æ®ç»“æ„-amp-ç®—æ³•é¢˜"><a href="#æ•°æ®ç»“æ„-amp-ç®—æ³•é¢˜" class="headerlink" title="æ•°æ®ç»“æ„&amp;ç®—æ³•é¢˜"></a>æ•°æ®ç»“æ„&amp;ç®—æ³•é¢˜</h2><ol><li>é“¾è¡¨å’Œæ•°ç»„çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿæ’å…¥å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦åˆ†åˆ«æ˜¯å¤šå°‘ï¼Ÿ</li><li>å“ˆå¸Œè¡¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå¦‚ä½•è§£å†³åœ°å€å†²çªï¼Ÿ</li><li>æ’åºé¢˜ï¼šå†’æ³¡æ’åºï¼Œé€‰æ‹©æ’åºï¼Œæ’å…¥æ’åºï¼Œå¿«é€Ÿæ’åºï¼ˆäºŒè·¯ï¼Œä¸‰è·¯ï¼‰èƒ½å†™å‡ºé‚£äº›ï¼Ÿ</li><li>é“¾è¡¨é¢˜ï¼šå¦‚ä½•æ£€æµ‹é“¾è¡¨ä¸­æ˜¯å¦æœ‰ç¯ï¼Ÿå¦‚ä½•åˆ é™¤é“¾è¡¨ä¸­ç­‰äºæŸä¸ªå€¼çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Ÿ</li><li>æ•°ç»„é¢˜ï¼šå¦‚ä½•åœ¨æœ‰åºæ•°ç»„ä¸­æ‰¾å‡ºå’Œç­‰äºç»™å®šå€¼çš„ä¸¤ä¸ªå…ƒç´ ï¼Ÿå¦‚ä½•åˆå¹¶ä¸¤ä¸ªæœ‰åºçš„æ•°ç»„ä¹‹åä¿æŒæœ‰åºï¼Ÿ</li><li>äºŒå‰æ ‘é¢˜ï¼šå¦‚ä½•åè½¬äºŒå‰æ ‘ï¼Ÿå¦‚ä½•éªŒè¯ä¸¤ä¸ªäºŒå‰æ ‘æ˜¯å®Œå…¨ç›¸ç­‰çš„ï¼Ÿ</li></ol><hr><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="https://mp.weixin.qq.com/s/-cefmEo7RcZ5wifXX8JB5g" target="_blank" rel="noopener">å‡ºä¸€å¥— iOS é«˜çº§é¢è¯•é¢˜</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ¬æ–‡å€Ÿé‰´æ•´ç†äº†iOSé«˜çº§å¼€å‘å¸¸è§çš„é¢è¯•é¢˜ï¼Œå¹¶ä¸”åˆ†åšå®¢ä¸€ä¸€åˆ†æï¼Œå¸Œæœ›èƒ½å’Œå¤§å®¶ä¸€èµ·è¿›æ­¥å­¦ä¹ ã€‚&lt;/p&gt;
&lt;p&gt;æ¬¢è¿å¤§å®¶å…³æ³¨æˆ‘çš„ &lt;a href=&quot;
      
    
    </summary>
    
      <category term="iOS" scheme="https://vanchchen.github.io/categories/iOS/"/>
    
    
      <category term="é¢è¯•" scheme="https://vanchchen.github.io/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
</feed>
