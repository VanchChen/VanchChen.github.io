{"meta":{"title":"Vanch's Blog","subtitle":"æ¬¢è¿æ¥åˆ°æˆ‘çš„ä¸–ç•Œ","description":"å˜¿å˜¿å˜¿ï½","author":"Vanch","url":"https://vanchchen.github.io"},"pages":[{"title":"","date":"2019-01-30T09:20:32.560Z","updated":"2017-11-07T01:57:43.000Z","comments":true,"path":"404.html","permalink":"https://vanchchen.github.io/404.html","excerpt":"","text":"404"},{"title":"","date":"2019-01-30T09:20:32.546Z","updated":"2018-10-08T01:55:15.827Z","comments":true,"path":"google706759de818b3de4.html","permalink":"https://vanchchen.github.io/google706759de818b3de4.html","excerpt":"","text":"google-site-verification: google706759de818b3de4.html"},{"title":"","date":"2019-01-30T09:20:32.566Z","updated":"2018-10-08T01:55:15.826Z","comments":true,"path":"baidu_verify_taFsHIjAWm.html","permalink":"https://vanchchen.github.io/baidu_verify_taFsHIjAWm.html","excerpt":"","text":"taFsHIjAWm"},{"title":"æˆ‘æ˜¯è°ï¼Ÿ","date":"2018-10-06T07:34:27.000Z","updated":"2019-04-01T01:17:47.246Z","comments":true,"path":"about/index.html","permalink":"https://vanchchen.github.io/about/index.html","excerpt":"","text":"@card{ æˆ‘å«é™ˆæ–‡ç¦ï¼Œè‹±æ–‡åVanchï¼Œç°å±…ä¸Šæµ·ï¼Œä»äº‹iOSå¼€å‘å·¥ä½œï¼Œå¯¹ä»£ç æœ‰ç‚¹å¼ºè¿«ç—‡ã€‚ è¿‘æœŸæ‰å†³å®šæŠŠæœ€è¿‘æ‰€å­¦æ•´ç†æˆåšå®¢è®°å½•ä¸‹æ¥ï¼Œç›®å‰ä¸»è¦æ–¹å‘ä¸ºé¢è¯•é¢˜å‡†å¤‡ã€‚ åšä¿¡çŸ¥è¯†åªæœ‰æ•´ç†æˆè‡ªå·±çš„æ–‡å­—ï¼Œæ‰ç®—ç†è§£å­¦ä¼šã€‚ } å…´è¶£@column-2{ @card{ å·¦è„‘ä¸»æ”» iOSï¼ŒLinux åŸç†å®ç°ä¸å„ç§æœ‰æ„æ€çš„è¯¾é¢˜ æ­£åœ¨å­¦Shellè„šæœ¬æé«˜æ•ˆç‡ å‡†å¤‡è¾¹å­¦ Swift4.4 è¾¹å­¦ç®—æ³• çœŸå¤Ÿè´ªå¿ƒ ä¼šCocoså¼€å‘å¾®ä¿¡å°æ¸¸æˆ å¯¹Pythonæœ‰å…´è¶£ } @card{ å³è„‘å–œæ¬¢è¯»æ–‡å­¦ã€æ¨ç†ã€å†å²ä¹¦ç± å¤§çˆ±å¤å…¸éŸ³ä¹ï¼Œä½†ä¹Ÿå–œæ¬¢Rap ä»€ä¹ˆé¬¼.. å‰ä»– åªä¼šçˆ¬éŸ³é˜¶ å›´æ£‹ åˆçº§ç”µè„‘éƒ½æ‰“ä¸è¿‡ ç”»ç”» åªä¼šç®€ç¬”ç”» } } å¥èº«è®¡åˆ’ å‘¨ä¸€ å‘¨äºŒ å‘¨ä¸‰ å‘¨å›› å‘¨äº” å‘¨å…­ å‘¨æ—¥ èƒ¸è‡‚ èƒŒè‚© è‡€è…¿ èƒ¸è‡‚ èƒŒè‚© è‡€è…¿ ä¼‘æ¯ è…¹éƒ¨ è…¹éƒ¨ è…¹éƒ¨ è…¹éƒ¨ è…¹éƒ¨ è…¹éƒ¨ ä¼‘æ¯ @card{ èƒ¸è‡‚ï¼šå¼¹åŠ›å¸¦å¤¹èƒ¸ã€åæ‰‹å¤¹èƒ¸ã€äº¤å‰å¤¹èƒ¸ï¼Œä¿¯å§æ’‘ï¼Œå“‘é“ƒæ¨ä¸¾ã€å¼¯ä¸¾ã€‚ èƒŒè‚©ï¼šåæ‰‹åˆ’èˆ¹ã€å¯¹æ¡åˆ’èˆ¹ï¼Œå¼¹åŠ›å¸¦ä¸‹å‹ã€‚ è‡€è…¿ï¼šæ·±è¹²ï¼Œç¡¬æ‹‰ã€‚ è…¹éƒ¨ï¼šå·è…¹ï¼Œå¹³æ¿æ”¯æ’‘ï¼Œè…¹å¥è½®ã€‚ } æ±‚å‹¾æ­@card{ æ¬¢è¿å¤§å®¶å’Œæˆ‘äº¤æµï½ å¾®ä¿¡ï¼šVanch0714 é‚®ç®±ï¼š447389831@qq.com å¯ä»¥åœ¨è¯„è®ºåŒºç•™è¨€ï¼Œæœ‰æ—¶é—´æˆ‘éƒ½ä¼šå›å¤ï¼ }"},{"title":"categories","date":"2018-09-14T09:13:36.000Z","updated":"2018-09-14T09:15:05.482Z","comments":false,"path":"categories/index.html","permalink":"https://vanchchen.github.io/categories/index.html","excerpt":"","text":""},{"title":"é‡Œä¸–ç•Œ","date":"1991-07-14T04:00:00.000Z","updated":"2019-03-29T07:21:35.639Z","comments":false,"path":"sage/index.html","permalink":"https://vanchchen.github.io/sage/index.html","excerpt":"","text":""},{"title":"tags","date":"2018-09-14T09:00:14.000Z","updated":"2018-09-14T09:14:24.713Z","comments":false,"path":"tags/index.html","permalink":"https://vanchchen.github.io/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"é€æ­¥æ¢ç©¶ObjCçš„WeakæŠ€æœ¯åº•å±‚","slug":"WeakåŸç†","date":"2019-12-09T08:03:09.000Z","updated":"2019-12-09T09:12:33.187Z","comments":true,"path":"p/3e6b.html","link":"","permalink":"https://vanchchen.github.io/p/3e6b.html","excerpt":"","text":"å‰è¨€ä¹‹å‰çš„æ–‡ç« æœ‰è¯´è¿‡ Atomic åŸå­æ“ä½œçš„åŸç†ï¼Œå…¶ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ä¿®é¥°å‰ç¼€ï¼Œå½±å“äº†å­˜å–æ“ä½œã€‚ åœ¨å±æ€§ä¿®é¥°å®šä¹‰ä¸­ï¼Œè¿˜æœ‰å¦ä¸€ç±»ä¿®é¥°å‰ç¼€ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯ strong weak assign copyï¼Œè¿™äº›åˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ å¹³æ—¶å–œæ¬¢æ¢ç©¶çš„åŒå­¦ï¼Œå¯èƒ½ä¹Ÿè§è¿‡ unsafe_unretainedï¼Œè¿™ä¸ªåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ è®©æˆ‘ä»¬ä»å±æ€§ä¿®é¥°å…¥æ‰‹ï¼Œé€æ­¥æ­å¼€å¼±å¼•ç”¨çš„é¢çº±ã€‚ åŸç†å±æ€§è‡ªåŠ¨ç”Ÿæˆçš„å®ç°æ–¹æ³•æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿé¦–å…ˆæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªç¤ºä¾‹ä»£ç æ–‡ä»¶ä½œä¸ºæ ·æœ¬ã€‚ 1234567891011121314#import &lt;Foundation/Foundation.h&gt;@interface PropertyObject : NSObject@property (nonatomic, strong) NSObject *pStrongObj; //å¼ºå¼•ç”¨@property (nonatomic, copy) NSObject *pCopyObj; //æ‹·è´@property (nonatomic, weak) NSObject *pWeakObj; //å¼±å¼•ç”¨@property (nonatomic, assign) NSObject *pAssignObj; //ç”³æ˜@property (nonatomic, unsafe_unretained) NSObject *pUnretainedObj; //éæŒæœ‰@end@implementation PropertyObject@end ç„¶åé€šè¿‡ clang -rewrite-objc -fobjc-arc -stdlib=libc++ -mmacosx-version-min=10.14 -fobjc-runtime=macosx-10.14 -Wno-deprecated-declarations main.m å‘½ä»¤å°†å…¶è§£é‡Šæˆ c++ ä»£ç ã€‚ï¼ˆæ³¨æ„è¿™é‡Œè¦æŒ‡å®šç‰ˆæœ¬ï¼Œä¸ç„¶weakå±æ€§ä¸èƒ½ç¿»è¯‘ï¼‰ å±•å¼€çš„ä»£ç æ¯”è¾ƒå¤šï¼Œæˆ‘è¿™é‡Œæˆªå–å…³é”®éƒ¨åˆ†æ¢è®¨ã€‚ 12345678910111213struct PropertyObject_IMPL &#123; NSObject *__strong _pStrongObj; NSObject *__strong _pCopyObj; NSObject *__weak _pWeakObj; NSObject *__unsafe_unretained _pAssignObj; NSObject *__unsafe_unretained _pUnretainedObj;&#125;;&#123;\"pStrongObj\",\"T@\\\"NSObject\\\",&amp;,N,V_pStrongObj\"&#125;,&#123;\"pCopyObj\",\"T@\\\"NSObject\\\",C,N,V_pCopyObj\"&#125;,&#123;\"pWeakObj\",\"T@\\\"NSObject\\\",W,N,V_pWeakObj\"&#125;,&#123;\"pAssignObj\",\"T@\\\"NSObject\\\",N,V_pAssignObj\"&#125;,&#123;\"pUnretainedObj\",\"T@\\\"NSObject\\\",N,V_pUnretainedObj\"&#125; ä»å˜é‡ç»“æ„ä½“çš„æè¿°å’Œç‰¹æ€§å¯ä»¥çœ‹å‡ºï¼Œstrongå’Œcopyå®é™…éƒ½æ˜¯__strongä¿®é¥°ï¼Œä½†ç‰¹æ€§ä¸åŒï¼Œassignå’Œunsafe_unretained åˆ™å®Œå…¨ä¸€è‡´ï¼Œéƒ½æ˜¯__unsafe_unretainedï¼Œweakåˆ™å•ç‹¬ä½¿ç”¨__weakä¿®é¥°ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ–¹æ³•å…·ä½“å®ç°ã€‚ 123456789101112131415161718192021// @implementation PropertyObject//æ ¹æ®åç§»å–å€¼å’Œèµ‹å€¼static NSObject * _I_PropertyObject_pStrongObj(PropertyObject * self, SEL _cmd) &#123; return (*(NSObject *__strong *)((char *)self + OBJC_IVAR_$_PropertyObject$_pStrongObj)); &#125;static void _I_PropertyObject_setPStrongObj_(PropertyObject * self, SEL _cmd, NSObject *pStrongObj) &#123; (*(NSObject *__strong *)((char *)self + OBJC_IVAR_$_PropertyObject$_pStrongObj)) = pStrongObj; &#125;static NSObject * _I_PropertyObject_pCopyObj(PropertyObject * self, SEL _cmd) &#123; return (*(NSObject *__strong *)((char *)self + OBJC_IVAR_$_PropertyObject$_pCopyObj)); &#125;extern \"C\" __declspec(dllimport) void objc_setProperty (id, SEL, long, id, bool, bool);//åªæœ‰Copyä¸åŒï¼Œsetterçš„å®ç°æ˜¯objc_setPropertystatic void _I_PropertyObject_setPCopyObj_(PropertyObject * self, SEL _cmd, NSObject *pCopyObj) &#123; objc_setProperty (self, _cmd, __OFFSETOFIVAR__(struct PropertyObject, _pCopyObj), (id)pCopyObj, 0, 1); &#125;static NSObject * _I_PropertyObject_pWeakObj(PropertyObject * self, SEL _cmd) &#123; return (*(NSObject *__weak *)((char *)self + OBJC_IVAR_$_PropertyObject$_pWeakObj)); &#125;static void _I_PropertyObject_setPWeakObj_(PropertyObject * self, SEL _cmd, NSObject *pWeakObj) &#123; (*(NSObject *__weak *)((char *)self + OBJC_IVAR_$_PropertyObject$_pWeakObj)) = pWeakObj; &#125;static NSObject * _I_PropertyObject_pAssignObj(PropertyObject * self, SEL _cmd) &#123; return (*(NSObject *__unsafe_unretained *)((char *)self + OBJC_IVAR_$_PropertyObject$_pAssignObj)); &#125;static void _I_PropertyObject_setPAssignObj_(PropertyObject * self, SEL _cmd, NSObject *pAssignObj) &#123; (*(NSObject *__unsafe_unretained *)((char *)self + OBJC_IVAR_$_PropertyObject$_pAssignObj)) = pAssignObj; &#125;static NSObject * _I_PropertyObject_pUnretainedObj(PropertyObject * self, SEL _cmd) &#123; return (*(NSObject *__unsafe_unretained *)((char *)self + OBJC_IVAR_$_PropertyObject$_pUnretainedObj)); &#125;static void _I_PropertyObject_setPUnretainedObj_(PropertyObject * self, SEL _cmd, NSObject *pUnretainedObj) &#123; (*(NSObject *__unsafe_unretained *)((char *)self + OBJC_IVAR_$_PropertyObject$_pUnretainedObj)) = pUnretainedObj; &#125;// @end åœ¨ä»£ç ä¸­ï¼Œåªæœ‰copyä¿®é¥°å±æ€§çš„setteræ–¹æ³•ä½¿ç”¨äº†objc_setPropertyï¼Œå…¶ä»–å‡ ç§éƒ½æ˜¯æ ¹æ® self + åç§»é‡ çš„æ–¹å¼è®¡ç®—å‡ºå†…å­˜åœ°å€ç›´æ¥è¿›è¡Œå­˜å–ã€‚ é‚£é—®é¢˜æ¥äº†ï¼Œå¦‚æœçœŸçš„æ˜¯é‚£ä¹ˆç®€å•çš„è¯ï¼Œarc æ˜¯æ€ä¹ˆå®ç°æ ¹æ®ä¸åŒä¿®é¥°ä»è€Œè¿›è¡Œå†…å­˜ç®¡ç†çš„å‘¢ï¼Ÿ åŸæ¥é€šè¿‡ clang -rewrite-objc çš„ä»£ç åªæ˜¯ç¿»è¯‘æˆ c++ è¯­è¨€ï¼Œåœ¨ä¹‹åçš„ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šè¿›ä¸€æ­¥å¤„ç†ã€‚ æ¥ç€ä½¿ç”¨ clang -S -fobjc-arc -emit-llvm main.m -o main.ll å‘½ä»¤ç”Ÿæˆä¸­é—´ç ã€‚ ï¼ˆä¸­é—´ç æ˜¾ç¤ºæ¯”è¾ƒæ‚ä¹±ï¼Œæˆ‘æ ¹æ®è‡ªå·±ç†è§£æ•´ç†æˆç®€æ´ç‰ˆï¼‰ 123456789101112131415161718192021222324252627282930313233343536//ä»£ç æ•´ç†åid [PropertyObject pStrongObj] &#123; return *location; &#125;void [PropertyObject setPStrongObj:](self, _cmd, obj) &#123; @llvm.objc.storeStrong(*location, obj)&#125;id [PropertyObject pCopyObj] &#123; return @objc_getProperty(self, _cmd, offset, atomic)&#125;void [PropertyObject setPCopyObj:](self, _cmd, obj) &#123; @objc_setProperty_nonatomic_copy(self, _cmd, obj, offset)&#125;id [PropertyObject pWeakObj] &#123; id obj = @llvm.objc.loadWeakRetained(*location) return @llvm.objc.autoreleaseReturnValue(obj)&#125;void [PropertyObject setPWeakObj:](self, _cmd, obj) &#123; @llvm.objc.storeWeak(*location, obj)&#125;id [PropertyObject pAssignObj] &#123; return *location&#125;void [PropertyObject setPAssignObj:](self, _cmd, obj) &#123; *location = obj&#125;id [PropertyObject pUnretainedObj] &#123; return *location&#125;void [PropertyObject setPUnretainedObj:](self, _cmd, obj) &#123; *location = obj&#125; å¯ä»¥çœ‹å‡ºåˆ†åˆ«é’ˆå¯¹strong å’Œ weak éƒ½åšäº†å¤„ç†ï¼Œè€Œassign å’Œ unsafe_unretainedåˆ™ä¸åšå†…å­˜ç®¡ç†ç›´æ¥è¿”å›ï¼Œè¿™ä¹Ÿè¯´æ˜è¿™ä¸¤è€…çš„å¤„ç†æ–¹å¼æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«åœ¨äº assign é’ˆå¯¹ã€‚ strong copy weak assign unsafe_unretained Ownership __strong __strong __weak __unsafe_unretained __unsafe_unretained Getter *location objc_getProperty loadWeakRetained *location *location Setter storeStrong objc_setProperty storeWeak *location *location å¯¹è±¡ NSObject NSObject NSObject NSObject Scalar Weakå¯¹è±¡æ€ä¹ˆå®ç°å­˜å–çš„ï¼Ÿæœ¬æ–‡ç¯‡å¹…æœ‰é™ï¼Œæš‚ä¸ä»‹ç» storeStrong å’Œ objc_setProperty_nonatomic_copyï¼Œä¸»è¦ä»‹ç» weak ç›¸å…³æ“ä½œã€‚ æ‰“å¼€ objc4-750 å¼€æºä»£ç ï¼Œç¿»åˆ° NSObject.mmï¼Œæˆ‘ä»¬æ¥ä¸€æ¢ç©¶ç«Ÿã€‚ 123456789101112131415161718192021// åˆå§‹åŒ–å¼±å¼•ç”¨id objc_initWeak(id *location, id newObj) &#123; // ä¸å­˜åœ¨åˆ™ä¸ä¿å­˜ if (!newObj) &#123; *location = nil; return nil; &#125; return storeWeak&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt; (location, (objc_object*)newObj);&#125;// é”€æ¯å¼±å¼•ç”¨void objc_destroyWeak(id *location) &#123; (void)storeWeak&lt;DoHaveOld, DontHaveNew, DontCrashIfDeallocating&gt; (location, nil);&#125;// äº¤æ¢åŸæœ‰çš„å€¼id objc_storeWeak(id *location, id newObj) &#123; return storeWeak&lt;DoHaveOld, DoHaveNew, DoCrashIfDeallocating&gt; (location, (objc_object *)newObj);&#125; å¯ä»¥çœ‹åˆ° runtime ä¸­è°ƒç”¨çš„éƒ½æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼ŒåŒºåˆ«åœ¨äºä½¿ç”¨äº†ä¸åŒçš„æ¨¡ç‰ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸‹å¯¹ä¸€ä¸ªåœ°å€çš„å­˜å–æ–¹æ³•ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125// è·å–æ“ä½œçš„å…·ä½“å®ç°id objc_loadWeakRetained(id *location) &#123; id obj; id result; Class cls; SideTable *table; retry: // ä¿è¯åœ°å€æœ‰æ•°æ®ä¸”ä¸æ˜¯ä¼ªæŒ‡é’ˆ obj = *location; if (!obj) return nil; if (obj-&gt;isTaggedPointer()) return obj; // æ ¹æ®åœ°å€å–å‡ºå¯¹åº”çš„è¡¨ table = &amp;SideTables()[obj]; // åŠ é” table-&gt;lock(); // å¦‚æœæ•°æ®è¢«å…¶ä»–çº¿ç¨‹æ”¹å˜ï¼Œåˆ™é‡è¯• if (*location != obj) &#123; table-&gt;unlock(); goto retry; &#125; result = obj; cls = obj-&gt;ISA(); if (! cls-&gt;hasCustomRR()) &#123; // å¦‚æœä½¿ç”¨çš„æ˜¯ç³»ç»Ÿé»˜è®¤çš„å†…å­˜ç®¡ç†ï¼Œåˆ™ä¿è¯äº†å·²ç»åˆå§‹åŒ– // æ‰€ä»¥å¯ä»¥ç›´æ¥rootTryRetain assert(cls-&gt;isInitialized()); if (! obj-&gt;rootTryRetain()) &#123; result = nil; &#125; &#125; else &#123; // å¦‚æœä¸æ˜¯é»˜è®¤çš„ï¼Œåˆ™éœ€è¦ç¡®ä¿åœ¨åˆå§‹åŒ–çº¿ç¨‹ä¸Šæ‰§è¡Œè‡ªå®šä¹‰retainæ“ä½œ if (cls-&gt;isInitialized() || _thisThreadIsInitializingClass(cls)) &#123; BOOL (*tryRetain)(id, SEL) = (BOOL(*)(id, SEL)) class_getMethodImplementation(cls, SEL_retainWeakReference); if ((IMP)tryRetain == _objc_msgForward) &#123; result = nil; &#125; else if (! (*tryRetain)(obj, SEL_retainWeakReference)) &#123; result = nil; &#125; &#125; else &#123; table-&gt;unlock(); _class_initialize(cls); goto retry; &#125; &#125; //å®Œæˆåè§£é” table-&gt;unlock(); return result;&#125;// ä¿å­˜æ“ä½œçš„å…·ä½“å®ç°static id storeWeak(id *location, objc_object *newObj) &#123; // ä¸¤è€…å¿…é¡»æœ‰ä¸€ä¸ªï¼Œä¸ç„¶æ²¡æœ‰æ‰§è¡Œçš„å¿…è¦ assert(haveOld || haveNew); if (!haveNew) assert(newObj == nil); Class previouslyInitializedClass = nil; id oldObj; SideTable *oldTable; SideTable *newTable; // ç”±äºæœ‰é”çš„æœºåˆ¶ï¼Œå¦‚æœåœ¨æœŸé—´å€¼è¢«æ”¹å˜äº†ï¼Œåˆ™é‡è¯•ï¼Œç›´åˆ°æˆåŠŸ retry: if (haveOld) &#123; oldObj = *location; oldTable = &amp;SideTables()[oldObj]; // æ ¹æ®å†…å­˜åœ°å€è·å–è¡¨ &#125; else &#123; oldTable = nil; &#125; if (haveNew) &#123; newTable = &amp;SideTables()[newObj]; &#125; else &#123; newTable = nil; &#125; // é”ä½è¿™ä¸¤å¼ è¡¨ï¼Œæ³¨æ„å¦‚æœæ˜¯åŒä¸€å¼ è¡¨ä¹Ÿæ²¡å…³ç³»ï¼Œæœ‰å¯¹é”åšåˆ¤æ–­ SideTable::lockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); // æ£€æŸ¥å¦‚æœå·²ç»æ”¹å˜äº†ï¼Œåˆ™é‡è¯• if (haveOld &amp;&amp; *location != oldObj) &#123; SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); goto retry; &#125; // æ£€æŸ¥æ–°å¯¹è±¡ç±»æœ‰æ²¡æœ‰åˆå§‹åŒ–å®Œï¼Œæ²¡æœ‰åˆ™é‡è¯• if (haveNew &amp;&amp; newObj) &#123; Class cls = newObj-&gt;getIsa(); if (cls != previouslyInitializedClass &amp;&amp; !((objc_class *)cls)-&gt;isInitialized()) &#123; SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); _class_initialize(_class_getNonMetaClass(cls, (id)newObj)); // å¦‚æœæ­£åœ¨åˆå§‹åŒ–ï¼Œåˆ™è®©ä¸‹ä¸€æ¬¡ç»•è¿‡è¿™ä¸ªåˆ¤æ–­ç»§ç»­è¿è¡Œ previouslyInitializedClass = cls; goto retry; &#125; &#125; // æ¸…é™¤ä¹‹å‰ä¿å­˜çš„å¼±å¼•ç”¨æ•°æ® if (haveOld) &#123; weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location); &#125; // ä¿å­˜æ–°çš„å¼±å¼•ç”¨æ•°æ® if (haveNew) &#123; newObj = (objc_object *) weak_register_no_lock(&amp;newTable-&gt;weak_table, (id)newObj, location, crashIfDeallocating); // ä¿å­˜æˆåŠŸå°±è®°å½•åˆ°å¯¹è±¡æŒ‡é’ˆä¸­ï¼Œè¿™æ ·å¯ä»¥åœ¨é‡Šæ”¾æ—¶æ£€æŸ¥ if (newObj &amp;&amp; !newObj-&gt;isTaggedPointer()) &#123; newObj-&gt;setWeaklyReferenced_nolock(); &#125; // ä¿å­˜åˆ°å¯¹åº”ä½ç½® *location = (id)newObj; &#125; // æ“ä½œæˆåŠŸåè§£é” SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); // è¿”å›æœ€ç»ˆæ•°æ® return (id)newObj;&#125; é™¤å»ä¿æŠ¤æ–¹æ³•ï¼Œå…¶å® objc_loadWeakRetained æ–¹æ³•å°±æ˜¯æ£€æŸ¥åè¿”å› *locationï¼Œä¹Ÿå°±æ˜¯å˜é‡æŒ‡å‘çš„å®é™…åœ°å€ã€‚ è€Œ storeWeak æ–¹æ³•åˆ™æ˜¯æ ¹æ®æ¨¡ç‰ˆï¼Œå¯¹æ—§å¯¹è±¡æ‰§è¡Œ weak_unregister_no_lockï¼Œå¯¹æ–°å¯¹è±¡æ‰§è¡Œ weak_register_no_lockã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128//æ³¨é”€å¼•ç”¨void weak_unregister_no_lock (weak_table_t *weak_table, id referent_id, id *referrer_id) &#123; objc_object *referent = (objc_object *)referent_id; //è¢«å¼•ç”¨äºº objc_object **referrer = (objc_object **)referrer_id; //å¼•ç”¨äºº weak_entry_t *entry; if (!referent) return; //è·å–è¢«å¼•ç”¨äººçš„å¼•ç”¨æ•°ç»„ if ((entry = weak_entry_for_referent(weak_table, referent))) &#123; //ç§»é™¤å¼•ç”¨äºº remove_referrer(entry, referrer); bool empty = true; if (entry-&gt;out_of_line() &amp;&amp; entry-&gt;num_refs != 0) &#123; empty = false; &#125; else &#123; for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) &#123; if (entry-&gt;inline_referrers[i]) &#123; empty = false; break; &#125; &#125; &#125; //å¦‚æœä¸€ä¸ªå¼•ç”¨ä¹Ÿæ²¡äº†ï¼Œåˆ™åˆ é™¤èŠ‚ç‚¹ if (empty) &#123; weak_entry_remove(weak_table, entry); &#125; &#125; // Do not set *referrer = nil. objc_storeWeak() requires that the // value not change. // ä¸Šé¢ä¸ºè‹¹æœæ³¨é‡Šï¼Œçœ‹è¿™æ„æ€åº”è¯¥æ˜¯objc_storeWeakè¿˜éœ€è¦ä½¿ç”¨å¼•ç”¨åœ°å€åšåç»­å¤„ç†ã€‚&#125;//æ³¨å†Œå¼•ç”¨id weak_register_no_lock (weak_table_t *weak_table, id referent_id, id *referrer_id, bool crashIfDeallocating) &#123; objc_object *referent = (objc_object *)referent_id; //è¢«å¼•ç”¨äºº objc_object **referrer = (objc_object **)referrer_id; //å¼•ç”¨äºº // taggedPointeræ²¡æœ‰å¼•ç”¨è®¡æ•°ï¼Œä¸éœ€è¦å¤„ç† if (!referent || referent-&gt;isTaggedPointer()) return referent_id; // ä¿è¯è¢«å¼•ç”¨äººä¸åœ¨é‡Šæ”¾ä¸­ï¼Œä¸ç„¶é—ªé€€ bool deallocating; if (!referent-&gt;ISA()-&gt;hasCustomRR()) &#123; deallocating = referent-&gt;rootIsDeallocating(); &#125; else &#123; BOOL (*allowsWeakReference)(objc_object *, SEL) = (BOOL(*)(objc_object *, SEL)) object_getMethodImplementation((id)referent, SEL_allowsWeakReference); if ((IMP)allowsWeakReference == _objc_msgForward) &#123; return nil; &#125; deallocating = ! (*allowsWeakReference)(referent, SEL_allowsWeakReference); &#125; if (deallocating) &#123; if (crashIfDeallocating) &#123; _objc_fatal(\"Cannot form weak reference to instance (%p) of \" \"class %s. It is possible that this object was \" \"over-released, or is in the process of deallocation.\", (void*)referent, object_getClassName((id)referent)); &#125; else &#123; return nil; &#125; &#125; //è·å–è¢«å¼•ç”¨äººçš„å¼•ç”¨æ•°ç»„ï¼Œæ²¡æœ‰åˆ™åˆ›å»º weak_entry_t *entry; if ((entry = weak_entry_for_referent(weak_table, referent))) &#123; append_referrer(entry, referrer); &#125; else &#123; weak_entry_t new_entry(referent, referrer); weak_grow_maybe(weak_table); weak_entry_insert(weak_table, &amp;new_entry); &#125; // Do not set *referrer. objc_storeWeak() requires that the // value not change. return referent_id;&#125;//é‡Šæ”¾è¿‡ç¨‹æ¸…ç©ºå¼•ç”¨void weak_clear_no_lock (weak_table_t *weak_table, id referent_id) &#123; objc_object *referent = (objc_object *)referent_id; //è¢«å¼•ç”¨äºº //è·å–è¢«å¼•ç”¨äººçš„å¼•ç”¨æ•°ç»„ weak_entry_t *entry = weak_entry_for_referent(weak_table, referent); if (entry == nil) &#123; //è¿™é‡Œåº”è¯¥è‚¯å®šæœ‰entryï¼Œå› ä¸ºè°ƒç”¨å‰åˆ¤æ–­äº†å¯¹è±¡çš„WeaklyReferenced //å¦‚æœç¡®å®æ²¡æœ‰ï¼Œè‹¹æœè®¤ä¸ºå¯èƒ½æ˜¯CF/objcåŸå›  return; &#125; //æ¸…ç©ºå¼•ç”¨æ•°ç»„ weak_referrer_t *referrers; size_t count; if (entry-&gt;out_of_line()) &#123; referrers = entry-&gt;referrers; count = TABLE_SIZE(entry); &#125; else &#123; referrers = entry-&gt;inline_referrers; count = WEAK_INLINE_COUNT; &#125; //éå†æ•°ç»„ï¼Œæ‰¾åˆ°æ¯ä¸ªå¼•ç”¨äººï¼Œæ¸…ç©ºä»–ä»¬çš„æŒ‡å‘åœ°å€ for (size_t i = 0; i &lt; count; ++i) &#123; objc_object **referrer = referrers[i]; if (referrer) &#123; if (*referrer == referent) &#123; *referrer = nil; &#125; else if (*referrer) &#123; _objc_inform(\"__weak variable at %p holds %p instead of %p. \" \"This is probably incorrect use of \" \"objc_storeWeak() and objc_loadWeak(). \" \"Break on objc_weak_error to debug.\\n\", referrer, (void*)*referrer, (void*)referent); objc_weak_error(); &#125; &#125; &#125; //å»é™¤èŠ‚ç‚¹ weak_entry_remove(weak_table, entry);&#125; å¯ä»¥å‘ç°ï¼Œå¯¹ç”³æ˜æ˜¯ __weak çš„å˜é‡è¿›è¡Œå­˜å–æ“ä½œï¼Œå…¶å®éƒ½æ˜¯é€šè¿‡è¢«æ“ä½œçš„å¯¹è±¡åœ°å€æŸ¥æ‰¾åˆ°ç›¸åº”çš„è¡¨ï¼Œç„¶åå¢åˆ è¡¨çš„å¼•ç”¨æ•°ç»„å†…å®¹ã€‚ SideTableè¡¨æ€ä¹ˆè®¾è®¡çš„ï¼Ÿå…³é”®å°±åœ¨äºæ€ä¹ˆç”³æ˜åˆ›å»ºè¡¨ï¼Œä»¥åŠè¿™ä¸ªè¡¨æ˜¯æ€ä¹ˆè®¾è®¡åŠä½¿ç”¨çš„ã€‚ 12345678910111213141516171819202122232425262728293031323334// SideTables ç±»å‹ç”³æ˜// è¿™é‡Œä¹‹æ‰€ä»¥å…ˆä½¿ç”¨æ•°æ®çš„æ–¹å¼ç”³æ˜æ˜¯å› ä¸ºè€ƒè™‘åˆ°åŠ è½½é¡ºåºçš„é—®é¢˜alignas(StripedMap&lt;SideTable&gt;) static uint8_t SideTableBuf[sizeof(StripedMap&lt;SideTable&gt;)];// åŠ è½½imageæ—¶æ‰§è¡Œåˆå§‹åŒ–static void SideTableInit() &#123; new (SideTableBuf) StripedMap&lt;SideTable&gt;();&#125;// æ•°ç»„è¿˜åŸæˆStripedMapç±»å‹static StripedMap&lt;SideTable&gt;&amp; SideTables() &#123; return *reinterpret_cast&lt;StripedMap&lt;SideTable&gt;*&gt;(SideTableBuf);&#125;// StripedMap çš„ç»“æ„enum &#123; CacheLineSize = 64 &#125;;template&lt;typename T&gt;class StripedMap &#123;#if TARGET_OS_IPHONE &amp;&amp; !TARGET_OS_SIMULATOR enum &#123; StripeCount = 8 &#125;;#else enum &#123; StripeCount = 64 &#125;;#endif // 64ä½å¯¹é½ struct PaddedT &#123; T value alignas(CacheLineSize); &#125;; // æ‰‹æœºç³»ç»Ÿæ•°ç»„ä¸ªæ•°ä¸º8 PaddedT array[StripeCount]; // æŠŠæŒ‡é’ˆåœ°å€åŒ¹é…åˆ°æ•°ç»„çš„åºå· static unsigned int indexForPointer(const void *p) &#123; uintptr_t addr = reinterpret_cast&lt;uintptr_t&gt;(p); return ((addr &gt;&gt; 4) ^ (addr &gt;&gt; 9)) % StripeCount; &#125;&#125; åœ¨åŠ è½½é•œåƒçš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ SideTableInit æ–¹æ³•åˆ›å»ºå…¨å±€è¡¨æ•°ç»„ï¼Œå¯ä»¥çœ‹åˆ°æ‰‹æœºç³»ç»Ÿæ˜¯8ä¸ªæ•°ç»„ã€‚ æºç ä¸­ä½¿ç”¨ &amp;SideTables()[obj] çš„æ–¹å¼ï¼Œå…¶å®å°±æ˜¯æŠŠ obj çš„æŒ‡é’ˆåœ°å€è½¬æˆåºå·è·å–æŸä¸€ä¸ª tableï¼Œé€šè¿‡è¿™ç§æ–¹å¼åˆ†æ•£å†—ä½™ã€‚ æ¥ç€æˆ‘ä»¬çœ‹ SideTable ç±»çš„å†…éƒ¨ç»“æ„ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152// å“ˆå¸Œæ•£åˆ—è¡¨ï¼Œä½¿ç”¨è¡¥ç çš„å½¢å¼æŠŠæŒ‡é’ˆåœ°å€ä½œä¸ºKeyï¼Œä¿å­˜å¼•ç”¨è®¡æ•°typedef objc::DenseMap&lt;DisguisedPtr&lt;objc_object&gt;,size_t,true&gt; RefcountMap;// Template parameters.enum HaveOld &#123; DontHaveOld = false, DoHaveOld = true &#125;;enum HaveNew &#123; DontHaveNew = false, DoHaveNew = true &#125;;struct SideTable &#123; spinlock_t slock; // è‡ªæ—‹é” RefcountMap refcnts; // å¼•ç”¨è®°æ•°è¡¨ weak_table_t weak_table;// å¼±å¼•ç”¨è¡¨ template&lt;HaveOld, HaveNew&gt; static void lockTwo(SideTable *lock1, SideTable *lock2); template&lt;HaveOld, HaveNew&gt; static void unlockTwo(SideTable *lock1, SideTable *lock2);&#125;;struct weak_table_t &#123; weak_entry_t *weak_entries; //å¼±å¼•ç”¨æ•°ç»„ size_t num_entries; //æ•°ç»„ä¸ªæ•° uintptr_t mask; //è®¡ç®—è¾…åŠ©é‡ï¼Œæ•°å€¼ä¸ºæ•°ç»„æ€»æ•°-1 uintptr_t max_hash_displacement;//å“ˆå¸Œæœ€å¤§åç§»é‡&#125;;#if __LP64__#define PTR_MINUS_2 62#else#define PTR_MINUS_2 30#endiftypedef DisguisedPtr&lt;objc_object *&gt; weak_referrer_t;struct weak_entry_t &#123; // è¢«å¼•ç”¨è€… DisguisedPtr&lt;objc_object&gt; referent; union &#123; // å¼•ç”¨è€…æ•°æ®ç»“æ„ struct &#123; // å½“æ•°é‡è¶…è¿‡4ä¸ªæ—¶ï¼Œç»“æ„è½¬ä¸ºæŒ‡é’ˆï¼Œæ¯æ¬¡å®¹é‡æ»¡çš„æ—¶å€™å°±æ‰©å®¹ä¸¤å€ // éœ€è¦ä¸æ•°ç»„ä½œåŒºåˆ†ï¼Œæ‰€ä»¥æœ‰out_of_line_nessæ ‡è®° weak_referrer_t *referrers; uintptr_t out_of_line_ness : 2; uintptr_t num_refs : PTR_MINUS_2; uintptr_t mask; uintptr_t max_hash_displacement; &#125;; struct &#123; // å››ä¸ªæ•°ç»„ weak_referrer_t inline_referrers[4]; &#125;; &#125;;&#125;; SideTable å­˜å‚¨çš„ä¸ä»…æœ‰å¯¹è±¡å¼•ç”¨è®¡æ•°è¡¨ï¼Œè¿˜æœ‰æˆ‘ä»¬å…³æ³¨çš„å¼±å¼•ç”¨è¡¨ï¼Œå…¶ç»“æ„é¡ºåºå¦‚ä¸‹ï¼š SideTable-&gt;weak_table_t-&gt;weak_entry_t-&gt;weak_referrer_t ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘æ¨¡æ‹Ÿä¸€ä¸‹æ‰¾å¼±å¼•ç”¨å¯¹è±¡çš„æ­¥éª¤: sideTable = &amp;SideTables()[referent] æŠŠå¯¹è±¡å†…å­˜åœ°å€æŒ‰ç…§8å–ä½™åæ‰¾åˆ°è¡¨ weakTable = &amp;sideTable-&gt;weak_table å–å‡ºå¼±å¼•ç”¨è¡¨ entry = weak_entry_for_referent(weakTable, referent) æ ¹æ®è¢«å¼•ç”¨äººåœ°å€ï¼Œéå†å¼±å¼•ç”¨è¡¨æ‰¾å‡ºå…¥å£ referrer = entry-&gt;referrers[index] å…¥å£æœ‰ç‰¹æ®Šçš„æ•°ç»„ï¼Œå…¶ä¸­ä¿å­˜äº†æ‰€æœ‰å¼±å¼•ç”¨è€…çš„å¯¹è±¡åœ°å€ ä»”ç»†ä¸€ç‚¹çš„åŒå­¦åº”è¯¥å‘ç°äº† weak_entry_t ä¸­æœ‰ä¸€ä¸ªè”åˆä½“ï¼Œè¿™åˆæ˜¯æ€ä¹ˆæ“ä½œå®ç°çš„å‘¢ï¼Ÿ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051// æ·»åŠ æ–°å¼•ç”¨è€…static void append_referrer (weak_entry_t *entry, objc_object **new_referrer) &#123; // æ²¡æœ‰è¶…è¿‡4ä¸ªï¼Œå°±ç”¨å†…æ•›æ•°ç»„ if (! entry-&gt;out_of_line()) &#123; // éå†æ•°ç»„ï¼Œå¦‚æœæœ‰ç©ºä½ç½®ï¼Œåˆ™æ’å…¥åè¿”å› for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) &#123; if (entry-&gt;inline_referrers[i] == nil) &#123; entry-&gt;inline_referrers[i] = new_referrer; return; &#125; &#125; // å¦‚æœè¶…è¿‡4ä¸ªäº†ï¼Œå°±ä»æ•°ç»„ç»“æ„è½¬æˆæŒ‡é’ˆç»“æ„ weak_referrer_t *new_referrers = (weak_referrer_t *) calloc(WEAK_INLINE_COUNT, sizeof(weak_referrer_t)); // æ‹·è´åŸæ•°æ®åˆ°æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) &#123; new_referrers[i] = entry-&gt;inline_referrers[i]; &#125; entry-&gt;referrers = new_referrers; //æŒ‡é’ˆæ•°ç»„ entry-&gt;num_refs = WEAK_INLINE_COUNT; //æ•°ç»„å…ƒç´ ä¸ªæ•° entry-&gt;out_of_line_ness = REFERRERS_OUT_OF_LINE; //æ˜¯å¦æ˜¯æŒ‡é’ˆçš„æ ‡è®°ä½ entry-&gt;mask = WEAK_INLINE_COUNT-1; //æ•°ç»„æœ€å¤§ä¸‹æ ‡ï¼Œç”¨äºå–ä½™ entry-&gt;max_hash_displacement = 0; //æœ€å¤§hashç§»ä½æ¬¡æ•°ï¼Œç”¨äºä¼˜åŒ–å¾ªç¯ // ç”±äºåªæœ‰4ä¸ªï¼Œä¼šåœ¨ä¸‹ä¸ªåˆ¤æ–­åæ‰§è¡Œgrow_refs_and_insertåˆå§‹åŒ–å¹¶æ’å…¥æ–°å¯¹è±¡ &#125; // æ–­è¨€å¿…ç„¶æ˜¯æŒ‡é’ˆç»“æ„ assert(entry-&gt;out_of_line()); // å¦‚æœæŒ‡é’ˆæ•°é‡è¶…è¿‡3/4ï¼Œå°±å®¹é‡ç¿»å€åå†æ’å…¥ if (entry-&gt;num_refs &gt;= TABLE_SIZE(entry) * 3/4) &#123; return grow_refs_and_insert(entry, new_referrer); &#125; size_t begin = w_hash_pointer(new_referrer) &amp; (entry-&gt;mask); size_t index = begin; size_t hash_displacement = 0; //æ‰¾ä¸€ä¸ªç©ºä½ç½®ï¼Œä¸å¤Ÿå°±ä»å¤´æ‰¾ while (entry-&gt;referrers[index] != nil) &#123; hash_displacement++; index = (index+1) &amp; entry-&gt;mask; //ä¸‹æ ‡+1åå–ä½™ if (index == begin) bad_weak_table(entry); &#125; if (hash_displacement &gt; entry-&gt;max_hash_displacement) &#123; entry-&gt;max_hash_displacement = hash_displacement; &#125; //ä¿å­˜ weak_referrer_t &amp;ref = entry-&gt;referrers[index]; ref = new_referrer; entry-&gt;num_refs++;&#125; æ€»ç»“è‡³æ­¤å¯¹äºå¼±å¼•ç”¨çš„æ•´ä½“ç»“æ„å’Œé€»è¾‘éƒ½æ¸…æ¥šäº†ï¼Œå¯¹è±¡æ ¹æ®ä¿®é¥°ç¬¦è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œå¦‚æœæ˜¯å¼±å¼•ç”¨ï¼Œåˆ™æ‰¾åˆ°å…¶å¼•ç”¨åœ°å€çš„å¼•ç”¨è¡¨æ“ä½œã€‚ åè¿‡æ¥è®²ï¼Œå¼ºå¯¹è±¡è¢«å¼•ç”¨æ—¶åœ¨å…¨å±€å¼•ç”¨è¡¨ä¸­æ³¨å†Œä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¿å­˜æ‰€æœ‰å¼•ç”¨è€…çš„åœ°å€ï¼Œå½“é‡Šæ”¾æ—¶è®¾ç½®æ‰€æœ‰åœ°å€ä¸ºç©ºã€‚ é—®ç­”è¢«weakä¿®é¥°çš„å¯¹è±¡åœ¨è¢«é‡Šæ”¾çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæ˜¯å¦‚ä½•å®ç°çš„ï¼ŸçŸ¥é“sideTableä¹ˆï¼Ÿé‡Œé¢çš„ç»“æ„å¯ä»¥ç”»å‡ºæ¥ä¹ˆï¼Ÿ å¯¹è±¡è¢«é‡Šæ”¾æ—¶æ‰§è¡Œ obj-&gt;rootDealloc()ï¼Œå¦‚æœæœ‰å¼±å¼•ç”¨æ ‡è®°ï¼Œåˆ™ä¼šæ‰§è¡Œ objc_destructInstance æ–¹æ³•åé‡Šæ”¾ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839void *objc_destructInstance(id obj) &#123; if (obj) &#123; // Read all of the flags at once for performance. bool cxx = obj-&gt;hasCxxDtor(); bool assoc = obj-&gt;hasAssociatedObjects(); // This order is important. if (cxx) object_cxxDestruct(obj); //è°ƒç”¨ææ„å‡½æ•° if (assoc) _object_remove_assocations(obj); //ç§»é™¤å…³è”å¯¹è±¡å…³ç³» obj-&gt;clearDeallocating(); //å¤„ç†isa &#125; return obj;&#125;inline void objc_object::clearDeallocating() &#123; if (slowpath(!isa.nonpointer)) &#123; // Slow path for raw pointer isa. sidetable_clearDeallocating(); &#125; else if (slowpath(isa.weakly_referenced || isa.has_sidetable_rc)) &#123; // Slow path for non-pointer isa with weak refs and/or side table data. clearDeallocating_slow(); &#125; assert(!sidetable_present());&#125;void objc_object::sidetable_clearDeallocating() &#123; SideTable&amp; table = SideTables()[this]; // åˆ é™¤å¼ºå¼•ç”¨å’Œå¼±å¼•ç”¨ table.lock(); RefcountMap::iterator it = table.refcnts.find(this); if (it != table.refcnts.end()) &#123; if (it-&gt;second &amp; SIDE_TABLE_WEAKLY_REFERENCED) &#123; weak_clear_no_lock(&amp;table.weak_table, (id)this); &#125; table.refcnts.erase(it); &#125; table.unlock();&#125; å¯ä»¥çœ‹åˆ°åœ¨ sidetable_clearDeallocating æ–¹æ³•ä¸­ï¼Œæœ€åæ‰§è¡Œäº† weak_clear_no_lock æ¸…ç©ºäº†æ‰€æœ‰å¼•ç”¨å…³ç³»ã€‚ SideTable è¡¨ç»“æ„å¦‚ä¸‹å›¾ï¼š æ€»ç»“weakåŸç†æ˜¯ç»•ä¸å¼€çš„ç»å…¸è¯¾é¢˜ï¼Œé€šè¿‡é˜…è¯»å¼€æºä»£ç å¯¹è‹¹æœå¦‚ä½•å®ç°æœ‰äº†å¤§è‡´çš„äº†è§£ï¼Œå—ç›ŠåŒªæµ…ã€‚ é˜…è¯»è¿‡ç¨‹ä¸­è¿˜æƒŠå¹äºè‹¹æœå„ç§èŠ±å¼å°æŠ€å·§ï¼Œç”±äºæ–‡ç« ç¯‡å¹…æœ‰é™æ²¡æ¥å¾—åŠä»‹ç»ï¼Œæ„Ÿå…´è¶£å¯ä»¥äº†è§£ä¸€ä¸‹ï¼Œæ¯”å¦‚ DisguisedPtrã€‚ èµ„æ–™åˆ†äº«Objective-C Class Ivar Layout æ¢ç´¢ ç†è§£ ARC å®ç°åŸç† weak å¼±å¼•ç”¨çš„å®ç°æ–¹å¼","categories":[{"name":"iOS","slug":"iOS","permalink":"https://vanchchen.github.io/categories/iOS/"}],"tags":[{"name":"åŸç†åˆ†æ","slug":"åŸç†åˆ†æ","permalink":"https://vanchchen.github.io/tags/åŸç†åˆ†æ/"}]},{"title":"AtomicåŸå­æ“ä½œåŸç†å‰–æ","slug":"AtomicåŸç†","date":"2018-12-28T09:40:47.000Z","updated":"2019-10-08T06:34:01.453Z","comments":true,"path":"p/168d.html","link":"","permalink":"https://vanchchen.github.io/p/168d.html","excerpt":"","text":"å‰è¨€ç»å¤§éƒ¨åˆ† Objective-C ç¨‹åºå‘˜ä½¿ç”¨å±æ€§æ—¶ï¼Œéƒ½ä¸å¤ªå…³æ³¨ä¸€ä¸ªç‰¹æ®Šçš„ä¿®é¥°å‰ç¼€ï¼Œä¸€èˆ¬éƒ½æ— è„‘çš„ä½¿ç”¨å…¶éé»˜è®¤ç¼ºçœçš„çŠ¶æ€ï¼Œä»–å°±æ˜¯ atomicã€‚ 123456@interface PropertyClass@property (atomic, strong) NSObject *atomicObj; //ç¼ºçœä¹Ÿæ˜¯atomic@property (nonatomic, strong) NSObject *nonatomicObj;@end å…¥é—¨æ•™ç¨‹ä¸­ä¸€èˆ¬éƒ½å»ºè®®ä½¿ç”¨éåŸå­æ“ä½œï¼Œå› ä¸ºæ–°æ‰‹å¤§éƒ¨åˆ†æ“ä½œéƒ½åœ¨ä¸»çº¿ç¨‹ï¼Œç”¨ä¸åˆ°çº¿ç¨‹å®‰å…¨çš„ç‰¹æ€§ï¼Œå¤§é‡ä½¿ç”¨è¿˜ä¼šé™ä½æ‰§è¡Œæ•ˆç‡ã€‚ é‚£ä»–åˆ°åº•æ€ä¹ˆå®ç°çº¿ç¨‹å®‰å…¨çš„å‘¢ï¼Ÿä½¿ç”¨äº†å“ªç§æŠ€æœ¯å‘¢ï¼Ÿ åŸç†å±æ€§çš„å®ç°é¦–å…ˆæˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹å±æ€§åŒ…å«çš„å†…å®¹ã€‚é€šè¿‡æŸ¥é˜…æºç ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š 1234struct property_t &#123; const char *name; //åå­— const char *attributes; //ç‰¹æ€§&#125;; å±æ€§çš„ç»“æ„æ¯”è¾ƒç®€å•ï¼ŒåŒ…å«äº†å›ºå®šçš„åå­—å’Œå…ƒç´ ï¼Œå¯ä»¥é€šè¿‡ property_getName è·å–å±æ€§åï¼Œproperty_getAttributes è·å–ç‰¹æ€§ã€‚ ä¸Šä¾‹ä¸­ atomicObj çš„ç‰¹æ€§ä¸º T@&quot;NSObject&quot;,&amp;,V_atomicObjï¼Œå…¶ä¸­ &amp; ä»£è¡¨äº† strongï¼Œatomic ç‰¹æ€§ç¼ºçœæ²¡æœ‰æ˜¾ç¤ºï¼Œå¦‚æœæ˜¯ nonatomic åˆ™æ˜¾ç¤º Nã€‚ é‚£åˆ°åº•æ˜¯æ€ä¹ˆå®ç°åŸå­æ“ä½œçš„å‘¢ï¼Ÿ é€šè¿‡å¼•å…¥runtimeï¼Œæˆ‘ä»¬èƒ½è°ƒè¯•ä¸€ä¸‹è°ƒç”¨çš„å‡½æ•°æ ˆã€‚ å¯ä»¥çœ‹åˆ°åœ¨ç¼–è¯‘æ—¶å°±æŠŠå±æ€§ç‰¹æ€§è€ƒè™‘è¿›å»äº†ï¼ŒSetter æ–¹æ³•ç›´æ¥è°ƒç”¨äº† objc_setProperty çš„ atomic ç‰ˆæœ¬ã€‚è¿™é‡Œä¸ç”¨ runtime å»åŠ¨æ€åˆ†æç‰¹æ€§ï¼Œåº”è¯¥æ˜¯å¯¹æ‰§è¡Œæ€§èƒ½çš„è€ƒè™‘ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455static inline void reallySetProperty(id self, SEL _cmd, id newValue, ptrdiff_t offset, bool atomic, bool copy, bool mutableCopy) &#123; //åç§»ä¸º0è¯´æ˜æ”¹çš„æ˜¯isa if (offset == 0) &#123; object_setClass(self, newValue); return; &#125; id oldValue; id *slot = (id*) ((char*)self + offset);//è·å–åŸå€¼ //æ ¹æ®ç‰¹æ€§æ‹·è´ if (copy) &#123; newValue = [newValue copyWithZone:nil]; &#125; else if (mutableCopy) &#123; newValue = [newValue mutableCopyWithZone:nil]; &#125; else &#123; if (*slot == newValue) return; newValue = objc_retain(newValue); &#125; //åˆ¤æ–­åŸå­æ€§ if (!atomic) &#123; //éåŸå­ç›´æ¥èµ‹å€¼ oldValue = *slot; *slot = newValue; &#125; else &#123; //åŸå­æ“ä½œä½¿ç”¨è‡ªæ—‹é” spinlock_t&amp; slotlock = PropertyLocks[slot]; slotlock.lock(); oldValue = *slot; *slot = newValue; slotlock.unlock(); &#125; objc_release(oldValue);&#125;id objc_getProperty(id self, SEL _cmd, ptrdiff_t offset, BOOL atomic) &#123; // å–isa if (offset == 0) &#123; return object_getClass(self); &#125; // éåŸå­æ“ä½œç›´æ¥è¿”å› id *slot = (id*) ((char*)self + offset); if (!atomic) return *slot; // åŸå­æ“ä½œè‡ªæ—‹é” spinlock_t&amp; slotlock = PropertyLocks[slot]; slotlock.lock(); id value = objc_retain(*slot); slotlock.unlock(); // å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œåœ¨é”ä¹‹å¤–autorelease return objc_autoreleaseReturnValue(value);&#125; ä»€ä¹ˆæ˜¯è‡ªæ—‹é”å‘¢ï¼Ÿé”ç”¨äºè§£å†³çº¿ç¨‹äº‰å¤ºèµ„æºçš„é—®é¢˜ï¼Œä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ï¼Œè‡ªæ—‹é”(spin)å’Œäº’æ–¥é”(mutex)ã€‚ äº’æ–¥é”å¯ä»¥è§£é‡Šä¸ºçº¿ç¨‹è·å–é”ï¼Œå‘ç°é”è¢«å ç”¨ï¼Œå°±å‘ç³»ç»Ÿç”³è¯·é”ç©ºé—²æ—¶å”¤é†’ä»–å¹¶ç«‹åˆ»ä¼‘çœ ã€‚ è‡ªæ—‹é”æ¯”è¾ƒç®€å•ï¼Œå½“çº¿ç¨‹å‘ç°é”è¢«å ç”¨æ—¶ï¼Œä¼šä¸æ–­å¾ªç¯åˆ¤æ–­é”çš„çŠ¶æ€ï¼Œç›´åˆ°è·å–ã€‚ åŸå­æ“ä½œçš„é¢—ç²’åº¦æœ€å°ï¼Œåªé™äºè¯»å†™ï¼Œå¯¹äºæ€§èƒ½çš„è¦æ±‚å¾ˆé«˜ï¼Œå¦‚æœä½¿ç”¨äº†äº’æ–¥é”åŠ¿å¿…åœ¨åˆ‡æ¢çº¿ç¨‹ä¸Šè€—è´¹å¤§é‡èµ„æºã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œç”±äºè¯»å†™æ“ä½œè€—æ—¶æ¯”è¾ƒå°ï¼Œèƒ½å¤Ÿåœ¨ä¸€ä¸ªæ—¶é—´ç‰‡å†…å®Œæˆï¼Œè‡ªæ—‹æ›´é€‚åˆè¿™ä¸ªåœºæ™¯ã€‚ è‡ªæ—‹é”çš„å‘ä½†æ˜¯iOS 10ä¹‹åï¼Œè‹¹æœå› ä¸ºä¸€ä¸ªå·¨å¤§çš„ç¼ºé™·å¼ƒç”¨äº† OSSpinLock æ”¹ä¸ºæ–°çš„ os_unfair_lockã€‚ æ–°ç‰ˆ iOS ä¸­ï¼Œç³»ç»Ÿç»´æŠ¤äº† 5 ä¸ªä¸åŒçš„çº¿ç¨‹ä¼˜å…ˆçº§/QoS: backgroundï¼Œutilityï¼Œdefaultï¼Œuser-initiatedï¼Œuser-interactiveã€‚é«˜ä¼˜å…ˆçº§çº¿ç¨‹å§‹ç»ˆä¼šåœ¨ä½ä¼˜å…ˆçº§çº¿ç¨‹å‰æ‰§è¡Œï¼Œä¸€ä¸ªçº¿ç¨‹ä¸ä¼šå—åˆ°æ¯”å®ƒæ›´ä½ä¼˜å…ˆçº§çº¿ç¨‹çš„å¹²æ‰°ã€‚è¿™ç§çº¿ç¨‹è°ƒåº¦ç®—æ³•ä¼šäº§ç”Ÿæ½œåœ¨çš„ä¼˜å…ˆçº§åè½¬é—®é¢˜ï¼Œä»è€Œç ´åäº† spin lockã€‚ æè¿°å¼•ç”¨è‡ª ibireme å¤§ç¥çš„æ–‡ç« ã€‚ æˆ‘çš„ç†è§£æ˜¯ï¼Œå½“ä½ä¼˜å…ˆçº§çº¿ç¨‹è·å–äº†é”ï¼Œé«˜ä¼˜å…ˆçº§çº¿ç¨‹è®¿é—®æ—¶é™·å…¥å¿™ç­‰çŠ¶æ€ï¼Œç”±äºæ˜¯å¾ªç¯è°ƒç”¨ï¼Œæ‰€ä»¥å ç”¨äº†ç³»ç»Ÿè°ƒåº¦èµ„æºï¼Œå¯¼è‡´ä½ä¼˜å…ˆçº§çº¿ç¨‹è¿Ÿè¿Ÿä¸èƒ½å¤„ç†èµ„æºå¹¶é‡Šæ”¾é”ï¼Œå¯¼è‡´é™·å…¥æ­»é”ã€‚ é‚£ä¸ºä»€ä¹ˆåŸå­æ“ä½œç”¨çš„è¿˜æ˜¯ spinlock_t å‘¢ï¼Ÿ 123456789101112131415using spinlock_t = mutex_tt&lt;LOCKDEBUG&gt;;using mutex_t = mutex_tt&lt;LOCKDEBUG&gt;;class mutex_tt : nocopy_t &#123; os_unfair_lock mLock; //å¤„ç†äº†ä¼˜å…ˆçº§çš„äº’æ–¥é” void lock() &#123; lockdebug_mutex_lock(this); os_unfair_lock_lock_with_options_inline (&amp;mLock, OS_UNFAIR_LOCK_DATA_SYNCHRONIZATION); &#125; void unlock() &#123; lockdebug_mutex_unlock(this); os_unfair_lock_unlock_inline(&amp;mLock); &#125;&#125; å·®ç‚¹è¢«è‹¹æœéª—äº†ï¼åŸæ¥ç³»ç»Ÿä¸­è‡ªæ—‹é”å·²ç»å…¨éƒ¨æ”¹ä¸ºäº’æ–¥é”å®ç°äº†ï¼Œåªæ˜¯åç§°ä¸€ç›´æ²¡æœ‰æ›´æ”¹ã€‚ ä¸ºäº†ä¿®å¤ä¼˜å…ˆçº§åè½¬çš„é—®é¢˜ï¼Œè‹¹æœä¹Ÿåªèƒ½æ”¾å¼ƒä½¿ç”¨è‡ªæ—‹é”ï¼Œæ”¹ç”¨ä¼˜åŒ–äº†æ€§èƒ½çš„ os_unfair_lockï¼Œå®é™…æµ‹è¯•ä¸¤è€…çš„æ•ˆç‡å·®ä¸å¤šã€‚ é—®ç­”atomicçš„å®ç°æœºåˆ¶ä½¿ç”¨atomic ä¿®é¥°å±æ€§ï¼Œç¼–è¯‘å™¨ä¼šè®¾ç½®é»˜è®¤è¯»å†™æ–¹æ³•ä¸ºåŸå­è¯»å†™ï¼Œå¹¶ä½¿ç”¨äº’æ–¥é”æ·»åŠ ä¿æŠ¤ã€‚ ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯ç»å¯¹çš„çº¿ç¨‹å®‰å…¨ï¼Ÿå•ç‹¬çš„åŸå­æ“ä½œç»å¯¹æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯ç»„åˆä¸€èµ·çš„æ“ä½œå°±ä¸èƒ½ä¿è¯ã€‚ 123456789101112131415- (void)competition &#123; self.intSource = 0; dispatch_async(queue1, ^&#123; for (int i = 0; i &lt; 10000; i++) &#123; self.intSource = self.intSource + 1; &#125; &#125;); dispatch_async(queue2, ^&#123; for (int i = 0; i &lt; 10000; i++) &#123; self.intSource = self.intSource + 1; &#125; &#125;);&#125; æœ€ç»ˆå¾—åˆ°çš„ç»“æœè‚¯å®šå°äº20000ã€‚å½“è·å–å€¼çš„æ—¶å€™éƒ½æ˜¯åŸå­çº¿ç¨‹å®‰å…¨æ“ä½œï¼Œæ¯”å¦‚ä¸¤ä¸ªçº¿ç¨‹ä¾åºè·å–äº†å½“å‰å€¼ 0ï¼Œäºæ˜¯åˆ†åˆ«å¢é‡åå˜ä¸ºäº† 1ï¼Œæ‰€ä»¥ä¸¤ä¸ªé˜Ÿåˆ—ä¾åºå†™å…¥å€¼éƒ½æ˜¯ 1ï¼Œæ‰€ä»¥ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ è§£å†³çš„åŠæ³•åº”è¯¥æ˜¯å¢åŠ é¢—ç²’åº¦ï¼Œå°†è¯»å†™ä¸¤ä¸ªæ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªåŸå­æ“ä½œï¼Œä»è€Œè§£å†³å†™å…¥è¿‡æœŸæ•°æ®çš„é—®é¢˜ã€‚ 123456789101112131415161718192021os_unfair_lock_t unfairLock;- (void)competition &#123; self.intSource = 0; unfairLock = &amp;(OS_UNFAIR_LOCK_INIT); dispatch_async(queue1, ^&#123; for (int i = 0; i &lt; 10000; i++) &#123; os_unfair_lock_lock(unfairLock); self.intSource = self.intSource + 1; os_unfair_lock_unlock(unfairLock); &#125; &#125;); dispatch_async(queue2, ^&#123; for (int i = 0; i &lt; 10000; i++) &#123; os_unfair_lock_lock(unfairLock); self.intSource = self.intSource + 1; os_unfair_lock_unlock(unfairLock); &#125; &#125;);&#125; æ€»ç»“é€šè¿‡å­¦ä¹ å±æ€§çš„åŸå­æ€§ï¼Œå¯¹ç³»ç»Ÿä¸­é”çš„ç†è§£åˆåŠ æ·±ï¼ŒåŒ…æ‹¬è‡ªæ—‹é”ï¼Œäº’æ–¥é”ï¼Œè¯»å†™é”ç­‰ã€‚ æœ¬æ¥éƒ½ä»¥ä¸ºå®ç°æ˜¯è‡ªæ—‹é”äº†ï¼Œè¿˜å¥½ç•™äº†ä¸ªå¿ƒçœ¼å¤šçœ‹äº†ä¸€å±‚æ‰å‘ç°æœ€ç»ˆå®ç°è¿˜æ˜¯äº’æ–¥é”ã€‚è¿™ä»¶äº‹ä¹Ÿç»™æˆ‘ä¸€ä¸ªå°æ•™è®­ï¼ŒæŸ¥é˜…æºç è¿˜æ˜¯è¦åˆ¨æ ¹é—®åº•ï¼Œåªæµ®äºè¡¨é¢çš„è¯ï¼Œå¯èƒ½å¾—ä¸åˆ°æƒ³è¦çš„çœŸç›¸ã€‚ å¼•ç”¨å¯ä»¥ç¼–è¯‘çš„runtimeåº“ ä¸å†å®‰å…¨çš„ OSSpinLock","categories":[{"name":"iOS","slug":"iOS","permalink":"https://vanchchen.github.io/categories/iOS/"}],"tags":[{"name":"åŸç†åˆ†æ","slug":"åŸç†åˆ†æ","permalink":"https://vanchchen.github.io/tags/åŸç†åˆ†æ/"}]},{"title":"ä¸‰ç§UIScrollViewåµŒå¥—å®ç°æ–¹æ¡ˆ","slug":"UIScrollViewåµŒå¥—","date":"2018-12-25T09:34:25.000Z","updated":"2018-12-25T09:54:50.335Z","comments":true,"path":"p/7448.html","link":"","permalink":"https://vanchchen.github.io/p/7448.html","excerpt":"","text":"èƒŒæ™¯éšç€äº§å“åŠŸèƒ½ä¸æ–­çš„è¿­ä»£ï¼Œæ€»ä¼šæœ‰éœ€æ±‚å¸Œæœ›åœ¨ä¿è¯ä¸å½±å“å…¶ä»–åŒºåŸŸåŠŸèƒ½çš„å‰æä¸‹ï¼Œåœ¨æŸä¸€åŒºåŸŸå®ç°æ ¹æ®é€‰æ‹©å™¨åˆ‡æ¢ä¸åŒçš„å†…å®¹æ˜¾ç¤ºã€‚ è‹¹æœå¹¶ä¸æ¨èåµŒå¥—æ»šåŠ¨è§†å›¾ï¼Œå¦‚æœç›´æ¥æ·»åŠ çš„è¯ï¼Œå°±ä¼šå‡ºç°ä¸‹å›¾è¿™ç§æƒ…å†µï¼Œæ‰‹åŠ¿çš„å†²çªé€ æˆäº†ä½“éªŒä¸Šçš„æ‚²å‰§ã€‚ åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä¹Ÿä¸æ–­çš„åœ¨æ€è€ƒè§£å†³æ–¹æ¡ˆï¼Œç»å†äº†å‡ æ¬¡é‡æ„åï¼Œæœ‰äº†äº›æ”¹è¿›çš„ç»éªŒï¼Œå› æ­¤æŠ½ç©ºæ•´ç†äº†ä¸‰ç§æ–¹æ¡ˆï¼Œä»–ä»¬å®ç°çš„æœ€ç»ˆæ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„ã€‚ åˆ†è€Œæ²»ä¹‹æœ€å¸¸è§çš„ä¸€ç§æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨ UITableView ä½œä¸ºå¤–éƒ¨æ¡†æ¶ï¼Œå°†å­è§†å›¾çš„å†…å®¹é€šè¿‡ UITableViewCell çš„æ–¹å¼å±•ç°ã€‚ è¿™ç§åšæ³•çš„å¥½å¤„åœ¨äºè§£è€¦æ€§ï¼Œæ¡†æ¶åªè¦æ¥å—ä¸åŒçš„æ•°æ®æºå°±èƒ½åˆ·æ–°å¯¹åº”çš„å†…å®¹ã€‚ 123456789101112func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -&gt; CGFloat &#123; if indexPath.section == 0 &#123; return NSTHeaderHeight &#125; if segmentView.selectedIndex == 0 &#123; return tableSource.tableView(_:tableView, heightForRowAt:indexPath) &#125; return webSource.tableView(_:tableView, heightForRowAt:indexPath)&#125; ä½†æ˜¯ç›¸å¯¹çš„ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå†…éƒ¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ»šåŠ¨è§†å›¾ï¼Œæ¯”å¦‚ UIWebView çš„å­è§†å›¾ UIWebScrollViewï¼Œè¿˜æ˜¯ä¼šæœ‰æ‰‹åŠ¿å†²çªçš„æƒ…å†µã€‚ å¸¸è§„åšæ³•é¦–å…ˆç¦æ­¢å†…éƒ¨è§†å›¾çš„æ»šåŠ¨ï¼Œå½“æ»šåŠ¨åˆ°ç½‘é¡µçš„ä½ç½®æ—¶ï¼Œå¯åŠ¨ç½‘é¡µçš„æ»šåŠ¨å¹¶ç¦æ­¢å¤–éƒ¨æ»šåŠ¨ï¼Œåä¹‹äº¦ç„¶ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œè¿™ç§æ–¹æ¡ˆæœ€å¤§çš„é—®é¢˜æ˜¯é¡¿æŒ«æ„Ÿã€‚ å†…éƒ¨è§†å›¾åˆå§‹æ˜¯ä¸èƒ½æ»šåŠ¨çš„ï¼Œæ‰€ä»¥å¤–éƒ¨è§†å›¾ä½œä¸ºæ•´å¥—äº‹ä»¶çš„æ¥æ”¶è€…ã€‚å½“æ»šåŠ¨åˆ°é¢„è®¾çš„ä½ç½®å¹¶å¼€å¯äº†å†…éƒ¨è§†å›¾çš„æ»šåŠ¨ï¼Œäº‹ä»¶è¿˜æ˜¯ä¼ é€’ç»™å”¯ä¸€æ¥æ”¶è€…å¤–éƒ¨è§†å›¾ï¼Œåªæœ‰æ¾å¼€æ‰‹ç»“æŸäº‹ä»¶åé‡æ–°è§¦å‘ï¼Œæ‰èƒ½ä½¿å†…éƒ¨è§†å›¾å¼€å§‹æ»šåŠ¨ã€‚ å¥½åœ¨æœ‰ä¸€ä¸ªæ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950func scrollViewDidScroll(_ scrollView: UIScrollView) &#123; if scrollView == tableView &#123; //å¤–éƒ¨åœ¨æ»šåŠ¨ if offset &gt; anchor &#123; //æ»šåˆ°è¿‡äº†é”šç‚¹ï¼Œè¿˜åŸå¤–éƒ¨è§†å›¾ä½ç½®ï¼Œæ·»åŠ åç§»åˆ°å†…éƒ¨ tableView.setContentOffset(CGPoint(x: 0, y: anchor), animated: false) let webOffset = webScrollView.contentOffset.y + offset - anchor webScrollView.setContentOffset(CGPoint(x: 0, y: webOffset), animated: false) &#125; else if offset &lt; anchor &#123; //æ²¡æ»šåˆ°é”šç‚¹ï¼Œè¿˜åŸä½ç½® webScrollView.setContentOffset(CGPoint.zero, animated: false) &#125; &#125; else &#123; //å†…éƒ¨åœ¨æ»šåŠ¨ if offset &gt; 0 &#123; //å†…éƒ¨æ»šåŠ¨è¿˜åŸå¤–éƒ¨ä½ç½® tableView.setContentOffset(CGPoint(x: 0, y: anchor), animated: false) &#125; else if offset &lt; 0 &#123; //å†…éƒ¨å¾€ä¸Šæ»šï¼Œæ·»åŠ åç§»é‡åˆ°å¤–éƒ¨è§†å›¾ let tableOffset = tableView.contentOffset.y + offset tableView.setContentOffset(CGPoint(x: 0, y: tableOffset), animated: false) webScrollView.setContentOffset(CGPoint.zero, animated: false) &#125; &#125;&#125;func scrollViewDidEndScroll(_ scrollView: UIScrollView) &#123; //æ ¹æ®æ»šåŠ¨åœæ­¢åçš„åç§»é‡ï¼Œè®¡ç®—è°å¯ä»¥æ»šåŠ¨ var outsideScrollEnable = true if scrollView == tableView &#123; if offset == anchor &amp;&amp; webScrollView.contentOffset.y &gt; 0 &#123; outsideScrollEnable = false &#125; else &#123; outsideScrollEnable = true &#125; &#125; else &#123; if offset == 0 &amp;&amp; tableView.contentOffset.y &lt; anchor &#123; outsideScrollEnable = true &#125; else &#123; outsideScrollEnable = false &#125; &#125; //è®¾ç½®æ»šåŠ¨ï¼Œæ˜¾ç¤ºå¯¹åº”çš„æ»šåŠ¨æ¡ tableView.isScrollEnabled = outsideScrollEnable tableView.showsHorizontalScrollIndicator = outsideScrollEnable webScrollView.isScrollEnabled = !outsideScrollEnable webScrollView.showsHorizontalScrollIndicator = !outsideScrollEnable&#125; é€šè¿‡æ¥å—æ»šåŠ¨å›è°ƒï¼Œæˆ‘ä»¬å°±å¯ä»¥äººä¸ºæ§åˆ¶æ»šåŠ¨è¡Œä¸ºã€‚å½“æ»šåŠ¨è·ç¦»è¶…è¿‡äº†æˆ‘ä»¬çš„é¢„è®¾å€¼ï¼Œå°±å¯ä»¥è®¾ç½®å¦ä¸€ä¸ªè§†å›¾çš„åç§»é‡æ¨¡æ‹Ÿå‡ºæ»šåŠ¨çš„æ•ˆæœã€‚æ»šåŠ¨çŠ¶æ€ç»“æŸåï¼Œå†æ ¹æ®åˆ¤æ–­æ¥å®šä½å“ªä¸ªè§†å›¾å¯ä»¥æ»šåŠ¨ã€‚ å½“ç„¶è¦ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¿…é¡»æŠŠä¸¤ä¸ªæ»šåŠ¨è§†å›¾çš„ä»£ç†éƒ½è®¾ç½®ä¸ºæ§åˆ¶å™¨ï¼Œå¯èƒ½ä¼šå¯¹ä»£ç é€»è¾‘æœ‰å½±å“ (UIWebView æ˜¯ UIWebScrollView çš„ä»£ç†ï¼Œåæ–‡æœ‰è§£å†³æ–¹æ¡ˆ)ã€‚ UITableView åµŒå¥—çš„æ–¹å¼ï¼Œèƒ½å¤Ÿå¾ˆå¥½çš„è§£å†³åµŒå¥—ç®€å•è§†å›¾ï¼Œé‡åˆ° UIWebView è¿™ç§å¤æ‚æƒ…å†µï¼Œä¹Ÿèƒ½äººä¸ºæ§åˆ¶è§£å†³ã€‚ä½†æ˜¯ä½œä¸º UITableView çš„ä¸€ç¯ï¼Œæœ‰å¾ˆå¤šé™åˆ¶(æ¯”å¦‚ä¸åŒæ•°æ®æºéœ€è¦ä¸åŒçš„è®¾å®šï¼Œæœ‰çš„å¸Œæœ›åŠ¨æ€é«˜åº¦ï¼Œæœ‰çš„éœ€è¦æ’å…¥é¢å¤–çš„è§†å›¾)ï¼Œè¿™äº›éƒ½ä¸èƒ½å¾ˆå¥½çš„è§£å†³ã€‚ å„è‡ªä¸ºæ”¿å¦ä¸€ç§è§£å†³æ–¹æ¡ˆæ¯”è¾ƒåå®¢ä¸ºä¸»ï¼Œçµæ„Ÿæ¥æºäºä¸‹æ‹‰åˆ·æ–°çš„å®ç°æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯å°†éœ€è¦æ˜¾ç¤ºçš„å†…å®¹å¡å…¥è´Ÿä¸€å±ã€‚ é¦–å…ˆä¿è¯å­è§†å›¾æ’‘æ»¡å…¨å±ï¼ŒæŠŠä¸»è§†å›¾å†…å®¹æ’å…¥å­è§†å›¾ï¼Œå¹¶è®¾ç½® ContentInset ä¸ºå¤´éƒ¨é«˜åº¦ï¼Œä»è€Œå®ç°æ•ˆæœã€‚ æ¥çœ‹ä¸‹ä»£ç å®ç°ã€‚ 123456789101112131415161718192021222324func reloadScrollView() &#123; //é€‰æ‹©å½“å‰æ˜¾ç¤ºçš„è§†å›¾ let scrollView = segmentView.selectedIndex == 0 ? tableSource.tableView : webSource.webView.scrollView //ç›¸åŒè§†å›¾å°±ä¸æ“ä½œäº† if currentScrollView == scrollView &#123; return &#125; //ä»ä¸Šæ¬¡çš„è§†å›¾ä¸­ç§»é™¤å¤–éƒ¨å†…å®¹ headLabel.removeFromSuperview() segmentView.removeFromSuperview() if currentScrollView != nil &#123; currentScrollView!.removeFromSuperview() &#125; //è®¾ç½®æ–°æ»šåŠ¨è§†å›¾çš„å†…åµŒåç§»é‡ä¸ºå¤–éƒ¨å†…å®¹çš„é«˜åº¦ scrollView.contentInset = UIEdgeInsets(top: NSTSegmentHeight + NSTHeaderHeight, left: 0, bottom: 0, right: 0) //æ·»åŠ å¤–éƒ¨å†…å®¹åˆ°æ–°è§†å›¾ä¸Š scrollView.addSubview(headLabel) scrollView.addSubview(segmentView) view.addSubview(scrollView) currentScrollView = scrollView&#125; ç”±äºåœ¨UIå±‚çº§å°±åªå­˜åœ¨ä¸€ä¸ªæ»šåŠ¨è§†å›¾ï¼Œæ‰€ä»¥å·§å¦™çš„é¿å¼€äº†å†²çªã€‚ ç›¸å¯¹çš„ï¼Œæ’å…¥çš„å¤´éƒ¨è§†å›¾å¿…é¡»è¦è½»é‡ï¼Œå¦‚æœéœ€è¦å’Œæˆ‘ä¾‹å­ä¸­ä¸€æ ·å®ç°æµ®åŠ¨æ æ•ˆæœï¼Œå°±è¦è§‚å¯Ÿåç§»é‡çš„å˜åŒ–æ‰‹åŠ¨å®šä½ã€‚ 12345678910111213141516171819202122232425262728func reloadScrollView() &#123; if currentScrollView != nil &#123; currentScrollView!.removeFromSuperview() //ç§»é™¤ä¹‹å‰çš„ KVO observer?.invalidate() observer = nil &#125; //æ–°è§†å›¾æ·»åŠ æ»šåŠ¨è§‚å¯Ÿ observer = scrollView.observe(\\.contentOffset, options: [.new, .initial]) &#123;[weak self] object, change in guard let strongSelf = self else &#123; return &#125; let closureScrollView = object as UIScrollView var segmentFrame = strongSelf.segmentView.frame //è®¡ç®—åç§»ä½ç½® let safeOffsetY = closureScrollView.contentOffset.y + closureScrollView.safeAreaInsets.top //è®¡ç®—æµ®åŠ¨æ ä½ç½® if safeOffsetY &lt; -NSTSegmentHeight &#123; segmentFrame.origin.y = -NSTSegmentHeight &#125; else &#123; segmentFrame.origin.y = safeOffsetY &#125; strongSelf.segmentView.frame = segmentFrame &#125;&#125; è¿™æ–¹æ³•æœ‰ä¸€ä¸ªå‘ï¼Œå¦‚æœåŠ è½½çš„ UITableView éœ€è¦æ˜¾ç¤ºè‡ªå·±çš„ SectionHeader ï¼Œé‚£ä¹ˆç”±äºè®¾ç½®äº† ContentInset ï¼Œå°±ä¼šå¯¼è‡´æµ®åŠ¨ä½ç½®åç§»ã€‚ æˆ‘æƒ³åˆ°çš„è§£å†³åŠæ³•å°±æ˜¯åœ¨å›è°ƒä¸­ä¸æ–­è°ƒæ•´ ContentInset æ¥è§£å†³ã€‚ 12345678910111213141516171819observer = scrollView.observe(\\.contentOffset, options: [.new, .initial]) &#123;[weak self] object, change in guard let strongSelf = self else &#123; return &#125; let closureScrollView = object as UIScrollView //è®¡ç®—åç§»ä½ç½® let safeOffsetY = closureScrollView.contentOffset.y + closureScrollView.safeAreaInsets.top //ContentInset æ ¹æ®å½“å‰æ»šåŠ¨å®šåˆ¶ var contentInsetTop = NSTSegmentHeight + NSTHeaderHeight if safeOffsetY &lt; 0 &#123; contentInsetTop = min(contentInsetTop, fabs(safeOffsetY)) &#125; else &#123; contentInsetTop = 0 &#125; closureScrollView.contentInset = UIEdgeInsets(top: contentInsetTop, left: 0, bottom: 0, right: 0)&#125; è¿™ä¸ªæ–¹æ³•å¥½åœ¨ä¿è¯äº†æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ»šåŠ¨è§†å›¾ï¼Œæ‰€æœ‰çš„æ‰‹åŠ¿æ“ä½œéƒ½æ˜¯åŸç”Ÿå®ç°ï¼Œå‡å°‘äº†å¯èƒ½å­˜åœ¨çš„è”åŠ¨é—®é¢˜ã€‚ ä½†ä¹Ÿæœ‰ä¸€ä¸ªå°ç¼ºé™·ï¼Œé‚£å°±æ˜¯å¤´éƒ¨å†…å®¹çš„åç§»é‡éƒ½æ˜¯è´Ÿæ•°ï¼Œè¿™ä¸åˆ©äºä¸‰æ–¹è°ƒç”¨å’Œç³»ç»ŸåŸå§‹è°ƒç”¨çš„å®ç°ï¼Œéœ€è¦ç»´æŠ¤ã€‚ ä¸­å¤®é›†æƒæœ€åä»‹ç»ä¸€ç§æ¯”è¾ƒå®Œå–„çš„æ–¹æ¡ˆã€‚å¤–éƒ¨è§†å›¾é‡‡ç”¨ UIScrollView ï¼Œå†…éƒ¨è§†å›¾æ°¸è¿œä¸å¯æ»šåŠ¨ï¼Œå¤–éƒ¨è¾¹æ»šåŠ¨è¾¹è°ƒæ•´å†…éƒ¨çš„ä½ç½®ï¼Œä¿è¯äº†åŒæ–¹çš„ç‹¬ç«‹æ€§ã€‚ ä¸ç¬¬äºŒç§æ–¹æ³•ç›¸æ¯”ï¼Œåˆ‡æ¢ä¸åŒåŠŸèƒ½å°±æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦æ›¿æ¢å†…éƒ¨è§†å›¾ï¼Œå¹¶å®ç°å¤–éƒ¨è§†å›¾çš„ä»£ç†ï¼Œæ»šåŠ¨æ—¶è®¾ç½®å†…éƒ¨è§†å›¾çš„åç§»é‡å°±å¯ä»¥äº†ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748func reloadScrollView() &#123; //è·å–å½“å‰æ•°æ®æº let contentScrollView = segmentView.selectedIndex == 0 ? tableSource.tableView : webSource.webView.scrollView //ç§»é™¤ä¹‹å‰çš„è§†å›¾ if currentScrollView != nil &#123; currentScrollView!.removeFromSuperview() &#125; //ç¦æ­¢æ»šåŠ¨åæ·»åŠ æ–°è§†å›¾ contentScrollView.isScrollEnabled = false scrollView.addSubview(contentScrollView) //ä¿å­˜å½“å‰è§†å›¾ currentScrollView = contentScrollView&#125;func scrollViewDidScroll(_ scrollView: UIScrollView) &#123; //æ ¹æ®åç§»é‡åˆ·æ–° Segment å’Œå†…éƒ¨è§†å›¾çš„ä½ç½® self.view.setNeedsLayout() self.view.layoutIfNeeded() //æ ¹æ®å¤–éƒ¨è§†å›¾æ•°æ®è®¡ç®—å†…éƒ¨è§†å›¾çš„åç§»é‡ var floatOffset = scrollView.contentOffset floatOffset.y -= (NSTHeaderHeight + NSTSegmentHeight) floatOffset.y = max(floatOffset.y, 0) //åŒæ­¥å†…éƒ¨è§†å›¾çš„åç§» if currentScrollView?.contentOffset.equalTo(floatOffset) == false &#123; currentScrollView?.setContentOffset(floatOffset, animated: false) &#125;&#125;override func viewDidLayoutSubviews() &#123; super.viewDidLayoutSubviews() //æ’‘æ»¡å…¨éƒ¨ scrollView.frame = view.bounds //å¤´éƒ¨å›ºå®š headLabel.frame = CGRect(x: 15, y: 0, width: scrollView.frame.size.width - 30, height: NSTHeaderHeight) //Segmentçš„ä½ç½®æ˜¯åç§»å’Œå¤´éƒ¨é«˜åº¦çš„æœ€å¤§å€¼ //ä¿è¯æ»šåŠ¨åˆ°å¤´éƒ¨ä½ç½®æ—¶ä¸æµ®åŠ¨ segmentView.frame = CGRect(x: 0, y: max(NSTHeaderHeight, scrollView.contentOffset.y), width: scrollView.frame.size.width, height: NSTSegmentHeight) //è°ƒæ•´å†…éƒ¨è§†å›¾çš„ä½ç½® if currentScrollView != nil &#123; currentScrollView?.frame = CGRect(x: 0, y: segmentView.frame.maxY, width: scrollView.frame.size.width, height: view.bounds.size.height - NSTSegmentHeight) &#125;&#125; å½“å¤–éƒ¨è§†å›¾å¼€å§‹æ»šåŠ¨æ—¶ï¼Œå…¶å®ä¸€ç›´åœ¨æ ¹æ®åç§»é‡è°ƒæ•´å†…éƒ¨è§†å›¾çš„ä½ç½®ã€‚ å¤–éƒ¨è§†å›¾çš„å†…å®¹é«˜åº¦ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯å†…éƒ¨è§†å›¾å†…å®¹é«˜åº¦åŠ ä¸Šå¤´éƒ¨é«˜åº¦ï¼Œæ‰€ä»¥éœ€è¦è§‚å¯Ÿå…¶å˜åŒ–å¹¶åˆ·æ–°ã€‚ 1234567891011121314151617181920func reloadScrollView() &#123; if currentScrollView != nil &#123; //ç§»é™¤KVO observer?.invalidate() observer = nil &#125; //æ·»åŠ å†…å®¹å°ºå¯¸çš„ KVO observer = contentScrollView.observe(\\.contentSize, options: [.new, .initial]) &#123;[weak self] object, change in guard let strongSelf = self else &#123; return &#125; let closureScrollView = object as UIScrollView let contentSizeHeight = NSTHeaderHeight + NSTSegmentHeight + closureScrollView.contentSize.height //å½“å†…å®¹å°ºå¯¸æ”¹å˜æ—¶ï¼Œåˆ·æ–°å¤–éƒ¨è§†å›¾çš„æ€»å°ºå¯¸ï¼Œä¿è¯æ»šåŠ¨è·ç¦» strongSelf.scrollView.contentSize = CGSize(width: 0, height: contentSizeHeight) &#125;&#125; è¿™ä¸ªæ–¹æ³•ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºå†…éƒ¨æ»šåŠ¨éƒ½æ˜¯ç”±å¤–éƒ¨æ¥å®ç°ï¼Œæ²¡æœ‰æ‰‹åŠ¿çš„å‚ä¸ï¼Œå› æ­¤å¾—ä¸åˆ° scrollViewDidEndDragging ç­‰æ»šåŠ¨å›è°ƒï¼Œå¦‚æœæ¶‰åŠç¿»é¡µä¹‹ç±»çš„éœ€æ±‚å°±ä¼šé‡åˆ°å›°éš¾ã€‚ è§£å†³åŠæ³•æ˜¯è·å–å†…éƒ¨è§†å›¾åŸæœ¬çš„ä»£ç†ï¼Œå½“å¤–éƒ¨è§†å›¾ä»£ç†æ”¶åˆ°å›è°ƒæ—¶ï¼Œè½¬å‘ç»™è¯¥ä»£ç†å®ç°åŠŸèƒ½ã€‚ 123456789101112131415161718func reloadScrollView() &#123; typealias ClosureType = @convention(c) (AnyObject, Selector) -&gt; AnyObject //å®šä¹‰è·å–ä»£ç†æ–¹æ³• let sel = #selector(getter: UIScrollView.delegate) //è·å–æ»šåŠ¨è§†å›¾ä»£ç†çš„å®ç° let imp = class_getMethodImplementation(UIScrollView.self, sel) //åŒ…è£…æˆé—­åŒ…çš„å½¢å¼ let delegateFunc : ClosureType = unsafeBitCast(imp, to: ClosureType.self) //è·å¾—å®é™…çš„ä»£ç†å¯¹è±¡ currentScrollDelegate = delegateFunc(contentScrollView, sel) as? UIScrollViewDelegate&#125;func scrollViewDidEndDragging(_ scrollView: UIScrollView, willDecelerate decelerate: Bool) &#123; if currentScrollDelegate != nil &#123; currentScrollDelegate!.scrollViewDidEndDragging? (currentScrollView!, willDecelerate: decelerate) &#125;&#125; æ³¨æ„è¿™é‡Œæˆ‘å¹¶æ²¡æœ‰ä½¿ç”¨ contentScrollView.delegateï¼Œè¿™æ˜¯å› ä¸º UIWebScrollView é‡è½½äº†è¿™ä¸ªæ–¹æ³•å¹¶è¿”å›äº† UIWebView çš„ä»£ç†ã€‚ä½†å®é™…çœŸæ­£çš„ä»£ç†æ˜¯ä¸€ä¸ª NSProxy å¯¹è±¡ï¼Œä»–è´Ÿè´£æŠŠå›è°ƒä¼ ç»™ UIWebView å’Œå¤–éƒ¨ä»£ç†ã€‚è¦ä¿è¯ UIWebView èƒ½æ­£å¸¸å¤„ç†çš„è¯ï¼Œå°±è¦è®©å®ƒä¹Ÿæ”¶åˆ°å›è°ƒï¼Œæ‰€ä»¥ä½¿ç”¨ Runtime æ‰§è¡Œ UIScrollView åŸå§‹è·å–ä»£ç†çš„å®ç°æ¥è·å–ã€‚ æ€»ç»“ç›®å‰åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä½¿ç”¨çš„æ˜¯æœ€åä¸€ç§æ–¹æ³•ï¼Œä½†å…¶å®è¿™äº›æ–¹æ³•äº’æœ‰ä¼˜ç¼ºç‚¹ã€‚ æ–¹æ¡ˆ åˆ†è€Œæ²»ä¹‹ å„è‡ªä¸ºæ”¿ ä¸­å¤®é›†æƒ æ–¹å¼ åµŒå¥— å†…åµŒ åµŒå¥— è”åŠ¨ æ‰‹åŠ¨ è‡ªåŠ¨ æ‰‹åŠ¨ åˆ‡æ¢ æ•°æ®æº æ•´ä½“æ›´æ”¹ å±€éƒ¨æ›´æ”¹ ä¼˜åŠ¿ ä¾¿äºç†è§£ æ»šåŠ¨æ•ˆæœå¥½ ç‹¬ç«‹æ€§ åŠ£åŠ¿ è”åŠ¨å¤æ‚ å¤æ‚åœºæ™¯è‹¦æ‰‹ æ¨¡æ‹Ÿæ»šåŠ¨éšæ‚£ è¯„åˆ† ğŸŒŸğŸŒŸğŸŒŸ ğŸŒŸğŸŒŸğŸŒŸğŸŒŸ ğŸŒŸğŸŒŸğŸŒŸğŸŒŸ æŠ€æœ¯æ²¡æœ‰å¯¹é”™ï¼Œåªæœ‰é€‚ä¸é€‚åˆå½“å‰çš„éœ€æ±‚ã€‚ åˆ†è€Œæ²»ä¹‹é€‚åˆ UITableView äº’ç›¸åµŒå¥—çš„æƒ…å†µï¼Œé€šè¿‡æ•°æ®æºçš„å˜åŒ–èƒ½å¤Ÿå¾ˆå¥½å®ç°åˆ‡æ¢åŠŸèƒ½ã€‚ å„è‡ªä¸ºæ”¿é€‚åˆç›¸å¯¹ç®€å•çš„é¡µé¢éœ€æ±‚ï¼Œå¦‚æœèƒ½å¤Ÿé¿å…æµ®åŠ¨æ¡†ï¼Œé‚£ä½¿ç”¨è¿™ä¸ªæ–¹æ³•èƒ½å¤Ÿå®ç°æœ€å¥½çš„æ»šåŠ¨æ•ˆæœã€‚ ä¸­å¤®é›†æƒé€‚åˆå¤æ‚çš„åœºæ™¯ï¼Œé€šè¿‡ç‹¬ç«‹ä¸åŒç±»å‹çš„æ»šåŠ¨è§†å›¾ï¼Œä½¿å¾—äº’ç›¸æœ€å°‘å½±å“ï¼Œä½†æ˜¯ç”±äºå…¶æ¨¡æ‹Ÿæ»šåŠ¨çš„ç‰¹æ€§ï¼Œéœ€è¦å°å¿ƒå¤„ç†ã€‚ å¸Œæœ›æœ¬æ–‡èƒ½ç»™å¤§å®¶å¸¦æ¥å¯å‘ï¼Œé¡¹ç›®å¼€æºä»£ç åœ¨æ­¤ï¼Œæ¬¢è¿æŒ‡æ•™ä¸Starã€‚","categories":[{"name":"iOS","slug":"iOS","permalink":"https://vanchchen.github.io/categories/iOS/"}],"tags":[{"name":"é‡æ„","slug":"é‡æ„","permalink":"https://vanchchen.github.io/tags/é‡æ„/"}]},{"title":"è…¾è®¯äº‘Macå›¾åºŠæ’ä»¶","slug":"å›¾åºŠæ’ä»¶","date":"2018-12-07T06:16:09.000Z","updated":"2018-12-07T06:52:08.715Z","comments":true,"path":"p/648.html","link":"","permalink":"https://vanchchen.github.io/p/648.html","excerpt":"","text":"èƒŒæ™¯ éšç€åšå®¢è¶Šå†™è¶Šå¤šï¼Œéš¾å…ä¼šé‡åˆ°éœ€è¦æ’å…¥å›¾ç‰‡æ¥è¯´æ˜çš„æƒ…å†µã€‚ å›¾åºŠé€‰æ‹©é¦–å…ˆè°ƒç ”äº†å¸‚é¢ä¸Šçš„å›¾åºŠæœåŠ¡ï¼Œæœ¬ç€ç¨³å®šé•¿æœŸçš„ç›®æ ‡ï¼Œè¿‡æ»¤æ‰äº†æ‰“ä¸€æªæ¢ä¸€ä¸ªåœ°æ–¹çš„é‡é¸¡å°ç½‘ç«™ï¼Œå‰©ä½™æ¯”è¾ƒé è°±çš„ä¼˜ç¼ºç‚¹å¦‚ä¸‹ã€‚ å›¾åºŠ ä¼˜ç‚¹ ç¼ºç‚¹ è…¾è®¯äº‘ å…è´¹ æ— éœ€åŸŸå æœªæ¥å¯èƒ½ä¼šæ”¶è´¹ ä¸ƒç‰› å…è´¹ éœ€è¦åŸŸåå’Œå¤‡æ¡ˆ åˆæ‹äº‘ å…è´¹ æ— éœ€åŸŸå æœªæ¥å¯èƒ½ä¼šæ”¶è´¹ é˜¿é‡Œäº‘ ç›®å‰æœ€å®Œå¤‡ æ”¶è´¹ éœ€è¦åŸŸå å¾®åš å…è´¹ æ— éœ€åŸŸå ä¸ç¨³å®š åŒ¿åä¸Šä¼  ä½œä¸ºä¸€ä¸ªåˆšèµ·æ­¥çš„å°åšå®¢ï¼Œåº”è¯¥æŠŠç²¾åŠ›æ›´å¤šå…³æ³¨äºå†…å®¹ï¼Œä»¥åå†è€ƒè™‘åŸŸåå¤‡æ¡ˆæˆ–è€…å¤§æµé‡å¥—é¤ï¼Œå› æ­¤å°½é‡é€‰æ‹©å…è´¹çš„å›¾åºŠã€‚ å…¶å®æ˜¯ç©· å¾®åšä½œä¸ºå›½å†…é¦–å±ˆä¸€æŒ‡çš„æµé‡å¤§æˆ·ï¼Œå…¶å›¾åºŠçš„CDNå’Œè´¨é‡è‚¯å®šæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ä¸Šä¼ å›¾ç‰‡ä¼šè‡ªå¸¦æ°´å°ï¼Œä¸”åŒ¿åä¸Šä¼ æ€»è§‰å¾—ä¸é è°±ã€‚ å‰©ä¸‹çš„é€‰æ‹©è¿˜æœ‰ä¸¤ä¸ªï¼Œåˆæ‹äº‘è¿›å†›å¯¹è±¡å­˜å‚¨é¢†åŸŸæ¯”è…¾è®¯äº‘æ—©è€Œä¸”æ›´æˆç†Ÿï¼Œä½†æ˜¯å°±è§„æ¨¡å’ŒæŠ€æœ¯æ¥è¯´ï¼Œæˆ‘è¿˜æ˜¯æ›´æ„¿æ„ç›¸ä¿¡è…¾è®¯ã€‚ å·¥å…·æ³¨å†Œå®Œè…¾è®¯äº‘è´¦å·åï¼Œä¸‹ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ€ä¹ˆæ›´æ–¹ä¾¿çš„å°†å›¾åºŠä¸ MarkDown ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œæé«˜æ•ˆç‡å’Œä½“éªŒã€‚ iPic å®Œç¾ç¬¦åˆæˆ‘çš„éœ€æ±‚ï¼Œè¿™æ˜¯ä¸€æ¬¾ Mac ä¸Šçš„çŠ¶æ€æ è½¯ä»¶ï¼Œæ”¯æŒä¸Šä¼ æœ¬åœ°å›¾ç‰‡åˆ°è®¾å®šçš„å›¾åºŠï¼Œè·å–å›¾ç‰‡åœ°å€åæŒ‰ç…§ ![](url) æ ¼å¼å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚ é‚£ä¹ˆå¥½çš„åº”ç”¨ä¸ºå•¥ä¸ç”¨å‘¢ï¼Ÿ å› ä¸ºä¸æƒ³æŒ‰å¹´äº¤é’±ã€‚åº”ç”¨é»˜è®¤æ˜¯å¾®åšå›¾åºŠï¼Œå¦‚æœè¦ä½¿ç”¨å…¶ä»–å›¾åºŠå°±éœ€è¦è´­ä¹°ä¸“ä¸šç‰ˆï¼Œæ¯å¹´60å…ƒã€‚å¦‚æœæ˜¯ä¸€æ¬¡ä¹°æ–­çš„è¯ï¼Œä¹Ÿå°±ä¹°äº†ï¼Œå¹´è´¹å¿ƒé‡Œæ€»æœ‰ç–™ç˜© çŸ«æƒ…ã€‚ çªç„¶ï¼Œæˆ‘å°±æƒ³åˆ°ï¼ è‡ªå·±å¼€å‘ä¸€ä¸ªï¼ é—²çš„è›‹ç–¼ å¼€å‘iPhoneåº”ç”¨å·²ç»å¥½å¤šå¹´äº†ï¼Œè¿˜ä»æœªå¼€å‘è¿‡Macä¸Šçš„çŠ¶æ€æ è½¯ä»¶ï¼Œæ­£å¥½è¿˜èƒ½é”»ç‚¼ä¸‹Swiftï¼Œäºæ˜¯è¯´å¹²å°±å¹²ã€‚æ²¡æƒ³åˆ°å¼€å‘äº†ä¸€ä¸ªæœˆ éœ€æ±‚è®¾è®¡äº§å“ä½¿ç”¨é€»è¾‘åŸºæœ¬ä¸ iPic ä¸€è‡´ï¼ŒåŸºäºçŠ¶æ€æ äº¤äº’ï¼Œé€‰æ‹©png jpgæ–‡ä»¶ä¸Šä¼ ã€‚ å¯ä»¥è®¾ç½®æ˜¯å¦å‹ç¼©å›¾ç‰‡ï¼Œå‹ç¼©ä¼šå‹åˆ°500Kä»¥ä¸‹ã€‚ è¿˜éœ€è¦æœ‰ä¸€ä¸ªç™»å½•ç•Œé¢è®°å½•è…¾è®¯äº‘çš„è´¦å·å’Œå­˜å‚¨åº“ä¿¡æ¯ã€‚ æ–‡ä»¶ä¸Šä¼ æˆåŠŸåï¼Œå¼¹å‡ºé€šçŸ¥æé†’ï¼Œå¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚ å¦‚æœä¸æ…å¤åˆ¶äº†å…¶ä»–æ–‡æœ¬å¯¼è‡´ä¸¢å¤±äº†é“¾æ¥ï¼Œå†ç‚¹å‡»ä¸€æ¬¡é€šçŸ¥å°±å¯ä»¥é‡æ–°è·å–ã€‚ é‡åˆ°çš„éš¾é¢˜Swiftç¬¬ä¸€å…³å°±æ˜¯ç¼–ç¨‹è¯­è¨€ã€‚ è™½ç„¶ä¹Ÿæ›¾ç³»ç»Ÿçš„å­¦è¿‡Swiftï¼Œä½†ç”±äºå¸¸å¹´ä½¿ç”¨Objective-C å¼€å‘ï¼Œæ€ç»´æ–¹å¼è¿˜è½¬ä¸è¿‡æ¥ã€‚ ä¸¥æ ¼çš„ç©ºå˜é‡æ¯”è¾ƒæ˜æ˜¾çš„åŒºåˆ«å°±æ˜¯å¤„ç†ç©ºå˜é‡çš„æ–¹å¼ã€‚ åœ¨ObjCä¸­ï¼ŒæŒ‡é’ˆå˜é‡å¯ä»¥æ˜¯nilï¼ˆä¹Ÿå°±æ˜¯0ï¼‰ï¼Œå¯¹nilæ‰§è¡Œæ–¹æ³•ä¸ä¼šå‘ç”Ÿä»»ä½•äº‹æƒ…ï¼Œå› æ­¤å¯ä»¥ç®—æ˜¯éƒ¨åˆ†å®‰å…¨ã€‚ Swiftå¯¹å¾…ç©ºå˜é‡æ›´ä¸¥æ ¼ï¼Œ!ä¿®é¥°çš„å˜é‡å¿…é¡»æœ‰å…·ä½“å€¼ï¼Œ?ä¿®é¥°çš„å˜é‡æ‰å…·æœ‰ç©ºå€¼çš„å¯èƒ½æ€§ã€‚ nilä¸å†è¡¨ç¤ºä¸ºç©ºå¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªç©ºå€¼ï¼Œå‘ç©ºå€¼è°ƒç”¨æ–¹æ³•ä¼šå¯¼è‡´é—ªé€€ã€‚å¯¹å¾…?ä¿®é¥°çš„å˜é‡å¿…é¡»è¦å°å¿ƒï¼Œæœ€å¥½å…ˆåˆ¤æ–­æ˜¯å¦æœ‰å€¼å†ä½¿ç”¨ï¼Œå¥½åœ¨æœ‰è¯­æ³•ç³–å¯ä»¥è§£å†³è¿™ç±»é—®é¢˜ã€‚ 123456789101112131415161718192021//é»˜è®¤ä¸ºnilvar money : String?//å˜é‡æœ‰å€¼money = \"million\"//åˆ¤æ–­è‚¯å®šæœ‰å€¼åå†ä½¿ç”¨if money != nil &#123; print(\"I have \\(money!) dollars.\")&#125;//ä¿è¯å˜é‡æœ‰å€¼å¹¶èµ‹å€¼ç»™å®‰å…¨å˜é‡åæ‰§è¡Œif let account = money &#123; print(\"I have \\(account) dollars.\") &#125;//å˜é‡å¦‚æœæ²¡æœ‰å€¼å°±æ‰§è¡Œelseäº‹ä»¶å¹¶returnguard let account = money else &#123; print(\"I have no money.\")&#125;print(\"I have \\(account) dollars.\") åˆç†ä½¿ç”¨! ? ä¼šä½¿æˆ‘ä»¬çš„ä»£ç æ›´å®‰å…¨ä¸ç®€æ´ã€‚ Swift çš„ nil å’Œ Objective-C ä¸­çš„ nil å¹¶ä¸ä¸€æ ·ã€‚åœ¨ Objective-C ä¸­ï¼Œnil æ˜¯ä¸€ä¸ªæŒ‡å‘ä¸å­˜åœ¨å¯¹è±¡çš„æŒ‡é’ˆã€‚åœ¨ Swift ä¸­ï¼Œnil ä¸æ˜¯æŒ‡é’ˆâ€”â€”å®ƒæ˜¯ä¸€ä¸ªç¡®å®šçš„å€¼ï¼Œç”¨æ¥è¡¨ç¤ºå€¼ç¼ºå¤±ã€‚ä»»ä½•ç±»å‹çš„å¯é€‰çŠ¶æ€éƒ½å¯ä»¥è¢«è®¾ç½®ä¸º nilï¼Œä¸åªæ˜¯å¯¹è±¡ç±»å‹ã€‚ æŠ›å‡ºè­¦å‘ŠObjC æœ‰ @throw çš„ç”¨æ³•ï¼Œä½†æ˜¯æ ¹æ®è‹¹æœå®˜æ–¹çš„æè¿°ï¼Œæ‰§è¡Œçš„æˆæœ¬å¾ˆå¤§ã€‚ç©¶å…¶åŸå› åœ¨äº ObjC åŸºäº C è¯­è¨€è€Œä¸æ˜¯ C++ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨ setjmp()å’Œlongjmp() æ–¹æ³•å®ç°ï¼Œå› æ­¤å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚ Important: Exceptions are resource-intensive in Objective-C. You should not use exceptions for general flow-control, or simply to signify errors (such as a file not being accessible) Swift ä»æ ¹æœ¬è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ç»“åˆæšä¸¾ä¼˜åŒ–äº†æ•´ä¸ªæµç¨‹ã€‚ 12345678910111213141516171819202122232425262728enum CompressError : Error &#123; case NoImage case OverSize(size : Int)&#125;func compressImage(_ imageData: Data?) throws -&gt; Data? &#123; guard var compressData = imageData else &#123; throw CompressError.NoImage &#125; if compressData.count &gt; maxSize &#123; throw CompressError.OverSize(size: compressData.count) &#125;&#125;func uploadImage(_ imageData: Data?) &#123; var compressData : Data? = nil do &#123; compressData = try self.compressImage(imageData) &#125; catch CompressError.NoImage &#123; print(\"Image Not Exist\") &#125; catch CompressError.OverSize(let size) &#123; print(\"Image over size of \\(size)\") &#125; catch _ &#123;&#125; //ç®€æ´çš„æ–¹å¼ï¼Œå¿½ç•¥å¤„ç†è­¦å‘Š let compressData = try? self.compressImage(imageData)&#125; åˆ©ç”¨Swiftå¼ºå¤§çš„æšä¸¾ç±»å‹ï¼Œå¯ä»¥å®šåˆ¶åŒ–è­¦å‘Šä»è€Œä¼ é€’å‡ºæˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯ï¼Œä½¿å¾—æ•´ä¸ªæµç¨‹æ›´ä¸ºé¡ºç•…ã€‚ è¯­æ³•è¿˜æ”¯æŒ try?å¿½ç•¥è­¦å‘Šè·å–ä¸€ä¸ªå¯èƒ½ä¸ºç©ºå€¼çš„å˜é‡ï¼Œå¦‚æœè‡ªä¿¡ç»å¯¹ä¸ä¼šæŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œè¿˜èƒ½ä½¿ç”¨try!è·å–ä¸€ä¸ªè‚¯å®šå€¼ã€‚ Mac OS å¼€å‘å®é™…ç¼–å†™Cocoaä»£ç è¿‡ç¨‹ä¸­ï¼Œå‘ç°ä¸UIKitç›¸å·®è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ã€‚ æ§ä»¶é€»è¾‘UIKit çš„å±‚çº§ä¸€èˆ¬æ˜¯ UINavigationController -&gt; UIViewController Cocoa çš„å±‚çº§åˆ™ä¸å¤ªä¸€æ ·ï¼ŒNSWindowController -&gt; NSViewController åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œæ‰‹æœºä¸Šä¸€èˆ¬åªæœ‰ä¸€ä¸ªçª—å£ï¼Œä¾é å¯¼èˆªæ è¿›è¡Œé¡µé¢è·³è½¬ã€‚ä½†æ˜¯æ¡Œé¢ç«¯é€»è¾‘å°±ä¸å¤ªä¸€æ ·ï¼Œæ–°é¡µé¢ä¸€èˆ¬éƒ½æ˜¯ä»¥æ–°çª—å£çš„å½¢å¼å¼¹å‡ºã€‚ å…¶æ¬¡æ¡Œé¢ç«¯æ‹¥æœ‰ç‰¹å®šçš„çŠ¶æ€æ æ§ä»¶NSMenuï¼Œåœ¨å…¶ä¸­æ“ä½œèœå•é¡¹ä¹Ÿæ˜¯ä¸€ä¸ªæ–°çš„æŒ‘æˆ˜ã€‚ è…¾è®¯äº‘ç›¸å…³ç”±äºè…¾è®¯äº‘åªæä¾›äº†iOSçš„åº“ï¼Œæ‰€ä»¥æˆ‘è¿˜éœ€è¦å…ˆæŠŠåº“æ–‡ä»¶é‡æ–°è°ƒæ•´ä¸ºCocoaä»£ç ã€‚è¿™ä¸€éƒ¨åˆ†ä¹Ÿæ˜¯åƒäº†ä¸å°‘è‹¦å¤´ï¼Œéœ€è¦æŠŠè®¾å¤‡ç›¸å…³çš„ä»£ç ä¸åº”ç”¨ã€è¿›å‡ºåå°çš„é€šçŸ¥ç­‰éƒ½å»é™¤ï¼Œè¿˜è¦å¤„ç†ç±»ä¼¼åŠŸèƒ½çš„è½¬æ¢ï¼ˆæ¯”å¦‚UIImage -&gt; NSImageï¼‰ã€‚ åŒæ—¶è¿˜æœ‰ç¬¬äºŒä¸ªå‘ï¼Œè…¾è®¯äº‘çš„åº“éƒ½æ˜¯ObjCä»£ç ï¼Œæ‰€ä»¥éœ€è¦æ··ç¼–ã€‚ åˆ›å»ºä¸€ä¸ªå·¥ä½œç©ºé—´åæ‹–å…¥ä¸¤ä¸ªå·¥ç¨‹ï¼Œåœ¨ä¸»å·¥ç¨‹çš„ Targets / Build Phases / Embed Frameworks ä¸­åŠ å…¥SDKåº“ã€‚ æ¥ç€åœ¨Swiftå·¥ç¨‹ä¸­åˆ›å»ºProject-Bridging-Header.h å¤´æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­å¼•ç”¨SDKåº“ã€‚ æœ€ååœ¨ Targets / Build Settings / Objective-C Bridging Header è®¾ç½®å¤´æ–‡ä»¶ï¼Œå°±å¯ä»¥è§£å†³ä»£ç æ··ç¼–çš„é—®é¢˜ã€‚ å…¶åŸç†åœ¨äºè‡ªåŠ¨åˆ›å»ºäº†åŸºäºå¤´æ–‡ä»¶çš„pchï¼ŒæŠŠå¤´æ–‡ä»¶ä¸­å¼•ç”¨åˆ°çš„ObjCä»£ç ï¼Œéƒ½æ¡¥æ¥åˆ°å·¥ç¨‹ä¸­ã€‚ å›¾ç‰‡å‹ç¼©ç®—æ³•ä¹‹æ‰€ä»¥ä¸ä½¿ç”¨ç°æˆçš„è½¯ä»¶è¿˜æœ‰ä¸€ä¸ªåŸå› ï¼Œå°±æ˜¯æˆ‘æƒ³è‡ªå·±æ§åˆ¶å‹ç¼©å›¾ç‰‡çš„å‚æ•°å’Œæ•ˆæœã€‚ é€šè¿‡è°ƒç ”å’Œå®éªŒå›¾ç‰‡å‹ç¼©æ•ˆæœï¼Œæœ€ç»ˆæˆ‘é€‰æ‹©å‹åˆ¶æˆjpgæ ¼å¼ï¼Œ500kå¤§å°é™åˆ¶ï¼Œå‹ç¼©ç‡é™åˆ¶ä¸ºæœ€å°0.75ï¼Œç­‰æ¯”å®½åº¦é™åˆ¶ä¸º1280pxã€‚ æ–‡é¦–é‚£å¼ ç¾å¥³å›¾ï¼Œåˆå§‹æ˜¯1.9M 5087x3661ï¼Œç”±äºå°ºå¯¸è¿‡å¤§ï¼Œç¬¬ä¸€æ¬¡å‹ç¼©å›¾ç‰‡è´¨é‡åï¼Œå®¹é‡åè€Œå¢åŠ åˆ°äº†2.4Mã€‚ å°†å®½é«˜ç­‰æ¯”ç¼©å°åˆ°1280x922ï¼Œå›¾ç‰‡åˆå˜å¤§äº†ï¼Œè¿™æ¬¡å¢åŠ åˆ°äº†4.7Mã€‚ï¼ˆæ”¹å˜å®½é«˜éœ€è¦æ–°å»ºä¸€å¼ ç”»å¸ƒï¼Œåˆ›å»ºæ—¶å¿…é¡»è¦æœ‰alphaé€šé“ç­‰å…¶ä»–è®¾ç½®ï¼Œæ‰€ä»¥ä¼šå˜å¤§ï¼‰ æˆ‘ä»¬æ¥ç€å‹ç¼©ï¼Œæœ€ç»ˆåœ¨å‹ç¼©ç‡ä¸º0.9çš„æƒ…å†µä¸‹æŠŠå›¾ç‰‡å‹åˆ°äº†260Kï¼ŒæˆåŠŸè¾¾åˆ°äº†ç›®æ ‡ã€‚ æ€»ç»“è·ç¦»ä¸Šä¸€æ¬¡åšå®¢å·²ç»æœ‰ä¸¤ä¸ªæœˆçš„é—´éš”ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†åŸå› åœ¨äºç”Ÿæ´»ä¸Šçš„ä¸€äº›å˜æ•…ï¼Œå¦ä¸€ä¸ªåŸå› å°±åœ¨äºä¸ç†Ÿæ‚‰ Cocoa + Swift å¼€å‘ã€‚ å¥½åœ¨æœ€ç»ˆè¿˜æ˜¯å•ƒå‡ºæ¥äº†ï¼ŒGithubé¡¹ç›®å·²å¼€æºï¼Œæ¬¢è¿å¤§å®¶æŒ‡ç‚¹ä¸åæ§½ã€‚ è¿™æ¬¡é¡¹ç›®æœ€å¤§çš„æ”¶è·åœ¨äºè„±ç¦»è‡ªå·±çš„èˆ’é€‚åŒºã€‚äººçš„æœ¬æ€§åŒ…å«æƒ°æ€§ï¼Œæ€»æ˜¯è¶‹å‘äºåœ¨ç†Ÿæ‚‰çš„é¢†åŸŸå¹²ç†Ÿæ‚‰çš„æ´»ã€‚ä½†æ˜¯å°±å’Œä¼ä¸šä¸€æ ·ï¼Œä¸åˆ›æ–°å°±æ­»ï¼ŒæŠ€æœ¯ä¸æ–­åœ¨å‘å±•ï¼Œå¦‚æœæ²¡æœ‰è·Ÿä¸Šæ½®æµï¼Œæœ€ç»ˆå°±ä¼šè¢«æ·˜æ±°ã€‚ä»¥æ­¤å…±å‹‰ï¼ å‚è€ƒèµ„æ–™Swift 4.0 æ•™ç¨‹ Appå›¾ç‰‡å‹ç¼©è£å‰ªåŸç†å’Œä¸Šä¼ æ–¹æ¡ˆ","categories":[{"name":"iOS","slug":"iOS","permalink":"https://vanchchen.github.io/categories/iOS/"}],"tags":[{"name":"æ•ˆç‡å·¥å…·","slug":"æ•ˆç‡å·¥å…·","permalink":"https://vanchchen.github.io/tags/æ•ˆç‡å·¥å…·/"}]},{"title":"åˆ¨æ ¹é—®åº•KVOåŸç†","slug":"åˆ¨æ ¹é—®åº•KVOåŸç†","date":"2018-10-15T09:31:00.000Z","updated":"2018-10-16T01:15:41.979Z","comments":true,"path":"p/52b3.html","link":"","permalink":"https://vanchchen.github.io/p/52b3.html","excerpt":"","text":"ä»‹ç»KVO( NSKeyValueObserving )æ˜¯ä¸€ç§ç›‘æµ‹å¯¹è±¡å±æ€§å€¼å˜åŒ–çš„è§‚å¯Ÿè€…æ¨¡å¼æœºåˆ¶ã€‚å…¶ç‰¹ç‚¹æ˜¯æ— éœ€äº‹å…ˆä¿®æ”¹è¢«è§‚å¯Ÿè€…ä»£ç ï¼Œåˆ©ç”¨ runtime å®ç°è¿è¡Œä¸­ä¿®æ”¹æŸä¸€å®ä¾‹è¾¾åˆ°ç›®çš„ï¼Œä¿è¯äº†æœªä¾µå…¥æ€§ã€‚ Aå¯¹è±¡æŒ‡å®šè§‚å¯ŸBå¯¹è±¡çš„å±æ€§åï¼Œå½“å±æ€§å‘ç”Ÿå˜æ›´ï¼ŒAå¯¹è±¡ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œè·å–å˜æ›´å‰ä»¥åŠå˜æ›´çš„çŠ¶æ€ï¼Œä»è€Œåšè¿›ä¸€æ­¥å¤„ç†ã€‚ åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¤šç”¨äºåº”ç”¨å±‚è§‚å¯Ÿæ¨¡å‹å±‚æ•°æ®å˜åŠ¨ï¼Œæ¥æ”¶åˆ°é€šçŸ¥åæ›´æ–°ï¼Œä»è€Œè¾¾æˆæ¯”è¾ƒå¥½çš„è®¾è®¡æ¨¡å¼ã€‚ å¦ä¸€ç§å¸¸ç”¨çš„ç”¨æ³•æ˜¯ Debugï¼Œé€šè¿‡è§‚å¯Ÿé—®é¢˜å±æ€§çš„å˜åŒ–ï¼Œè¿½è¸ªé—®é¢˜å‡ºç°çš„å †æ ˆï¼Œæ›´æœ‰æ•ˆç‡çš„è§£å†³é—®é¢˜ã€‚ åº”ç”¨è§‚å¯Ÿå›è°ƒ1234- (void)observeValueForKeyPath:(nullable NSString *)keyPath ofObject:(nullable id)object change:(nullable NSDictionary&lt;NSKeyValueChangeKey, id&gt; *)change context:(nullable void *)context; è§‚å¯Ÿè€…éœ€è¦å®ç°è¿™ä¸ªæ–¹æ³•æ¥æ¥å—å›è°ƒï¼Œå…¶ä¸­keyPath æ˜¯ KVC è·¯å¾„ï¼Œ object æ˜¯è§‚å¯Ÿè€…ï¼Œcontext åŒºåˆ†ä¸åŒè§‚å¯Ÿçš„æ ‡è¯†ã€‚ æ”¹å˜å­—å…¸æœ€å…³é”®çš„æ˜¯æ”¹å˜å­—å…¸ï¼Œå…¶ä¸­åŒ…å«äº† NSKeyValueChangeKeyï¼Œé€šè¿‡é¢„å®šä¹‰çš„å­—ç¬¦ä¸²æ¥è·å–ç‰¹å®šçš„æ•°å€¼ã€‚ 1234567typedef NSString * NSKeyValueChangeKey NS_STRING_ENUM;FOUNDATION_EXPORT NSKeyValueChangeKey const NSKeyValueChangeKindKey;FOUNDATION_EXPORT NSKeyValueChangeKey const NSKeyValueChangeNewKey;FOUNDATION_EXPORT NSKeyValueChangeKey const NSKeyValueChangeOldKey;FOUNDATION_EXPORT NSKeyValueChangeKey const NSKeyValueChangeIndexesKey;FOUNDATION_EXPORT NSKeyValueChangeKey const NSKeyValueChangeNotificationIsPriorKey NSKeyValueChangeKindKey ä¸­å®šä¹‰çš„æ˜¯æ”¹å˜çš„ç±»å‹ï¼Œå¦‚æœè°ƒç”¨çš„æ˜¯Setteræ–¹æ³•ï¼Œé‚£å°±æ˜¯NSKeyValueChangeSettingã€‚ å‰©ä½™çš„ä¸‰ç§åˆ†åˆ«æ˜¯æ’å…¥ã€åˆ é™¤ã€æ›¿æ¢ï¼Œå½“è§‚å¯Ÿçš„å±æ€§å±äºé›†åˆç±»ï¼ˆè¿™ç‚¹ä¼šåœ¨ä¹‹åè®²ï¼‰ï¼Œå˜åŠ¨æ—¶å°±ä¼šé€šçŸ¥è¿™äº›ç±»å‹ã€‚ 123456typedef NS_ENUM(NSUInteger, NSKeyValueChange) &#123; NSKeyValueChangeSetting = 1, NSKeyValueChangeInsertion = 2, NSKeyValueChangeRemoval = 3, NSKeyValueChangeReplacement = 4,&#125;; NSKeyValueChangeNewKey è·å–å˜æ›´çš„æœ€æ–°å€¼ï¼ŒNSKeyValueChangeOldKey è·å–åŸå§‹æ•°å€¼ã€‚ NSKeyValueChangeIndexesKey å¦‚æœè§‚å¯Ÿçš„æ˜¯é›†åˆï¼Œé‚£è¿™ä¸ªé”®å€¼è¿”å›ç´¢å¼•é›†åˆã€‚ NSKeyValueChangeNotificationIsPriorKey å¦‚æœè®¾ç½®äº†æ¥å—æå‰é€šçŸ¥ï¼Œé‚£ä¹ˆä¿®æ”¹ä¹‹å‰ä¼šå…ˆå‘é€é€šçŸ¥ï¼Œä¿®æ”¹åå†å‘ä¸€æ¬¡ã€‚ä¸ºäº†åŒºåˆ†è¿™ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡ä¼šå¸¦ä¸Šè¿™ä¸ªé”®å€¼å¯¹ï¼Œå…¶å†…å®¹ä¸º @1ã€‚ å­—ç¬¦ä¸²æšä¸¾åœ¨æ³¨å†Œç±»å‹æ—¶ï¼Œè‹¹æœä½¿ç”¨äº†NS_STRING_ENUMå®ã€‚ è™½ç„¶è¿™ä¸ªå®åœ¨ObjCä¸‹æ¯«æ— ä½œç”¨ï¼Œä½†æ˜¯å¯¹äºSwiftæœ‰ä¼˜åŒ–ï¼Œä¸Šé¢çš„å®šä¹‰ä¼šå˜æˆè¿™æ ·ã€‚123456789enum NSKeyValueChangeKey: String &#123; case kind case new case old case indexes case notificationIsPrior&#125;let dict: [NSKeyValueChangeKey : Any] = [......]let kind = dict[.kind] as! Number å­—ç¬¦ä¸²æšä¸¾å¯¹äºä½¿ç”¨æ¥è¯´æ˜¯éå¸¸ç›´è§‚å’Œå®‰å…¨çš„ã€‚ æ·»åŠ ä¸åˆ é™¤å¯¹äºæ™®é€šå¯¹è±¡ï¼Œä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•å°±èƒ½æ³¨å†Œä¸æ³¨é”€è§‚å¯Ÿã€‚12345678- (void)addObserver:(NSObject *)observer forKeyPath:(NSString *)keyPath options:(NSKeyValueObservingOptions)options context:(nullable void *)context;- (void)removeObserver:(NSObject *)observer forKeyPath:(NSString *)keyPath context:(nullable void *)context; å¯ä»¥è®¾ç½®å¤šç§è§‚å¯Ÿæ¨¡å¼æ¥åŒ¹é…éœ€æ±‚ã€‚1234567891011typedef NS_OPTIONS(NSUInteger, NSKeyValueObservingOptions) &#123; //å¯ä»¥æ”¶åˆ°æ–°æ”¹å˜çš„æ•°å€¼ NSKeyValueObservingOptionNew = 0x01, //å¯ä»¥æ”¶åˆ°æ”¹å˜å‰çš„æ•°å€¼ NSKeyValueObservingOptionOld = 0x02, //addObserveråç«‹åˆ»è§¦å‘é€šçŸ¥ï¼Œåªæœ‰newï¼Œæ²¡æœ‰old NSKeyValueObservingOptionInitial = 0x04, //ä¼šåœ¨æ”¹å˜å‰ä¸æ”¹å˜åå‘é€ä¸¤æ¬¡é€šçŸ¥ //æ”¹å˜å‰çš„é€šçŸ¥å¸¦æœ‰notificationIsPrior=@1ï¼Œold NSKeyValueObservingOptionPrior = 0x08&#125;; ç”±äºä¸ç¬¦åˆ KVC çš„è®¿é—®å™¨æ ‡å‡†ï¼Œè‹¹æœè§„å®š NSArray NSOrderedSet NSSet ä¸å¯ä»¥æ‰§è¡Œ addObserver æ–¹æ³•ï¼Œä¸ç„¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚é’ˆå¯¹ NSArray æœ‰ç‰¹æ®Šçš„æ–¹æ³•ï¼Œå¦‚ä¸‹12345678910- (void)addObserver:(NSObject *)observer toObjectsAtIndexes:(NSIndexSet *)indexes forKeyPath:(NSString *)keyPath options:(NSKeyValueObservingOptions)options context:(nullable void *)context;- (void)removeObserver:(NSObject *)observer fromObjectsAtIndexes:(NSIndexSet *)indexes forKeyPath:(NSString *)keyPath context:(nullable void *)context; ä¸»è¦çš„åŒºåˆ«åœ¨äºå¤šäº†ä¸€ä¸ªObjectsAtIndexesï¼Œå…¶å®åšçš„äº‹æƒ…æ˜¯ä¸€æ ·çš„ï¼Œæ ¹æ®ç´¢å¼•æ‰¾åˆ°å¯¹è±¡ï¼Œå†é€ä¸€å»ºç«‹è§‚å¯Ÿå…³ç³»ã€‚ åŸç†RuntimeNSKeyValueObserving ä¸ NSKeyValueCoding ä¸€èµ·å®šä¹‰åœ¨ Foundation åº“ï¼Œè€Œè¿™ä¸ªåº“æ˜¯ä¸å¼€æºçš„ï¼Œæˆ‘ä»¬å…ˆä»è‹¹æœå¼€å‘è€…æ–‡æ¡£ä¸­è·å–ä¿¡æ¯ã€‚ Automatic key-value observing is implemented using a technique called isa-swizzling. çœ‹æè¿°çŒœæµ‹è‹¹æœåº”è¯¥æ˜¯é€šè¿‡é‡æ–°è®¾ç½®è¢«è§‚å¯Ÿè€…çš„ Class (isa ä¸­åŒ…å« Class ä¿¡æ¯)ï¼Œè¯¥ç±»ç»§æ‰¿äº†åŸç±»å¹¶ä¸”é‡è½½å±æ€§çš„ Setter æ–¹æ³•ï¼Œæ·»åŠ å‘é€šçŸ¥çš„æ“ä½œè¾¾åˆ°ç›®çš„ã€‚ 12345678910111213141516171819202122232425@interface ConcreteSubject : NSObject@property (nonatomic, strong) id obj;@endConcreteSubject *sub = [ConcreteSubject new];NSLog(@\"%s\", class_getName(object_getClass(sub)));//æ”¹å˜å‰ outprint--&gt; ConcreteSubject[sub addObserver:self forKeyPath:@\"obj\" options:NSKeyValueObservingOptionNew context:nil];//æ‰§è¡Œè§‚å¯Ÿæ–¹æ³•NSLog(@\"%s\", class_getName(object_getClass(sub)));//æ”¹å˜å outprint--&gt; NSKVONotifying_ConcreteSubjectNSLog(@\"%s\", class_getName(object_getClass(class_getSuperclass(cls))));//è·å–è¶…ç±»å outprint--&gt; ConcreteSubjectNSLog(@\"%s\", class_getName(sub.class));//è·å–ç±»å outprint--&gt; ConcreteSubjectclass_getMethodImplementation(cls, @selector(setObj:));//imp = (IMP)(Foundation`_NSSetObjectValueAndNotify)class_getMethodImplementation(cls, @selector(class));//imp = (IMP)(Foundation`NSKVOClass) è¯•äº†ä¸€ä¸‹æœç„¶ Class è¢«æ›¿æ¢äº†ï¼Œå˜æˆåŠ äº† NSKVONotifying_ å‰ç¼€çš„æ–°ç±»ã€‚ æ–°ç±»ç»§æ‰¿è‡ªåŸç±»ï¼Œä½†æ˜¯è¿™ä¸ªç±»çš„ class æ–¹æ³•è¿”å›çš„è¿˜æ˜¯åŸç±»ï¼Œè¿™ä¿è¯äº†å¤–éƒ¨é€»è¾‘å®Œæ•´ã€‚ åç¼–è¯‘æºç é€šè¿‡ Runtime ï¼Œæˆ‘ä»¬åªèƒ½çŸ¥é“ KVO ä½¿ç”¨äº†ä¸€ä¸ªç»§æ‰¿äº†åŸç±»çš„ç±»ï¼Œå¹¶ä¸”æ›¿æ¢äº†åŸæ–¹æ³•çš„å®ç°ï¼ŒsetObj: = _NSSetObjectValueAndNotify class = _NSKVOClassã€‚å¦‚æœæˆ‘ä»¬æƒ³è¿›ä¸€æ­¥äº†è§£è¯¦æƒ…ï¼Œåªèƒ½é€šè¿‡åç¼–è¯‘ Foundation æ¥æŸ¥æ‰¾æ±‡ç¼–ä»£ç ã€‚ è¿™é‡Œæˆ‘ä½¿ç”¨äº† Hopper å·¥å…·ï¼Œåˆ†æçš„äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„æ˜¯/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/Library/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/Frameworks/Foundation.framework/Foundation æ›¿æ¢çš„å®ç°1234567891011//ä¼ªä»£ç ï¼Œä»…ä¾›ç†è§£void _NSKVOClass(id self, SEL _cmd) &#123; Class cls = object_getClass(self); Class originCls = __NSKVONotifyingOriginalClassForIsa(cls); if (cls != originCls) &#123; return [originCls class]; &#125; else &#123; Method method = class_getInstanceMethod(cls, _cmd); return method_invoke(self, method); &#125;&#125; å…ˆçœ‹åŸ class æ–¹æ³•ï¼Œè·å–äº†å½“å‰ç±»å’ŒåŸç±»ï¼Œå¦‚æœä¸ä¸€è‡´å°±è¿”å›åŸç±»ï¼Œå¦‚æœä¸€è‡´å°±æ‰§è¡ŒåŸ class å®ç°ã€‚ 12345678910111213141516171819//ä¼ªä»£ç ï¼Œä»…ä¾›ç†è§£void __NSSetObjectValueAndNotify(id self, SEL _cmd, id value) &#123; //è·å–é¢å¤–çš„å˜é‡ void *indexedIvars = object_getIndexedIvars(object_getClass(self)); //åŠ é” pthread_mutex_lock(indexedIvars + 0x20); //ä»SELè·å–KeyPath NSString *keyPath = [CFDictionaryGetValue(*(indexedIvars) + 0x18), _cmd) copyWithZone:0x0]; //è§£é” pthread_mutex_unlock(indexedIvars + 0x20); //æ”¹å˜å‰å‘é€šçŸ¥ [self willChangeValueForKey:keyPath]; //å®ç°Setteræ–¹æ³• IMP imp = class_getMethodImplementation(*indexedIvars, _cmd); (imp)(self, _cmd, value); //æ”¹å˜åå‘é€šçŸ¥ [self didChangeValueForKey:keyPath];&#125; å†çœ‹æ”¹å˜åçš„ Setter æ–¹æ³•ï¼Œå…¶ä¸­ indexedIvars æ˜¯åŸç±»ä¹‹å¤–çš„æˆå‘˜å˜é‡ï¼Œç¬¬ä¸€ä¸ªæŒ‡é’ˆæ˜¯æ”¹å˜åçš„ç±»ï¼Œ0x20 çš„åç§»é‡æ˜¯çº¿ç¨‹é”ï¼Œ0x18 åœ°å€å‚¨å­˜äº†æ”¹å˜è¿‡çš„æ–¹æ³•å­—å…¸ã€‚ åœ¨æ‰§è¡ŒåŸæ–¹æ³•å®ç°å‰è°ƒç”¨äº† willChangeValueForKey å‘èµ·é€šçŸ¥ï¼ŒåŒæ ·åœ¨ä¹‹åè°ƒç”¨ didChangeValueForKeyã€‚ æ·»åŠ è§‚å¯Ÿæ–¹æ³•é‚£ä¹ˆæ˜¯åœ¨å“ªä¸ªæ–¹æ³•ä¸­æ›¿æ¢çš„å®ç°å‘¢ï¼Ÿå…ˆçœ‹ [NSObject addObserver:forKeyPath:options:context:] æ–¹æ³•ã€‚12345678910111213//ä¼ªä»£ç ï¼Œä»…ä¾›ç†è§£void -[NSObject addObserver:forKeyPath:options:context:](void * self, void * _cmd, void * arg2, void * arg3, unsigned long long arg4, void * arg5) &#123; pthread_mutex_lock(__NSKeyValueObserverRegistrationLock); *__NSKeyValueObserverRegistrationLockOwner = pthread_self(); rax = object_getClass(self); rax = _NSKeyValuePropertyForIsaAndKeyPath(rax, arg3); [self _addObserver:arg2 forProperty:rax options:arg4 context:arg5]; *__NSKeyValueObserverRegistrationLockOwner = 0x0; pthread_mutex_unlock(__NSKeyValueObserverRegistrationLock); return;&#125; æ–¹æ³•å¾ˆç®€å•ï¼Œæ ¹æ® KeyPath è·å–å…·ä½“å±æ€§åè¿›ä¸€æ­¥è°ƒç”¨æ–¹æ³•ã€‚ç”±äºè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œæˆ‘ç‰¹åœ°æ•´ç†æˆ ObjC ä»£ç ï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657//ä¼ªä»£ç ï¼Œä»…ä¾›ç†è§£- (void *)_addObserver:(id)observer forProperty:(NSKeyValueProperty *)property options:(NSKeyValueObservingOptions)option context:(void *)context &#123; //éœ€è¦æ³¨å†Œé€šçŸ¥ if (option &amp; NSKeyValueObservingOptionInitial) &#123; //è·å–å±æ€§åè·¯å¾„ NSString *keyPath = [property keyPath]; //è§£é” pthread_mutex_unlock(__NSKeyValueObserverRegistrationLock); //å¦‚æœæ³¨å†Œäº†è·å¾—æ–°å€¼ï¼Œå°±è·å–æ•°å€¼ id value = nil; if (option &amp; NSKeyValueObservingOptionNew) &#123; value = [self valueForKeyPath:keyPath]; if (value == nil) &#123; value = [NSNull null]; &#125; &#125; //å‘é€æ³¨å†Œé€šçŸ¥ _NSKeyValueNotifyObserver(observer, keyPath, self, context, value, 0 /*originalObservable*/, 1 /*NSKeyValueChangeSetting*/); //åŠ é” pthread_mutex_lock(__NSKeyValueObserverRegistrationLock); &#125; //è·å–å±æ€§çš„è§‚å¯Ÿä¿¡æ¯ Info *info = __NSKeyValueRetainedObservationInfoForObject(self, property-&gt;_containerClass); //åˆ¤æ–­æ˜¯å¦éœ€è¦è·å–æ–°çš„æ•°å€¼ id _additionOriginalObservable = nil; if (option &amp; NSKeyValueObservingOptionNew) &#123; //0\u001dx15æ²¡æœ‰æ‰¾åˆ°å®šä¹‰ï¼ŒçŒœæµ‹ä¸ºä¿å­˜æ˜¯å¦å¯è§‚å¯Ÿçš„æ•°ç»„ id tsd = _CFGetTSD(0x15); if (tsd != nil) &#123; _additionOriginalObservable = *(tsd + 0x10); &#125; &#125; //åœ¨åŸæœ‰ä¿¡æ¯ä¸Šç”Ÿæˆæ–°çš„ä¿¡æ¯ Info *newInfo = __NSKeyValueObservationInfoCreateByAdding (info, observer, property, option, context, _additionOriginalObservable, 0, 1); //æ›¿æ¢å±æ€§çš„è§‚å¯Ÿä¿¡æ¯ __NSKeyValueReplaceObservationInfoForObject(self, property-&gt;_containerClass, info, newInfo); //å±æ€§æ·»åŠ åé€’å½’æ·»åŠ å…³è”å±æ€§ [property object:self didAddObservance:newInfo recurse:true]; //è·å–æ–°çš„isa Class cls = [property isaForAutonotifying]; if ((cls != NULL) &amp;&amp; (object_getClass(self) != cls)) &#123; //å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å°±æ›¿æ¢isa object_setClass(self, cls); &#125; //é‡Šæ”¾è§‚å¯Ÿä¿¡æ¯ [newInfo release]; if (info != nil) &#123; [info release]; &#125; return;&#125; å…¶ä¸­æœ‰å¯èƒ½æ›¿æ¢æ–¹æ³•å®ç°çš„æ­¥éª¤æ˜¯è·å– isa çš„æ—¶å€™ï¼ŒçŒœæµ‹å½“ç¬¬ä¸€æ¬¡åˆ›å»ºæ–°ç±»çš„æ—¶å€™ï¼Œä¼šæ³¨å†Œæ–°çš„æ–¹æ³•ï¼Œæ¥ç€è¿½è¸ª isaForAutonotifying æ–¹æ³•ã€‚ è·å–è§‚å¯Ÿç±»1234567891011121314151617181920void * -[NSKeyValueUnnestedProperty _isaForAutonotifying] (void * self, void * _cmd) &#123; rbx = self; r14 = *_OBJC_IVAR_$_NSKeyValueProperty._containerClass; if ([*(rbx + r14)-&gt;_originalClass automaticallyNotifiesObserversForKey:rbx-&gt;_keyPath] != 0x0) &#123; r14 = __NSKeyValueContainerClassGetNotifyingInfo(*(rbx + r14)); if (r14 != 0x0) &#123; __NSKVONotifyingEnableForInfoAndKey(r14, rbx-&gt;_keyPath); rax = *(r14 + 0x8); &#125; else &#123; rax = 0x0; &#125; &#125; else &#123; rax = 0x0; &#125; return rax;&#125; ç«‹åˆ»å‘ç°äº†ç†Ÿæ‚‰çš„æ–¹æ³•ï¼ automaticallyNotifiesObserversForKey: æ˜¯ä¸€ä¸ªç±»æ–¹æ³•ï¼Œå¦‚æœä½ ä¸å¸Œæœ›æŸä¸ªå±æ€§è¢«è§‚å¯Ÿï¼Œé‚£ä¹ˆå°±è®¾ä¸º NOï¼Œisa è¿”å›æ˜¯ç©ºä¹Ÿå°±å®£å‘Šè¿™æ¬¡æ·»åŠ è§‚å¯Ÿå¤±è´¥ã€‚ å¦‚æœä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œå°†ä¼šæ‰§è¡Œ__NSKVONotifyingEnableForInfoAndKey(info, keyPath) æ”¹å˜ class çš„æ–¹æ³•ï¼Œæœ€ç»ˆè¿”å›å…¶ isaã€‚ å®è´¨æ›¿æ¢æ–¹æ³•ç”±äºè¯¥æ–¹æ³•å®åœ¨å¤ªé•¿ï¼Œä¸”ä½¿ç”¨äº†gotoä¸æ–¹ä¾¿é˜…è¯»ï¼Œæ‰€ä»¥ä¾æ—§æ•´ç†æˆä¼ªä»£ç ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071//ä¼ªä»£ç ï¼Œä»…ä¾›ç†è§£int __NSKVONotifyingEnableForInfoAndKey(void *info, id keyPath) &#123; //çº¿ç¨‹é”åŠ é” pthread_mutex_lock(info + 0x20); //æ·»åŠ keyPathåˆ°æ•°ç»„ CFSetAddValue(*(info + 0x10), keyPath); //è§£é” pthread_mutex_unlock(info + 0x20); //åˆ¤æ–­åŸç±»å®ç°èƒ½ä¸èƒ½æ›¿æ¢ Class originClass = *info; MethodClass *methodClass = __NSKeyValueSetterForClassAndKey(originClass, keyPath, originClass); if (![methodClass isKindOfClass:[NSKeyValueMethodSetter class]]) &#123; swizzleMutableMethod(info, keyPath); return; &#125; //åˆ¤æ–­Setteræ–¹æ³•è¿”å›å€¼ Method method = [methodClass method]; if (*(int8_t *)method_getTypeEncoding(method) != _C_VOID) &#123; _NSLog(@\"KVO autonotifying only supports -set&lt;Key&gt;: methods that return void.\"); swizzleMutableMethod(info, keyPath); return; &#125; //è·å–Setteræ–¹æ³•å‚æ•° char *typeEncoding = method_copyArgumentType(method, 0x2); char type = sign_extend_64(*(int8_t *)typeEncoding); SEL sel;//æ ¹æ®å‚æ•°ç±»å‹é€‰æ‹©æ›¿æ¢çš„æ–¹æ³• switch (type) &#123; case _C_BOOL: sel = __NSSetBoolValueAndNotify; case _C_UCHR: sel = __NSSetUnsignedCharValueAndNotify; case _C_UINT: sel = __NSSetUnsignedIntValueAndNotify; case _C_ULNG: sel = __NSSetUnsignedLongValueAndNotify; case _C_ULNG_LNG: sel = __NSSetUnsignedLongLongValueAndNotify; case _C_CHR: sel = __NSSetCharValueAndNotify; case _C_DBL: sel = __NSSetDoubleValueAndNotify; case _C_FLT: sel = __NSSetFloatValueAndNotify; case _C_INT: sel = __NSSetIntValueAndNotify; case _C_LNG: sel = __NSSetLongValueAndNotify; case _C_LNG_LNG: sel = __NSSetLongLongValueAndNotify; case _C_SHT: sel = __NSSetShortValueAndNotify; case _C_USHT: sel = __NSSetUnsignedShortValueAndNotify; case _C_LNG_LNG: sel = __NSSetLongLongValueAndNotify; case _C_ID: sel = __NSSetObjectValueAndNotify; case \"&#123;CGPoint=dd&#125;\": sel = __NSSetPointValueAndNotify; case \"&#123;_NSRange=QQ&#125;\": sel = __NSSetRangeValueAndNotify; case \"&#123;CGRect=&#123;CGPoint=dd&#125;&#123;CGSize=dd&#125;&#125;\": sel = __NSSetRectValueAndNotify; case \"&#123;CGSize=dd&#125;\": sel = __NSSetSizeValueAndNotify; case *_NSKeyValueOldSizeObjCTypeName: sel = __CF_forwarding_prep_0; default; &#125; //ä¸æ”¯æŒçš„å‚æ•°ç±»å‹æ‰“å°é”™è¯¯ä¿¡æ¯ if (sel == NULL) &#123; _NSLog(@\"KVO autonotifying only supports -set&lt;Key&gt;: methods that take id, NSNumber-supported scalar types, and some NSValue-supported structure types.\") swizzleMutableMethod(info, keyPath); return; &#125; //æ›¿æ¢æ–¹æ³•å®ç° SEL methodSel = method_getName(method); _NSKVONotifyingSetMethodImplementation(info, methodSel, sel, keyPath); if (sel == __CF_forwarding_prep_0) &#123; _NSKVONotifyingSetMethodImplementation(info, @selector(forwardInvocation:), _NSKVOForwardInvocation, false); Class cls = *(info + 0x8); SEL newSel = sel_registerName(\"_original_\" + sel_getName(methodSel)); Imp imp = method_getImplementation(method); TypeEncoding type = method_getTypeEncoding(method); class_addMethod(cls, newSel, imp, type); &#125; swizzleMutableMethod(info, keyPath);&#125; å¯ä»¥è¡¨è¿°ä¸ºæ ¹æ® Setter æ–¹æ³•è¾“å…¥å‚æ•°ç±»å‹ï¼ŒåŒ¹é…åˆé€‚çš„ NSSetValueAndNotify å®ç°æ¥æ›¿æ¢ï¼Œä»è€Œå®ç°æ•ˆæœã€‚ é‚£ä¹ˆ swizzleMutableMethod æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿ 1234567891011121314151617181920212223242526272829303132333435363738//æ›¿æ¢å¯å˜æ•°ç»„é›†åˆçš„æ–¹æ³•int swizzleMutableMethod(void *info, id keyPath) &#123; //NSKeyValueArray CFMutableSetRef getterSet = __NSKeyValueMutableArrayGetterForIsaAndKey(*info, keyPath); if ([getterSet respondsToSelector:mutatingMethods]) &#123; mutatingMethods methodList = [getterSet mutatingMethods]; replace methodList-&gt;insertObjectAtIndex _NSKVOInsertObjectAtIndexAndNotify replace methodList-&gt;insertObjectsAtIndexes _NSKVOInsertObjectsAtIndexesAndNotify replace methodList-&gt;removeObjectAtIndex _NSKVORemoveObjectAtIndexAndNotify replace methodList-&gt;removeObjectsAtIndexes _NSKVORemoveObjectsAtIndexesAndNotify replace methodList-&gt;replaceObjectAtIndex _NSKVOReplaceObjectAtIndexAndNotify replace methodList-&gt;replaceObjectsAtIndexes _NSKVOReplaceObjectsAtIndexesAndNotify &#125; //NSKeyValueOrderedSet getterSet = __NSKeyValueMutableOrderedSetGetterForIsaAndKey(*info, keyPath); if ([getterSet respondsToSelector:mutatingMethods]) &#123; mutatingMethods methodList = [getterSet mutatingMethods]; replace methodList-&gt;insertObjectAtIndex _NSKVOInsertObjectAtIndexAndNotify replace methodList-&gt;insertObjectsAtIndexes _NSKVOInsertObjectsAtIndexesAndNotify replace methodList-&gt;removeObjectAtIndex _NSKVORemoveObjectAtIndexAndNotify replace methodList-&gt;removeObjectsAtIndexes _NSKVORemoveObjectsAtIndexesAndNotify replace methodList-&gt;replaceObjectAtIndex _NSKVOReplaceObjectAtIndexAndNotify replace methodList-&gt;replaceObjectsAtIndexes _NSKVOReplaceObjectsAtIndexesAndNotify &#125; //NSKeyValueSet getterSet = __NSKeyValueMutableSetGetterForClassAndKey(*info, keyPath); if ([getterSet respondsToSelector:mutatingMethods]) &#123; mutatingMethods methodList = [getterSet mutatingMethods]; replace methodList-&gt;addObject _NSKVOAddObjectAndNotify replace methodList-&gt;intersectSet _NSKVOIntersectSetAndNotify replace methodList-&gt;minusSet _NSKVOMinusSetAndNotify replace methodList-&gt;removeObject _NSKVORemoveObjectAndNotify replace methodList-&gt;unionSet _NSKVOUnionSetAndNotify &#125; //æ”¹å˜æ–°ç±»çš„æ–¹æ³•ç¼“å­˜ __NSKeyValueInvalidateCachedMutatorsForIsaAndKey(*(info + 0x8), keyPath); return rax;&#125; å‰é¢æåˆ°çš„éƒ½æ˜¯ä¸€å¯¹ä¸€ï¼Œé‚£å¦‚æœæˆ‘æƒ³è§‚å¯Ÿä¸€å¯¹å¤šçš„é›†åˆç±»å‘¢ï¼Ÿå°±æ˜¯é€šè¿‡ KVC ä¸­çš„ mutableArrayValueForKey: è¿”å›ä¸€ä¸ªä»£ç†é›†åˆï¼Œæ”¹å˜è¿™äº›ä»£ç†ç±»çš„å®ç°åšåˆ°çš„ã€‚å…·ä½“çš„ä¾‹å­ä¹‹åä¼šä»‹ç»ã€‚ åˆ›å»ºæ–°ç±»è¿˜æœ‰ä¸€ä¸ªç–‘é—®å°±æ˜¯æ›¿æ¢çš„ç±»æ˜¯æ€ä¹ˆåˆ›å»ºçš„ï¼Ÿå…·ä½“æ–¹æ³•åœ¨ __NSKVONotifyingEnableForInfoAndKey ä¸­å®ç°ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364//ä¼ªä»£ç ï¼Œä»…ä¾›ç†è§£int __NSKVONotifyingCreateInfoWithOriginalClass(Class cls) &#123; //æ‹¼æ¥æ–°åå­— const char *name = class_getName(cls); int length = strlen(r12) + 0x10;//16æ˜¯NSKVONotifying_çš„é•¿åº¦ char *newName = malloc(length); __strlcpy_chk(newName, \"NSKVONotifying_\", length, -1); __strlcat_chk(newName, name, length, -1); //ç”Ÿæˆä¸€ä¸ªç»§æ‰¿åŸç±»çš„æ–°ç±» Class newCls = objc_allocateClassPair(cls, newName, 0x68); free(newName); if (newCls != NULL) &#123; objc_registerClassPair(newCls); //è·å–é¢å¤–çš„å®ä¾‹å˜é‡è¡¨ void *indexedIvars = object_getIndexedIvars(newCls); *indexedIvars = cls; //è®°å½•åŸisa *(indexedIvars + 0x8) = newCls; //è®°å½•æ–°isa //æ–°å»ºä¸€ä¸ªé›†åˆï¼Œä¿å­˜è§‚å¯Ÿçš„keyPath *(indexedIvars + 0x10) = CFSetCreateMutable(0x0, 0x0, _kCFCopyStringSetCallBacks); //æ–°å»ºä¸€ä¸ªå­—å…¸ï¼Œä¿å­˜æ”¹å˜è¿‡çš„SEL *(indexedIvars + 0x18) = CFDictionaryCreateMutable(0x0, 0x0, 0x0, _kCFTypeDictionaryValueCallBacks); //æ–°å»ºä¸€ä¸ªçº¿ç¨‹é” pthread_mutexattr_init(var_38); pthread_mutexattr_settype(var_38, 0x2); pthread_mutex_init(indexedIvars + 0x20, var_38); pthread_mutexattr_destroy(var_38); //è·å–NSObjectç±»é»˜è®¤çš„å®ç° if (*__NSKVONotifyingCreateInfoWithOriginalClass.NSObjectIMPLookupOnce == NULL) &#123; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^&#123; *__NSKVONotifyingCreateInfoWithOriginalClass.NSObjectWillChange = class_getMethodImplementation([NSObject class], @selector(willChangeValueForKey:)); *__NSKVONotifyingCreateInfoWithOriginalClass.NSObjectDidChange = class_getMethodImplementation([NSObject class], @selector(didChangeValueForKey:)); &#125;); &#125; //è®¾ç½®æ˜¯å¦æ›¿æ¢è¿‡ChangeValueæ–¹æ³•çš„flag BOOL isChangedImp = YES; if (class_getMethodImplementation(cls, @selector(willChangeValueForKey:)) == *__NSKVONotifyingCreateInfoWithOriginalClass.NSObjectWillChange) &#123; BOOL isChangedDidImp = class_getMethodImplementation(cls, @selector(didChangeValueForKey:)) != *__NSKVONotifyingCreateInfoWithOriginalClass.NSObjectDidChange; isChangedImp = isChangedDidImp ? YES : NO; &#125; *(int8_t *)(indexedIvars + 0x60) = isChangedImp; //ä½¿ç”¨KVOçš„å®ç°æ›¿æ¢åŸç±»æ–¹æ³• _NSKVONotifyingSetMethodImplementation(indexedIvars, @selector(_isKVOA), _NSKVOIsAutonotifying, false/*æ˜¯å¦éœ€è¦ä¿å­˜SELåˆ°å­—å…¸*/); _NSKVONotifyingSetMethodImplementation(indexedIvars, @selector(dealloc), _NSKVODeallocate, false); _NSKVONotifyingSetMethodImplementation(indexedIvars, @selector(class), _NSKVOClass, false); &#125; return newCls;&#125; å»ºç«‹å…³ç³»è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯è§‚å¯Ÿçš„å±æ€§ä¾èµ–äºå¤šä¸ªå…³ç³»ï¼Œæ¯”å¦‚ color å¯èƒ½ä¾èµ–äº r g b aï¼Œå…¶ä¸­ä»»ä½•ä¸€ä¸ªæ”¹å˜ï¼Œéƒ½éœ€è¦é€šçŸ¥ color çš„å˜åŒ–ã€‚ å»ºç«‹å…³ç³»çš„æ–¹æ³•æ˜¯ + (NSSet *)keyPathsForValuesAffectingValueForKey:(NSString *)key æˆ– + (NSSet *)keyPathsForValuesAffecting&lt;key&gt; è¿”å›ä¾èµ–é”®å€¼çš„å­—ç¬¦ä¸²é›†åˆ 123456789101112//ä¼ªä»£ç + (NSSet *)keyPathsForValuesAffectingValueForKey:(NSString *)key &#123; char *str = \"keyPathsForValuesAffecting\" + key; SEL sel = sel_registerName(str); Method method = class_getClassMethod(self, sel); if (method != NULL) &#123; result = method_invoke(self, method); &#125; else &#123; result = [self _keysForValuesAffectingValueForKey:key]; &#125; return result;&#125; è¿˜è®°å¾—ä¹‹å‰åœ¨ _addObserver æ–¹æ³•ä¸­æœ‰è¿™æ®µä»£ç å—ï¼Ÿ 12//å±æ€§æ·»åŠ åé€’å½’æ·»åŠ å…³è”å±æ€§[property object:self didAddObservance:newInfo recurse:true]; å…¶ä¸­ NSKeyValueProperty ä¹Ÿæ˜¯ä¸€ä¸ªç±»ç°‡ï¼Œå…·ä½“åˆ†ä¸º NSKeyValueProperty NSKeyValueComputedProperty NSKeyValueUnnestedProperty NSKeyValueNestedPropertyï¼Œä»åå­—ä¹Ÿçœ‹å‡º NSKeyValueNestedProperty æ˜¯æŒ‡åµŒå¥—å­å±æ€§çš„å±æ€§ç±»ï¼Œé‚£æˆ‘ä»¬è§‚å¯Ÿä¸‹ä»–çš„å®ç°ã€‚ 1234567891011121314//ä¼ªä»£ç - (void)object:(id)obj didAddObservance:(id)info recurse:(BOOL)isRecurse &#123; if (self-&gt;_isAllowedToResultInForwarding != nil) &#123; //è·å¾—å…³ç³»é”® relateObj = [obj valueForKey:self-&gt;_relationshipKey]; //æ³¨å†Œæ‰€æœ‰å…³ç³»é€šçŸ¥ [relateObj addObserver:info forKeyPath:self-&gt;_keyPathFromRelatedObject options:info-&gt;options context:nil]; &#125; //å†å¾€ä¸‹é€’å½’ [self-&gt;_relationshipProperty object:obj didAddObservance:info recurse:isRecurse];&#125; è‡³æ­¤ï¼Œå®ç°çš„å¤§è‡´æ•´ä½“è½®å»“æ¯”è¾ƒäº†è§£äº†ï¼Œä¸‹é¢ä¼šè®²ä¸€ä¸‹æ€ä¹ˆæŠŠåŸç†è¿ç”¨åˆ°å®é™…ã€‚ åº”ç”¨åŸç†æ‰‹åŠ¨è§¦å‘å½“ +(BOOL)automaticallyNotifiesObserversForKey:(NSString *)key è¿”å›æ˜¯ YESï¼Œé‚£ä¹ˆæ³¨å†Œçš„è¿™ä¸ª Key å°±ä¼šæ›¿æ¢å¯¹åº”çš„ Setter ï¼Œä»è€Œåœ¨æ”¹å˜çš„æ—¶å€™è°ƒç”¨ -(void)willChangeValueForKey:(NSString *)key ä¸ -(void)didChangeValueForKey:(NSString *)key å‘é€é€šçŸ¥ç»™è§‚å¯Ÿè€…ã€‚ é‚£ä¹ˆåªè¦æŠŠè‡ªåŠ¨é€šçŸ¥è®¾ä¸º NOï¼Œå¹¶ä»£ç å®ç°è¿™ä¸¤ä¸ªé€šçŸ¥æ–¹æ³•ï¼Œå°±å¯ä»¥è¾¾åˆ°æ‰‹åŠ¨è§¦å‘çš„è¦æ±‚ã€‚ 123456789101112131415+ (BOOL)automaticallyNotifiesObserversForKey:(NSString *)key &#123; if ([key isEqualToString:@\"object\"]) &#123; return false; &#125; return [super automaticallyNotifiesObserversForKey:key];&#125;- (void)setObject:(NSObject *)object &#123; if (object != _object) &#123; [self willChangeValueForKey:@\"object\"]; _object = object; [self didChangeValueForKey:@\"object\"]; &#125;&#125; å¦‚æœæ“ä½œçš„æ˜¯ä¹‹å‰æåˆ°çš„é›†åˆå¯¹è±¡ï¼Œé‚£ä¹ˆå®ç°çš„æ–¹æ³•å°±éœ€è¦å˜ä¸º 12345678910111213- (void)willChange:(NSKeyValueChange)changeKind valuesAtIndexes:(NSIndexSet *)indexes forKey:(NSString *)key;- (void)didChange:(NSKeyValueChange)changeKind valuesAtIndexes:(NSIndexSet *)indexes forKey:(NSString *)key;- (void)willChangeValueForKey:(NSString *)key withSetMutation:(NSKeyValueSetMutationKind)mutationKind usingObjects:(NSSet *)objects;- (void)didChangeValueForKey:(NSString *)key withSetMutation:(NSKeyValueSetMutationKind)mutationKind usingObjects:(NSSet *)objects; ä¾èµ–é”®è§‚å¯Ÿä¹‹å‰ä¹Ÿæœ‰æè¿‡æ„å»ºä¾èµ–å…³ç³»çš„æ–¹æ³•ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ 12345678910111213141516171819202122232425262728+ (NSSet&lt;NSString *&gt; *)keyPathsForValuesAffectingValueForKey:(NSString *)key &#123; if ([key isEqualToString:@\"color\"]) &#123; return [NSSet setWithObjects:@\"r\",@\"g\",@\"b\",@\"a\",nil]; &#125; return [super keyPathsForValuesAffectingValueForKey:key];&#125;//å»ºè®®ä½¿ç”¨é™æ€æŒ‡é’ˆåœ°å€ä½œä¸ºä¸Šä¸‹æ–‡åŒºåˆ†ä¸åŒçš„è§‚å¯Ÿstatic void * const kColorContext = (void*)&amp;kColorContext;- (void)viewDidLoad &#123; [super viewDidLoad]; [self addObserver:self forKeyPath:@\"color\" options:NSKeyValueObservingOptionNew context:kColorContext]; self.r = 133;&#125;- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context &#123; if (context == kColorContext) &#123; NSLog(@\"%@\", keyPath); //outprint --&gt; color &#125;&#125; å¯å˜æ•°ç»„ä¸é›†åˆä¸å¯å˜çš„æ•°ç»„ä¸é›†åˆç”±äºå†…éƒ¨ç»“æ„å›ºå®šï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡è§‚å¯Ÿå®¹å™¨ç±»å†…å­˜åœ°å€æ¥åˆ¤æ–­æ˜¯å¦å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯ NSKeyValueChangeSettingã€‚ é›†åˆå’Œæ•°ç»„çš„è§‚å¯Ÿéƒ½å¾ˆç±»ä¼¼ï¼Œæˆ‘ä»¬å…ˆå…³æ³¨å¦‚æœè¦è§‚å¯Ÿå¯å˜æ•°ç»„å†…éƒ¨æ’å…¥ç§»é™¤çš„å˜åŒ–å‘¢ï¼Ÿ å…ˆäº†è§£ä¸€ä¸‹é›†åˆä»£ç†æ–¹æ³•ï¼Œ- (NSMutableArray *)mutableArrayValueForKey:ï¼Œè¿™æ˜¯ä¸€ä¸ª KVC æ–¹æ³•ï¼Œèƒ½å¤Ÿè¿”å›ä¸€ä¸ªå¯ä¾›è§‚å¯Ÿçš„ NSKeyValueArray å¯¹è±¡ã€‚ æ ¹æ®è‹¹æœæ³¨é‡Šï¼Œå…¶æœç´¢é¡ºåºå¦‚ä¸‹ 1.æœç´¢æ˜¯å¦å®ç°æœ€å°‘ä¸€ä¸ªæ’å…¥ä¸ä¸€ä¸ªåˆ é™¤æ–¹æ³•1234-insertObject:in&lt;Key&gt;AtIndex:-removeObjectFrom&lt;Key&gt;AtIndex:-insert&lt;Key&gt;:atIndexes:-remove&lt;Key&gt;AtIndexes: 2.å¦åˆ™æœç´¢æ˜¯å¦æœ‰ set&lt;Key&gt;: æ–¹æ³•ï¼Œæœ‰çš„è¯æ¯æ¬¡éƒ½æŠŠä¿®æ”¹æ•°ç»„é‡æ–°èµ‹å€¼å›åŸå±æ€§ã€‚ 3.å¦åˆ™æ£€æŸ¥ + (BOOL)accessInstanceVariablesDirectlyï¼Œå¦‚æœæ˜¯YESï¼Œå°±æŸ¥æ‰¾æˆå‘˜å˜é‡_&lt;key&gt; or &lt;key&gt;ï¼Œæ­¤åæ‰€æœ‰çš„æ“ä½œé’ˆå¯¹ä»£ç†éƒ½è½¬æ¥ç»™æˆå‘˜å˜é‡æ‰§è¡Œã€‚ 4.æœ€åè¿›å…¥ä¿æŠ¤æ–¹æ³•valueForUndefinedKey: ç¬¬ä¸€ç§æ–¹æ³•1234567891011121314151617- (void)insertObject:(NSObject *)object inDataArrayAtIndex:(NSUInteger)index &#123; [_dataArray insertObject:object atIndex:index];&#125;- (void)removeObjectFromDataArrayAtIndex:(NSUInteger)index &#123; [_dataArray removeObjectAtIndex:index];&#125;- (void)viewDidLoad &#123; [super viewDidLoad]; _dataArray = @[].mutableCopy; [self addObserver:self forKeyPath:@\"dataArray\" options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld | NSKeyValueObservingOptionPrior context:nil]; [self insertObject:@1 inDataArrayAtIndex:0];&#125; é€šè¿‡å®ç°äº†insertä¸removeæ–¹æ³•ï¼Œä½¿å¾—ä»£ç†æ•°ç»„èƒ½å¤Ÿæ­£å¸¸è¿ä½œæ•°ç»„å˜é‡ï¼ŒKVO è§‚å¯Ÿäº†ä»£ç†æ•°ç»„çš„è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå‘å‡ºäº†æˆ‘ä»¬éœ€è¦çš„é€šçŸ¥ã€‚ è¿™ç§æ–¹å¼ä½¿ç”¨äº†ç¬¬ä¸€æ­¥æœç´¢ï¼Œæ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œç¼ºç‚¹æ˜¯æ”¹åŠ¨çš„ä»£ç æ¯”è¾ƒå¤šï¼Œæ”¹åŠ¨æ•°ç»„å¿…é¡»é€šè¿‡è‡ªå®šä¹‰æ–¹æ³•ã€‚ ç¬¬äºŒç§æ–¹æ³•1234567891011121314151617@property (nonatomic, strong, readonly) NSMutableArray *dataArray;@synthesize dataArray = _dataArray;- (NSMutableArray *)dataArray &#123; return [self mutableArrayValueForKey:@\"dataArray\"];&#125;- (void)viewDidLoad &#123; [super viewDidLoad]; _dataArray = @[].mutableCopy; [self addObserver:self forKeyPath:@\"dataArray\" options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld | NSKeyValueObservingOptionPrior context:nil]; [self.dataArray addObject:@1];&#125; è¿™ç§æ–¹å¼ç›¸å¯¹æ¥è¯´æ›´ç®€æ´ï¼Œä¿®æ”¹æ•°ç»„çš„æ–¹æ³•ä¸å¹³æ—¶ä¸€è‡´ï¼Œæ¯”è¾ƒé€‚åˆä½¿ç”¨ã€‚ ä¸‹é¢è¯´ä¸€ä¸‹åŸç†ï¼Œé¦–å…ˆæˆ‘ä»¬æ²¡æœ‰å®ç°å¯¹åº”çš„insertä¸removeæ–¹æ³•ï¼Œå…¶æ¬¡readonlyå±æ€§ä¹Ÿæ²¡æœ‰set&lt;key&gt;:æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å®ç°äº† @synthesize dataArray = _dataArray; æ‰€ä»¥æ ¹æ®ç¬¬ä¸‰æ­¥å¯¹ä»£ç†æ•°ç»„çš„æ“ä½œéƒ½ä¼šå®é™…æ“ä½œåˆ°å®ä¾‹å˜é‡ä¸­ã€‚ ç„¶åé‡è½½äº† dataArray çš„ Getter æ–¹æ³•ï¼Œä¿è¯äº†ä¿®æ”¹æ•°ç»„æ—¶å¿…é¡»è°ƒç”¨ä¸»ä½“æ˜¯self.dataArrayï¼Œä¹Ÿå°±æ˜¯ä»£ç†æ•°ç»„ï¼Œä»è€Œå‘é€é€šçŸ¥ã€‚ é—®ç­”KVOçš„åº•å±‚å®ç°ï¼ŸKVO å°±æ˜¯é€šè¿‡ Runtime æ›¿æ¢è¢«è§‚å¯Ÿç±»çš„ Setter å®ç°ï¼Œä»è€Œåœ¨å‘ç”Ÿæ”¹å˜æ—¶å‘èµ·é€šçŸ¥ã€‚ å¦‚ä½•å–æ¶ˆç³»ç»Ÿé»˜è®¤çš„KVOå¹¶æ‰‹åŠ¨è§¦å‘ï¼ˆç»™KVOçš„è§¦å‘è®¾å®šæ¡ä»¶ï¼šæ”¹å˜çš„å€¼ç¬¦åˆæŸä¸ªæ¡ä»¶æ—¶å†è§¦å‘KVOï¼‰ï¼Ÿé€šè¿‡è®¾ç½® automaticallyNotifiesObserversForKey ä¸º False å®ç°å–æ¶ˆè‡ªåŠ¨è§¦å‘ã€‚ ç¬¦åˆæ¡ä»¶å†è§¦å‘å¯ä»¥è¿™ä¹ˆå®ç°ã€‚ 123456789101112- (void)setObject:(NSObject *)object &#123; if (object == _object) return; BOOL needNotify = [object isKindOfClass:[NSString class]]; if (needNotify) &#123; [self willChangeValueForKey:@\"object\"]; &#125; _object = object; if (needNotify) &#123; [self didChangeValueForKey:@\"object\"]; &#125;&#125; æ€»ç»“ç”±äºå¯¹æ±‡ç¼–è¯­è¨€ã€åç¼–è¯‘å·¥å…·ã€objc4å¼€æºä»£ç çš„ä¸ç†Ÿæ‚‰ï¼Œè¿™ç¯‡æ–‡ç« å†™äº†ä¸€å‘¨æ—¶é—´ï¼Œç»“æ„ä¹Ÿæœ‰ç‚¹æ··ä¹±ã€‚ æ‰€å¹¸è¿˜æ˜¯ç†é¡ºäº†æ•´ä½“ç»“æ„ï¼Œåœ¨æ•´ç†çš„è¿‡ç¨‹ä¸­å­¦ä¼šäº†å¾ˆå¤šå¾ˆå¤šã€‚ ç”±äºæ‰ç–å­¦æµ…ï¼Œå…¶ä¸­å¯¹æ±‡ç¼–å’Œæºç çš„è§£é‡Šéš¾å…å‡ºé”™ï¼Œè¿˜æœ›å¤§ä½¬å¤šå¤šæŒ‡æ•™ï¼ èµ„æ–™åˆ†äº«ObjCä¸­å›½çš„æœŸåˆŠ KVCå’ŒKVO æ¨å¤§ç‰›çš„ Objective-Cä¸­çš„KVCå’ŒKVO iOSå¼€å‘æŠ€å·§ç³»åˆ—â€”è¯¦è§£KVC(æˆ‘å‘Šè¯‰ä½ KVCçš„ä¸€åˆ‡)","categories":[{"name":"iOS","slug":"iOS","permalink":"https://vanchchen.github.io/categories/iOS/"}],"tags":[{"name":"åŸç†åˆ†æ","slug":"åŸç†åˆ†æ","permalink":"https://vanchchen.github.io/tags/åŸç†åˆ†æ/"}]},{"title":"è„šæœ¬å¤„ç†iOSçš„Crashæ—¥å¿—","slug":"è„šæœ¬è§£æCrash","date":"2018-10-08T08:06:38.000Z","updated":"2018-12-07T06:16:41.187Z","comments":true,"path":"p/2616.html","link":"","permalink":"https://vanchchen.github.io/p/2616.html","excerpt":"","text":"èƒŒæ™¯å½“æˆ‘ä»¬æ‰“åŒ…appæ—¶ï¼Œå¯ä»¥é€‰æ‹©ç”Ÿæˆå¯¹åº”çš„ç¬¦å·è¡¨ï¼Œå…¶ä¿å­˜ 16 è¿›åˆ¶å‡½æ•°åœ°å€æ˜ å°„ä¿¡æ¯ï¼Œé€šè¿‡ç»™å®šçš„å‡½æ•°èµ·å§‹åœ°å€å’Œåç§»é‡ï¼Œå¯ä»¥å¯¹åº”å‡½æ•°å…·ä½“ä¿¡æ¯ä»¥ä¾›åˆ†æã€‚ æ‰€ä»¥æˆ‘ä»¬æ‹¿åˆ°æµ‹è¯•ç»™çš„é—ªé€€æ—¥å¿—(.crash)æ—¶ï¼Œéœ€è¦æ‰¾åˆ°æ‰“åŒ…æ—¶å¯¹åº”ç”Ÿæˆçš„ç¬¦å·è¡¨(.dSYM)ä½œä¸ºé’¥åŒ™è§£æã€‚å…·ä½“åˆ†ä¸ºä¸‹é¢å‡ ä¸ªæ­¥éª¤ dwarfdump --uuid å‘½ä»¤è·å– .dSYM çš„ uuid æ‰“å¼€ .crash æ–‡ä»¶ï¼Œåœ¨ç‰¹å®šä½ç½®æ‰¾åˆ° uuid æ ¹æ® arm ç‰ˆæœ¬æ¯”å¯¹ä¸¤è€…æ˜¯å¦ä¸€è‡´ åˆ° Xcode ç›®å½•ä¸‹å¯»æ‰¾ symbolicatecrash å·¥å…· ä¸åŒç‰ˆæœ¬æ–‡ä»¶è·¯å¾„ä¸åŒï¼Œå…·ä½“ç‰ˆæœ¬è¯·è°·æ­Œã€‚Xcode9è·¯å¾„æ˜¯/Applications/Xcode.app/Contents/SharedFrameworks/DVTFoundation.framework/Versions/A/Resources/ è®¾ç½®ç»ˆç«¯ç¯å¢ƒå˜é‡ export DEVELOPER_DIR=&quot;/Applications/Xcode.app/Contents/Developer&quot; ä½¿ç”¨ symbolicatecrash å·¥å…·è§£ææ—¥å¿— symbolicatecrash .crash .dsym &gt; a.out è™½ç„¶è¿‡ç¨‹ä¸å¤æ‚ï¼Œä½†æ˜¯æ¯æ¬¡éƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ä¸å‘½ä»¤ï¼Œè¿‡äºç¹çï¼Œæ‰€ä»¥å†³å®šç”¨è„šæœ¬åŒ–æé«˜æ•ˆç‡ã€‚ æ­¥éª¤å®ç°è¾“å…¥Crashæ—¥å¿—123#è¦æ±‚è¾“å…¥crashæ–‡ä»¶è·¯å¾„inputFile 'Please Input Crash File' 'crash'crashPath=$filePath ç”±äºéœ€è¦è¾“å…¥ä¸¤ç§ä¸åŒåç¼€çš„æ–‡ä»¶è·¯å¾„ï¼Œä¸”éƒ½éœ€è¦æ£€æŸ¥ï¼Œå› æ­¤ç»Ÿä¸€å®šä¹‰ä¸€ä¸ªæ–¹æ³•ã€‚123456789101112131415161718#å®šä¹‰å…¨å±€å˜é‡filePath=#è¾“å…¥æ–‡ä»¶è·¯å¾„inputFile() &#123; readSuccess=false #é¦–å…ˆæ¸…ç©ºå˜é‡å€¼ filePath= while [ $readSuccess = false ]; do echo $1 #è¯»å–åˆ°å˜é‡ä¸­ read -a filePath if [[ ! -e $filePath || $&#123;filePath##*.&#125; != $2 ]]; then echo \"Input file is not .\"$2 else readSuccess=true fi done&#125; .dSYM æ˜¯æ–‡ä»¶å¤¹è·¯å¾„ï¼Œæ‰€ä»¥è¿™é‡Œç®€å•çš„åˆ¤æ–­äº†è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±ç»§ç»­è®©ç”¨æˆ·è¾“å…¥ã€‚ Shellå‘½ä»¤ä¸­åˆ¤æ–­åˆ†ä¸º[]ä¸[[]]ï¼Œåè€…æ¯”å‰è€…æ›´é€šç”¨ï¼Œå¯ä»¥ä½¿ç”¨ || æ­£åˆ™è¿ç®—ç­‰ã€‚ åˆ¤æ–­ä¸­ï¼Œ-fè¡¨ç¤ºæ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œ-dè¡¨ç¤ºæ£€æŸ¥æ˜¯å¦å­˜åœ¨æ–‡ä»¶å¤¹ï¼Œ-eè¡¨ç¤ºæ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥è·¯å¾„ è¾“å…¥dSYMç¬¦å·è¡¨1234567891011121314dsymSuccess=falsewhile [ $dsymSuccess = false ]; do #è¦æ±‚è¾“å…¥dSYMæ–‡ä»¶è·¯å¾„ inputFile 'Please Input dSYM File' 'dSYM' dsymPath=$filePath #æ£€æŸ¥æ˜¯å¦åŒ¹é… checkUUID \"$crashPath\" \"$dsymPath\" match=$? if [ $match -eq 0 ]; then echo 'UUID not match!' else dsymSuccess=true fidone å¾ªç¯è·å–åŒ¹é… UUID çš„ dSYM ï¼Œè¿™é‡Œä½¿ç”¨äº†å¦ä¸€ç§æ–¹æ³•è·å–æ–¹æ³•è¿”å›å€¼ï¼Œå…·ä½“ä¹‹åç« èŠ‚ä¼šæ€»ç»“ã€‚ æŸ¥æ‰¾symbolicatecrashå·¥å…·åœ¨ Xcode æ–‡ä»¶å¤¹æŒ‡å®šè·¯å¾„ä¸‹æŸ¥æ‰¾å·¥å…·ï¼ŒåŠ å¿«æ•ˆç‡ï¼Œå¦‚æœæ²¡æ‰¾åˆ°å°±åœæ­¢è¿è¡Œã€‚ 123456# æŸ¥æ‰¾symbolicatecrashè§£æå·¥å…·ï¼Œå†…ç½®åœ¨Xcodeçš„åº“æ–‡ä»¶ä¸­toolPath=`find /Applications/Xcode.app/Contents/SharedFrameworks -name symbolicatecrash | head -n 1`if [ ! -f $toolPath ]; then echo \"Symbolicatecrash not exist!\" exit 0fi æ‰§è¡Œè§£æå‘½ä»¤1234567#å…ˆè®¾ç½®ç¯å¢ƒå˜é‡export DEVELOPER_DIR=\"/Applications/Xcode.app/Contents/Developer\"#æŒ‡å®šè§£æç»“æœè·¯å¾„crashName=`basename $crashPath`afterPath=\"$(dirname \"$crashPath\")\"/\"$&#123;crashName%%.*&#125;\"\"_after.crash\"#å¼€å§‹è§£æ$toolPath \"$crashPath\" \"$dsymPath\" &gt; \"$afterPath\" 2&gt; /dev/null è¿™é‡Œæˆ‘å°†é”™è¯¯ä¿¡æ¯å¯¼æµåˆ° /dev/nullï¼Œä¿è¯è§£ææ–‡ä»¶æ²¡æœ‰æ‚ä¹±ä¿¡æ¯ã€‚ é‡åˆ°çš„é—®é¢˜æ€ä¹ˆè·å–å‡½æ•°è¿”å›å€¼ï¼Ÿä¹‹å‰æ²¡æœ‰å¤„ç†è¿‡éœ€è¦è¿”å›æ•°å€¼çš„æ–¹æ³•ï¼Œæ‰€ä»¥ä¸€å¼€å§‹æœ‰ç‚¹æ‡µï¼ŒæŸ¥è¯¢èµ„æ–™åæœ€ç»ˆé‡‡ç”¨äº†ä¸¤ç§æ–¹å¼å®ç°äº†æ•ˆæœï¼Œç°åœ¨åšä¸€äº›æ€»ç»“ã€‚ å…¨å±€å˜é‡è®°å½•12345678#å®šä¹‰å…¨å±€å˜é‡filePath=inputFile() &#123; #è¯»å–åˆ°å˜é‡ä¸­ read -a filePath&#125;inputFilecrashPath=$filePath é€šè¿‡ inputFile æ–¹æ³•æ¥äº†è§£ä¸€ä¸‹ï¼Œé¦–å…ˆå®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ä¸º filePathï¼Œåœ¨æ–¹æ³•ä¸­é‡æ–°èµ‹å€¼ï¼Œæ–¹æ³•ç»“æŸåè¯»å–å…¨å±€å˜é‡ä¸­çš„æ•°æ®ã€‚ è¿™ç§æ–¹æ³•çš„å¥½å¤„æ˜¯å¯ä»¥è‡ªå®šä¹‰è¿”å›å‚æ•°ç±»å‹å’Œä¸ªæ•°ï¼Œç¼ºç‚¹æ˜¯å®¹æ˜“å’Œå…¶ä»–å˜é‡ææ··ã€‚ Returnè¿”å›å€¼ç±»ä¼¼ä¸Cè¯­è¨€ä¸­çš„ç”¨æ³•ï¼Œè„šæœ¬ä¹Ÿæ”¯æŒ retrun 0 è¿”å›ç»“æœå¹¶åœæ­¢è¿è¡Œã€‚ 123456789checkUUID() &#123; grep \"$arm64id\" \"$1\" if [ $? -ne 0 ]; then return 1; fi return 0;&#125;checkUUID \"$crashPath\" \"$dsymPath\"match=$? è·å–ç»“æœçš„æ–¹å¼ä¸º $?ï¼Œå…¶èƒ½å¤Ÿè¿”å›ç¯å¢ƒä¸­æœ€åä¸€ä¸ªæŒ‡ä»¤ç»“æœï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰æ‰§è¡Œçš„checkUUIDçš„ç»“æœã€‚ ä¼˜ç‚¹æ˜¯ç®€æ´æ˜äº†ï¼Œç¬¦åˆç¼–ç ä¹ æƒ¯ï¼Œç¼ºç‚¹æ˜¯è¿”å›å€¼åªèƒ½æ˜¯ 0-255 çš„æ•°å­—ï¼Œä¸èƒ½è¿”å›å…¶ä»–ç±»å‹çš„æ•°æ®ã€‚ è·å–æ‰“å°å€¼è¿˜æœ‰ä¸€ç§æ–¹æ³•å…¶å®å¹³æ—¶ä¸€ç›´åœ¨ä½¿ç”¨ï¼Œåªä¸è¿‡å¹¶ä¸äº†è§£å…¶è¿è¡Œæ–¹å¼ã€‚123456crashName=`basename $crashPath`print() &#123; echo \"Hello World\"&#125;text=$(print) è¿è¡Œç³»ç»Ÿé¢„è®¾çš„æ–¹æ³•æˆ–è€…è‡ªå®šä¹‰æ–¹æ³•ï¼Œå°†æ‰§è¡Œå‘½ä»¤ç”¨ $() çš„æ–¹å¼ä½¿ç”¨ï¼Œå°±å¯ä»¥è·å–è¯¥å‘½ä»¤ä¸­æ‰€æœ‰æ‰“å°çš„ä¿¡æ¯ï¼Œèµ‹å€¼åˆ°å˜é‡å°±å¯ä»¥æ‹¿åˆ°éœ€è¦çš„è¿”å›å€¼ã€‚ ä¼˜ç‚¹æ˜¯åŠŸèƒ½å…¨æ•ˆç‡é«˜ï¼Œä½¿ç”¨å­—ç¬¦ä¸²çš„æ–¹å¼å¯ä»¥ä¼ é€’å®šåˆ¶åŒ–ä¿¡æ¯ï¼Œç¼ºç‚¹æ˜¯ä¸å¯é¢„æœŸè¿”å›ç»“æœï¼Œéœ€è¦é€šè¿‡å­—ç¬¦ä¸²æŸ¥æ‰¾ç­‰å‘½ä»¤è¾…åŠ©ã€‚ å¾ªç¯è¾“å…¥åˆæ³•è·¯å¾„åœ¨æˆ‘çš„è®¾æƒ³ä¸­ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥åŒ¹é…çš„ dSYM æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœä¸åŒ¹é…ï¼Œåˆ™é‡æ–°è¾“å…¥ï¼Œç›´åˆ°åˆæ³•ã€‚ä¸ºäº†æ”¯æŒåµŒå¥—ï¼Œéœ€è¦å®šä¹‰å±€éƒ¨å˜é‡æ§åˆ¶å¾ªç¯ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹1234567891011121314dsymSuccess=falsewhile [ $dsymSuccess = false ]; do #è¦æ±‚è¾“å…¥dSYMæ–‡ä»¶è·¯å¾„ inputFile 'Please Input dSYM File' 'dSYM' dsymPath=$filePath #æ£€æŸ¥æ˜¯å¦åŒ¹é… checkUUID \"$crashPath\" \"$dsymPath\" match=$? if [ $match -eq 0 ]; then echo 'UUID not match!' else dsymSuccess=true fidone å¤„ç†å­—ç¬¦ä¸²è·å–åˆ° UUID æ‰€æœ‰è¾“å‡ºä¿¡æ¯åï¼Œéœ€è¦æˆªå–å‡ºå¯¹åº”å¹³å°çš„ä¿¡æ¯ï¼Œå¤„ç†è¿˜æ˜¯ä¸å¤ªç†Ÿæ‚‰ï¼Œç‰¹åœ°æ•´ç†å¦‚ä¸‹1234567891011121314151617#åŸå§‹ä¿¡æ¯UUID: 92E495AA-C2D4-3E9F-A759-A50AAEF446CD (armv7) /Volumes/.dSYM/Contents/Resources/DWARF/appUUID: 536527A8-0243-34DB-AE08-F1F64ACA4351 (arm64) /Volumes/.dSYM/Contents/Resources/DWARF/app#å»é™¤ä¸­é—´é—´éš”-uuid=$&#123;uuid//-/&#125;#ä»åå¾€å‰æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é… \\(arm64çš„ï¼Œå¹¶ä¸”éƒ½åˆ é™¤arm64id=$&#123;uuid% \\(arm64*&#125;#å¤„ç†åUUID: 92E495AAC2D43E9FA759A50AAEF446CD (armv7) /Volumes/.dSYM/Contents/Resources/DWARF/appUUID: 536527A8024334DBAE08F1F64ACA4351#ä»å‰å¾€åæ‰¾æœ€åä¸€ä¸ªUUID: ï¼Œå¹¶åˆ é™¤arm64id=$&#123;arm64id##*UUID: &#125;#å¤„ç†å 536527A8024334DBAE08F1F64ACA4351 æ€»ç»“çœ‹ä¼¼ç®€å•çš„è„šæœ¬ï¼Œä¹ŸèŠ±äº†ä¸€å¤©æ—¶é—´ç¼–å†™ï¼Œæ€»ä½“è¿˜æ˜¯ä¸å¤ªç†Ÿç»ƒï¼Œä»éœ€åŠªåŠ›è”ç³»ã€‚ è¿™æ¬¡ç‰¹åœ°å°è¯•äº†ä¸ä¸Šæ¬¡ä¸åŒçš„å‚æ•°è¾“å…¥æ–¹æ³•ï¼Œä½¿ç”¨æç¤ºè¾“å…¥çš„æ–¹å¼ï¼Œæœç„¶é‡åˆ°äº†æ–°çš„é—®é¢˜ã€‚å¥½åœ¨éƒ½æŸ¥èµ„æ–™è§£å†³äº†ï¼Œç»“æœè¿˜ç®—æ»¡æ„ã€‚ è„šæœ¬æˆ‘æäº¤åˆ°äº†Githubï¼Œæ¬¢è¿å¤§å®¶æŒ‡æ•™å…±åŒè¿›æ­¥ï¼ç»™ä¸ªå…³æ³¨æœ€å¥½å•¦ï½","categories":[{"name":"Shell","slug":"Shell","permalink":"https://vanchchen.github.io/categories/Shell/"}],"tags":[{"name":"æ•ˆç‡å·¥å…·","slug":"æ•ˆç‡å·¥å…·","permalink":"https://vanchchen.github.io/tags/æ•ˆç‡å·¥å…·/"}]},{"title":"AssociatedObjectå…³è”å¯¹è±¡åŸç†å®ç°","slug":"AssociatedObjectåŸç†å®ç°","date":"2018-09-29T09:55:21.000Z","updated":"2018-10-16T01:15:41.975Z","comments":true,"path":"p/f39e.html","link":"","permalink":"https://vanchchen.github.io/p/f39e.html","excerpt":"","text":"ä»‹ç»å…³è”å¯¹è±¡ï¼ˆAssociatedObjectï¼‰æ˜¯Objective-C 2.0è¿è¡Œæ—¶çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå…è®¸å¼€å‘è€…å¯¹å·²ç»å­˜åœ¨çš„ç±»åœ¨æ‰©å±•ä¸­æ·»åŠ è‡ªå®šä¹‰çš„å±æ€§ã€‚åœ¨å®é™…ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æ–¹å¼æ˜¯ç»™åˆ†ç±»ï¼ˆCategoryï¼‰æ·»åŠ æˆå‘˜å˜é‡ã€‚ ä¾‹å­1234567891011121314151617181920#import &lt;objc/runtime.h&gt;@interface NSObject (AssociatedObject)@property (nonatomic, strong) id property;@end@implementation NSObject (AssociatedObject)@dynamic property;- (id)property &#123; return objc_getAssociatedObject(self, _cmd);&#125;- (void)setProperty:(NSString *)property &#123; objc_setAssociatedObject(self, @selector(property), property, OBJC_ASSOCIATION_RETAIN_NONATOMIC);&#125;@end é€šè¿‡å®ç°ä»£ç å¯ä»¥ç¨å¾®åˆ†æä¸‹ï¼Œobjc_getAssociatedObject æ‹¿ç€ä¸å˜çš„æŒ‡é’ˆåœ°å€ï¼ˆç¤ºä¾‹ä¼ å…¥selectorä½œä¸ºå‚æ•°ï¼Œå®é™…æ˜¯void*ï¼‰ï¼Œä»å®ä¾‹ä¸­è·å–éœ€è¦çš„å¯¹è±¡ã€‚objc_setAssociatedObject æ ¹æ®ä¼ å…¥çš„å‚æ•°åè®®ï¼Œä¿å­˜æŒ‡å®šçš„å¯¹è±¡ã€‚ å‚æ•°åè®®1234567typedef OBJC_ENUM(uintptr_t, objc_AssociationPolicy) &#123; OBJC_ASSOCIATION_ASSIGN = 0, /**&lt; Specifies a weak reference to the associated object. */ OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, /**&lt; Specifies a strong reference to the associated object. The association is not made atomically. */ OBJC_ASSOCIATION_COPY_NONATOMIC = 3, /**&lt; Specifies that the associated object is copied. The association is not made atomically. */ OBJC_ASSOCIATION_RETAIN = 01401, /**&lt; Specifies a strong reference to the associated object. The association is made atomically. */ OBJC_ASSOCIATION_COPY = 01403 /**&lt; Specifies that the associated object is copied. The association is made atomically. */&#125;; å…¶å®è¿™äº”ä¸ªåè®®å°±æ˜¯æˆ‘ä»¬å¹³æ—¶å®šä¹‰å±æ€§æ—¶ä½¿ç”¨çš„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶è‹¹æœåœ¨æ³¨é‡Šä¸­è¯´ OBJC_ASSOCIATION_ASSIGN ç›¸å½“äºä¸€ä¸ª weak referenceï¼Œä½†å…¶å®ç­‰äº assign/unsafe_unretainedã€‚ å¯¹äºä¸weakçš„åŒºåˆ«ä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´å†…ï¼Œæµ…æ˜¾çš„åŒºåˆ«åœ¨äºå˜é‡é‡Šæ”¾åï¼Œweak ä¼šæŠŠå¼•ç”¨ç½®ç©ºï¼Œunsafe_unretainedä¼šä¿ç•™å†…å­˜åœ°å€ï¼Œä¸€æ—¦è·å–å¯èƒ½ä¼šé‡æŒ‡é’ˆé—ªé€€ã€‚ æ€»ç»“æˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœç±»è¦æ·»åŠ å˜é‡ï¼Œåªæœ‰åœ¨objc_allocateClassPairä¸objc_registerClassPairä¹‹é—´addIvarã€‚ç­‰ç±»æ³¨å†Œåï¼Œå˜é‡ç»“æ„å°±ä¸å…è®¸å†è¢«æ”¹å˜ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢ä¸¤ä¸ªç›¸åŒç±»çš„å®ä¾‹æ‹¥æœ‰ä¸åŒå˜é‡å¯¼è‡´è¿è¡Œå›°æƒ‘ã€‚ é‚£ä¹ˆåœ¨runtimeæ—¶ç»™å®ä¾‹æ·»åŠ å˜é‡ï¼Œåˆä¸æ”¹å˜ç±»å†…éƒ¨å˜é‡ç»“æ„ï¼Œå…³è”å¯¹è±¡å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„åšæ³•ã€‚ å…³è”å¯¹è±¡çš„å®ç°å¤–éƒ¨æ–¹æ³•12345678//Sets an associated value for a given object using a given key and association policy.void objc_setAssociatedObject(id object, const void * key, id value, objc_AssociationPolicy policy);//Returns the value associated with a given object for a given key.id objc_getAssociatedObject(id object, const void * key);//Removes all associations for a given object.void objc_removeAssociatedObjects(id object); ç›¸æ¯”åˆšåˆšä¾‹å­ä¸­çš„ç”¨æ³•ï¼Œå¤šäº†ä¸€ä¸ªobjc_removeAssociatedObjectsï¼Œé‚£ä¹ˆå¯ä¸å¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•æ¥åˆ é™¤ä¸ç”¨çš„å…³è”å¯¹è±¡å‘¢ï¼Ÿ è‹¹æœçš„æ–‡æ¡£ä¸­è§£é‡Šè¯´è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨æ¥è¿˜åŸå¯¹è±¡åˆ°ç±»åˆå§‹çš„çŠ¶æ€ï¼Œä¼šç§»é™¤æ‰€æœ‰çš„å…³è”ï¼ŒåŒ…æ‹¬å…¶ä»–æ¨¡å—æ·»åŠ çš„ï¼Œå› æ­¤åº”è¯¥ç”¨ objc_setAssociatedObject(..,nil,..) çš„æ–¹å¼å»å¸è½½ã€‚ Setterå®ç°objc_setAssociatedObjectå®é™…è°ƒç”¨çš„æ˜¯_object_set_associative_reference 1234567891011121314151617181920212223242526272829303132333435363738394041424344void _object_set_associative_reference(id object, void *key, id value, uintptr_t policy) &#123; // retain the new value (if any) outside the lock. ObjcAssociation old_association(0, nil); id new_value = value ? acquireValue(value, policy) : nil; &#123; AssociationsManager manager; AssociationsHashMap &amp;associations(manager.associations()); disguised_ptr_t disguised_object = DISGUISE(object); if (new_value) &#123; // break any existing association. AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) &#123; // secondary table exists ObjectAssociationMap *refs = i-&gt;second; ObjectAssociationMap::iterator j = refs-&gt;find(key); if (j != refs-&gt;end()) &#123; old_association = j-&gt;second; j-&gt;second = ObjcAssociation(policy, new_value); &#125; else &#123; (*refs)[key] = ObjcAssociation(policy, new_value); &#125; &#125; else &#123; // create the new association (first time). ObjectAssociationMap *refs = new ObjectAssociationMap; associations[disguised_object] = refs; (*refs)[key] = ObjcAssociation(policy, new_value); object-&gt;setHasAssociatedObjects(); &#125; &#125; else &#123; // setting the association to nil breaks the association. AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) &#123; ObjectAssociationMap *refs = i-&gt;second; ObjectAssociationMap::iterator j = refs-&gt;find(key); if (j != refs-&gt;end()) &#123; old_association = j-&gt;second; refs-&gt;erase(j); &#125; &#125; &#125; &#125; // release the old value (outside of the lock). if (old_association.hasValue()) ReleaseValue()(old_association);&#125; å†…å­˜ç®¡ç†12345678910111213141516171819202122static id acquireValue(id value, uintptr_t policy) &#123; switch (policy &amp; 0xFF) &#123; case OBJC_ASSOCIATION_SETTER_RETAIN: return objc_retain(value); case OBJC_ASSOCIATION_SETTER_COPY: return ((id(*)(id, SEL))objc_msgSend)(value, SEL_copy); &#125; return value;&#125;static void releaseValue(id value, uintptr_t policy) &#123; if (policy &amp; OBJC_ASSOCIATION_SETTER_RETAIN) &#123; return objc_release(value); &#125;&#125;ObjcAssociation old_association(0, nil);id new_value = value ? acquireValue(value, policy) : nil;&#123; old_association = ...&#125;if (old_association.hasValue()) ReleaseValue()(old_association); æˆ‘ä»¬æ‘˜å‡ºä¸å¯¹è±¡å†…å­˜ç›¸å…³çš„ä»£ç ä»”ç»†åˆ†æä¸‹ï¼Œé¦–å…ˆæŠŠæ–°ä¼ å…¥çš„å¯¹è±¡ï¼Œæ ¹æ®åè®®è¿›è¡Œretain/copyï¼Œåœ¨èµ‹å€¼çš„è¿‡ç¨‹ä¸­è·å–æ—§å€¼ï¼Œåœ¨æ–¹æ³•ç»“æŸå‰releaseã€‚ èµ‹å€¼1234567891011121314151617181920212223242526AssociationsManager manager;AssociationsHashMap &amp;associations(manager.associations());disguised_ptr_t disguised_object = DISGUISE(object);if (new_value) &#123; //éœ€è¦èµ‹å€¼ AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) &#123; //æ‰¾åˆ°äº†è¿™ä¸ªå¯¹è±¡çš„å…³è”è¡¨ ObjectAssociationMap *refs = i-&gt;second; ObjectAssociationMap::iterator j = refs-&gt;find(key); if (j != refs-&gt;end()) &#123; //æ‰¾åˆ°äº†è¿™ä¸ªkeyçš„å…³è”å¯¹è±¡ old_association = j-&gt;second; j-&gt;second = ObjcAssociation(policy, new_value); &#125; else &#123; //æ²¡æ‰¾åˆ°ï¼Œæ–°å¢ä¸€ä¸ªå…³è” (*refs)[key] = ObjcAssociation(policy, new_value); &#125; &#125; else &#123; //æ²¡æ‰¾åˆ°ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å…³è”è¡¨ ObjectAssociationMap *refs = new ObjectAssociationMap; associations[disguised_object] = refs; (*refs)[key] = ObjcAssociation(policy, new_value); object-&gt;setHasAssociatedObjects(); &#125;&#125; å…ˆäº†è§£ä¸€ä¸‹AssociationsManagerä¸AssociationsHashMap12345678910111213class AssociationsManager &#123; static AssociationsHashMap *_map;public: AssociationsHashMap &amp;associations() &#123; if (_map == NULL) _map = new AssociationsHashMap(); return *_map; &#125;&#125;;class AssociationsHashMap : public unordered_map&lt;disguised_ptr_t, ObjectAssociationMap *, DisguisedPointerHash, DisguisedPointerEqual, AssociationsHashMapAllocator&gt;;class ObjectAssociationMap : public std::map&lt;void *, ObjcAssociation, ObjectPointerLess, ObjectAssociationMapAllocator&gt;ï¼› AssociationsManageré€šè¿‡ä¸€ä¸ªä»¥æŒ‡é’ˆåœ°å€ä¸ºä¸»é”®ï¼Œå€¼ä¸ºå…³è”è¡¨çš„å“ˆå¸Œè¡¨ï¼Œæ¥ç®¡ç†åº”ç”¨å†…æ‰€æœ‰çš„å…³è”å¯¹è±¡ã€‚ é¦–å…ˆä»¥å¯¹è±¡çš„æŒ‡é’ˆåœ°å€å»å¯»æ‰¾å…³è”è¡¨ï¼Œå†é€šè¿‡æŒ‡å®šçš„é”®å€¼æŸ¥æ‰¾å…³è”å…³ç³»ï¼Œä»è€Œè·å–å…³è”å¯¹è±¡ã€‚ åˆ é™¤123456789AssociationsHashMap::iterator i = associations.find(disguised_object);if (i != associations.end()) &#123; ObjectAssociationMap *refs = i-&gt;second; ObjectAssociationMap::iterator j = refs-&gt;find(key); if (j != refs-&gt;end()) &#123; old_association = j-&gt;second; refs-&gt;erase(j); &#125;&#125; å’Œä¿®æ”¹æ–¹æ³•ç±»ä¼¼ï¼Œæ‰¾åˆ°å…³è”å…³ç³»åï¼Œæ‰§è¡Œå“ˆå¸Œè¡¨çš„eraseæ–¹æ³•åˆ é™¤ã€‚ Getterå®ç°objc_getAssociatedObjectå®é™…è°ƒç”¨çš„æ˜¯_object_get_associative_reference 1234567891011121314151617181920212223242526id _object_get_associative_reference(id object, void *key) &#123; id value = nil; uintptr_t policy = OBJC_ASSOCIATION_ASSIGN; &#123; AssociationsManager manager; AssociationsHashMap &amp;associations(manager.associations()); disguised_ptr_t disguised_object = DISGUISE(object); AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) &#123; ObjectAssociationMap *refs = i-&gt;second; ObjectAssociationMap::iterator j = refs-&gt;find(key); if (j != refs-&gt;end()) &#123; ObjcAssociation &amp;entry = j-&gt;second; value = entry.value(); policy = entry.policy(); if (policy &amp; OBJC_ASSOCIATION_GETTER_RETAIN) &#123; objc_retain(value); &#125; &#125; &#125; &#125; if (value &amp;&amp; (policy &amp; OBJC_ASSOCIATION_GETTER_AUTORELEASE)) &#123; objc_autorelease(value); &#125; return value;&#125; æŸ¥æ‰¾å“ˆå¸Œè¡¨çš„æ–¹æ³•å’ŒSetterä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äºå¦‚æœç­–ç•¥ä¸­éœ€è¦retainå’Œautoreleaseçš„è¯ï¼Œéƒ½éœ€è¦å¤„ç†ã€‚é‚£ä¹ˆæ˜¯æ€ä¹ˆçº¦å®šè¿™äº›ç­–ç•¥å‘¢ï¼Ÿ 12345678910111213141516enum &#123; OBJC_ASSOCIATION_SETTER_ASSIGN = 0, OBJC_ASSOCIATION_SETTER_RETAIN = 1, OBJC_ASSOCIATION_SETTER_COPY = 3, // NOTE: both bits are set, so we can simply test 1 bit in releaseValue below. OBJC_ASSOCIATION_GETTER_READ = (0 &lt;&lt; 8), OBJC_ASSOCIATION_GETTER_RETAIN = (1 &lt;&lt; 8), OBJC_ASSOCIATION_GETTER_AUTORELEASE = (2 &lt;&lt; 8)&#125;; typedef OBJC_ENUM(uintptr_t, objc_AssociationPolicy) &#123; OBJC_ASSOCIATION_ASSIGN = 0, OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, OBJC_ASSOCIATION_COPY_NONATOMIC = 3, OBJC_ASSOCIATION_RETAIN = 01401, OBJC_ASSOCIATION_COPY = 01403&#125;; OBJC_ASSOCIATION_RETAIN = 01401ï¼Œå…¶ä¸­01401å¼€å¤´æ˜¯0ï¼Œæ‰€ä»¥æ˜¯å…«è¿›åˆ¶æ•°å­—ï¼Œç¿»è¯‘ä¸ºäºŒè¿›åˆ¶å°±æ˜¯0000 0011 0000 0001ï¼Œå–ä½åˆ¤æ–­å°±æ˜¯OBJC_ASSOCIATION_SETTER_RETAIN OBJC_ASSOCIATION_GETTER_RETAIN OBJC_ASSOCIATION_GETTER_AUTORELEASEã€‚ åœ¨ä¿å­˜çš„æ—¶å€™ï¼Œéœ€è¦retainï¼Œåœ¨è·å–çš„æ—¶å€™ï¼Œéœ€è¦å…ˆretainå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå†æ‰§è¡Œautoreleaseç­‰å¾…é‡Šæ”¾ï¼Œä»è€Œå®ç°åŸå­æ€§ã€‚ Removeå®ç°objc_removeAssociatedObjectsä¼šåˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜åœ¨å…³è”ï¼Œç„¶åå†æ‰§è¡Œ_object_set_associative_reference12345678910111213141516171819202122void _object_remove_assocations(id object) &#123; vector&lt; ObjcAssociation,ObjcAllocator&lt;ObjcAssociation&gt; &gt; elements; &#123; AssociationsManager manager; AssociationsHashMap &amp;associations(manager.associations()); if (associations.size() == 0) return; disguised_ptr_t disguised_object = DISGUISE(object); AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) &#123; // copy all of the associations that need to be removed. ObjectAssociationMap *refs = i-&gt;second; for (ObjectAssociationMap::iterator j = refs-&gt;begin(), end = refs-&gt;end(); j != end; ++j) &#123; elements.push_back(j-&gt;second); &#125; // remove the secondary table. delete refs; associations.erase(i); &#125; &#125; // the calls to releaseValue() happen outside of the lock. for_each(elements.begin(), elements.end(), ReleaseValue());&#125; å®ç°æ–¹å¼ä¹Ÿå¯ä»¥çœ‹å‡ºä¸ºä»€ä¹ˆåœ¨ä»‹ç»é‡Œä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºä¼šéå†æ‰€æœ‰çš„å…³è”å¯¹è±¡ï¼Œå¹¶ä¸”å…¨éƒ¨é‡Šæ”¾ï¼Œå¯èƒ½ä¼šé€ æˆåˆ«çš„æ¨¡å—åŠŸèƒ½ç¼ºé™·ã€‚ åˆ¤æ–­å…³è”å¯¹è±¡æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯åˆ¤æ–­å¯¹è±¡æ˜¯å¦æœ‰å…³è”å¯¹è±¡çš„å®ç°ã€‚ 123456inline bool objc_object::hasAssociatedObjects()&#123; if (isTaggedPointer()) return true; if (isa.nonpointer) return isa.has_assoc; return true;&#125; 1234567891011121314inline void objc_object::setHasAssociatedObjects()&#123; if (isTaggedPointer()) return; retry: isa_t oldisa = LoadExclusive(&amp;isa.bits); isa_t newisa = oldisa; if (!newisa.nonpointer || newisa.has_assoc) &#123; ClearExclusive(&amp;isa.bits); return; &#125; newisa.has_assoc = true; if (!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits)) goto retry;&#125; é»˜è®¤è¿”å›çš„ç»“æœéƒ½æ˜¯trueï¼Œåªæœ‰åœ¨64ä½ç³»ç»Ÿä¸‹ï¼Œæ‰ä¿å­˜ä¸€ä¸ªæ ‡è®°ä½ã€‚è¿™ä¹ˆå¤„ç†æˆ‘æ¨æµ‹æ˜¯ä¸ºäº†åŠ å¿«é‡Šæ”¾å‘¨æœŸé€Ÿåº¦ï¼Œåœ¨ææ„å¯¹è±¡æ—¶ï¼Œä¼šæ ¹æ®è¿™ä¸ªæ–¹æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦é‡Šæ”¾å…³è”å¯¹è±¡ã€‚è¯•æƒ³å¦‚æœæ¯æ¬¡éƒ½æŸ¥è¯¢å“ˆå¸Œè¡¨ï¼Œæ‰§è¡Œæ•ˆç‡å¿…å®šä¼šé™ä½ï¼Œä¸å¦‚éƒ½å…ˆé€šè¿‡ï¼Œä¹‹åå†åšå¤„ç†ã€‚ å…³äºnonpointerä¸åœ¨æœ¬æ–‡ä»‹ç»èŒƒå›´å†…ï¼Œç®€å•æè¿°ä¸ºåœ¨64ä½ç³»ç»Ÿä¸‹ï¼ŒæŒ‡é’ˆåœ°å€ä¿å­˜ä¸ä»…ä»…ä¸ºå†…å­˜åœ°å€ï¼Œè¿˜å­˜æœ‰å…¶ä»–æ ‡è®°ä¿¡æ¯ï¼ŒåŒ…æ‹¬æœ¬æ–‡æ¶‰åŠçš„has_assocã€‚ taggedPointeræ˜¯ä¸€ç§ä¼˜åŒ–ç­–ç•¥ï¼ŒæŠŠç®€å•çš„æ•°å­—æˆ–å­—ç¬¦ä¸²ä¿¡æ¯ç›´æ¥ä¿å­˜åœ¨æŒ‡é’ˆåœ°å€ä¸­ï¼Œä»è€Œä¸ç”³è¯·é¢å¤–å†…å­˜åŠ å¿«è¿è¡Œæ•ˆç‡ã€‚ æ€»ç»“å…³è”å¯¹è±¡çš„å®ç°ä¸å¤æ‚ï¼Œä¿å­˜çš„æ–¹å¼ä¸ºä¸€ä¸ªå…¨å±€çš„å“ˆå¸Œè¡¨ï¼Œå­˜å–éƒ½é€šè¿‡æŸ¥è¯¢è¡¨æ‰¾åˆ°å…³è”æ¥æ‰§è¡Œã€‚å“ˆå¸Œè¡¨çš„ç‰¹ç‚¹å°±æ˜¯ç‰ºç‰²ç©ºé—´æ¢å–æ—¶é—´ï¼Œæ‰€ä»¥æ‰§è¡Œé€Ÿåº¦ä¹Ÿå¯ä»¥ä¿è¯ã€‚ é—®ç­”å…³è”å¯¹è±¡æœ‰ä»€ä¹ˆåº”ç”¨ï¼Ÿå…³è”å¯¹è±¡å¯ä»¥åœ¨è¿è¡Œæ—¶ç»™æŒ‡å®šå¯¹è±¡ç»‘å®šä¸€ä¸ªæœ‰ç”Ÿå‘½å‘¨æœŸçš„å˜é‡ã€‚ 1.ç”±äºä¸æ”¹å˜åŸç±»çš„å®ç°ï¼Œæ‰€ä»¥å¯ä»¥ç»™åŸç”Ÿç±»æˆ–è€…æ˜¯æ‰“åŒ…çš„åº“è¿›è¡Œæ‰©å±•ï¼Œä¸€èˆ¬é…åˆCategoryå®ç°å®Œæ•´çš„åŠŸèƒ½ã€‚ 2.ObjCç±»å®šä¹‰çš„å˜é‡ï¼Œç”±äºruntimeçš„ç‰¹æ€§ï¼Œéƒ½ä¼šæš´éœ²åˆ°å¤–éƒ¨ï¼Œä½¿ç”¨å…³è”å¯¹è±¡å¯ä»¥éšè—å…³é”®å˜é‡ï¼Œä¿è¯å®‰å…¨ã€‚ 3.å¯ä»¥ç”¨äºKVOï¼Œä½¿ç”¨å…³è”å¯¹è±¡ä½œä¸ºè§‚å¯Ÿè€…ï¼Œå¯ä»¥é¿å…è§‚å¯Ÿè‡ªèº«å¯¼è‡´å¾ªç¯ã€‚ ç³»ç»Ÿå¦‚ä½•ç®¡ç†å…³è”å¯¹è±¡ï¼Ÿç³»ç»Ÿé€šè¿‡ç®¡ç†ä¸€ä¸ªå…¨å±€å“ˆå¸Œè¡¨ï¼Œé€šè¿‡å¯¹è±¡æŒ‡é’ˆåœ°å€å’Œä¼ é€’çš„å›ºå®šå‚æ•°åœ°å€æ¥è·å–å…³è”å¯¹è±¡ã€‚æ ¹æ®setterä¼ å…¥çš„å‚æ•°åè®®ï¼Œæ¥ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚ å…¶è¢«é‡Šæ”¾çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨å°†å…¶æŒ‡é’ˆç½®ç©ºä¹ˆï¼Ÿå½“å¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œå¦‚æœè®¾ç½®çš„åè®®æ˜¯OBJC_ASSOCIATION_ASSIGNï¼Œé‚£ä¹ˆä»–çš„å…³è”å¯¹è±¡ä¸ä¼šå‡å°‘å¼•ç”¨è®¡æ•°ï¼Œå…¶ä»–çš„åè®®éƒ½ä¼šå‡å°‘ä»è€Œé‡Šæ”¾å…³è”å¯¹è±¡ã€‚ unsafe_unretainä¸€èˆ¬è®¤ä¸ºå¤–éƒ¨æœ‰å¯¹è±¡æ§åˆ¶ï¼Œæ‰€ä»¥å¯¹è±¡ä¸ç”¨å¤„ç†ï¼Œå› æ­¤ä¸ç®¡ä»€ä¹ˆåè®®ï¼Œå¯¹è±¡é‡Šæ”¾æ—¶éƒ½æ— éœ€æ‰‹åŠ¨è®²å…³è”å¯¹è±¡ç½®ç©ºã€‚","categories":[{"name":"iOS","slug":"iOS","permalink":"https://vanchchen.github.io/categories/iOS/"}],"tags":[{"name":"åŸç†åˆ†æ","slug":"åŸç†åˆ†æ","permalink":"https://vanchchen.github.io/tags/åŸç†åˆ†æ/"}]},{"title":"åˆè¯•Shellè„šæœ¬","slug":"åˆè¯•Shellè„šæœ¬","date":"2018-09-20T08:45:12.000Z","updated":"2018-12-07T06:16:35.757Z","comments":true,"path":"p/3f22.html","link":"","permalink":"https://vanchchen.github.io/p/3f22.html","excerpt":"","text":"èƒŒæ™¯ä¸´ä¸Šçº¿å‰æµ‹è¯•æ¯”è¾ƒåŠªåŠ›ï¼Œé‡åˆ°é—ªé€€æˆ–è€…å…¶ä»–é—®é¢˜ï¼Œä¼šæŠŠæ—¥å¿—åŒ…æ‰“ç»™æˆ‘ï¼Œç”±äºappå†…å­˜é™åˆ¶ï¼Œç›®å‰æ¯æ¬¡æ‰“åŒ…éƒ½æ˜¯1må¤§å°ï¼Œæ‰€ä»¥æœ‰æ—¶æŸ¥æ‰¾é—®é¢˜çš„ä¸Šä¸‹æ–‡æ¯”è¾ƒåƒåŠ›ã€‚åŒæ—¶ç”±äºæ—¥å¿—æ¯”è¾ƒå¤šï¼Œæ ¹æ®å…³é”®è¯è¿‡æ»¤çš„éœ€æ±‚è¶Šæ¥è¶Šé‡è¦ã€‚ äºæ˜¯å†³å®šå­¦å†™è„šæœ¬å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œæ ¹æ®æˆ‘çš„è¦æ±‚ï¼Œå·¥ä½œæµç¨‹åº”è¯¥æ˜¯ä¼ å…¥å‹ç¼©åŒ…ï¼Œæ ¹æ®åç¼€åè§£å‹ï¼Œæ ¹æ®æ—¥æœŸæ’åºååˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ï¼ŒæŒ‰éœ€è¿‡æ»¤å…³é”®è¯ã€‚ å…ˆä¸Šä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104#!/usr/bin/env bash# Created By Vanch at 2018/9/20printHelp() &#123; echo \"Uncompess log files from inputed zip\" echo \"Then Merge these logs to one file\" echo \"Supported file types: zip tar tar.gz tar.bz2\" echo echo \"Use -s for filtering socket result to socket.log\" echo echo \"Have fun!\"&#125;#å¦‚æœæ²¡è¾“å…¥å‚æ•°ï¼Œå°±æ‰“å°å¸®åŠ©ä¿¡æ¯if [ $# -eq 0 ]; then printHelp exit 0fi#æŠŠé•¿é€‰é¡¹è½¬åˆ°çŸ­é€‰é¡¹for arg in \"$@\"; do shift case \"$arg\" in \"--help\") set -- \"$@\" \"-h\" ;; \"--version\") set -- \"$@\" \"-v\" ;; \"--list\") set -- \"$@\" \"-l\" ;; *) set -- \"$@\" \"$arg\" esacdone#è·å–çŸ­é€‰é¡¹OPTIND=1printS=false;while getopts \"dmksahvl\" opt; do case $opt in h) #è¾“å…¥ä¸ºhelpï¼Œå°±æ‰“å°å¸®åŠ©ä¿¡æ¯ printHelp exit 0;; l) #æ”¯æŒå•ç‹¬è·å–æ”¯æŒæ–‡ä»¶åç¼€åˆ—è¡¨ echo \"Supported file types: zip tar tar.gz tar.bz2\" exit 0;; v) #æ”¯æŒæŸ¥æ‰¾ç‰ˆæœ¬å· echo \"1.0.0\" exit 0;; s) #è¿‡æ»¤Socket printS=true;; esacdone#è·å¾—å‹ç¼©åŒ…åœ°å€file=$&#123;!#&#125;#å¦‚æœä¸å­˜åœ¨å°±é€€å‡ºif [ ! -f \"$file\" ]; then echo \"File not exist!\" exit 0;fi #è·å–å‹ç¼©åç¼€fileName=`basename $file`suffix=$&#123;fileName#*.&#125;#åˆ¤æ–­æ–‡ä»¶ç±»å‹support=('tar','tar.gz','tar.bz2','zip')if [ -z `echo \"$&#123;support[@]&#125;\" | grep -w \"$suffix\"` ] ; then echo \"File type not support!\" exit 0; fi#æ‹¼æ¥æ–‡ä»¶å¤¹åœ°å€fileDir=$(dirname $file)/$&#123;fileName%%.*&#125;if [ -d $fileDir ]; then rm -rf $fileDirfimkdir $fileDircd $fileDir#è§£å‹æ–‡ä»¶case $suffix in 'tar') eval \"tar xvf $file &gt; /dev/null 2&gt;&amp;1\";; 'tar.gz') eval \"tar zxvf $file &gt; /dev/null 2&gt;&amp;1\";; 'tar.bz2') eval \"tar jxvf $file &gt; /dev/null 2&gt;&amp;1\";; 'zip') eval \"unzip -o $file &gt; /dev/null 2&gt;&amp;1\";;esacecho 'Uncompass Success!'#è·å–æ—¥å¿—åˆ—è¡¨ï¼ŒæŒ‰æ’åºåˆå¹¶åˆ°ä¸€ä¸ªæ—¥å¿—mergeFile=./merge.loglogCount=0#æœç´¢comå¼€å¤´çš„æ—¥å¿—ï¼ŒæŒ‰æ—¥æœŸæ’åºï¼Œç”¨ï¼Ÿä¸´æ—¶ä»£æ›¿ç©ºæ ¼for logName in `ls | grep 'com' | sort -n | tr \" \" \"?\"`; do logName=$&#123;logName//'?'/' '&#125; cat ./\"$logName\" &gt;&gt; $mergeFile ((logCount++))done#ä¸å­˜åœ¨æ—¥å¿—å°±æ‰“æ–­if [ $logCount -eq 0 ]; then echo \"Log not exist!\" exit fiecho 'Merge Success!'#æ‰“å°socketif [ $printS = true ]; then cat $mergeFile | grep -i 'socket' &gt;&gt; ./socket.log echo 'Filter socket'fi é‡åˆ°çš„é—®é¢˜æŸ¥è¯¢äº†å¾ˆå¤šèµ„æ–™åå†™å®Œäº†è¿™ä¸ªè„šæœ¬ï¼ŒåŸºæœ¬æ»¡è¶³äº†æˆ‘çš„éœ€æ±‚ï¼Œä¸‹é¢æ€»ç»“ä¸€ä¸‹æ€ä¹ˆè§£å†³é‡åˆ°çš„é—®é¢˜ã€‚ ä½¿ç”¨ç¯å¢ƒä¸€å¼€å§‹å­¦è„šæœ¬æ—¶ï¼Œä¹¦ä¸Šéƒ½è¯´#! /bin/bashï¼Œä½†æ˜¯çœ‹é¡¹ç›®ä¸­å¤§ç¥å†™çš„è„šæœ¬ï¼Œéƒ½æ˜¯#!/usr/bin/env bashï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ è„šæœ¬ç”¨envå¯åŠ¨çš„åŸå› ï¼Œæ˜¯å› ä¸ºè„šæœ¬è§£é‡Šå™¨åœ¨linuxä¸­å¯èƒ½è¢«å®‰è£…äºä¸åŒçš„ç›®å½•ï¼Œenvå¯ä»¥åœ¨ç³»ç»Ÿçš„PATHç›®å½•ä¸­æŸ¥æ‰¾ã€‚åŒæ—¶ï¼Œenvè¿˜è§„å®šä¸€äº›ç³»ç»Ÿç¯å¢ƒå˜é‡ã€‚ ä¸åŒçš„ç³»ç»Ÿï¼Œè§£é‡Šå™¨çš„è·¯å¾„å¯èƒ½ä¹Ÿä¸åŒï¼Œæ‰€ä»¥ä½¿ç”¨ç»å¯¹è·¯å¾„æ˜¯æ¯”è¾ƒå±é™©çš„æ–¹å¼ã€‚é€šè¿‡ä»ç¯å¢ƒä¸­æŸ¥æ‰¾ï¼Œå¯ä»¥ä¿è¯å…¼å®¹æ€§ã€‚ è·å–é€‰é¡¹å¼€å‘ä¸­æˆ‘ä»¬ç»å¸¸ç”¨åˆ°å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤ä¸€èˆ¬éƒ½é…åˆé€‰é¡¹è¾¾åˆ°ä¸åŒçš„æ•ˆæœï¼Œæ¯”å¦‚æœ€å¸¸ç”¨çš„ls -alï¼Œé€šè¿‡-aæ¥æŒ‡å®šç»“æœåŒ…å«éšè—æ–‡ä»¶ï¼Œé€šè¿‡-lè¾¾åˆ°åˆ—è¡¨æ˜¾ç¤ºçš„æ•ˆæœã€‚ é€šè¿‡æŸ¥è¯¢ç›¸å…³èµ„æ–™ï¼Œæˆ‘å‘ç°è·å–é€‰é¡¹æ™®éçš„åšæ³•æ˜¯ä½¿ç”¨getoptså‘½ä»¤ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•åªèƒ½è·å–-hè¿™ç§çŸ­é€‰é¡¹ï¼Œå¯¹äº--helpé•¿é€‰é¡¹å°±ä¸è¡Œã€‚ ç¬¬ä¸€ç§åŠæ³•æ˜¯æ¢æˆgetoptå‘½ä»¤ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ¯ä¸ªç³»ç»Ÿéƒ½æ”¯æŒè¿™ä¸ªå‘½ä»¤ã€‚å…·ä½“ä½¿ç”¨å’Œgetoptsç±»ä¼¼ï¼Œæ¯”å¦‚getopt -o ab:c -l a-long:b-long ç¬¬äºŒç§æ–¹æ³•æ˜¯æŠŠæ”¯æŒçš„é•¿å‘½ä»¤è½¬æˆçŸ­å‘½ä»¤ï¼Œæˆ‘ä½¿ç”¨çš„å°±æ˜¯è¿™ç§æ–¹å¼ï¼Œç›¸å¯¹æ¥è¯´æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä¸”caseå†™çš„æ¯”è¾ƒç»Ÿä¸€ã€‚é€šè¿‡shiftå–å‡ºå‚æ•°ï¼Œå†set --çš„æ–¹å¼é‡å†™ï¼Œæœ€åOPTIND=1æŠŠæŒ‡é’ˆæŒ‡å›ç¬¬ä¸€ä¸ªé€‰é¡¹ã€‚ æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶åç¼€æŒ‰éœ€æ±‚éœ€è¦åˆ¤æ–­åç¼€åæ¥è§£å‹ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆ¤æ–­tar.gzä¹‹ç±»çš„é—®é¢˜ã€‚åŒæ—¶ï¼Œå¦‚æœä¼ å…¥çš„æ–‡ä»¶ç›®å½•æ˜¯éšè—ç›®å½•ï¼Œä¹Ÿä¼šé€ æˆä¸€å®šçš„éšœç¢ã€‚æˆ‘ä»¬å‡è®¾ä¼ å…¥æ–‡ä»¶è·¯å¾„ä¸º/a/.b/c.tar.gzã€‚ ${param#pattern} ä»paramå‰é¢åˆ é™¤patternçš„æœ€å°åŒ¹é…${param##pattern} ä»paramå‰é¢åˆ é™¤patternçš„æœ€å¤§åŒ¹é…${param%pattern} ä»paramåé¢åˆ é™¤patternçš„æœ€å°åŒ¹é…${param%%pattern} ä»paramåé¢åˆ é™¤patternçš„æœ€å¤§åŒ¹é… å¦‚æœæŒ‰ç…§${fileName##*.}æ¥æˆªå–ï¼Œé‚£ä¹ˆåªèƒ½æ‹¿åˆ°gzã€‚å¦‚æœæŒ‰ç…§${fileName#*.}æ¥æˆªå–ï¼Œæ‹¿åˆ°çš„åˆæ˜¯b/c.tar.gzã€‚é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ å¥½åœ¨æœ‰dirnameå¯ä»¥ç›´æ¥è·å–æ–‡ä»¶è·¯å¾„ï¼Œbasenameæ‹¿åˆ°æ–‡ä»¶åï¼Œå•ç‹¬å¯¹æ–‡ä»¶åè¿›è¡Œ${fileName#*.}å°±å¯ä»¥æ‹¿åˆ°tar.gzäº†ã€‚ å»é™¤ä¸å¿…è¦çš„æ‰“å°æ‰§è¡Œè§£å‹å‘½ä»¤æ—¶ï¼Œä¼šæ‰“å°è§£å‹æ­¥éª¤ï¼Œä¸€èˆ¬æ¥è¯´ä¹Ÿéœ€è¦æ˜¾ç¤ºï¼Œé‚£å¦‚æœæˆ‘ä»¬ä¸æƒ³è¦æ‰“å°å‡ºæ¥å‘¢ï¼Ÿæœ‰ä¸€ä¸ªåŠæ³•å°±æ˜¯åœ¨å‘½ä»¤ä¹‹ååŠ ä¸Š&gt; /dev/null 2&gt;&amp;1 /dev/null ï¼šä»£è¡¨ç©ºè®¾å¤‡æ–‡ä»¶ > ï¼šä»£è¡¨é‡å®šå‘åˆ°å“ªé‡Œï¼Œä¾‹å¦‚ï¼šecho â€œ123â€ &gt; /home/123.txt 1 ï¼šè¡¨ç¤ºstdoutæ ‡å‡†è¾“å‡ºï¼Œç³»ç»Ÿé»˜è®¤å€¼æ˜¯1ï¼Œæ‰€ä»¥â€&gt;/dev/nullâ€ç­‰åŒäºâ€1&gt;/dev/nullâ€ 2 ï¼šè¡¨ç¤ºstderræ ‡å‡†é”™è¯¯ &amp; ï¼šè¡¨ç¤ºç­‰åŒäºçš„æ„æ€ï¼Œ2&gt;&amp;1ï¼Œè¡¨ç¤º2çš„è¾“å‡ºé‡å®šå‘ç­‰åŒäº1 æ‰€ä»¥å«ä¹‰å°±æ˜¯æŠŠå‘½ä»¤è¾“å‡ºç»“æœå’Œé”™è¯¯è¾“å‡ºé‡å®šå‘ï¼Œä½¿å¾—è¾“å‡ºä¸åœ¨å½“å‰å±å¹•æ˜¾ç¤ºï¼Œç”±äºnullæ¯”è¾ƒç‰¹æ®Šï¼Œå‘è¿™ä¸ªæ–‡ä»¶è¾“å…¥ç­‰äºè¿›å…¥é»‘æ´ï¼Œå› æ­¤è¾¾åˆ°æ•ˆæœã€‚ æ•°ç»„ä¸ç©ºæ ¼ä½¿ç”¨ls | grepçš„æ–¹å¼æ¥è¿‡æ»¤ç»“æœè·å–æ–‡ä»¶åæ•°ç»„çš„æœ€å¤§é—®é¢˜æ˜¯ï¼Œå¦‚æœæ–‡ä»¶ååŒ…å«ç©ºæ ¼ï¼Œé‚£ä¹ˆå‰åä¼šè¢«åˆ†å‰²æˆä¸¤ä¸ªå•å…ƒï¼Œå¯¼è‡´å¤„ç†æ¯”è¾ƒå›°éš¾ã€‚ æ¯”è¾ƒè®¨å·§çš„æ–¹æ³•æ˜¯ä¸´æ—¶ç”¨ç‰¹æ®Šç¬¦å·ä»£æ›¿ç©ºæ ¼ï¼Œåœ¨ä½¿ç”¨æ—¶å†æ›¿æ¢å›æ¥ã€‚è¿™ç§æ–¹æ³•ä¸ä¼šæ”¹å˜æ–‡ä»¶åï¼Œä¹Ÿä¸ç”¨å†™å¤æ‚çš„æ•°ç»„åˆå¹¶ï¼Œæ¯”è¾ƒç¬¦åˆç®€å•çš„è®¾è®¡ã€‚ 12tr \" \" \"?\"$&#123;logName//'?'/' '&#125; æ€»ç»“é€šè¿‡è¿™æ¬¡ç®€å•çš„è„šæœ¬å®éªŒï¼Œå¯¹shellæœ‰äº†æ–°çš„è®¤è¯†ï¼ŒåŠæ—¶è®°å½•é‡åˆ°çš„é—®é¢˜ï¼Œç›¸ä¿¡ä¸‹æ¬¡ä¼šæ›´æœ‰å°è±¡ã€‚ä½¿ç”¨è„šæœ¬ï¼Œå¯ä»¥è®©å·¥ä½œæ›´æœ‰æ•ˆç‡ï¼Œç›¸ä¿¡ä»¥åä¹Ÿä¼šè¶Šç”¨è¶Šå¤šã€‚","categories":[{"name":"Shell","slug":"Shell","permalink":"https://vanchchen.github.io/categories/Shell/"}],"tags":[{"name":"æ•ˆç‡å·¥å…·","slug":"æ•ˆç‡å·¥å…·","permalink":"https://vanchchen.github.io/tags/æ•ˆç‡å·¥å…·/"}]},{"title":"Categoryæ¢ç´¢","slug":"Categoryæ¢ç´¢","date":"2018-09-17T07:29:29.000Z","updated":"2018-10-16T01:15:41.976Z","comments":true,"path":"p/5cb0.html","link":"","permalink":"https://vanchchen.github.io/p/5cb0.html","excerpt":"","text":"ä»€ä¹ˆæ˜¯Category?Categoryæ˜¯Objective-C 2.0ä¹‹åæ·»åŠ çš„è¯­è¨€ç‰¹æ€§ï¼ŒCategoryçš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºå·²ç»å­˜åœ¨çš„ç±»æ·»åŠ æ–¹æ³•ï¼Œä¸€èˆ¬ç§°ä¸ºåˆ†ç±»ï¼Œæ–‡ä»¶åæ ¼å¼æ˜¯â€NSObject+A.hâ€ã€‚ 123456789struct category_t &#123; const char *name; classref_t cls; struct method_list_t *instanceMethods; struct method_list_t *classMethods; struct protocol_list_t *protocols; struct property_list_t *instanceProperties; struct property_list_t *_classProperties;&#125; ä»ç»“æ„èƒ½çœ‹å‡ºåˆ†ç±»å¯ä»¥æ‰©å±•å®ä¾‹æ–¹æ³•åˆ—è¡¨ã€ç±»æ–¹æ³•åˆ—è¡¨ã€åè®®åˆ—è¡¨ï¼Œä¹Ÿæ”¯æŒæ‰©å±•å±æ€§ï¼Œä½†ä¸æ”¯æŒæ‰©å±•æˆå‘˜å˜é‡ï¼ˆä¹‹åä¼šè¯´ï¼‰ã€‚ ä¸€èˆ¬ä½¿ç”¨çš„åœºæ™¯æœ‰æ‰©å±•ç°æœ‰ç±»æ–¹æ³•ã€ä»£ç åˆ†åŒºã€æ·»åŠ ç§æœ‰æ–¹æ³•ï¼ˆä¸å¯¹å¤–æš´éœ²category.hï¼‰ã€æ¨¡æ‹Ÿå¤šç»§æ‰¿ï¼ˆä½¿ç”¨å…³è”å¯¹è±¡çš„æ–¹å¼æ·»åŠ å±æ€§å®ç°ï¼‰ ä»€ä¹ˆæ˜¯Extensionï¼ŸExtensionä¸€èˆ¬è¢«ç§°ä¸ºç±»æ‰©å±•ã€åŒ¿ååˆ†ç±»ï¼Œç”¨äºå®šä¹‰ç§æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œä¸å¯è¢«ç»§æ‰¿ã€‚åªèƒ½ä¾é™„è‡ªå®šä¹‰ç±»å†™äº.mä¸­ï¼Œå®šä¹‰ä¸€èˆ¬ä¸º: 12345@interface ViewController ()@property (nonatomic, strong) NSObject *obj;@end ç±»æ‰©å±•æ”¯æŒå†™åœ¨å¤šä¸ª.hæ–‡ä»¶ï¼Œä½†éƒ½å¿…é¡»åœ¨.mæ–‡ä»¶ä¸­å¼•ç”¨ï¼Œä¸”ä¸èƒ½æœ‰è‡ªå·±çš„å®ç°ã€‚ ç±»æ‰©å±•å¾ˆå¤šæ—¶å€™ä¼šä¸åˆ†ç±»ææ··ï¼Œæˆ‘åœ¨æ–‡åé—®ç­”ç¯èŠ‚è¯¦ç»†æ•´ç†äº†ä»–ä»¬çš„åŒºåˆ«ã€‚ Categoryå¦‚ä½•åŠ è½½çš„ï¼Ÿ1234567891011121314151617181920212223242526struct objc_class : objc_object &#123; Class superclass; class_data_bits_t bits; class_rw_t *data() &#123; return bits.data(); &#125; ...&#125;struct class_rw_t &#123; const class_ro_t *ro; method_array_t methods; property_array_t properties; protocol_array_t protocols; ...&#125;struct class_ro_t &#123; const char * name; method_list_t * baseMethodList; protocol_list_t * baseProtocols; const ivar_list_t * ivars; //åªæœ‰roæ‰æœ‰å®ä¾‹å˜é‡è¡¨ property_list_t *baseProperties; ...&#125;; å…ˆç®€å•äº†è§£ä¸€ä¸‹Classå¯¹è±¡çš„ç»“æ„ï¼Œæ¯ä¸ªobjc_classéƒ½åŒ…å«æœ‰class_data_bits_tæ•°æ®ä½ï¼Œå…¶ä¸­å‚¨å­˜äº†class_rw_tçš„æŒ‡é’ˆåœ°å€å’Œä¸€äº›å…¶ä»–æ ‡è®°ã€‚class_rw_tä¸­åŒ…å«æœ‰å±æ€§æ–¹æ³•åè®®åˆ—è¡¨ï¼Œä»¥åŠclass_ro_tæŒ‡é’ˆåœ°å€ã€‚è€Œåœ¨class_ro_tç»“æ„ä¸­ï¼Œå‚¨å­˜çš„æ˜¯ç¼–è¯‘å™¨å†³å®šçš„å±æ€§æ–¹æ³•åè®®ã€‚ é‚£ä¹ˆæ˜¯æ€ä¹ˆè¿è¡Œçš„å‘¢ï¼Ÿåœ¨ç¼–è¯‘æœŸç±»çš„ç»“æ„ä¸­çš„class_data_bits_tæŒ‡å‘çš„æ˜¯ä¸€ä¸ª class_ro_tæŒ‡é’ˆã€‚ åœ¨è¿è¡Œæ—¶è°ƒç”¨realizeClassæ–¹æ³•ï¼Œåˆå§‹åŒ–ä¸€ä¸ªclass_rw_tç»“æ„ä½“ï¼Œè®¾ç½®roå€¼ä¸ºåŸæ•°æ®ä¸­çš„class_ro_tåè®¾ä¸ºæ•°æ®ä½ä¸­çš„æŒ‡å‘ï¼Œæœ€åè°ƒç”¨methodizeClassæ–¹æ³•åŠ è½½ã€‚ 12345678910111213141516171819202122232425262728293031static void methodizeClass(Class cls)&#123; auto rw = cls-&gt;data(); auto ro = rw-&gt;ro; //ä»roä¸­åŠ è½½æ–¹æ³•è¡¨ method_list_t *list = ro-&gt;baseMethods(); if (list) &#123; prepareMethodLists(cls, &amp;list, 1, YES, isBundleClass(cls)); rw-&gt;methods.attachLists(&amp;list, 1); &#125; //åŠ è½½å±æ€§ property_list_t *proplist = ro-&gt;baseProperties; if (proplist) &#123; rw-&gt;properties.attachLists(&amp;proplist, 1); &#125; //åŠ è½½åè®® protocol_list_t *protolist = ro-&gt;baseProtocols; if (protolist) &#123; rw-&gt;protocols.attachLists(&amp;protolist, 1); &#125; //åŸºç±»æ·»åŠ åˆå§‹åŒ–æ–¹æ³• if (cls-&gt;isRootMetaclass()) &#123; addMethod(cls, SEL_initialize, (IMP)&amp;objc_noop_imp, \"\", NO); &#125; //åŠ è½½åˆ†ç±» category_list *cats = unattachedCategoriesForClass(cls, true /*realizing*/); attachCategories(cls, cats, false /*don't flush caches*/); if (cats) free(cats);&#125; å¯ä»¥çœ‹åˆ°ï¼Œåœ¨methodizeClassä¸­åŠ è½½äº†åŸå…ˆç±»åœ¨ç¼–è¯‘æœŸå†³å®šçš„æ–¹æ³•å±æ€§å’Œåè®®ï¼Œç„¶åè·å–äº†æœªè¿æ¥çš„åˆ†ç±»è¡¨ï¼Œå°†åˆ—è¡¨ä¸­çš„æ‰©å±•æ–¹æ³•æ·»åŠ åˆ°è¿è¡ŒæœŸç±»ä¸­ã€‚ Categoryæ–¹æ³•è¦†ç›–å¦‚æœä¸åŒçš„åˆ†ç±»å®ç°äº†ç›¸åŒåå­—çš„æ–¹æ³•ï¼Œé‚£ä¹ˆè°ƒç”¨æ—¶ä¼šä½¿ç”¨æœ€ååŠ å…¥çš„å®ç°ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ åŠ è½½Categorydyldé“¾æ¥å¹¶åˆå§‹åŒ–äºŒè¿›åˆ¶æ–‡ä»¶åï¼Œäº¤ç”±ImageLoaderè¯»å–ï¼Œæ¥ç€é€šçŸ¥runtimeå¤„ç†ï¼Œruntimeè°ƒç”¨map_imagesè§£æï¼Œç„¶åæ‰§è¡Œ_read_imagesåˆ†ææ–‡ä»¶ä¸­åŒ…å«çš„ç±»å’Œåˆ†ç±»ã€‚ 1234567891011121314151617181920212223242526272829303132333435//åŠ è½½åˆ†ç±»category_t **catlist = _getObjc2CategoryList(hi, &amp;count);bool hasClassProperties = hi-&gt;info()-&gt;hasCategoryClassProperties();for (i = 0; i &lt; count; i++) &#123; category_t *cat = catlist[i]; Class cls = remapClass(cat-&gt;cls); if (!cls) &#123; //åˆ†ç±»æŒ‡å®šçš„ç±»è¿˜æ²¡åŠ è½½ï¼Œå¯èƒ½æ˜¯é“¾æ¥åº“é¡ºåºçš„é—®é¢˜ catlist[i] = nil; continue; &#125; //æ·»åŠ åˆ†ç±»åˆ°ç±»çš„åˆ†ç±»è¡¨ä¸­ï¼Œä¼ºæœºé‡è½½å…¥ bool classExists = NO; if (cat-&gt;instanceMethods || cat-&gt;protocols || cat-&gt;instanceProperties) &#123; addUnattachedCategoryForClass(cat, cls, hi); if (cls-&gt;isRealized()) &#123; remethodizeClass(cls); classExists = YES; &#125; &#125; //æ·»åŠ åˆ†ç±»åˆ°å…ƒç±»ä¸­ if (cat-&gt;classMethods || cat-&gt;protocols || (hasClassProperties &amp;&amp; cat-&gt;_classProperties)) &#123; addUnattachedCategoryForClass(cat, cls-&gt;ISA(), hi); if (cls-&gt;ISA()-&gt;isRealized()) &#123; remethodizeClass(cls-&gt;ISA()); &#125; &#125;&#125; æ·»åŠ æ–¹æ³•å±æ€§å’Œåè®®å¦‚æœæœ‰æ–°å¢çš„åˆ†ç±»ï¼Œå°±åˆ†åˆ«æ·»åŠ åˆ°åŸç±»å’Œmetaç±»ï¼Œå¹¶é€šè¿‡remethodizeClassæ›´æ–°ï¼Œå…·ä½“å°±æ˜¯è°ƒç”¨attachCategoriesæ–¹æ³•æŠŠåˆ†ç±»ä¸­æ‰€æœ‰çš„æ–¹æ³•éƒ½æ·»åŠ åˆ°æŒ‡å®šç±»ä¸­ã€‚1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253static void attachCategories(Class cls, category_list *cats, bool flush_caches)&#123; if (!cats) return; bool isMeta = cls-&gt;isMetaClass(); //æ–°å»ºæ•°ç»„æŒ‡é’ˆ method_list_t **mlists = (method_list_t **) malloc(cats-&gt;count * sizeof(*mlists)); property_list_t **proplists = (property_list_t **) malloc(cats-&gt;count * sizeof(*proplists)); protocol_list_t **protolists = (protocol_list_t **) malloc(cats-&gt;count * sizeof(*protolists)); int mcount = 0; int propcount = 0; int protocount = 0; int i = cats-&gt;count;//å€’åºè·å–æœ€æ–°çš„åˆ†ç±» bool fromBundle = NO; while (i--) &#123; auto&amp; entry = cats-&gt;list[i]; //åˆ†åˆ«è·å–åˆ—è¡¨ method_list_t *mlist = entry.cat-&gt;methodsForMeta(isMeta); if (mlist) &#123; mlists[mcount++] = mlist; fromBundle |= entry.hi-&gt;isBundle(); &#125; property_list_t *proplist = entry.cat-&gt;propertiesForMeta(isMeta, entry.hi); if (proplist) &#123; proplists[propcount++] = proplist; &#125; protocol_list_t *protolist = entry.cat-&gt;protocols; if (protolist) &#123; protolists[protocount++] = protolist; &#125; &#125; auto rw = cls-&gt;data(); //åŠ è½½åˆ—è¡¨åˆ°rwä¸­ prepareMethodLists(cls, mlists, mcount, NO, fromBundle); rw-&gt;methods.attachLists(mlists, mcount); free(mlists); if (flush_caches &amp;&amp; mcount &gt; 0) flushCaches(cls); rw-&gt;properties.attachLists(proplists, propcount); free(proplists); rw-&gt;protocols.attachLists(protolists, protocount); free(protolists);&#125; 123456789101112131415161718192021222324252627282930void attachLists(List* const * addedLists, uint32_t addedCount) &#123; if (addedCount == 0) return; if (hasArray()) &#123; // many lists -&gt; many lists uint32_t oldCount = array()-&gt;count; uint32_t newCount = oldCount + addedCount; setArray((array_t *)realloc(array(), array_t::byteSize(newCount))); array()-&gt;count = newCount; memmove(array()-&gt;lists + addedCount, array()-&gt;lists, oldCount * sizeof(array()-&gt;lists[0])); memcpy(array()-&gt;lists, addedLists, addedCount * sizeof(array()-&gt;lists[0])); &#125; else if (!list &amp;&amp; addedCount == 1) &#123; // 0 lists -&gt; 1 list list = addedLists[0]; &#125; else &#123; // 1 list -&gt; many lists List* oldList = list; uint32_t oldCount = oldList ? 1 : 0; uint32_t newCount = oldCount + addedCount; setArray((array_t *)malloc(array_t::byteSize(newCount))); array()-&gt;count = newCount; if (oldList) array()-&gt;lists[addedCount] = oldList; memcpy(array()-&gt;lists, addedLists, addedCount * sizeof(array()-&gt;lists[0])); &#125; &#125; å¯ä»¥çœ‹åˆ°æœ€åè°ƒç”¨äº†rw-&gt;methods.attachLists(mlists, mcount); æŠŠæ–°å¢åˆ†ç±»ä¸­çš„æ–¹æ³•åˆ—è¡¨æ·»åŠ åˆ°å®é™…è¿è¡Œæ—¶æŸ¥è¯¢çš„æ–¹æ³•åˆ—è¡¨å¤´éƒ¨ã€‚ åœ¨è¿›è¡Œæ–¹æ³•è°ƒç”¨æ—¶ä¼šä»å¤´éƒ¨æŸ¥è¯¢ï¼Œä¸€æ—¦æŸ¥åˆ°åå°±è¿”å›ç»“æœï¼Œå› æ­¤åç¼–è¯‘çš„æ–‡ä»¶ä¸­çš„æ–¹æ³•ä¼šè¢«ä¼˜å…ˆè°ƒç”¨ã€‚ åŒæ—¶ä¹‹å‰æ·»åŠ çš„æ–¹æ³•å®ç°ä¹Ÿä¿å­˜äº†ï¼Œå¯ä»¥é€šè¿‡è·å–åŒåæ–¹æ³•çš„æ–¹å¼æŸ¥æ‰¾åŸç±»çš„å®ç°ã€‚ Categoryå®ç°å±æ€§åˆ†ç±»ä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡å±æ€§ï¼ˆPropertyï¼‰åŒ…å«äº†æˆå‘˜å˜é‡ï¼ˆIvarï¼‰å’ŒSetter&amp;Getterã€‚ å¯ä»¥åœ¨åˆ†ç±»ä¸­å®šä¹‰å±æ€§ï¼Œä½†ç”±äºåˆ†ç±»æ˜¯åœ¨è¿è¡Œæ—¶æ·»åŠ åˆ†ç±»å±æ€§åˆ°ç±»çš„å±æ€§åˆ—è¡¨ä¸­ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰åˆ›å»ºå¯¹åº”çš„æˆå‘˜å˜é‡å’Œæ–¹æ³•å®ç°ã€‚ å…³è”å¯¹è±¡å¦‚æœæˆ‘ä»¬æƒ³è®©åˆ†ç±»å®ç°æ·»åŠ æ–°çš„å±æ€§ï¼Œä¸€èˆ¬éƒ½é€šè¿‡å…³è”å¯¹è±¡çš„æ–¹å¼ã€‚12345678910111213141516171819// å£°æ˜æ–‡ä»¶@interface TestObject (Category)@property (nonatomic, strong) NSObject *object;@end// å®ç°æ–‡ä»¶static void *const kAssociatedObjectKey = (void *)&amp;kAssociatedObjectKey;@implementation TestObject (Category)- (NSObject *)object &#123; return objc_getAssociatedObject(self, kAssociatedObjectKey);&#125;- (void)setObject:(NSObject *)object &#123; objc_setAssociatedObject(self, kAssociatedObjectKey, object, OBJC_ASSOCIATION_RETAIN_NONATOMIC);&#125;@end è¿™ç§æ–¹å¼å¯ä»¥å®ç°å­˜å–å¯¹è±¡ï¼Œä½†æ˜¯ä¸èƒ½è·å–_objectå˜é‡ã€‚ é—®ç­”åˆ†ç±»å’Œæ‰©å±•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ1.åˆ†ç±»å¤šç”¨äºæ‰©å±•æ–¹æ³•å®ç°ï¼Œç±»æ‰©å±•å¤šç”¨äºç”³æ˜ç§æœ‰å˜é‡å’Œæ–¹æ³•ã€‚ 2.ç±»æ‰©å±•ä½œç”¨åœ¨ç¼–è¯‘æœŸï¼Œç›´æ¥å’ŒåŸç±»åœ¨ä¸€èµ·ï¼Œè€Œåˆ†ç±»ä½œç”¨åœ¨è¿è¡Œæ—¶ï¼ŒåŠ è½½ç±»çš„æ—¶å€™åŠ¨æ€æ·»åŠ åˆ°åŸç±»ä¸­ã€‚ 3.ç±»æ‰©å±•å¯ä»¥å®šä¹‰å±æ€§ï¼Œåˆ†ç±»ä¸­å®šä¹‰çš„å±æ€§åªä¼šç”³æ˜setter/getterï¼Œå¹¶æ²¡æœ‰ç›¸å…³å®ç°å’Œå˜é‡ã€‚ åˆ†ç±»æœ‰å“ªäº›å±€é™æ€§ï¼Ÿ1.åˆ†ç±»åªèƒ½ç»™ç°æœ‰çš„ç±»åŠ æ–¹æ³•æˆ–åè®®ï¼Œä¸èƒ½æ·»åŠ å®ä¾‹å˜é‡ï¼ˆivarï¼‰ã€‚ 2.åˆ†ç±»æ·»åŠ çš„æ–¹æ³•å¦‚æœä¸ç°æœ‰çš„é‡åï¼Œä¼šè¦†ç›–åŸæœ‰æ–¹æ³•çš„å®ç°ã€‚å¦‚æœå¤šä¸ªåˆ†ç±»æ–¹æ³•éƒ½é‡åï¼Œåˆ™æ ¹æ®ç¼–è¯‘é¡ºåºæ‰§è¡Œæœ€åä¸€ä¸ªã€‚ åˆ†ç±»çš„ç»“æ„ä½“é‡Œé¢æœ‰å“ªäº›æˆå‘˜ï¼Ÿåˆ†ç±»ç»“æ„ä½“åŒ…å«äº†åˆ†ç±»åï¼Œç»‘å®šçš„ç±»ï¼Œå®ä¾‹ä¸ç±»æ–¹æ³•åˆ—è¡¨ï¼Œå®ä¾‹ä¸ç±»æ–¹æ³•å±æ€§ä»¥åŠåè®®è¡¨ã€‚ å‚è€ƒæ·±å…¥ç†è§£Objective-Cï¼šCategory ç¥ç»ç—…é™¢ Objective-C Runtime å…¥é™¢ç¬¬ä¸€å¤©â€”â€” isa å’Œ Class æ¢ç§˜Runtime - æ·±å…¥å‰–æCategory","categories":[{"name":"iOS","slug":"iOS","permalink":"https://vanchchen.github.io/categories/iOS/"}],"tags":[{"name":"åŸç†åˆ†æ","slug":"åŸç†åˆ†æ","permalink":"https://vanchchen.github.io/tags/åŸç†åˆ†æ/"}]},{"title":"iOSé¢è¯•é¢˜","slug":"iOSé¢è¯•é¢˜","date":"2018-09-14T09:40:01.000Z","updated":"2018-10-16T01:35:44.505Z","comments":true,"path":"p/6ea5.html","link":"","permalink":"https://vanchchen.github.io/p/6ea5.html","excerpt":"","text":"å‰è¨€æœ¬æ–‡å€Ÿé‰´æ•´ç†äº†iOSé«˜çº§å¼€å‘å¸¸è§çš„é¢è¯•é¢˜ï¼Œå¹¶ä¸”åˆ†åšå®¢ä¸€ä¸€åˆ†æï¼Œå¸Œæœ›èƒ½å’Œå¤§å®¶ä¸€èµ·è¿›æ­¥å­¦ä¹ ã€‚ æ¬¢è¿å¤§å®¶å…³æ³¨æˆ‘çš„ GithubğŸ‘ä»¥åŠç›¸å…³åšå®¢ ç®€ä¹¦ åšå®¢å›­ å¤§å®¶çš„é¼“åŠ±æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›ğŸ˜„ iOSåŸºç¡€é¢˜ åˆ†ç±»å’Œæ‰©å±•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå¯ä»¥åˆ†åˆ«ç”¨æ¥åšä»€ä¹ˆï¼Ÿåˆ†ç±»æœ‰å“ªäº›å±€é™æ€§ï¼Ÿåˆ†ç±»çš„ç»“æ„ä½“é‡Œé¢æœ‰å“ªäº›æˆå‘˜ï¼Ÿ Categoryæ¢ç´¢ è®²ä¸€ä¸‹atomicçš„å®ç°æœºåˆ¶ï¼›ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯ç»å¯¹çš„çº¿ç¨‹å®‰å…¨ï¼ˆæœ€å¥½å¯ä»¥ç»“åˆåœºæ™¯æ¥è¯´ï¼‰ï¼Ÿ è¢«weakä¿®é¥°çš„å¯¹è±¡åœ¨è¢«é‡Šæ”¾çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæ˜¯å¦‚ä½•å®ç°çš„ï¼ŸçŸ¥é“sideTableä¹ˆï¼Ÿé‡Œé¢çš„ç»“æ„å¯ä»¥ç”»å‡ºæ¥ä¹ˆï¼Ÿ å…³è”å¯¹è±¡æœ‰ä»€ä¹ˆåº”ç”¨ï¼Œç³»ç»Ÿå¦‚ä½•ç®¡ç†å…³è”å¯¹è±¡ï¼Ÿå…¶è¢«é‡Šæ”¾çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨å°†å…¶æŒ‡é’ˆç½®ç©ºä¹ˆï¼Ÿ AssociatedObjectå…³è”å¯¹è±¡åŸç†å®ç° KVOçš„åº•å±‚å®ç°ï¼Ÿå¦‚ä½•å–æ¶ˆç³»ç»Ÿé»˜è®¤çš„KVOå¹¶æ‰‹åŠ¨è§¦å‘ï¼ˆç»™KVOçš„è§¦å‘è®¾å®šæ¡ä»¶ï¼šæ”¹å˜çš„å€¼ç¬¦åˆæŸä¸ªæ¡ä»¶æ—¶å†è§¦å‘KVOï¼‰ï¼Ÿ åˆ¨æ ¹é—®åº•KVOåŸç† Autoreleasepoolæ‰€ä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼ŸAutoreleasePoolPageç»“æ„ä½“äº†è§£ä¹ˆï¼Ÿ è®²ä¸€ä¸‹å¯¹è±¡ï¼Œç±»å¯¹è±¡ï¼Œå…ƒç±»ï¼Œè·Ÿå…ƒç±»ç»“æ„ä½“çš„ç»„æˆä»¥åŠä»–ä»¬æ˜¯å¦‚ä½•ç›¸å…³è”çš„ï¼Ÿä¸ºä»€ä¹ˆå¯¹è±¡æ–¹æ³•æ²¡æœ‰ä¿å­˜çš„å¯¹è±¡ç»“æ„ä½“é‡Œï¼Œè€Œæ˜¯ä¿å­˜åœ¨ç±»å¯¹è±¡çš„ç»“æ„ä½“é‡Œï¼Ÿ class_ro_t å’Œ class_rw_t çš„åŒºåˆ«ï¼Ÿ iOS ä¸­å†…çœçš„å‡ ä¸ªæ–¹æ³•ï¼Ÿclassæ–¹æ³•å’Œobjc_getClassæ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«? åœ¨è¿è¡Œæ—¶åˆ›å»ºç±»çš„æ–¹æ³•objc_allocateClassPairçš„æ–¹æ³•åå°¾éƒ¨ä¸ºä»€ä¹ˆæ˜¯pairï¼ˆæˆå¯¹çš„æ„æ€ï¼‰ï¼Ÿ ä¸€ä¸ªintå˜é‡è¢«__blockä¿®é¥°ä¸å¦çš„åŒºåˆ«ï¼Ÿ\\12. ä¸ºä»€ä¹ˆåœ¨blockå¤–éƒ¨ä½¿ç”¨__weakä¿®é¥°çš„åŒæ—¶éœ€è¦åœ¨å†…éƒ¨ä½¿ç”¨__strongä¿®é¥°ï¼Ÿ RunLoopçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿå®ƒçš„å†…éƒ¨å·¥ä½œæœºåˆ¶äº†è§£ä¹ˆï¼Ÿï¼ˆæœ€å¥½ç»“åˆçº¿ç¨‹å’Œå†…å­˜ç®¡ç†æ¥è¯´ï¼‰ å“ªäº›åœºæ™¯å¯ä»¥è§¦å‘ç¦»å±æ¸²æŸ“ï¼Ÿï¼ˆçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰ iOS å®æˆ˜é¢˜ AppDelegateå¦‚ä½•ç˜¦èº«ï¼Ÿ åå°„æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥ä¸¾å‡ºå‡ ä¸ªåº”ç”¨åœºæ™¯ä¹ˆï¼Ÿï¼ˆçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰ æœ‰å“ªäº›åœºæ™¯æ˜¯NSOperationæ¯”GCDæ›´å®¹æ˜“å®ç°çš„ï¼Ÿï¼ˆæˆ–æ˜¯NSOperationä¼˜äºGCDçš„å‡ ç‚¹ï¼ŒçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰ App å¯åŠ¨ä¼˜åŒ–ç­–ç•¥ï¼Ÿæœ€å¥½ç»“åˆå¯åŠ¨æµç¨‹æ¥è¯´ï¼ˆmain()å‡½æ•°çš„æ‰§è¡Œå‰åéƒ½åˆ†åˆ«è¯´ä¸€ä¸‹ï¼ŒçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰ App æ— ç—•åŸ‹ç‚¹çš„æ€è·¯äº†è§£ä¹ˆï¼Ÿä½ è®¤ä¸ºç†æƒ³çš„æ— ç—•åŸ‹ç‚¹ç³»ç»Ÿåº”è¯¥å…·å¤‡å“ªäº›ç‰¹ç‚¹ï¼Ÿï¼ˆçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰ ä½ çŸ¥é“æœ‰å“ªäº›æƒ…å†µä¼šå¯¼è‡´appå´©æºƒï¼Œåˆ†åˆ«å¯ä»¥ç”¨ä»€ä¹ˆæ–¹æ³•æ‹¦æˆªå¹¶åŒ–è§£ï¼Ÿï¼ˆçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰ ä½ çŸ¥é“æœ‰å“ªäº›æƒ…å†µä¼šå¯¼è‡´appå¡é¡¿ï¼Œåˆ†åˆ«å¯ä»¥ç”¨ä»€ä¹ˆæ–¹æ³•æ¥é¿å…ï¼Ÿï¼ˆçŸ¥é“å¤šå°‘è¯´å¤šå°‘ï¼‰ ç½‘ç»œé¢˜ App ç½‘ç»œå±‚æœ‰å“ªäº›ä¼˜åŒ–ç­–ç•¥ï¼Ÿ TCPä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹ï¼Ÿ å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†çš„åŒºåˆ«ï¼Ÿåˆ†åˆ«æœ‰å“ªäº›ç®—æ³•çš„å®ç°ï¼Ÿ HTTPSçš„æ¡æ‰‹æµç¨‹ï¼Ÿä¸ºä»€ä¹ˆå¯†é’¥çš„ä¼ é€’éœ€è¦ä½¿ç”¨éå¯¹ç§°åŠ å¯†ï¼ŸåŒå‘è®¤è¯äº†è§£ä¹ˆï¼Ÿ HTTPSæ˜¯å¦‚ä½•å®ç°éªŒè¯èº«ä»½å’ŒéªŒè¯å®Œæ•´æ€§çš„ï¼Ÿ å¦‚ä½•ç”¨CharlesæŠ“HTTPSçš„åŒ…ï¼Ÿå…¶ä¸­åŸç†å’Œæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ ä»€ä¹ˆæ˜¯ä¸­é—´äººæ”»å‡»ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ è®¡ç®—æœºç³»ç»Ÿé¢˜ äº†è§£ç¼–è¯‘çš„è¿‡ç¨‹ä¹ˆï¼Ÿåˆ†ä¸ºå“ªå‡ ä¸ªæ­¥éª¤ï¼Ÿ é™æ€é“¾æ¥äº†è§£ä¹ˆï¼Ÿé™æ€åº“å’ŒåŠ¨æ€åº“çš„åŒºåˆ«ï¼Ÿ å†…å­˜çš„å‡ å¤§åŒºåŸŸï¼Œå„è‡ªçš„èŒèƒ½åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ staticå’Œconstæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ äº†è§£å†…è”å‡½æ•°ä¹ˆï¼Ÿ ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°æ­»é”ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ è¯´ä¸€è¯´ä½ å¯¹çº¿ç¨‹å®‰å…¨çš„ç†è§£ï¼Ÿ åˆ—ä¸¾ä½ çŸ¥é“çš„çº¿ç¨‹åŒæ­¥ç­–ç•¥ï¼Ÿ æœ‰å“ªå‡ ç§é”ï¼Ÿå„è‡ªçš„åŸç†ï¼Ÿå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿæœ€å¥½å¯ä»¥ç»“åˆä½¿ç”¨åœºæ™¯æ¥è¯´ è®¾è®¡æ¨¡å¼é¢˜ é™¤äº†å•ä¾‹ï¼Œè§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼ä»¥å¤–ï¼Œè¿˜çŸ¥é“å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿåˆ†åˆ«ä»‹ç»ä¸€ä¸‹ æœ€å–œæ¬¢å“ªä¸ªè®¾è®¡æ¨¡å¼ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ iOS SDK é‡Œé¢æœ‰å“ªäº›è®¾è®¡æ¨¡å¼çš„å®è·µï¼Ÿ **è®¾è®¡æ¨¡å¼æ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜çš„ï¼Ÿ **è®¾è®¡æ¨¡å¼çš„æˆå‘˜æ„æˆä»¥åŠå·¥ä½œæœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ **è®¾è®¡æ¨¡å¼çš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ æ¶æ„ &amp; è®¾è®¡é¢˜ MVCå’ŒMVVMçš„åŒºåˆ«ï¼ŸMVVMå’ŒMVPçš„åŒºåˆ«ï¼Ÿ é¢å‘å¯¹è±¡çš„å‡ ä¸ªè®¾è®¡åŸåˆ™äº†è§£ä¹ˆï¼Ÿæœ€å¥½å¯ä»¥ç»“åˆåœºæ™¯æ¥è¯´ã€‚ å¯ä»¥è¯´å‡ ä¸ªé‡æ„çš„æŠ€å·§ä¹ˆï¼Ÿä½ è§‰å¾—é‡æ„é€‚åˆä»€ä¹ˆæ—¶å€™æ¥åšï¼Ÿ ä½ è§‰å¾—æ¡†æ¶å’Œè®¾è®¡æ¨¡å¼çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ çœ‹è¿‡å“ªäº›ç¬¬ä¸‰æ–¹æ¡†æ¶çš„æºç ï¼Œå®ƒä»¬æ˜¯æ€ä¹ˆè®¾è®¡çš„ï¼Ÿè®¾è®¡å¥½çš„åœ°æ–¹åœ¨å“ªé‡Œï¼Œä¸å¥½çš„åœ°æ–¹åœ¨å“ªé‡Œï¼Œå¦‚ä½•æ”¹è¿›ï¼Ÿï¼ˆè¿™é“é¢˜çš„åä¸‰ä¸ªé—®é¢˜çš„éš¾åº¦å·²ç»å¾ˆé«˜äº†ï¼Œå¦‚æœä¸æ˜¯å¤ªNçš„å…¬å¸ä¸å»ºè®®æ·±ç©¶ï¼‰ æ•°æ®ç»“æ„&amp;ç®—æ³•é¢˜ é“¾è¡¨å’Œæ•°ç»„çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿæ’å…¥å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦åˆ†åˆ«æ˜¯å¤šå°‘ï¼Ÿ å“ˆå¸Œè¡¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå¦‚ä½•è§£å†³åœ°å€å†²çªï¼Ÿ æ’åºé¢˜ï¼šå†’æ³¡æ’åºï¼Œé€‰æ‹©æ’åºï¼Œæ’å…¥æ’åºï¼Œå¿«é€Ÿæ’åºï¼ˆäºŒè·¯ï¼Œä¸‰è·¯ï¼‰èƒ½å†™å‡ºé‚£äº›ï¼Ÿ é“¾è¡¨é¢˜ï¼šå¦‚ä½•æ£€æµ‹é“¾è¡¨ä¸­æ˜¯å¦æœ‰ç¯ï¼Ÿå¦‚ä½•åˆ é™¤é“¾è¡¨ä¸­ç­‰äºæŸä¸ªå€¼çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Ÿ æ•°ç»„é¢˜ï¼šå¦‚ä½•åœ¨æœ‰åºæ•°ç»„ä¸­æ‰¾å‡ºå’Œç­‰äºç»™å®šå€¼çš„ä¸¤ä¸ªå…ƒç´ ï¼Ÿå¦‚ä½•åˆå¹¶ä¸¤ä¸ªæœ‰åºçš„æ•°ç»„ä¹‹åä¿æŒæœ‰åºï¼Ÿ äºŒå‰æ ‘é¢˜ï¼šå¦‚ä½•åè½¬äºŒå‰æ ‘ï¼Ÿå¦‚ä½•éªŒè¯ä¸¤ä¸ªäºŒå‰æ ‘æ˜¯å®Œå…¨ç›¸ç­‰çš„ï¼Ÿ å¼•ç”¨å‡ºä¸€å¥— iOS é«˜çº§é¢è¯•é¢˜","categories":[{"name":"iOS","slug":"iOS","permalink":"https://vanchchen.github.io/categories/iOS/"}],"tags":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://vanchchen.github.io/tags/é¢è¯•/"}]}]}